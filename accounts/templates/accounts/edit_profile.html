{% extends 'base.html' %}
{% load static %}

{% block body %}
<div class="max-w-2xl mx-auto p-6 bg-white rounded shadow mt-10">
  <h2 class="text-2xl font-bold mb-6">í”„ë¡œí•„ ê´€ë¦¬</h2>

  <!-- ì„±ê³µ/ì—ëŸ¬ ë©”ì‹œì§€ -->
  {% if messages %}
    {% for message in messages %}
      <div class="mb-4 p-3 rounded {% if message.tags == 'success' %}bg-green-100 text-green-700 border border-green-200{% else %}bg-red-100 text-red-700 border border-red-200{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <!-- âœ… í”„ë¡œí•„ í—¤ë” -->
  <div class="flex items-center space-x-4 mb-8 p-4 bg-gray-50 rounded-lg">
    {% if user_profile.profile_image and user_profile.profile_image.name %}
      <img src="{{ user_profile.profile_image.url }}" alt="í”„ë¡œí•„"
          class="w-16 h-16 rounded-full object-cover border-2 border-white shadow">
    {% else %}
      <img src="{% static 'image/ddok_logo.png' %}" alt="ê¸°ë³¸ í”„ë¡œí•„"
          class="w-16 h-16 rounded-full object-cover border-2 border-white shadow">
    {% endif %}
    <div class="flex-1">
      <h3 class="text-lg font-bold text-gray-800">
        {% if user_profile.first_name %}
          {{ user_profile.first_name }}
        {% elif user_profile.username|slice:":6" == "kakao_" %}
          ì¹´ì¹´ì˜¤ ì‚¬ìš©ì
        {% elif user_profile.username|slice:":6" == "naver_" %}
          ë„¤ì´ë²„ ì‚¬ìš©ì
        {% else %}
          {{ user_profile.username }}
        {% endif %}
      </h3>
      
      <!-- ì†Œì…œ ë¡œê·¸ì¸ ë±ƒì§€ -->
      {% if user_profile.username|slice:":6" == "kakao_" %}
        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-yellow-100 text-yellow-800 border border-yellow-200 mt-1">
          <span class="mr-1">ğŸ’¬</span> ì¹´ì¹´ì˜¤ ì—°ê²°ë¨
        </span>
      {% elif user_profile.username|slice:":6" == "naver_" %}
        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-green-100 text-green-800 border border-green-200 mt-1">
          <span class="mr-1">N</span> ë„¤ì´ë²„ ì—°ê²°ë¨
        </span>
      {% endif %}
      
      <p class="text-sm text-gray-500 mt-1">{{ user_profile.date_joined|date:"Yë…„ mì›” dì¼ ê°€ì…" }}</p>
    </div>
    
    <a href="{% url 'accounts:edit_profile_image' user_profile.username %}"
       class="bg-blue-500 text-white text-sm px-4 py-2 rounded-lg hover:bg-pink-600 transition">
      ğŸ“· í”„ë¡œí•„ ì´ë¯¸ì§€ ë³€ê²½
    </a>
  </div>

  <!-- âœ… ìˆ˜ì • ê°€ëŠ¥í•œ ì •ë³´ë“¤ -->
  <div class="space-y-6">
    
    <!-- âœ… ë‹‰ë„¤ì„ ìˆ˜ì • -->
    <div class="border border-gray-200 rounded-lg p-4">
      <div id="nickname-display" class="flex justify-between items-start">
        <div class="flex-1">
          <label class="block text-sm font-semibold text-gray-700 mb-1">ë‹‰ë„¤ì„</label>
          <p class="text-lg font-medium text-gray-900" id="current-nickname">
            {% if user_profile.first_name %}
              {{ user_profile.first_name }}
            {% else %}
              {% if user_profile.username|slice:":6" == "kakao_" %}ì¹´ì¹´ì˜¤ ì‚¬ìš©ì{% elif user_profile.username|slice:":6" == "naver_" %}ë„¤ì´ë²„ ì‚¬ìš©ì{% else %}{{ user_profile.username }}{% endif %}
            {% endif %}
          </p>
          <p class="text-xs text-gray-500 mt-1">
            ë‹¤ë¥¸ ì‚¬ìš©ìë“¤ì—ê²Œ í‘œì‹œë˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤
          </p>
        </div>
        <button id="edit-nickname-btn" class="ml-4 px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 transition">
          ìˆ˜ì •
        </button>
      </div>

      <!-- âœ… ë‹‰ë„¤ì„ ìˆ˜ì • í¼ -->
      <form method="POST" id="nickname-edit-form"
            action="{% url 'accounts:edit_profile' user_profile.username %}"
            style="display: none;">
        {% csrf_token %}
        <div class="mt-3 space-y-3">
          <input type="text" id="new-nickname" name="first_name" 
                 value="{{ user.first_name }}"
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                 placeholder="ìƒˆ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”">
          
          <div class="bg-blue-50 p-3 rounded-lg">
            <p class="text-xs text-blue-700">
              ğŸ’¡ <strong>ë‹‰ë„¤ì„ ì„¤ì • íŒ</strong><br>
              â€¢ 2-20ìì˜ í•œê¸€, ì˜ë¬¸, ìˆ«ì ì‚¬ìš© ê°€ëŠ¥<br>
              â€¢ ì–¸ì œë“  ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>
              â€¢ ë‹¤ë¥¸ ì‚¬ìš©ìë“¤ì´ ì‰½ê²Œ ê¸°ì–µí•  ìˆ˜ ìˆëŠ” ì´ë¦„ì„ ì¶”ì²œí•´ìš”
            </p>
          </div>
          
          <div class="flex space-x-2">
            <button type="button" id="cancel-nickname-btn"
                    class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
              ì·¨ì†Œ
            </button>
            <button type="submit" id="save-nickname-btn"
                    class="flex-1 px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition">
              ì €ì¥
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- âœ… ì†Œê°œê¸€ ìˆ˜ì • -->
    <div class="border border-gray-200 rounded-lg p-4">
      <div id="bio-display" class="flex justify-between items-start">
        <div class="flex-1">
          <label class="block text-sm font-semibold text-gray-700 mb-1">ì†Œê°œ</label>
          <p class="text-gray-900" id="current-bio">
            {% if user_profile.bio %}
              {{ user_profile.bio }}
            {% else %}
              <span class="text-gray-400 italic">ì†Œê°œê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</span>
            {% endif %}
          </p>
          <p class="text-xs text-gray-500 mt-1">
            ìì‹ ì„ ê°„ë‹¨íˆ ì†Œê°œí•´ë³´ì„¸ìš”
          </p>
        </div>
        <button id="edit-bio-btn" class="ml-4 px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 transition">
          ìˆ˜ì •
        </button>
      </div>

      <!-- âœ… ì†Œê°œê¸€ ìˆ˜ì • í¼ -->
      <form method="POST" id="bio-edit-form"
            action="{% url 'accounts:edit_profile' user_profile.username %}"
            style="display: none;">
        {% csrf_token %}
        <div class="mt-3 space-y-3">
          <textarea id="new-bio" name="bio" class="w-full px-3 py-2 border border-gray-300 rounded-lg h-24 resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ìì‹ ì„ ì†Œê°œí•´ë³´ì„¸ìš”! (ìµœëŒ€ 150ì)">{% if user_profile.bio %}{{ user_profile.bio }}{% endif %}</textarea>
          
          <div class="flex justify-between items-center">
            <p class="text-xs text-gray-500">ìµœëŒ€ 150ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
            <span id="bio-count" class="text-xs text-gray-400 font-mono">0/150</span>
          </div>
          
          <div class="flex space-x-2">
            <button type="button" id="cancel-bio-btn"
                    class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
              ì·¨ì†Œ
            </button>
            <button type="submit" 
                    class="flex-1 px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition">
              ì €ì¥
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- âœ… ê³„ì • ì •ë³´ (ì½ê¸° ì „ìš©) -->
    <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
      <h4 class="text-sm font-semibold text-gray-700 mb-3">ê³„ì • ì •ë³´</h4>
      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span class="text-gray-600">ë¡œê·¸ì¸ ë°©ì‹</span>
          <span class="font-medium">
            {% if user_profile.username|slice:":6" == "kakao_" %}
              ì¹´ì¹´ì˜¤ ì†Œì…œ ë¡œê·¸ì¸
            {% elif user_profile.username|slice:":6" == "naver_" %}
              ë„¤ì´ë²„ ì†Œì…œ ë¡œê·¸ì¸
            {% else %}
              ì´ë©”ì¼ ë¡œê·¸ì¸
            {% endif %}
          </span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">ê°€ì…ì¼</span>
          <span class="font-medium">{{ user_profile.date_joined|date:"Yë…„ mì›” dì¼" }}</span>
        </div>
      </div>
    </div>

    <!-- âœ… ê³µì‹ íŒ¬ë¤ ì¸ì¦ ì—…ë¡œë“œ í¼ -->
    <div class="border border-blue-200 bg-blue-50 rounded-lg p-4 mt-6" id="fandom-auth">
      <h3 class="text-sm font-bold text-blue-700 mb-2">ğŸ« ê³µì‹ íŒ¬ë¤ ì¸ì¦</h3>

      {% if user_profile.is_verified_fandom %}
        <p class="text-green-600 font-semibold mb-2">âœ… ì¸ì¦ ì™„ë£Œëœ íŒ¬ë¤: {{ user_profile.fandom_artist.fandom }}</p>
      {% elif user_profile.is_pending_verification %}
        <p class="text-yellow-600 mb-2">â³ ì¸ì¦ ìš”ì²­ ì ‘ìˆ˜ ì™„ë£Œ (3ì¼ ì´ë‚´ ìŠ¹ì¸ ì˜ˆì •)</p>
      {% elif user_profile.verification_failed %}
        <p class="text-red-600 mb-2">âŒ ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
      {% else %}
        <p class="text-gray-600 text-sm mb-4">ì˜ˆì‹œ ì´ë¯¸ì§€ë¥¼ ì°¸ê³ í•´ íŒ¬í´ëŸ½ ì¹´ë“œë¥¼ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”. </p>
      {% endif %}

      <form method="POST" enctype="multipart/form-data"
            action="{% url 'accounts:upload_fandom_card' user_profile.username %}"
            class="space-y-4">
        {% csrf_token %}

        <!-- ì˜ˆì‹œ ì´ë¯¸ì§€ -->
        <div>
          <label class="block text-sm font-medium text-gray-700">ì˜ˆì‹œ ì´ë¯¸ì§€</label>
          <img src="{% static 'image/fandom_example.png' %}"
                alt="ì˜ˆì‹œ ì´ë¯¸ì§€"
                class="max-w-full h-auto rounded border shadow"
                style="max-height: 250px;" />
        </div>

        <!-- íŒ¬ë¤ ì„ íƒ -->
        <div>
          <label for="artist_id" class="block text-sm font-medium text-gray-700">íŒ¬ë¤ ì„ íƒ</label>
          <select name="artist_id" required class="w-full border rounded px-3 py-2 mt-1">
            {% for artist in artist_list %}
              <option value="{{ artist.id }}">{{ artist.display_name }}</option>
            {% endfor %}
          </select>
        </div>

        <!--ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
        <div>
          <label class="block text-sm font-medium text-gray-700">íšŒì›ì¹´ë“œ ìŠ¤í¬ë¦°ìƒ· ì—…ë¡œë“œ</label>
          <input type="file" name="fandom_card" id="fandom-card-input" accept="image/*"
                class="block w-full mt-1 border border-gray-300 rounded" required />
        </div>

        <!-- ë¯¸ë¦¬ë³´ê¸° -->
        <div id="fandom-card-preview-container" class="hidden mt-2">
          <label class="block text-xs text-gray-600">ë¯¸ë¦¬ë³´ê¸°</label>
          <img id="fandom-card-preview"
                src="#"
                class="max-w-full h-auto rounded border shadow"
                style="max-height: 250px;" />

        </div>

      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
            ì¸ì¦ ìš”ì²­
      </button>      
      </form>
    </div>


  </div>

  <!-- âœ… í•˜ë‹¨ ë²„íŠ¼ë“¤ -->
  <div class="mt-8 pt-6 border-t border-gray-200">
    <div class="flex space-x-3">
      <a href="{% url 'accounts:mypage' %}" 
         class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition text-center">
        â† ë§ˆì´í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°
      </a>
      <a href="{% url 'accounts:profile' user_profile.username %}" 
         class="flex-1 px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 transition text-center">
         ë‚´ ê³µê°œ í”„ë¡œí•„ ë³´ê¸° â†’
      </a>
    </div>
  </div>
</div>

<!-- âœ… JavaScript -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // âœ… ë‹‰ë„¤ì„ ìˆ˜ì •
    const nicknameDisplay = document.getElementById("nickname-display");
    const nicknameForm = document.getElementById("nickname-edit-form");
    const nicknameEditBtn = document.getElementById("edit-nickname-btn");
    const nicknameCancelBtn = document.getElementById("cancel-nickname-btn");

    // âœ… ì†Œê°œê¸€ ìˆ˜ì •
    const bioDisplay = document.getElementById("bio-display");
    const bioForm = document.getElementById("bio-edit-form");
    const bioEditBtn = document.getElementById("edit-bio-btn");
    const bioCancelBtn = document.getElementById("cancel-bio-btn");
    const bioTextarea = document.getElementById("new-bio");
    const bioCount = document.getElementById("bio-count");

    if (nicknameEditBtn && nicknameCancelBtn) {
      nicknameEditBtn.addEventListener("click", function () {
        nicknameDisplay.style.display = "none";
        nicknameForm.style.display = "block";
        document.getElementById("new-nickname").focus();
      });

      nicknameCancelBtn.addEventListener("click", function () {
        nicknameForm.style.display = "none";
        nicknameDisplay.style.display = "flex";
      });
    }

    if (bioEditBtn && bioCancelBtn) {
      bioEditBtn.addEventListener("click", function () {
        bioDisplay.style.display = "none";
        bioForm.style.display = "block";
        updateBioCount();
        bioTextarea.focus();
      });

      bioCancelBtn.addEventListener("click", function () {
        bioForm.style.display = "none";
        bioDisplay.style.display = "flex";
      });
    }

    function updateBioCount() {
      if (!bioTextarea || !bioCount) return;

      const currentLength = bioTextarea.value.length;
      bioCount.textContent = `${currentLength}/150`;

      if (currentLength > 150) {
        bioCount.classList.add('text-red-500');
        bioCount.classList.remove('text-gray-400');
        bioTextarea.value = bioTextarea.value.substring(0, 150);
        bioCount.textContent = '150/150';
      } else if (currentLength > 120) {
        bioCount.classList.add('text-yellow-600');
        bioCount.classList.remove('text-gray-400', 'text-red-500');
      } else {
        bioCount.classList.add('text-gray-400');
        bioCount.classList.remove('text-red-500', 'text-yellow-600');
      }
    }

    if (bioTextarea) {
      bioTextarea.addEventListener('input', updateBioCount);
      updateBioCount(); // ì´ˆê¸°ê°’
    }

    // âœ… ê³µì‹ íŒ¬ë¤ ì¸ì¦ ì´ë¯¸ì§€ ì—…ë¡œë“œ ë¯¸ë¦¬ë³´ê¸°
    const input = document.getElementById("fandom-card-input");
    const preview = document.getElementById("fandom-card-preview");
    const container = document.getElementById("fandom-card-preview-container");

    if (input) {
      input.addEventListener("change", function () {
        const file = this.files[0];
        if (file && file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = function (e) {
            preview.src = e.target.result;
            container.classList.remove("hidden");
          };
          reader.readAsDataURL(file);
        } else {
          container.classList.add("hidden");
        }
      });
    }
  });
</script>

{% endblock %}