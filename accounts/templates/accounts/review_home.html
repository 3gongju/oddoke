{% extends 'base.html' %}
{% load static %}
{% load custom_filters %} 
{% block body %}
<div class="max-w-4xl mx-auto px-4 py-10">
  <!-- 프로필 상단 - 닉네임만 표시 -->
  <div class="bg-white p-6 rounded-lg shadow mb-8">
    <a href="{% url 'accounts:profile' user_profile.username %}" 
      class="flex items-center hover:opacity-80 transition-opacity cursor-pointer no-underline">
      <img src="{{ user_profile.profile_image.url }}" 
          alt="프로필" 
          class="w-16 h-16 rounded-full object-cover mr-4">
      <div class="flex-1">
        <div class="flex items-center gap-3 mb-2">
          <h2 class="text-xl font-bold text-gray-800">
            {{ user_profile.username }}
          </h2>
          
          <!-- 신뢰덕 점수 뱃지 -->
          <span class="trust-score-badge {{ user_profile.trust_score_level }}">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            신뢰덕 {{ user_profile.trust_score }}점
          </span>
        </div>
        <p class="text-gray-600">신뢰덕 통계</p>
      </div>
    </a>
  </div>

  <!-- 리뷰 통계 영역 -->
  <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8">
    <div class="flex space-x-6 mb-8 border-b border-gray-100 pb-6">
      <h2 class="text-2xl font-bold text-gray-800 flex items-center">
        <svg class="w-6 h-6 text-gray-700 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z"/>
        </svg>
        신뢰덕 통계
      </h2>
    </div>

    <!-- 통계 카드들 -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      
      <!-- 전반적인 거래 만족도 -->
      <div class="stats-card rounded-xl p-6 animate-fadeInUp">
        <div class="flex items-center mb-4">
          <div class="icon-wrapper rating-color">
            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.006 5.404.434c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.434 2.082-5.005Z" clip-rule="evenodd"/>
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-gray-700">거래 만족도</h3>
        </div>
        <div id="rating-stats" class="space-y-3">
          <!-- 동적으로 생성됨 -->
        </div>
      </div>

      <!-- 상품 상태 일치 여부 -->
      <div class="stats-card rounded-xl p-6 animate-fadeInUp" style="animation-delay: 0.1s">
        <div class="flex items-center mb-4">
          <div class="icon-wrapper description-color">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 7.5l-9-5.25L3 7.5m18 0l-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9"/>
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-gray-700">상품 상태 일치도</h3>
        </div>
        <div id="description-stats" class="space-y-3">
          <!-- 동적으로 생성됨 -->
        </div>
      </div>

      <!-- 응답 속도 -->
      <div class="stats-card rounded-xl p-6 animate-fadeInUp" style="animation-delay: 0.2s">
        <div class="flex items-center mb-4">
          <div class="icon-wrapper response-color">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 0 1-2.555-.337A5.972 5.972 0 0 1 5.41 20.97a5.969 5.969 0 0 1-.474-.065 4.48 4.48 0 0 0 .978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25Z"/>
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-gray-700">응답 속도</h3>
        </div>
        <div id="response-stats" class="space-y-3">
          <!-- 동적으로 생성됨 -->
        </div>
      </div>

      <!-- 메시지 말투 -->
      <div class="stats-card rounded-xl p-6 animate-fadeInUp" style="animation-delay: 0.3s">
        <div class="flex items-center mb-4">
          <div class="icon-wrapper politeness-color">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.34 15.84c-.688-.06-1.386-.09-2.09-.09H7.5a4.5 4.5 0 1 1 0-9h.75c.704 0 1.402-.03 2.09-.09m0 9.18c.253.962.584 1.892.985 2.783.247.55.06 1.21-.463 1.511l-.657.38c-.551.318-1.26.117-1.527-.461a20.845 20.845 0 0 1-1.44-4.282m3.102.069a18.03 18.03 0 0 1-.59-4.59c0-1.586.205-3.124.59-4.59m0 9.18a23.848 23.848 0 0 1 8.835 2.535M10.34 6.66a23.847 23.847 0 0 0 8.835-2.535m0 0A23.74 23.74 0 0 0 18.795 3m.38 1.125a23.91 23.91 0 0 1 1.014 5.395m-1.014 8.855c-.118.38-.245.754-.38 1.125m.38-1.125a23.91 23.91 0 0 0 1.014-5.395m0-3.46c.495.413.811 1.035.811 1.73 0 .695-.316 1.317-.811 1.73m0-3.46a24.347 24.347 0 0 1 0 3.46"/>
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-gray-700">메시지 말투</h3>
        </div>
        <div id="politeness-stats" class="space-y-3">
          <!-- 동적으로 생성됨 -->
        </div>
      </div>

      <!-- 재거래 의사 -->
      <div class="stats-card rounded-xl p-6 animate-fadeInUp" style="animation-delay: 0.4s">
        <div class="flex items-center mb-4">
          <div class="icon-wrapper deal-color">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99"/>
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-gray-700">재거래 의사</h3>
        </div>
        <div id="deal-stats" class="space-y-3">
          <!-- 동적으로 생성됨 -->
        </div>
      </div>

      <!-- 전체 통계 요약 -->
      <div class="stats-card rounded-xl p-6 animate-fadeInUp" style="animation-delay: 0.5s">
        <div class="flex items-center mb-4">
          <div class="icon-wrapper bg-gradient-to-br from-gray-600 to-gray-800">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z"/>
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-gray-700">전체 통계</h3>
        </div>
        <div class="space-y-3">
          <div class="stats-item">
            <span class="stats-label">총 리뷰 수</span>
            <span class="stats-value" id="total-reviews">0</span>
          </div>
          <div class="stats-item">
            <span class="stats-label">평균 만족도</span>
            <span class="stats-value" id="avg-rating">0.0</span>
          </div>
          <div class="stats-item">
            <span class="stats-label">재거래 비율</span>
            <span class="stats-value" id="deal-rate">0%</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* 별점 스타일 */
  .star.active {
    color: #fbbf24 !important;
  }
  
  /* 라디오 버튼 숨기기 */
  input[type="radio"] {
    appearance: none;
    width: 16px;
    height: 16px;
    border: 2px solid #d1d5db;
    border-radius: 50%;
    position: relative;
    background: white;
    transition: all 0.2s ease;
  }
  
  input[type="radio"]:checked {
    border-color: #374151;
    background: #374151;
  }
  
  input[type="radio"]:checked::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: white;
  }
  
  /* 재거래 의사 버튼형 스타일 */
  input[type="radio"]:checked + .deal-button {
    border-color: #374151 !important;
    background: linear-gradient(135deg, #e5e7eb, #d1d5db) !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 25px rgba(55, 65, 81, 0.2) !important;
  }
  
  /* 호버 효과 강화 */
  label:hover input[type="radio"] {
    border-color: #6b7280;
  }

  /* 카드형 바 스타일 */
  .stats-card {
    background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
    border: 1px solid #e5e7eb;
    transition: all 0.3s ease;
  }

  .stats-card:hover {
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
  }

  /* 진행률 바 스타일 개선 */
  .progress-item {
    margin: 15px 0;
  }
  
  .progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  
  .progress-label {
    font-weight: 500;
    color: #374151;
    font-size: 14px;
  }
  
  .progress-value {
    font-weight: 600;
    color: #1f2937;
    font-size: 14px;
  }
  
  .progress-bar {
    width: 100%;
    height: 18px;
    background: #f3f4f6;
    border-radius: 9px;
    overflow: hidden;
    position: relative;
  }
  
  .progress-fill {
    height: 100%;
    border-radius: 9px;
    transition: all 0.8s ease;
    position: relative;
  }

  /* Legacy stats-bar 스타일 (호환성을 위해 유지) */
  .stats-bar {
    height: 8px;
    background: #f3f4f6;
    border-radius: 4px;
    overflow: hidden;
    position: relative;
  }

  .stats-bar-fill {
    height: 100%;
    background: linear-gradient(135deg, #374151, #1f2937);
    border-radius: 4px;
    transition: width 0.8s ease-out;
  }

  .stats-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f3f4f6;
  }

  .stats-item:last-child {
    border-bottom: none;
  }

  .stats-label {
    font-weight: 500;
    color: #374151;
    font-size: 14px;
  }

  .stats-value {
    font-weight: 700;
    color: #1f2937;
    font-size: 16px;
  }

  /* 아이콘 스타일 */
  .icon-wrapper {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    margin-right: 12px;
  }

  /* 검정색 계열로 통일된 색상 */
  .rating-color { background: linear-gradient(135deg, #4b5563, #374151); }
  .description-color { background: linear-gradient(135deg, #6b7280, #4b5563); }
  .response-color { background: linear-gradient(135deg, #374151, #1f2937); }
  .politeness-color { background: linear-gradient(135deg, #6b7280, #374151); }
  .deal-color { background: linear-gradient(135deg, #4b5563, #1f2937); }

  /* 모든 차트별 진행률 바를 검정색 계열로 통일 */
  .rating-fill {
    background: linear-gradient(90deg, #4b5563, #374151);
  }
  
  .description-fill {
    background: linear-gradient(90deg, #6b7280, #4b5563);
  }
  
  .response-fill {
    background: linear-gradient(90deg, #374151, #1f2937);
  }
  
  .politeness-fill {
    background: linear-gradient(90deg, #6b7280, #374151);
  }
  
  .deal-again-fill {
    background: linear-gradient(90deg, #4b5563, #1f2937);
  }

  /* Legacy 바 색상도 검정색 계열로 변경 */
  .bar-rating { background: linear-gradient(135deg, #4b5563, #374151); }
  .bar-description { background: linear-gradient(135deg, #6b7280, #4b5563); }
  .bar-response { background: linear-gradient(135deg, #374151, #1f2937); }
  .bar-politeness { background: linear-gradient(135deg, #6b7280, #374151); }
  .bar-deal { background: linear-gradient(135deg, #4b5563, #1f2937); }

  /* 빈 상태 스타일 */
  .empty-state {
    text-align: center;
    color: #9ca3af;
    font-size: 16px;
    padding: 40px 0;
  }

  /* 애니메이션 */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fadeInUp {
    animation: fadeInUp 0.6s ease-out;
  }
</style>

<script>
// Django 템플릿에서 JavaScript로 데이터 전달
const chartData = {
  rating: {{ rating_counter|safe }},
  description: {{ description_counter|safe }},
  response: {{ response_counter|safe }},
  politeness: {{ politeness_counter|safe }},
  deal_again: {{ deal_again_counter|safe }}
};

// 라벨 포맷팅 함수
function formatLabel(label) {
  if (label === 'O') return getIconForLabel('O');
  if (label === 'X') return getIconForLabel('X');
  if (label === '1') return getIconForLabel('1');
  if (label === '2') return getIconForLabel('2');
  if (label === '3') return getIconForLabel('3');
  if (label === '4') return getIconForLabel('4');
  if (label === '5') return getIconForLabel('5');
  return label;
}

// 라벨에 SVG 아이콘을 추가하는 함수 - 검정색 계열로 수정
function getIconForLabel(label) {
  if (label === 'O') {
    return '<svg class="w-4 h-4 inline mr-1 text-gray-700" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M7.502 6h7.128A3.375 3.375 0 0 1 18 9.375v9.375a3 3 0 0 0 3-3V6.108c0-1.505-1.125-2.811-2.664-2.94a48.972 48.972 0 0 0-.673-.05A3 3 0 0 0 15 1.5h-1.5a3 3 0 0 0-2.663 1.618c-.225.015-.45.032-.673.05C8.662 3.295 7.554 4.542 7.502 6ZM13.5 3A1.5 1.5 0 0 0 12 4.5h4.5A1.5 1.5 0 0 0 15 3h-1.5Z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M3 9.375C3 8.339 3.84 7.5 4.875 7.5h9.75c1.036 0 1.875.84 1.875 1.875v11.25c0 1.035-.84 1.875-1.875 1.875h-9.75A1.875 1.875 0 0 1 3 20.625V9.375ZM9.586 4l4.33 4.33a.75.75 0 1 1-1.061 1.06L9.525 6.06a.75.75 0 0 1 .061-1.06Z" clip-rule="evenodd"/></svg> 예';
  }
  if (label === 'X') {
    return '<svg class="w-4 h-4 inline mr-1 text-gray-700" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd"/></svg> 아니오';
  }
  if (label === '1') return '<svg class="w-4 h-4 inline mr-1 text-gray-700" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.006 5.404.434c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.434 2.082-5.005Z" clip-rule="evenodd"/></svg> 1점';
  if (label === '2') return '<svg class="w-4 h-4 inline mr-1 text-gray-700" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.006 5.404.434c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.434 2.082-5.005Z" clip-rule="evenodd"/></svg> 2점';
  if (label === '3') return '<svg class="w-4 h-4 inline mr-1 text-gray-700" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.006 5.404.434c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.434 2.082-5.005Z" clip-rule="evenodd"/></svg> 3점';
  if (label === '4') return '<svg class="w-4 h-4 inline mr-1 text-gray-700" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.006 5.404.434c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.434 2.082-5.005Z" clip-rule="evenodd"/></svg> 4점';
  if (label === '5') return '<svg class="w-4 h-4 inline mr-1 text-gray-700" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.006 5.404.434c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.434 2.082-5.005Z" clip-rule="evenodd"/></svg> 5점';
  return label;
}

// 진행률 바 차트 그리기 함수 (개선된 버전)
function drawProgressChart(containerId, data, chartType) {
  const container = document.getElementById(containerId);
  
  // 컨테이너 클리어
  container.innerHTML = '';
  
  // 데이터 처리
  const labels = Object.keys(data);
  const values = Object.values(data);
  const maxValue = Math.max(...values, 1);
  const totalValue = values.reduce((sum, val) => sum + val, 0);
  
  if (labels.length === 0 || totalValue === 0) {
    // 데이터가 없을 때
    container.innerHTML = `
      <div class="empty-state">
        <svg class="w-12 h-12 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z"/>
        </svg>
        <p>아직 리뷰가 없습니다</p>
      </div>
    `;
    return;
  }
  
  // 각 항목에 대해 진행률 바 생성
  labels.forEach((label, index) => {
    const value = values[index];
    const percentage = (value / maxValue) * 100;
    const totalPercentage = totalValue > 0 ? (value / totalValue * 100) : 0;
    
    const progressItem = document.createElement('div');
    progressItem.className = 'progress-item';
    
    const progressHeader = document.createElement('div');
    progressHeader.className = 'progress-header';
    
    const progressLabel = document.createElement('div');
    progressLabel.className = 'progress-label';
    progressLabel.innerHTML = formatLabel(label);
    
    const progressValue = document.createElement('div');
    progressValue.className = 'progress-value';
    progressValue.textContent = value + '명';
    
    progressHeader.appendChild(progressLabel);
    progressHeader.appendChild(progressValue);
    
    const progressBar = document.createElement('div');
    progressBar.className = 'progress-bar';
    
    const progressFill = document.createElement('div');
    progressFill.className = `progress-fill ${chartType}-fill`;
    progressFill.style.width = '0%'; // 애니메이션을 위해 0%로 시작
    
    // 퍼센티지 표시 추가
    const percentageText = document.createElement('div');
    percentageText.className = 'text-xs text-gray-500 mt-1 text-right';
    percentageText.textContent = totalPercentage.toFixed(1) + '%';
    
    progressBar.appendChild(progressFill);
    progressItem.appendChild(progressHeader);
    progressItem.appendChild(progressBar);
    progressItem.appendChild(percentageText);
    container.appendChild(progressItem);
    
    // 애니메이션 효과
    setTimeout(() => {
      progressFill.style.width = percentage + '%';
    }, 100 * (index + 1));
  });
}

// 전체 통계 계산 함수
function updateOverallStats() {
  const ratingValues = Object.values(chartData.rating);
  const totalRatingReviews = ratingValues.reduce((sum, val) => sum + val, 0);
  
  // 전체 리뷰 수 (가장 많은 카테고리 기준)
  const allTotals = [
    Object.values(chartData.rating).reduce((sum, val) => sum + val, 0),
    Object.values(chartData.description).reduce((sum, val) => sum + val, 0),
    Object.values(chartData.response).reduce((sum, val) => sum + val, 0),
    Object.values(chartData.politeness).reduce((sum, val) => sum + val, 0),
    Object.values(chartData.deal_again).reduce((sum, val) => sum + val, 0)
  ];
  const totalReviews = Math.max(...allTotals);
  
  // 평균 만족도 계산
  let weightedSum = 0;
  Object.entries(chartData.rating).forEach(([rating, count]) => {
    weightedSum += parseInt(rating) * count;
  });
  const avgRating = totalRatingReviews > 0 ? (weightedSum / totalRatingReviews).toFixed(1) : '0.0';
  
  // 재거래 비율 계산
  const dealYes = chartData.deal_again['O'] || 0;
  const dealTotal = Object.values(chartData.deal_again).reduce((sum, val) => sum + val, 0);
  const dealRate = dealTotal > 0 ? ((dealYes / dealTotal) * 100).toFixed(1) : '0.0';
  
  document.getElementById('total-reviews').textContent = totalReviews + '건';
  document.getElementById('avg-rating').textContent = avgRating + '점';
  document.getElementById('deal-rate').textContent = dealRate + '%';
}

// 페이지 로드 후 실행
document.addEventListener('DOMContentLoaded', function() {
  // 각 카드 생성 (개선된 진행률 바 사용)
  drawProgressChart('rating-stats', chartData.rating, 'rating');
  drawProgressChart('description-stats', chartData.description, 'description');
  drawProgressChart('response-stats', chartData.response, 'response');
  drawProgressChart('politeness-stats', chartData.politeness, 'politeness');
  drawProgressChart('deal-stats', chartData.deal_again, 'deal-again');
  
  // 전체 통계 업데이트
  updateOverallStats();
  
  // 반응형 처리
  window.addEventListener('resize', function() {
    setTimeout(() => {
      drawProgressChart('rating-stats', chartData.rating, 'rating');
      drawProgressChart('description-stats', chartData.description, 'description');
      drawProgressChart('response-stats', chartData.response, 'response');
      drawProgressChart('politeness-stats', chartData.politeness, 'politeness');
      drawProgressChart('deal-stats', chartData.deal_again, 'deal-again');
    }, 100);
  });
});

// 별점 기능 (기존 코드 유지) - 검정색 계열로 수정
const stars = document.querySelectorAll('.star');
const ratingInput = document.querySelector('input[name="rating"]');
const ratingText = document.getElementById('rating-text');

const ratingTexts = {
  1: '<svg class="w-5 h-5 inline mr-1 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.182 16.318A4.486 4.486 0 0 0 12.016 15a4.486 4.486 0 0 0-3.198 1.318M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0ZM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75 9.168 9 9.375 9s.375.336.375.75Zm-.375 0h.008v.015h-.008V9.75Zm5.625 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75Zm-.375 0h.008v.015h-.008V9.75Z"/></svg> 별로예요 (1점)',
  2: '<svg class="w-5 h-5 inline mr-1 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.182 16.318A4.486 4.486 0 0 0 12.016 15a4.486 4.486 0 0 0-3.198 1.318M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0ZM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75 9.168 9 9.375 9s.375.336.375.75Zm-.375 0h.008v.015h-.008V9.75Zm5.625 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75Zm-.375 0h.008v.015h-.008V9.75Z"/></svg> 아쉬워요 (2점)', 
  3: '<svg class="w-5 h-5 inline mr-1 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0ZM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75 9.168 9 9.375 9s.375.336.375.75Zm-.375 0h.008v.015h-.008V9.75Zm5.625 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75Zm-.375 0h.008v.015h-.008V9.75Z"/></svg> 보통이에요 (3점)',
  4: '<svg class="w-5 h-5 inline mr-1 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.182 15.182a4.5 4.5 0 0 1-6.364 0M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0ZM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75 9.168 9 9.375 9s.375.336.375.75Zm-.375 0h.008v.015h-.008V9.75Zm5.625 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75Zm-.375 0h.008v.015h-.008V9.75Z"/></svg> 좋아요! (4점)',
  5: '<svg class="w-5 h-5 inline mr-1 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.182 15.182a4.5 4.5 0 0 1-6.364 0M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0ZM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75 9.168 9 9.375 9s.375.336.375.75Zm-.375 0h.008v.015h-.008V9.75Zm5.625 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75Zm-.375 0h.008v.015h-.008V9.75Z"/></svg> 최고예요! (5점)'
};

if (stars.length > 0) {
  stars.forEach((star, index) => {
    star.addEventListener('click', (e) => {
      e.preventDefault();
      const rating = index + 1;
      
      if (ratingInput) ratingInput.value = rating;
      
      stars.forEach((s, i) => {
        if (i <= index) {
          s.classList.add('active');
        } else {
          s.classList.remove('active');
        }
      });
      
      if (ratingText) {
        ratingText.innerHTML = ratingTexts[rating];
      }
    });
    
    star.addEventListener('mouseenter', () => {
      stars.forEach((s, i) => {
        if (i <= index) {
          s.style.color = '#374151';
        } else {
          s.style.color = '#d1d5db';
        }
      });
    });
  });
}

const ratingStarsContainer = document.querySelector('.rating-stars');
if (ratingStarsContainer) {
  ratingStarsContainer.addEventListener('mouseleave', () => {
    stars.forEach((s, i) => {
      if (s.classList.contains('active')) {
        s.style.color = '#374151';
      } else {
        s.style.color = '#d1d5db';
      }
    });
  });
}

const form = document.getElementById('reviewForm');
if (form) {
  form.addEventListener('submit', (e) => {
    const ratingInput = document.querySelector('input[name="rating"]');
    if (ratingInput && !ratingInput.value) {
      e.preventDefault();
      alert('별점을 선택해주세요!');
      const ratingContainer = document.querySelector('.rating-stars');
      if (ratingContainer) {
        ratingContainer.scrollIntoView({ behavior: 'smooth' });
      }
    }
  });
}

function showTab(tab) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
  const tabContent = document.getElementById('tab-' + tab);
  if (tabContent) tabContent.classList.remove('hidden');

  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('text-blue-600', 'font-semibold', 'border-b-2', 'border-blue-500');
    btn.classList.add('text-gray-500');
  });
  
  if (event && event.target) {
    event.target.classList.add('text-blue-600', 'font-semibold', 'border-b-2', 'border-blue-500');
    event.target.classList.remove('text-gray-500');
  }
}
</script>
{% endblock %}