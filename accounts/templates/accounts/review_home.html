{% extends 'base.html' %}
{% load static %}
{% load custom_filters %} 
{% block body %}
<div class="max-w-4xl mx-auto px-4 py-10">
  <!-- âœ… í”„ë¡œí•„ ìƒë‹¨ - ë‹‰ë„¤ì„ë§Œ í‘œì‹œ -->
  <div class="bg-white p-6 rounded-lg shadow mb-8">
    <div class="flex items-center">
      <img src="{{ user_profile.profile_image.url }}" alt="í”„ë¡œí•„" class="w-16 h-16 rounded-full object-cover mr-4">
      <div>
        <h2 class="text-xl font-bold text-gray-800">
          {% if user_profile.first_name %}
            {{ user_profile.first_name }}
          {% elif user_profile.last_name %}
            {{ user_profile.last_name }}  
          {% elif user_profile.username|length > 20 %}
            ë‹‰ë„¤ì„ ë¯¸ì„¤ì •
          {% else %}
            {{ user_profile.username }}
          {% endif %}
        </h2>
        <p class="text-gray-600">ë§¤ë„ˆ ë¦¬ë·° í†µê³„</p>
      </div>
    </div>
  </div>

  <!-- âœ… ë¦¬ë·° í†µê³„ ì˜ì—­ -->
  <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8">
    <div class="flex space-x-6 mb-8 border-b border-gray-100 pb-6">
      <h2 class="text-2xl font-bold text-gray-800 flex items-center">
        <span class="text-blue-500 mr-2">ğŸ“Š</span>
        ë§¤ë„ˆ ë¦¬ë·° í†µê³„
      </h2>
    </div>

    <!-- í†µê³„ ì¹´ë“œë“¤ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      
      <!-- ì „ë°˜ì ì¸ ê±°ë˜ ë§Œì¡±ë„ -->
      <div class="stats-card rounded-xl p-6 animate-fadeInUp">
        <div class="flex items-center mb-4">
          <div class="icon-wrapper rating-color">â­</div>
          <h3 class="text-lg font-semibold text-gray-700">ê±°ë˜ ë§Œì¡±ë„</h3>
        </div>
        <div id="rating-stats" class="space-y-3">
          <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
        </div>
      </div>

      <!-- ìƒí’ˆ ìƒíƒœ ì¼ì¹˜ ì—¬ë¶€ -->
      <div class="stats-card rounded-xl p-6 animate-fadeInUp" style="animation-delay: 0.1s">
        <div class="flex items-center mb-4">
          <div class="icon-wrapper description-color">ğŸ“¦</div>
          <h3 class="text-lg font-semibold text-gray-700">ìƒí’ˆ ìƒíƒœ ì¼ì¹˜ë„</h3>
        </div>
        <div id="description-stats" class="space-y-3">
          <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
        </div>
      </div>

      <!-- ì‘ë‹µ ì†ë„ -->
      <div class="stats-card rounded-xl p-6 animate-fadeInUp" style="animation-delay: 0.2s">
        <div class="flex items-center mb-4">
          <div class="icon-wrapper response-color">ğŸ’¬</div>
          <h3 class="text-lg font-semibold text-gray-700">ì‘ë‹µ ì†ë„</h3>
        </div>
        <div id="response-stats" class="space-y-3">
          <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
        </div>
      </div>

      <!-- ë©”ì‹œì§€ ë§íˆ¬ -->
      <div class="stats-card rounded-xl p-6 animate-fadeInUp" style="animation-delay: 0.3s">
        <div class="flex items-center mb-4">
          <div class="icon-wrapper politeness-color">ğŸ—£ï¸</div>
          <h3 class="text-lg font-semibold text-gray-700">ë©”ì‹œì§€ ë§íˆ¬</h3>
        </div>
        <div id="politeness-stats" class="space-y-3">
          <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
        </div>
      </div>

      <!-- ì¬ê±°ë˜ ì˜ì‚¬ -->
      <div class="stats-card rounded-xl p-6 animate-fadeInUp" style="animation-delay: 0.4s">
        <div class="flex items-center mb-4">
          <div class="icon-wrapper deal-color">ğŸ”„</div>
          <h3 class="text-lg font-semibold text-gray-700">ì¬ê±°ë˜ ì˜ì‚¬</h3>
        </div>
        <div id="deal-stats" class="space-y-3">
          <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
        </div>
      </div>

      <!-- ì „ì²´ í†µê³„ ìš”ì•½ -->
      <div class="stats-card rounded-xl p-6 animate-fadeInUp" style="animation-delay: 0.5s">
        <div class="flex items-center mb-4">
          <div class="icon-wrapper bg-gradient-to-br from-gray-200 to-gray-400">ğŸ“ˆ</div>
          <h3 class="text-lg font-semibold text-gray-700">ì „ì²´ í†µê³„</h3>
        </div>
        <div class="space-y-3">
          <div class="stats-item">
            <span class="stats-label">ì´ ë¦¬ë·° ìˆ˜</span>
            <span class="stats-value" id="total-reviews">0</span>
          </div>
          <div class="stats-item">
            <span class="stats-label">í‰ê·  ë§Œì¡±ë„</span>
            <span class="stats-value" id="avg-rating">0.0</span>
          </div>
          <div class="stats-item">
            <span class="stats-label">ì¬ê±°ë˜ ë¹„ìœ¨</span>
            <span class="stats-value" id="deal-rate">0%</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* ë³„ì  ìŠ¤íƒ€ì¼ */
  .star.active {
    color: #fbbf24 !important;
  }
  
  /* ë¼ë””ì˜¤ ë²„íŠ¼ ìˆ¨ê¸°ê¸° */
  input[type="radio"] {
    appearance: none;
    width: 16px;
    height: 16px;
    border: 2px solid #d1d5db;
    border-radius: 50%;
    position: relative;
    background: white;
    transition: all 0.2s ease;
  }
  
  input[type="radio"]:checked {
    border-color: #3b82f6;
    background: #3b82f6;
  }
  
  input[type="radio"]:checked::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: white;
  }
  
  /* ì¬ê±°ë˜ ì˜ì‚¬ ë²„íŠ¼í˜• ìŠ¤íƒ€ì¼ */
  input[type="radio"]:checked + .deal-button {
    border-color: #10b981 !important;
    background: linear-gradient(135deg, #d1fae5, #a7f3d0) !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.2) !important;
  }
  
  /* í˜¸ë²„ íš¨ê³¼ ê°•í™” */
  label:hover input[type="radio"] {
    border-color: #6b7280;
  }

  /* ì¹´ë“œí˜• ë°” ìŠ¤íƒ€ì¼ */
  .stats-card {
    background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
    border: 1px solid #e5e7eb;
    transition: all 0.3s ease;
  }

  .stats-card:hover {
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
  }

  /* ì§„í–‰ë¥  ë°” ìŠ¤íƒ€ì¼ ê°œì„  */
  .progress-item {
    margin: 15px 0;
  }
  
  .progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  
  .progress-label {
    font-weight: 500;
    color: #374151;
    font-size: 14px;
  }
  
  .progress-value {
    font-weight: 600;
    color: #1f2937;
    font-size: 14px;
  }
  
  .progress-bar {
    width: 100%;
    height: 18px;
    background: #f3f4f6;
    border-radius: 9px;
    overflow: hidden;
    position: relative;
  }
  
  .progress-fill {
    height: 100%;
    border-radius: 9px;
    transition: all 0.8s ease;
    position: relative;
  }

  /* Legacy stats-bar ìŠ¤íƒ€ì¼ (í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€) */
  .stats-bar {
    height: 8px;
    background: #f3f4f6;
    border-radius: 4px;
    overflow: hidden;
    position: relative;
  }

  .stats-bar-fill {
    height: 100%;
    background: linear-gradient(135deg, #3b82f6, #1e40af);
    border-radius: 4px;
    transition: width 0.8s ease-out;
  }

  .stats-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f3f4f6;
  }

  .stats-item:last-child {
    border-bottom: none;
  }

  .stats-label {
    font-weight: 500;
    color: #374151;
    font-size: 14px;
  }

  .stats-value {
    font-weight: 700;
    color: #1f2937;
    font-size: 16px;
  }

  /* ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
  .icon-wrapper {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    margin-right: 12px;
  }

  /* ê° ì„¹ì…˜ë³„ ìƒ‰ìƒ */
  .rating-color { background: linear-gradient(135deg, #fef3c7, #fbbf24); }
  .description-color { background: linear-gradient(135deg, #d1fae5, #10b981); }
  .response-color { background: linear-gradient(135deg, #dbeafe, #3b82f6); }
  .politeness-color { background: linear-gradient(135deg, #e9d5ff, #8b5cf6); }
  .deal-color { background: linear-gradient(135deg, #fed7aa, #f97316); }

  /* ê° ì°¨íŠ¸ë³„ ì§„í–‰ë¥  ë°” ìƒ‰ìƒ */
  .rating-fill {
    background: linear-gradient(90deg, #f59e0b, #d97706);
  }
  
  .description-fill {
    background: linear-gradient(90deg, #10b981, #059669);
  }
  
  .response-fill {
    background: linear-gradient(90deg, #3b82f6, #1d4ed8);
  }
  
  .politeness-fill {
    background: linear-gradient(90deg, #8b5cf6, #7c3aed);
  }
  
  .deal-again-fill {
    background: linear-gradient(90deg, #ef4444, #dc2626);
  }

  /* Legacy ë°” ìƒ‰ìƒ */
  .bar-rating { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
  .bar-description { background: linear-gradient(135deg, #10b981, #059669); }
  .bar-response { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
  .bar-politeness { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
  .bar-deal { background: linear-gradient(135deg, #f97316, #ea580c); }

  /* ë¹ˆ ìƒíƒœ ìŠ¤íƒ€ì¼ */
  .empty-state {
    text-align: center;
    color: #9ca3af;
    font-size: 16px;
    padding: 40px 0;
  }

  /* ì• ë‹ˆë©”ì´ì…˜ */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fadeInUp {
    animation: fadeInUp 0.6s ease-out;
  }
</style>

<script>
// Django í…œí”Œë¦¿ì—ì„œ JavaScriptë¡œ ë°ì´í„° ì „ë‹¬
const chartData = {
  rating: {{ rating_counter|safe }},
  description: {{ description_counter|safe }},
  response: {{ response_counter|safe }},
  politeness: {{ politeness_counter|safe }},
  deal_again: {{ deal_again_counter|safe }}
};

// ë¼ë²¨ í¬ë§·íŒ… í•¨ìˆ˜
function formatLabel(label) {
  if (label === 'O') return 'ğŸ‘ ì˜ˆ';
  if (label === 'X') return 'ğŸ‘ ì•„ë‹ˆì˜¤';
  if (label === '1') return 'â­ 1ì ';
  if (label === '2') return 'â­â­ 2ì ';
  if (label === '3') return 'â­â­â­ 3ì ';
  if (label === '4') return 'â­â­â­â­ 4ì ';
  if (label === '5') return 'â­â­â­â­â­ 5ì ';
  return label;
}

// ì§„í–‰ë¥  ë°” ì°¨íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜ (ê°œì„ ëœ ë²„ì „)
function drawProgressChart(containerId, data, chartType) {
  const container = document.getElementById(containerId);
  
  // ì»¨í…Œì´ë„ˆ í´ë¦¬ì–´
  container.innerHTML = '';
  
  // ë°ì´í„° ì²˜ë¦¬
  const labels = Object.keys(data);
  const values = Object.values(data);
  const maxValue = Math.max(...values, 1);
  const totalValue = values.reduce((sum, val) => sum + val, 0);
  
  if (labels.length === 0 || totalValue === 0) {
    // ë°ì´í„°ê°€ ì—†ì„ ë•Œ
    container.innerHTML = `
      <div class="empty-state">
        <div class="text-4xl mb-2">ğŸ“Š</div>
        <p>ì•„ì§ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
      </div>
    `;
    return;
  }
  
  // ê° í•­ëª©ì— ëŒ€í•´ ì§„í–‰ë¥  ë°” ìƒì„±
  labels.forEach((label, index) => {
    const value = values[index];
    const percentage = (value / maxValue) * 100;
    const totalPercentage = totalValue > 0 ? (value / totalValue * 100) : 0;
    
    const progressItem = document.createElement('div');
    progressItem.className = 'progress-item';
    
    const progressHeader = document.createElement('div');
    progressHeader.className = 'progress-header';
    
    const progressLabel = document.createElement('div');
    progressLabel.className = 'progress-label';
    progressLabel.textContent = formatLabel(label);
    
    const progressValue = document.createElement('div');
    progressValue.className = 'progress-value';
    progressValue.textContent = value + 'ëª…';
    
    progressHeader.appendChild(progressLabel);
    progressHeader.appendChild(progressValue);
    
    const progressBar = document.createElement('div');
    progressBar.className = 'progress-bar';
    
    const progressFill = document.createElement('div');
    progressFill.className = `progress-fill ${chartType}-fill`;
    progressFill.style.width = '0%'; // ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•´ 0%ë¡œ ì‹œì‘
    
    // í¼ì„¼í‹°ì§€ í‘œì‹œ ì¶”ê°€
    const percentageText = document.createElement('div');
    percentageText.className = 'text-xs text-gray-500 mt-1 text-right';
    percentageText.textContent = totalPercentage.toFixed(1) + '%';
    
    progressBar.appendChild(progressFill);
    progressItem.appendChild(progressHeader);
    progressItem.appendChild(progressBar);
    progressItem.appendChild(percentageText);
    container.appendChild(progressItem);
    
    // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
    setTimeout(() => {
      progressFill.style.width = percentage + '%';
    }, 100 * (index + 1));
  });
}

// ì „ì²´ í†µê³„ ê³„ì‚° í•¨ìˆ˜
function updateOverallStats() {
  const ratingValues = Object.values(chartData.rating);
  const totalRatingReviews = ratingValues.reduce((sum, val) => sum + val, 0);
  
  // ì „ì²´ ë¦¬ë·° ìˆ˜ (ê°€ì¥ ë§ì€ ì¹´í…Œê³ ë¦¬ ê¸°ì¤€)
  const allTotals = [
    Object.values(chartData.rating).reduce((sum, val) => sum + val, 0),
    Object.values(chartData.description).reduce((sum, val) => sum + val, 0),
    Object.values(chartData.response).reduce((sum, val) => sum + val, 0),
    Object.values(chartData.politeness).reduce((sum, val) => sum + val, 0),
    Object.values(chartData.deal_again).reduce((sum, val) => sum + val, 0)
  ];
  const totalReviews = Math.max(...allTotals);
  
  // í‰ê·  ë§Œì¡±ë„ ê³„ì‚°
  let weightedSum = 0;
  Object.entries(chartData.rating).forEach(([rating, count]) => {
    weightedSum += parseInt(rating) * count;
  });
  const avgRating = totalRatingReviews > 0 ? (weightedSum / totalRatingReviews).toFixed(1) : '0.0';
  
  // ì¬ê±°ë˜ ë¹„ìœ¨ ê³„ì‚°
  const dealYes = chartData.deal_again['O'] || 0;
  const dealTotal = Object.values(chartData.deal_again).reduce((sum, val) => sum + val, 0);
  const dealRate = dealTotal > 0 ? ((dealYes / dealTotal) * 100).toFixed(1) : '0.0';
  
  document.getElementById('total-reviews').textContent = totalReviews + 'ê±´';
  document.getElementById('avg-rating').textContent = avgRating + 'ì ';
  document.getElementById('deal-rate').textContent = dealRate + '%';
}

// í˜ì´ì§€ ë¡œë“œ í›„ ì‹¤í–‰
document.addEventListener('DOMContentLoaded', function() {
  // ê° ì¹´ë“œ ìƒì„± (ê°œì„ ëœ ì§„í–‰ë¥  ë°” ì‚¬ìš©)
  drawProgressChart('rating-stats', chartData.rating, 'rating');
  drawProgressChart('description-stats', chartData.description, 'description');
  drawProgressChart('response-stats', chartData.response, 'response');
  drawProgressChart('politeness-stats', chartData.politeness, 'politeness');
  drawProgressChart('deal-stats', chartData.deal_again, 'deal-again');
  
  // ì „ì²´ í†µê³„ ì—…ë°ì´íŠ¸
  updateOverallStats();
  
  // ë°˜ì‘í˜• ì²˜ë¦¬
  window.addEventListener('resize', function() {
    setTimeout(() => {
      drawProgressChart('rating-stats', chartData.rating, 'rating');
      drawProgressChart('description-stats', chartData.description, 'description');
      drawProgressChart('response-stats', chartData.response, 'response');
      drawProgressChart('politeness-stats', chartData.politeness, 'politeness');
      drawProgressChart('deal-stats', chartData.deal_again, 'deal-again');
    }, 100);
  });
});

// ë³„ì  ê¸°ëŠ¥ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
const stars = document.querySelectorAll('.star');
const ratingInput = document.querySelector('input[name="rating"]');
const ratingText = document.getElementById('rating-text');

const ratingTexts = {
  1: 'ğŸ˜ ë³„ë¡œì˜ˆìš” (1ì )',
  2: 'ğŸ™ ì•„ì‰¬ì›Œìš” (2ì )', 
  3: 'ğŸ˜ ë³´í†µì´ì—ìš” (3ì )',
  4: 'ğŸ˜Š ì¢‹ì•„ìš”! (4ì )',
  5: 'ğŸ¤© ìµœê³ ì˜ˆìš”! (5ì )'
};

if (stars.length > 0) {
  stars.forEach((star, index) => {
    star.addEventListener('click', (e) => {
      e.preventDefault();
      const rating = index + 1;
      
      if (ratingInput) ratingInput.value = rating;
      
      stars.forEach((s, i) => {
        if (i <= index) {
          s.classList.add('active');
        } else {
          s.classList.remove('active');
        }
      });
      
      if (ratingText) {
        ratingText.textContent = ratingTexts[rating];
      }
    });
    
    star.addEventListener('mouseenter', () => {
      stars.forEach((s, i) => {
        if (i <= index) {
          s.style.color = '#fbbf24';
        } else {
          s.style.color = '#d1d5db';
        }
      });
    });
  });
}

const ratingStarsContainer = document.querySelector('.rating-stars');
if (ratingStarsContainer) {
  ratingStarsContainer.addEventListener('mouseleave', () => {
    stars.forEach((s, i) => {
      if (s.classList.contains('active')) {
        s.style.color = '#fbbf24';
      } else {
        s.style.color = '#d1d5db';
      }
    });
  });
}

const form = document.getElementById('reviewForm');
if (form) {
  form.addEventListener('submit', (e) => {
    const ratingInput = document.querySelector('input[name="rating"]');
    if (ratingInput && !ratingInput.value) {
      e.preventDefault();
      alert('ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
      const ratingContainer = document.querySelector('.rating-stars');
      if (ratingContainer) {
        ratingContainer.scrollIntoView({ behavior: 'smooth' });
      }
    }
  });
}

function showTab(tab) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
  const tabContent = document.getElementById('tab-' + tab);
  if (tabContent) tabContent.classList.remove('hidden');

  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('text-blue-600', 'font-semibold', 'border-b-2', 'border-blue-500');
    btn.classList.add('text-gray-500');
  });
  
  if (event && event.target) {
    event.target.classList.add('text-blue-600', 'font-semibold', 'border-b-2', 'border-blue-500');
    event.target.classList.remove('text-gray-500');
  }
}
</script>
{% endblock %}