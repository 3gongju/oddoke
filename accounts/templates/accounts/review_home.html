{% extends 'base.html' %}
{% load static %}
{% load custom_filters %} 
{% block body %}
<div class="max-w-4xl mx-auto px-4 py-10">
  <!-- ✅ 프로필 상단 - 닉네임만 표시 -->
  <div class="bg-white p-6 rounded-lg shadow mb-8">
    <div class="flex items-center">
      <img src="{{ user_profile.profile_image.url }}" alt="프로필" class="w-16 h-16 rounded-full object-cover mr-4">
      <div>
        <h2 class="text-xl font-bold">
          {% if user_profile.first_name %}
            {{ user_profile.first_name }}
          {% elif user_profile.last_name %}
            {{ user_profile.last_name }}  
          {% elif user_profile.username|length > 20 %}
            닉네임 미설정
          {% else %}
            {{ user_profile.username }}
          {% endif %}
        </h2>
      </div>
    </div>
  </div>

  <!-- ✅ 리뷰 탭 영역 -->
  <div class="bg-white rounded-lg shadow p-6">
    <div class="flex space-x-6 mb-4 border-b pb-2">
      <!-- <button class="tab-btn text-blue-600 font-semibold border-b-2 border-blue-500" onclick="showTab('write')">리뷰 쓰기</button> -->
      <h2 class="text-lg font-semibold text-gray-800">📊 매너 리뷰 통계</h2>
    </div>

    
    <!-- 내 리뷰 보기 영역 -->
    <!-- 📊 전반적인 거래 만족도 -->
    <div class="mb-6">
      <h3 class="text-base font-semibold text-gray-700 mb-2">전반적인 거래 만족도</h3>
      {% for label, count in rating_counter.items %}
        {% with max=max_counts.rating %}
        {% with width=count|percentage:max %}
        <div class="flex items-center mb-2">
          <span class="w-48 text-sm text-gray-800">{{ label }}점</span>
          <div class="flex-1 h-3 bg-gray-200 rounded ml-2 relative overflow-hidden">
            <div style="width:{{ width }}%; background-color:{{ count|bar_shade_by_count }};"></div>
          </div>
          <span class="ml-2 text-sm text-gray-500">{{ count }}명</span>
        </div>
        {% endwith %}
        {% endwith %}
      {% endfor %}
    </div>

    <!-- 🛍 상품 상태 일치 여부 -->
    <div class="mb-6">
      <h3 class="text-base font-semibold text-gray-700 mb-2">상품 상태 일치 여부</h3>
      {% for label, count in description_counter.items %}
        {% with max=max_counts.description %}
        {% with width=count|percentage:max %}
        <div class="flex items-center mb-2">
          <span class="w-48 text-sm text-gray-800">{{ label }}</span>
          <div class="flex-1 h-3 bg-gray-200 rounded ml-2 relative overflow-hidden">
            <div style="width:{{ width }}%; background-color:{{ count|bar_shade_by_count }};"></div>
          </div>
          <span class="ml-2 text-sm text-gray-500">{{ count }}명</span>
        </div>
        {% endwith %}
        {% endwith %}
      {% endfor %}
    </div>

    <!-- 📨 응답 속도 -->
    <div class="mb-6">
      <h3 class="text-base font-semibold text-gray-700 mb-2">응답 속도</h3>
      {% for label, count in response_counter.items %}
        {% with max=max_counts.response %}
        {% with width=count|percentage:max %}
        <p>{{ label }}점 → {{ count }}명 → {{ count|add:0 }} → 색상: {{ count|bar_shade_by_count }}</p>
        <div class="flex items-center mb-2">
          <span class="w-48 text-sm text-gray-800">{{ label }}</span>
          <div class="flex-1 h-3 bg-gray-200 rounded ml-2 relative overflow-hidden">
            <div style="width:{{ width }}%; background-color:{{ count|bar_shade_by_count }};"></div>
          </div>
          <span class="ml-2 text-sm text-gray-500">{{ count }}명</span>
        </div>
        {% endwith %}
        {% endwith %}
      {% endfor %}
    </div>

    <!-- 💬 메시지 말투 -->
    <div class="mb-6">
      <h3 class="text-base font-semibold text-gray-700 mb-2">메시지 말투</h3>
      {% for label, count in politeness_counter.items %}
        {% with max=max_counts.politeness %}
        {% with width=count|percentage:max %}
        <div class="flex items-center mb-2">
          <span class="w-48 text-sm text-gray-800">{{ label }}</span>
          <div class="flex-1 h-3 bg-gray-200 rounded ml-2 relative overflow-hidden">
            <div style="width:{{ width }}%; background-color:{{ count|bar_shade_by_count }};"></div>
          </div>
          <span class="ml-2 text-sm text-gray-500">{{ count }}명</span>
        </div>
        {% endwith %}
        {% endwith %}
      {% endfor %}
    </div>

    <!-- 🔁 재거래 의사 -->
    <div class="mb-6">
      <h3 class="text-base font-semibold text-gray-700 mb-2">재거래 의사</h3>
      {% for label, count in deal_again_counter.items %}
        {% with max=max_counts.deal_again %}
        {% with width=count|percentage:max %}
        <div class="flex items-center mb-2">
          <span class="w-48 text-sm text-gray-800">
            {% if label == "O" %}예{% else %}아니오{% endif %}
          </span>
          <div class="flex-1 h-3 bg-gray-200 rounded ml-2 relative overflow-hidden">
            <div style="width:{{ width }}%; background-color:{{ count|bar_shade_by_count }};"></div>
          </div>
          <span class="ml-2 text-sm text-gray-500">{{ count }}명</span>
        </div>
        {% endwith %}
        {% endwith %}
      {% endfor %}
    </div>

  
<style>
  /* 별점 스타일 */
  .star.active {
    color: #fbbf24 !important;
  }
  
  /* 라디오 버튼 숨기기 */
  input[type="radio"] {
    appearance: none;
    width: 16px;
    height: 16px;
    border: 2px solid #d1d5db;
    border-radius: 50%;
    position: relative;
    background: white;
    transition: all 0.2s ease;
  }
  
  input[type="radio"]:checked {
    border-color: #3b82f6;
    background: #3b82f6;
  }
  
  input[type="radio"]:checked::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: white;
  }
  
  /* 재거래 의사 버튼형 스타일 */
  input[type="radio"]:checked + .deal-button {
    border-color: #10b981 !important;
    background: linear-gradient(135deg, #d1fae5, #a7f3d0) !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.2) !important;
  }
  
  /* 호버 효과 강화 */
  label:hover input[type="radio"] {
    border-color: #6b7280;
  }
</style>

<script>
  // 별점 기능
  document.addEventListener('DOMContentLoaded', function() {
    const stars = document.querySelectorAll('.star');
    const ratingInput = document.querySelector('input[name="rating"]');
    const ratingText = document.getElementById('rating-text');
    
    const ratingTexts = {
      1: '😞 별로예요 (1점)',
      2: '🙁 아쉬워요 (2점)', 
      3: '😐 보통이에요 (3점)',
      4: '😊 좋아요! (4점)',
      5: '🤩 최고예요! (5점)'
    };
    
    stars.forEach((star, index) => {
      star.addEventListener('click', (e) => {
        e.preventDefault();
        const rating = index + 1;
        
        // 히든 input에 값 설정
        ratingInput.value = rating;
        
        // 별점 시각적 업데이트
        stars.forEach((s, i) => {
          if (i <= index) {
            s.classList.add('active');
          } else {
            s.classList.remove('active');
          }
        });
        
        // 텍스트 업데이트
        ratingText.textContent = ratingTexts[rating];
      });
      
      // 호버 효과
      star.addEventListener('mouseenter', () => {
        stars.forEach((s, i) => {
          if (i <= index) {
            s.style.color = '#fbbf24';
          } else {
            s.style.color = '#d1d5db';
          }
        });
      });
    });
    
    // 마우스 나갈 때 원래 상태로
    const ratingStarsContainer = document.querySelector('.rating-stars');
      if (ratingStarsContainer) {
        ratingStarsContainer.addEventListener('mouseleave', () => {
          stars.forEach((s, i) => {
            if (s.classList.contains('active')) {
              s.style.color = '#fbbf24';
            } else {
              s.style.color = '#d1d5db';
            }
          });
        });
      }
    
    // 폼 제출 전 검증
    const form = document.getElementById('reviewForm');
      if (form) {
        form.addEventListener('submit', (e) => {
          const ratingInput = document.querySelector('input[name="rating"]');
          if (!ratingInput.value) {
            e.preventDefault();
            alert('별점을 선택해주세요!');
            document.querySelector('.rating-stars').scrollIntoView({ behavior: 'smooth' });
          }
        });
      }

  // 탭 전환 기능
  function showTab(tab) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    document.getElementById('tab-' + tab).classList.remove('hidden');

    // 탭 버튼 스타일
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('text-blue-600', 'font-semibold', 'border-b-2', 'border-blue-500');
      btn.classList.add('text-gray-500');
    });
    event.target.classList.add('text-blue-600', 'font-semibold', 'border-b-2', 'border-blue-500');
    event.target.classList.remove('text-gray-500');
  }
});
</script>
{% endblock %}