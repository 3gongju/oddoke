{% extends 'base.html' %}
{% load static %}
{% load member_images %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.5/main.min.css" rel="stylesheet" />

<style>
  @font-face {
    font-family: 'NanumSquareRound';
    src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_two@1.0/NanumSquareRound.woff') format('woff');
    font-weight: normal;
    font-style: normal;
  }

  body,
  #calendar,
  h2,
  h2 span,
  .fc,
  .fc-toolbar-title,
  .fc-button,
  .fc-col-header-cell-cushion {
    font-family: 'NanumSquareRound', sans-serif !important;
    color: #111827;
  }

  #calendar {
    background-color: white;
    border-radius: 1rem;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    padding: 1.5rem;
  }

  .fc .fc-daygrid-day-number {
    font-weight: bold;
    font-size: 1rem;
  }

  .fc .fc-daygrid-event {
    background-color: transparent !important;
    border: none !important;
    font-size: 0.75rem;
    font-weight: normal;
    padding: 1px 4px;
    margin-bottom: 1px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
  }

  .fc .fc-event-main {
    display: flex;
    align-items: center;
    gap: 4px;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    max-width: 100%;
  }

  .member-avatar {
    width: 14px;
    height: 14px;
    border-radius: 9999px;
    object-fit: cover;
    flex-shrink: 0;
  }

  .member-name {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
    min-width: 0;
  }

  .fc-button {
    background-color: #efefef;
    border: none;
    border-radius: 6px;
    padding: 4px 10px;
    font-size: 0.875rem;
  }

  .fc-button-primary:not(:disabled).fc-button-active,
  .fc-button-primary:not(:disabled):active {
    background-color: #000000;
    color: #ffffff;
  }

  @media (max-width: 768px) {
    #calendar {
      padding: 0.5rem;
    }
    
    .fc .fc-toolbar {
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .fc .fc-toolbar-chunk {
      display: flex;
      justify-content: center;
    }
    
    .fc .fc-daygrid-event {
      font-size: 0.7rem;
      padding: 1px 2px;
      margin-bottom: 1px;
    }
    
    .member-avatar {
      width: 12px;
      height: 12px;
    }
    
    .fc .fc-event-main {
      gap: 2px;
    }
    
    .fc .fc-daygrid-day-number {
      font-size: 0.875rem;
      padding: 2px;
    }
    
    .fc .fc-col-header-cell-cushion {
      font-size: 0.75rem;
      padding: 4px 2px;
    }
    
    .fc .fc-daygrid-day-frame {
      min-height: 60px;
    }
    
    .fc .fc-button {
      padding: 2px 6px;
      font-size: 0.75rem;
    }
    
    .fc .fc-toolbar-title {
      font-size: 1.1rem;
    }
  }

  @media (max-width: 480px) {
    .member-avatar {
      width: 10px;
      height: 10px;
    }
    
    .fc .fc-daygrid-event {
      font-size: 0.65rem;
      padding: 0px 1px;
    }
    
    .fc .fc-event-main {
      gap: 1px;
    }
    
    .fc .fc-daygrid-day-frame {
      min-height: 50px;
    }
    
    .fc .fc-button {
      padding: 1px 4px;
      font-size: 0.7rem;
    }
    
    .fc .fc-toolbar-title {
      font-size: 1rem;
    }
    
    .fc .fc-daygrid-day-number {
      font-size: 0.8rem;
    }
  }
</style>
{% endblock %}

{% block body %}
<section class="max-w-6xl mx-auto px-4 py-10">
  <h2 class="text-2xl font-bold mb-6 flex items-center space-x-2">
    <img src="{% static 'image/ddok_logo_filled.png' %}" alt="로고" class="w-8 h-8">
    <span>전체 생일 멤버 (월간)</span>
  </h2>
  <div id="calendar"></div>
</section>

<!-- rrule -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/rrule/2.6.8/rrule.min.js"></script>
<!-- FullCalendar -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.5/index.global.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: window.innerWidth <= 768 ? 'dayGridWeek' : 'dayGridMonth',
      locale: 'ko',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: window.innerWidth <= 768 ? 'dayGridWeek' : 'dayGridMonth,dayGridWeek'
      },
      height: window.innerWidth <= 768 ? 'auto' : 'auto',
      aspectRatio: window.innerWidth <= 768 ? 1.0 : 1.35,
      nowIndicator: true,
      dayMaxEventRows: 10,
      eventDisplay: 'block',
      eventMaxStack: 10,

      eventDidMount: function(info) {
        const member = info.event.extendedProps.member_name;
        const imageUrl = info.event.extendedProps.image_url;

        // 아바타 이미지 생성
        const avatar = document.createElement('img');
        avatar.src = imageUrl || "{% static 'image/default_member.svg' %}";
        avatar.alt = member || 'Member';
        avatar.className = 'member-avatar';
        
        // 이미지 로드 실패시 기본 이미지로 대체
        avatar.onerror = function() {
          this.src = "{% static 'image/default_member.svg' %}";
        };

        // 텍스트 요소 찾기 및 이미지 추가
        const titleEl = info.el.querySelector('.fc-event-title');
        const mainEl = info.el.querySelector('.fc-event-main');
        const textEl = titleEl || mainEl;
        
        if (textEl) {
          textEl.style.color = '#111827';
          textEl.style.fontWeight = 'normal';
          textEl.style.display = 'flex';
          textEl.style.alignItems = 'center';
          textEl.style.gap = '4px';
          textEl.style.overflow = 'hidden';
          textEl.style.whiteSpace = 'nowrap';
          textEl.style.textOverflow = 'ellipsis';
          textEl.style.maxWidth = '100%';
          
          // 기존 텍스트 내용 저장
          const originalText = textEl.textContent;
          textEl.textContent = '';
          
          // 이미지와 텍스트 추가
          textEl.appendChild(avatar);
          const textSpan = document.createElement('span');
          textSpan.textContent = originalText;
          textSpan.className = 'member-name';
          textEl.appendChild(textSpan);
        }

        info.el.setAttribute('title', info.event.title);
      },

      events: "{% url 'bday_calendar:events_api' %}"
    });

    calendar.render();

    // 화면 크기 변경 시 뷰 자동 조정
    window.addEventListener('resize', function() {
      if (window.innerWidth <= 768) {
        calendar.changeView('dayGridWeek');
        calendar.setOption('aspectRatio', 1.0);
        calendar.setOption('headerToolbar', {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridWeek'
        });
      } else {
        calendar.changeView('dayGridMonth');
        calendar.setOption('aspectRatio', 1.35);
        calendar.setOption('headerToolbar', {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,dayGridWeek'
        });
      }
    });
  });
</script>
{% endblock %}