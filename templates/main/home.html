{# templates/main/home_improved.html #}
{% extends 'base.html' %}
{% load static %}
{% load member_images %}

{% block body %}

<!-- 히어로 섹션 (기존과 동일) -->
<section class="relative h-screen flex items-center justify-center overflow-hidden">
  <div class="absolute inset-0 z-0">
    <div id="bannerCarousel" class="w-full h-full relative">
      {% for path in banner_images %}
        <div class="absolute inset-0 transition-opacity duration-2000 ease-in-out
                    {% if forloop.first %}opacity-100{% else %}opacity-0{% endif %}">
          <img src="{% static path %}" class="w-full h-full object-cover" />
          <div class="absolute inset-0 bg-black/30"></div>
        </div>
      {% endfor %}
    </div>
  </div>

  <div class="relative z-10 text-center text-white max-w-4xl mx-auto px-6">
    <h1 class="font-playfair text-6xl md:text-8xl font-bold mb-6 leading-tight">어덕해</h1>
    <p class="text-xl md:text-2xl mb-8 font-light leading-relaxed opacity-90">
      팬들을 위한 특별한 공간<br>
      <span class="italic">굿즈 거래부터 덕질 기록까지</span>
    </p>
    <div class="flex flex-col sm:flex-row gap-4 justify-center">
      <a href="/ddokfarm/" class="inline-block px-8 py-4 bg-white text-gray-900 font-medium rounded-full hover:bg-gray-100 transition-all duration-300 shadow-lg">
        덕팜 둘러보기
      </a>
      <a href="/ddokdam/" class="inline-block px-8 py-4 border-2 border-white text-white font-medium rounded-full hover:bg-white hover:text-gray-900 transition-all duration-300">
        덕담 참여하기
      </a>
    </div>
  </div>

  <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 text-white animate-bounce">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
    </svg>
  </div>
</section>

<!-- ✅ 1. 실시간 인기 만두 (Hero 바로 아래, 3개만) -->
<section class="py-16 bg-white">
  <div class="max-w-7xl mx-auto px-6">
    <div class="flex justify-between items-end mb-10">
      <div>
        <h2 class="font-playfair text-3xl md:text-4xl font-bold text-gray-900 mb-3">
          🔥 지금 가장 핫한 만두
        </h2>
        <p class="text-gray-600 text-lg">실시간으로 관심받고 있는 굿즈</p>
      </div>
      <a href="/ddokfarm/" class="inline-flex items-center text-gray-900 hover:text-gray-600 font-medium transition-colors">
        더 많은 만두 보기
        <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </a>
    </div>
    
    <!-- 가로 3개 배치 (더 크게) -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
      {% for post in latest_sell_posts|slice:":3" %}
        <article class="group">
          <a href="{% url 'ddokfarm:post_detail' category=post.category post_id=post.id %}"
             class="block bg-white rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2">
            <div class="aspect-square overflow-hidden">
              {% if post.images.all %}
                <img src="{{ post.images.first.image.url }}" alt="{{ post.title }}" 
                     class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" />
              {% else %}
                <div class="w-full h-full bg-gradient-to-br from-purple-200 to-pink-200 flex items-center justify-center">
                  <span class="text-6xl">🛍️</span>
                </div>
              {% endif %}
            </div>
            <div class="p-6">
              <h3 class="font-semibold text-lg text-gray-900 mb-2 line-clamp-2">{{ post.title }}</h3>
              <div class="flex items-center justify-between">
                <span class="text-2xl font-bold text-gray-900">{{ post.price|default:"가격 문의" }}</span>
                <span class="text-sm text-gray-500">{{ post.created_at|date:"m/d" }}</span>
              </div>
            </div>
          </a>
        </article>
      {% endfor %}
    </div>
  </div>
</section>

<!-- ✅ 2. 오늘의 새 소식 (2x2 그리드) -->
<section class="py-16 bg-gradient-elegant">
  <div class="max-w-7xl mx-auto px-6">
    <div class="text-center mb-12">
      <h2 class="font-playfair text-3xl md:text-4xl font-bold text-gray-900 mb-4">
        📅 오늘의 새 소식
      </h2>
      <p class="text-xl text-gray-600">방금 올라온 따끈따끈한 게시글들</p>
    </div>

    <!-- 2x2 그리드 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto">
      <!-- 덕팜 최신 2개 -->
      {% for post in latest_sell_posts|slice:":2" %}
        <article class="group">
          <a href="{% url 'ddokfarm:post_detail' category=post.category post_id=post.id %}"
             class="block bg-white rounded-xl overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
            <div class="flex">
              {% if post.images.all %}
                <div class="w-24 h-24 flex-shrink-0">
                  <img src="{{ post.images.first.image.url }}" alt="{{ post.title }}" 
                       class="w-full h-full object-cover" />
                </div>
              {% endif %}
              <div class="flex-1 p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-medium">덕팜</span>
                  <span class="text-xs text-gray-500">{{ post.created_at|date:"H:i" }}</span>
                </div>
                <h3 class="font-medium text-gray-900 mb-1 line-clamp-2 text-sm">{{ post.title }}</h3>
                <p class="text-sm font-semibold text-gray-900">{{ post.price|default:"가격 문의" }}</p>
              </div>
            </div>
          </a>
        </article>
      {% endfor %}

      <!-- 덕담 최신 2개 -->
      {% for post in latest_community_posts|slice:":2" %}
        <article class="group">
          <a href="{% url 'ddokdam:post_detail' category=post.category post_id=post.id %}"
             class="block bg-white rounded-xl overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
            <div class="flex">
              {% if post.images.all %}
                <div class="w-24 h-24 flex-shrink-0">
                  <img src="{{ post.images.first.image.url }}" alt="{{ post.title }}" 
                       class="w-full h-full object-cover" />
                </div>
              {% endif %}
              <div class="flex-1 p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xs bg-pink-100 text-pink-700 px-2 py-1 rounded-full font-medium">덕담</span>
                  <span class="text-xs text-gray-500">{{ post.created_at|date:"H:i" }}</span>
                </div>
                <h3 class="font-medium text-gray-900 mb-1 line-clamp-2 text-sm">{{ post.title }}</h3>
                <p class="text-xs text-gray-600">{{ post.content|truncatechars:50 }}</p>
              </div>
            </div>
          </a>
        </article>
      {% endfor %}
    </div>
  </div>
</section>

<!-- ✅ 3. 카테고리 하이라이트 (각각 3개씩만) -->
<section class="py-16 bg-white">
  <div class="max-w-7xl mx-auto px-6">
    
    <!-- 덕팜 하이라이트 섹션 -->
    <div class="mb-16">
      <div class="flex justify-between items-end mb-8">
        <div>
          <h2 class="font-playfair text-2xl md:text-3xl font-bold text-gray-900 mb-2">
            🛍️ 덕팜 하이라이트
          </h2>
          <p class="text-gray-600">인기 굿즈 거래</p>
        </div>
        <a href="{% url 'ddokfarm:index' %}" class="text-gray-600 hover:text-gray-900 font-medium transition-colors">
          전체 보기 →
        </a>
      </div>
      
      <!-- ✅ 조건부 표시: 데이터가 있을 때만 표시 -->
      {% if latest_sell_posts|length >= 4 %}
        <!-- 기존 로직: 4~6번째 게시글 사용 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          {% for post in latest_sell_posts|slice:"3:6" %}
            <article class="group">
              <a href="{% url 'ddokfarm:post_detail' category=post.category post_id=post.id %}"
                class="block bg-white border border-gray-200 rounded-xl overflow-hidden hover:border-gray-300 hover:shadow-lg transition-all duration-300">
                {% if post.images.all %}
                  <div class="aspect-video overflow-hidden">
                    <img src="{{ post.images.first.image.url }}" alt="{{ post.title }}" 
                        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" />
                  </div>
                {% endif %}
                <div class="p-4">
                  <h3 class="font-medium text-gray-900 mb-2 line-clamp-2">{{ post.title }}</h3>
                  <div class="flex items-center justify-between text-sm">
                    <span class="font-semibold text-gray-900">{{ post.price|default:"가격 문의" }}</span>
                    <span class="text-gray-500">{{ post.created_at|date:"m월 d일" }}</span>
                  </div>
                </div>
              </a>
            </article>
          {% endfor %}
        </div>
      {% elif latest_sell_posts %}
        <!-- 대체 로직: 전체 게시글이 3개 이하일 때 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          {% for post in latest_sell_posts %}
            <article class="group">
              <a href="{% url 'ddokfarm:post_detail' category=post.category post_id=post.id %}"
                class="block bg-white border border-gray-200 rounded-xl overflow-hidden hover:border-gray-300 hover:shadow-lg transition-all duration-300">
                {% if post.images.all %}
                  <div class="aspect-video overflow-hidden">
                    <img src="{{ post.images.first.image.url }}" alt="{{ post.title }}" 
                        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" />
                  </div>
                {% endif %}
                <div class="p-4">
                  <h3 class="font-medium text-gray-900 mb-2 line-clamp-2">{{ post.title }}</h3>
                  <div class="flex items-center justify-between text-sm">
                    <span class="font-semibold text-gray-900">{{ post.price|default:"가격 문의" }}</span>
                    <span class="text-gray-500">{{ post.created_at|date:"m월 d일" }}</span>
                  </div>
                </div>
              </a>
            </article>
          {% endfor %}
        </div>
      {% else %}
        <!-- 게시글이 없을 때 -->
        <div class="text-center py-12 bg-gray-50 rounded-xl">
          <div class="text-6xl mb-4">🛍️</div>
          <h3 class="text-lg font-medium text-gray-900 mb-2">아직 덕팜 게시글이 없어요</h3>
          <p class="text-gray-600 mb-4">첫 번째 굿즈 거래를 시작해보세요!</p>
          <a href="{% url 'ddokfarm:post_create' category='sell' %}" 
            class="inline-block px-6 py-3 bg-gray-900 text-white rounded-full hover:bg-gray-800 transition-colors duration-300">
            게시글 작성하기
          </a>
        </div>
      {% endif %}
    </div>

    <!-- 덕담 하이라이트 -->
    <div class="mb-16">
      <div class="flex justify-between items-end mb-8">
        <div>
          <h2 class="font-playfair text-2xl md:text-3xl font-bold text-gray-900 mb-2">
            💌 덕담 하이라이트
          </h2>
          <p class="text-gray-600">인기 커뮤니티 글</p>
        </div>
        <a href="{% url 'ddokdam:index' %}" class="text-gray-600 hover:text-gray-900 font-medium transition-colors">
          전체 보기 →
        </a>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        {% for post in latest_community_posts|slice:"2:5" %}
          <article class="group">
            <a href="{% url 'ddokdam:post_detail' category=post.category post_id=post.id %}"
               class="block bg-white border border-gray-200 rounded-xl overflow-hidden hover:border-gray-300 hover:shadow-lg transition-all duration-300">
              {% if post.images.all %}
                <div class="aspect-video overflow-hidden">
                  <img src="{{ post.images.first.image.url }}" alt="{{ post.title }}" 
                       class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" />
                </div>
              {% else %}
                <div class="aspect-video bg-gradient-to-br from-pink-100 to-purple-100 flex items-center justify-center">
                  <span class="text-4xl">💌</span>
                </div>
              {% endif %}
              <div class="p-4">
                <h3 class="font-medium text-gray-900 mb-2 line-clamp-2">{{ post.title }}</h3>
                <div class="flex items-center justify-between text-sm">
                  <span class="text-gray-600">{{ post.user.display_name }}</span>
                  <span class="text-gray-500">{{ post.created_at|date:"m월 d일" }}</span>
                </div>
              </div>
            </a>
          </article>
        {% endfor %}
      </div>
    </div>
  </div>
</section>

<!-- ✅ 4. 이주의 베스트 (슬라이더) -->
<section class="py-16 bg-gray-50">
  <div class="max-w-7xl mx-auto px-6">
    <div class="text-center mb-12">
      <h2 class="font-playfair text-3xl md:text-4xl font-bold text-gray-900 mb-4">
        💎 이주의 베스트
      </h2>
      <p class="text-xl text-gray-600">이번 주 가장 사랑받은 게시글들</p>
    </div>

    <!-- 슬라이더 (Swiper 사용) -->
    <div class="swiper weekly-best-swiper">
      <div class="swiper-wrapper">
        {% for post in weekly_best_posts %}
          <div class="swiper-slide">
            <article class="group">
              <a href="#" class="block bg-white rounded-xl overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                {% if post.images.all %}
                  <div class="aspect-square overflow-hidden">
                    <img src="{{ post.images.first.image.url }}" alt="{{ post.title }}" 
                         class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" />
                  </div>
                {% endif %}
                <div class="p-4">
                  <div class="flex items-center gap-2 mb-2">
                    <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full font-medium">베스트</span>
                    <span class="text-xs text-gray-500">❤️ {{ post.like_count }}</span>
                  </div>
                  <h3 class="font-medium text-gray-900 mb-1 line-clamp-2">{{ post.title }}</h3>
                  <p class="text-sm text-gray-600">{{ post.user.display_name }}</p>
                </div>
              </a>
            </article>
          </div>
        {% endfor %}
      </div>
      
      <!-- 네비게이션 -->
      <div class="swiper-button-next"></div>
      <div class="swiper-button-prev"></div>
      <div class="swiper-pagination"></div>
    </div>
  </div>
</section>

<!-- 찜한 아티스트 & 생일 멤버 섹션 (기존과 동일) -->
<section class="py-24 bg-white">
  <div class="max-w-6xl mx-auto px-6">
    <div class="flex justify-between items-end mb-12">
      <div>
        <h3 class="font-playfair text-3xl md:text-4xl font-bold text-gray-900 mb-3">
          내가 찜한 덕
        </h3>
        <p class="text-gray-600 text-lg">나만의 특별한 아티스트들</p>
      </div>
      <a href="{% url 'artist:index' %}" class="inline-flex items-center text-gray-900 hover:text-gray-600 font-medium transition-colors">
        모든 덕 보기
        <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </a>
    </div>

    {% if raw_favs %}
      <div class="relative">
        <button onclick="moveArtistSlide(-1)" class="absolute left-0 top-1/2 -translate-y-1/2 w-12 h-12 bg-white border-2 border-gray-200 rounded-full shadow-lg hover:shadow-xl hover:border-gray-300 z-10 transition-all duration-300">
          <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
        
        <div class="overflow-hidden mx-16">
          <div id="artist-carousel-wrapper" class="flex transition-transform duration-500 ease-in-out">
            {% for group in grouped_artists %}
              <div class="flex justify-center space-x-8 min-w-full">
                {% for artist in group %}
                  <div class="flex flex-col items-center group cursor-pointer">
                    <a href="{% url 'artist:index' %}" class="block">
                      <div class="w-24 h-24 rounded-full overflow-hidden shadow-lg group-hover:shadow-xl transition-all duration-300 transform group-hover:scale-105">
                        <img src="{% static artist.logo %}" alt="{{ artist.display_name }}" class="w-full h-full object-cover" />
                      </div>
                    </a>
                    <p class="mt-3 text-sm font-medium text-gray-800 text-center group-hover:text-gray-600 transition-colors">
                      {{ artist.display_name }}
                    </p>
                  </div>
                {% endfor %}
              </div>
            {% endfor %}
          </div>
        </div>
        
        <button onclick="moveArtistSlide(1)" class="absolute right-0 top-1/2 -translate-y-1/2 w-12 h-12 bg-white border-2 border-gray-200 rounded-full shadow-lg hover:shadow-xl hover:border-gray-300 z-10 transition-all duration-300">
          <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
      </div>
    {% else %}
      <div class="text-center py-16">
        <div class="w-32 h-32 mx-auto mb-6 opacity-50">
          <img src="{% static 'image/ddok_black.png' %}" alt="찜한 아티스트 없음" class="w-full h-full object-contain" />
        </div>
        <h4 class="font-playfair text-2xl font-bold text-gray-800 mb-3">아직 찜한 덕이 없어요!</h4>
        <p class="text-gray-600 mb-6">마음에 드는 아티스트를 찜해보세요</p>
        <a href="{% url 'artist:index' %}" class="inline-block px-6 py-3 bg-gray-900 text-white rounded-full hover:bg-gray-800 transition-colors duration-300">
          찜덕하러 가기
        </a>
      </div>
    {% endif %}
  </div>
</section>

<!-- CTA 섹션 (기존과 동일) -->
<section class="py-24 bg-gray-900 text-white">
  <div class="max-w-4xl mx-auto text-center px-6">
    <h2 class="font-playfair text-4xl md:text-5xl font-bold mb-6">
      덕질, 이제 더 특별하게
    </h2>
    <p class="text-xl text-gray-300 mb-8 leading-relaxed">
      어덕해에서 새로운 덕질 경험을 시작해보세요
    </p>
    <div class="flex flex-col sm:flex-row gap-4 justify-center">
      <a href="/accounts/signup/" class="inline-block px-8 py-4 bg-white text-gray-900 font-medium rounded-full hover:bg-gray-100 transition-all duration-300">
        지금 시작하기
      </a>
      <a href="/ddokfarm/" class="inline-block px-8 py-4 border-2 border-white text-white font-medium rounded-full hover:bg-white hover:text-gray-900 transition-all duration-300">
        둘러보기
      </a>
    </div>
  </div>
</section>

<!-- 스크립트 -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    // 배너 슬라이드
    const slides = document.querySelectorAll("#bannerCarousel > div");
    let idx = 0;
    
    function showNextSlide() {
      slides[idx].classList.replace("opacity-100", "opacity-0");
      idx = (idx + 1) % slides.length;
      slides[idx].classList.replace("opacity-0", "opacity-100");
    }
    
    setInterval(showNextSlide, 6000);

    // 이주의 베스트 슬라이더
    new Swiper('.weekly-best-swiper', {
      slidesPerView: 1,
      spaceBetween: 20,
      loop: true,
      autoplay: {
        delay: 4000,
        disableOnInteraction: false,
      },
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
      },
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },
      breakpoints: {
        640: {
          slidesPerView: 2,
          spaceBetween: 20,
        },
        768: {
          slidesPerView: 3,
          spaceBetween: 24,
        },
        1024: {
          slidesPerView: 4,
          spaceBetween: 32,
        },
      }
    });
  });

  // 찜한 아티스트 페이징
  const wrapper = document.getElementById('artist-carousel-wrapper');
  const totalGroups = wrapper?.children.length || 0;
  let groupIndex = 0;

  function moveArtistSlide(direction) {
    const newIndex = groupIndex + direction;
    
    if (newIndex >= 0 && newIndex < totalGroups) {
      groupIndex = newIndex;
      wrapper.style.transform = `translateX(-${groupIndex * 100}%)`;
    }
  }

  window.addEventListener('resize', () => {
    groupIndex = 0;
    if (wrapper) {
      wrapper.style.transform = 'translateX(0%)';
    }
  });
</script>

{% endblock %}