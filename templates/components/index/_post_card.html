{% load humanize %}
{% load ddokfarm_filters %}

<div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-200 relative">
  <!-- íŒë§¤ì™„ë£Œ ì˜¤ë²„ë ˆì´ (ë•íŒœë§Œ) -->
  {% if post.is_sold and app_name == 'ddokfarm' %}
    <div class="absolute top-2 left-2 bg-red-500 text-white px-2 py-1 rounded-full text-xs font-bold z-10">
      íŒë§¤ì™„ë£Œ
    </div>
  {% endif %}

  <!-- ì´ë¯¸ì§€ ì˜ì—­ -->
  <div class="relative aspect-square bg-gray-100">
    <a href="{{ detail_url }}" class="block w-full h-full">
      {% if post.get_main_image %}
        <img src="{{ post.get_main_image }}" 
             alt="{{ post.title }}" 
             class="w-full h-full object-cover {% if post.is_sold and app_name == 'ddokfarm' %}opacity-70{% endif %}">
      {% elif post.images.all %}
        <img src="{{ post.images.first.image.url }}" 
             alt="{{ post.title }}" 
             class="w-full h-full object-cover {% if post.is_sold and app_name == 'ddokfarm' %}opacity-70{% endif %}">
      {% else %}
        <div class="w-full h-full flex items-center justify-center text-gray-400 text-4xl {% if post.is_sold and app_name == 'ddokfarm' %}opacity-70{% endif %}">
          ğŸ“·
        </div>
      {% endif %}
    </a>
    
    <!-- ì°œí•˜ê¸° ë²„íŠ¼ (ì´ë¯¸ì§€ ìœ„ ìš°ìƒë‹¨) -->
    <button class="absolute top-2 right-2 w-8 h-8 bg-white bg-opacity-80 rounded-full flex items-center justify-center text-pink-500 hover:bg-opacity-100 transition-all duration-200 shadow-sm"
            onclick="toggleLike(event, {{ post.id }}, '{{ post.category_type }}')">
      <span class="text-sm">ğŸ¤</span>
    </button>
  </div>

  <!-- ì¹´ë“œ ë‚´ìš© -->
  <div class="p-3 {% if post.is_sold and app_name == 'ddokfarm' %}opacity-80{% endif %}">
    <!-- ì œëª© -->
    <h3 class="font-medium text-gray-900 text-sm mb-2 line-clamp-2 leading-tight">
      <a href="{{ detail_url }}" class="hover:text-gray-700">
        {{ post.title }}
      </a>
    </h3>

    <!-- ê°€ê²© ì •ë³´ (ë•íŒœë§Œ) -->
    {% if app_name == 'ddokfarm' %}
      <div class="mb-3">
        {% if post.category_type == 'split' %}
          {% if post.get_price_range %}
            {% with min_price=post.get_price_range.0 max_price=post.get_price_range.1 %}
              <div class="text-lg font-bold text-gray-900">
                {% if min_price == max_price %}
                  {{ min_price|intcomma }}ì›
                {% else %}
                  {{ min_price|intcomma }}ì› ~ {{ max_price|intcomma }}ì›
                {% endif %}
              </div>
            {% endwith %}
          {% else %}
            <div class="text-lg font-bold text-gray-900">
              {{ post.shipping_fee|default:"0"|intcomma }}ì›
            </div>
          {% endif %}
        {% else %}
          <div class="text-lg font-bold text-gray-900">
            {{ post.price|intcomma }}ì›
          </div>
        {% endif %}
      </div>
    {% endif %}

    <!-- í•˜ë‹¨ ì •ë³´ ì˜ì—­ -->
    <div class="flex items-center justify-between text-xs text-gray-500">
      <!-- ìœ ì € ì •ë³´ -->
      <div class="flex items-center space-x-1 min-w-0 flex-1">
        <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ -->
        <div class="flex-shrink-0 w-5 h-5">
          {% if post.user.profile_image %}
            <img src="{{ post.user.profile_image.url }}" 
                 alt="{{ post.user.username }}" 
                 class="w-5 h-5 rounded-full object-cover">
          {% else %}
            <div class="w-5 h-5 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 text-xs">
              {{ post.user.username|first|upper }}
            </div>
          {% endif %}
        </div>
        
        <!-- ìœ ì €ëª… -->
        <span class="truncate text-gray-700 font-medium">{{ post.user.username }}</span>
        
        <!-- íŒ¬ë¤ ì¸ì¦ ë§ˆí¬ -->
        {% if post.user.is_verified_fandom %}
          <span class="flex-shrink-0 text-blue-500 text-sm" title="íŒ¬ë¤ ì¸ì¦">
            â­
          </span>
        {% endif %}
      </div>

      <!-- í†µê³„ ì •ë³´ -->
      <div class="flex items-center space-x-2 text-gray-400 flex-shrink-0">
        <!-- ì°œ ê°œìˆ˜ -->
        <div class="flex items-center space-x-1">
          <span>â¤ï¸</span>
          <span data-like-count>{{ post.like.count }}</span>
        </div>
        
        <!-- ì¡°íšŒìˆ˜ (ìˆëŠ” ê²½ìš°ë§Œ) -->
        {% if post.view_count %}
          <div class="flex items-center space-x-1">
            <span>ğŸ‘ï¸</span>
            <span>{{ post.view_count }}</span>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- ì•„í‹°ìŠ¤íŠ¸ íƒœê·¸ -->
    <div class="mt-2">
      <span class="inline-block bg-pink-100 text-pink-800 text-xs px-2 py-1 rounded-full">
        {{ post.artist.display_name }}
      </span>
    </div>

    <!-- ê²Œì‹œ ì‹œê°„ -->
    <div class="mt-2 text-xs text-gray-400">
      <span class="text-xs text-gray-500">{{ post.created_at|smart_date }}</span>
    </div>
  </div>
</div>

<!-- ì°œí•˜ê¸° JavaScript -->
<script>
function toggleLike(event, postId, category) {
  event.preventDefault();
  event.stopPropagation();
  
  // ë¡œê·¸ì¸ í™•ì¸
  if (!window.user || !window.user.is_authenticated) {
    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    return;
  }
  
  const button = event.currentTarget;
  const icon = button.querySelector('span');
  
  // ì•±ë³„ URL ê²°ì •
  const appName = '{{ app_name|default:"ddokfarm" }}';
  const baseUrl = appName === 'ddokfarm' ? '/ddokfarm/' : '/ddokdam/';
  
  fetch(`${baseUrl}${category}/${postId}/like/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || window.csrfToken,
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.liked) {
      icon.textContent = 'â¤ï¸';
      button.classList.add('text-red-500');
      button.classList.remove('text-pink-500');
    } else {
      icon.textContent = 'ğŸ¤';
      button.classList.add('text-pink-500');
      button.classList.remove('text-red-500');
    }
    
    // ì°œ ê°œìˆ˜ ì—…ë°ì´íŠ¸
    const likeCountSpan = button.closest('.bg-white').querySelector('[data-like-count]');
    if (likeCountSpan) {
      likeCountSpan.textContent = data.like_count;
    }
  })
  .catch(error => {
    console.error('ì°œí•˜ê¸° ì˜¤ë¥˜:', error);
    alert('ì°œí•˜ê¸° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  });
}
</script>

<!-- CSS ì¶”ê°€ (Tailwind ë³´ì™„ìš©) -->
<style>
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

@media (max-width: 640px) {
  .aspect-square {
    aspect-ratio: 1 / 1;
  }
}
</style>