{% load humanize %}
{% load ddokfarm_filters %}

<div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-200 relative">
  <!-- 판매완료 오버레이 (덕팜만) -->
  {% if post.is_sold and app_name == 'ddokfarm' %}
    <div class="absolute top-2 left-2 bg-red-500 text-white px-2 py-1 rounded-full text-xs font-bold z-10">
      판매완료
    </div>
  {% endif %}

  <!-- 이미지 영역 -->
  <div class="relative aspect-square bg-gray-100">
    <a href="{{ detail_url }}" class="block w-full h-full">
      {% if post.get_main_image %}
        <img src="{{ post.get_main_image }}" 
             alt="{{ post.title }}" 
             class="w-full h-full object-cover {% if post.is_sold and app_name == 'ddokfarm' %}opacity-70{% endif %}">
      {% elif post.images.all %}
        <img src="{{ post.images.first.image.url }}" 
             alt="{{ post.title }}" 
             class="w-full h-full object-cover {% if post.is_sold and app_name == 'ddokfarm' %}opacity-70{% endif %}">
      {% else %}
        <div class="w-full h-full flex items-center justify-center text-gray-400 text-4xl {% if post.is_sold and app_name == 'ddokfarm' %}opacity-70{% endif %}">
          📷
        </div>
      {% endif %}
    </a>
    
    <!-- 찜하기 버튼 (이미지 위 우상단) -->
    <button class="absolute top-2 right-2 w-8 h-8 bg-white bg-opacity-80 rounded-full flex items-center justify-center text-pink-500 hover:bg-opacity-100 transition-all duration-200 shadow-sm"
            onclick="toggleLike(event, {{ post.id }}, '{{ post.category_type }}')">
      <span class="text-sm">🤍</span>
    </button>
  </div>

  <!-- 카드 내용 -->
  <div class="p-3 {% if post.is_sold and app_name == 'ddokfarm' %}opacity-80{% endif %}">
    <!-- 제목 -->
    <h3 class="font-medium text-gray-900 text-sm mb-2 line-clamp-2 leading-tight">
      <a href="{{ detail_url }}" class="hover:text-gray-700">
        {{ post.title }}
      </a>
    </h3>

    <!-- 가격 정보 (덕팜만) -->
    {% if app_name == 'ddokfarm' %}
      <div class="mb-3">
        {% if post.category_type == 'split' %}
          {% if post.get_price_range %}
            {% with min_price=post.get_price_range.0 max_price=post.get_price_range.1 %}
              <div class="text-lg font-bold text-gray-900">
                {% if min_price == max_price %}
                  {{ min_price|intcomma }}원
                {% else %}
                  {{ min_price|intcomma }}원 ~ {{ max_price|intcomma }}원
                {% endif %}
              </div>
            {% endwith %}
          {% else %}
            <div class="text-lg font-bold text-gray-900">
              {{ post.shipping_fee|default:"0"|intcomma }}원
            </div>
          {% endif %}
        {% else %}
          <div class="text-lg font-bold text-gray-900">
            {{ post.price|intcomma }}원
          </div>
        {% endif %}
      </div>
    {% endif %}

    <!-- 하단 정보 영역 -->
    <div class="flex items-center justify-between text-xs text-gray-500">
      <!-- 유저 정보 -->
      <div class="flex items-center space-x-1 min-w-0 flex-1">
        <!-- 프로필 이미지 -->
        <div class="flex-shrink-0 w-5 h-5">
          {% if post.user.profile_image %}
            <img src="{{ post.user.profile_image.url }}" 
                 alt="{{ post.user.username }}" 
                 class="w-5 h-5 rounded-full object-cover">
          {% else %}
            <div class="w-5 h-5 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 text-xs">
              {{ post.user.username|first|upper }}
            </div>
          {% endif %}
        </div>
        
        <!-- 유저명 -->
        <span class="truncate text-gray-700 font-medium">{{ post.user.username }}</span>
        
        <!-- 팬덤 인증 마크 -->
        {% if post.user.is_verified_fandom %}
          <span class="flex-shrink-0 text-blue-500 text-sm" title="팬덤 인증">
            ⭐
          </span>
        {% endif %}
      </div>

      <!-- 통계 정보 -->
      <div class="flex items-center space-x-2 text-gray-400 flex-shrink-0">
        <!-- 찜 개수 -->
        <div class="flex items-center space-x-1">
          <span>❤️</span>
          <span data-like-count>{{ post.like.count }}</span>
        </div>
        
        <!-- 조회수 (있는 경우만) -->
        {% if post.view_count %}
          <div class="flex items-center space-x-1">
            <span>👁️</span>
            <span>{{ post.view_count }}</span>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- 아티스트 태그 -->
    <div class="mt-2">
      <span class="inline-block bg-pink-100 text-pink-800 text-xs px-2 py-1 rounded-full">
        {{ post.artist.display_name }}
      </span>
    </div>

    <!-- 게시 시간 -->
    <div class="mt-2 text-xs text-gray-400">
      <span class="text-xs text-gray-500">{{ post.created_at|smart_date }}</span>
    </div>
  </div>
</div>

<!-- 찜하기 JavaScript -->
<script>
function toggleLike(event, postId, category) {
  event.preventDefault();
  event.stopPropagation();
  
  // 로그인 확인
  if (!window.user || !window.user.is_authenticated) {
    alert('로그인이 필요합니다.');
    return;
  }
  
  const button = event.currentTarget;
  const icon = button.querySelector('span');
  
  // 앱별 URL 결정
  const appName = '{{ app_name|default:"ddokfarm" }}';
  const baseUrl = appName === 'ddokfarm' ? '/ddokfarm/' : '/ddokdam/';
  
  fetch(`${baseUrl}${category}/${postId}/like/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || window.csrfToken,
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.liked) {
      icon.textContent = '❤️';
      button.classList.add('text-red-500');
      button.classList.remove('text-pink-500');
    } else {
      icon.textContent = '🤍';
      button.classList.add('text-pink-500');
      button.classList.remove('text-red-500');
    }
    
    // 찜 개수 업데이트
    const likeCountSpan = button.closest('.bg-white').querySelector('[data-like-count]');
    if (likeCountSpan) {
      likeCountSpan.textContent = data.like_count;
    }
  })
  .catch(error => {
    console.error('찜하기 오류:', error);
    alert('찜하기 처리 중 오류가 발생했습니다.');
  });
}
</script>

<!-- CSS 추가 (Tailwind 보완용) -->
<style>
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

@media (max-width: 640px) {
  .aspect-square {
    aspect-ratio: 1 / 1;
  }
}
</style>