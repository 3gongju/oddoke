<!-- 카테고리 필터 -->
<div class="mb-6">
  <!-- 덕팜과 덕담 공통: 기본 카테고리 필터 -->
  {% if app_name == 'ddokfarm' %}
    <!-- 덕팜: 드롭다운이 있는 고급 카테고리 필터 -->
    <div class="flex flex-wrap gap-2 mb-6">
      <!-- 전체 버튼 -->
      <a href="{% url 'ddokfarm:index' %}" 
         class="px-4 py-2 rounded-full text-sm font-medium transition-colors {% if not category %}bg-black text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
        전체
      </a>

      <!-- 판매/구매 버튼 (서브 카테고리 포함) -->
      <div class="relative" id="sell-category-wrapper">
        <button id="sell-category-btn" 
                data-category="sell"
                class="px-4 py-2 rounded-full text-sm font-medium transition-colors flex items-center gap-1 {% if category == 'sell' %}bg-black text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
          양도
          <svg class="w-3 h-3 transition-transform" id="sell-arrow" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
        </button>
        
        <!-- 서브 카테고리 드롭다운 -->
        <div id="sell-subcategory" class="absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10 min-w-[120px] hidden">
          <a href="?category=sell&wantto=buy" 
             class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 first:rounded-t-lg subcategory-link {% if wantto == 'buy' %}bg-gray-50 font-medium{% endif %}">
            삽니다
          </a>
          <a href="?category=sell&wantto=sell" 
             class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 subcategory-link {% if wantto == 'sell' %}bg-gray-50 font-medium{% endif %}">
            팝니다
          </a>
          <a href="?category=sell&wantto=exchange" 
             class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 last:rounded-b-lg subcategory-link {% if wantto == 'exchange' %}bg-gray-50 font-medium{% endif %}">
            교환해요
          </a>
        </div>
      </div>

      <!-- 대여 버튼 (서브 카테고리 포함) -->
      <div class="relative" id="rental-category-wrapper">
        <button id="rental-category-btn" 
                data-category="rental"
                class="px-4 py-2 rounded-full text-sm font-medium transition-colors flex items-center gap-1 {% if category == 'rental' %}bg-black text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
          대여
          <svg class="w-3 h-3 transition-transform" id="rental-arrow" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
        </button>
        
        <!-- 서브 카테고리 드롭다운 -->
        <div id="rental-subcategory" class="absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10 min-w-[120px] hidden">
          <a href="?category=rental&wantto=sell" 
             class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 first:rounded-t-lg subcategory-link {% if wantto == 'sell' %}bg-gray-50 font-medium{% endif %}">
            빌려줍니다
          </a>
          <a href="?category=rental&wantto=buy" 
             class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 last:rounded-b-lg subcategory-link {% if wantto == 'buy' %}bg-gray-50 font-medium{% endif %}">
            빌려주세요
          </a>
        </div>
      </div>

      <!-- 분철 버튼 -->
      <a href="?category=split" 
         class="px-4 py-2 rounded-full text-sm font-medium transition-colors {% if category == 'split' %}bg-black text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
        분철
      </a>
    </div>

    <!-- 덕팜 전용: 드롭다운 JavaScript (2단계 클릭 로직 추가) -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 판매/구매 드롭다운 처리
      const sellBtn = document.getElementById('sell-category-btn');
      const sellDropdown = document.getElementById('sell-subcategory');
      const sellArrow = document.getElementById('sell-arrow');
      
      // 대여 드롭다운 처리
      const rentalBtn = document.getElementById('rental-category-btn');
      const rentalDropdown = document.getElementById('rental-subcategory');
      const rentalArrow = document.getElementById('rental-arrow');

      // 현재 페이지 카테고리 확인
      const currentCategory = '{{ category }}';
      const currentWantto = '{{ wantto }}';

      // 모든 드롭다운 닫기 함수
      function closeAllDropdowns() {
        sellDropdown.classList.add('hidden');
        rentalDropdown.classList.add('hidden');
        sellArrow.style.transform = 'rotate(0deg)';
        rentalArrow.style.transform = 'rotate(0deg)';
      }

      // 드롭다운 토글 함수
      function toggleDropdown(dropdown, arrow) {
        const isOpen = !dropdown.classList.contains('hidden');
        
        // 모든 드롭다운 닫기
        closeAllDropdowns();
        
        // 클릭한 드롭다운만 토글
        if (!isOpen) {
          dropdown.classList.remove('hidden');
          arrow.style.transform = 'rotate(180deg)';
        }
      }

      // 카테고리 페이지로 이동하는 함수
      function navigateToCategory(category) {
        const url = new URL(window.location);
        const params = new URLSearchParams(url.search);
        
        // 기존 파라미터 유지하면서 카테고리만 변경
        const currentQuery = params.get('q');
        const currentSort = params.get('sort');
        const currentAvailableOnly = params.get('available_only');
        
        // 새 URL 생성
        const newUrl = new URL(window.location.origin + window.location.pathname);
        const newParams = new URLSearchParams();
        
        newParams.set('category', category);
        if (currentQuery) newParams.set('q', currentQuery);
        if (currentSort) newParams.set('sort', currentSort);
        if (currentAvailableOnly) newParams.set('available_only', currentAvailableOnly);
        
        newUrl.search = newParams.toString();
        window.location.href = newUrl.toString();
      }

      // 판매/구매 버튼 클릭 이벤트
      if (sellBtn) {
        sellBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const targetCategory = this.dataset.category;
          
          // 1단계: 현재 카테고리가 아니면 카테고리 페이지로 이동
          if (currentCategory !== targetCategory) {
            navigateToCategory(targetCategory);
            return;
          }
          
          // 2단계: 이미 해당 카테고리에 있으면 드롭다운 토글
          toggleDropdown(sellDropdown, sellArrow);
        });
      }

      // 대여 버튼 클릭 이벤트
      if (rentalBtn) {
        rentalBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const targetCategory = this.dataset.category;
          
          // 1단계: 현재 카테고리가 아니면 카테고리 페이지로 이동
          if (currentCategory !== targetCategory) {
            navigateToCategory(targetCategory);
            return;
          }
          
          // 2단계: 이미 해당 카테고리에 있으면 드롭다운 토글
          toggleDropdown(rentalDropdown, rentalArrow);
        });
      }

      // 외부 클릭시 드롭다운 닫기
      document.addEventListener('click', function(e) {
        const sellWrapper = document.getElementById('sell-category-wrapper');
        const rentalWrapper = document.getElementById('rental-category-wrapper');
        
        if (!sellWrapper.contains(e.target) && !rentalWrapper.contains(e.target)) {
          closeAllDropdowns();
        }
      });

      // 서브 카테고리 링크 클릭 시 자동 닫힘 및 URL 이동
      const subcategoryLinks = document.querySelectorAll('.subcategory-link');
      subcategoryLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          // 드롭다운 즉시 닫기 (애니메이션과 함께)
          closeAllDropdowns();
          
          const url = new URL(window.location);
          const linkUrl = new URL(this.href, window.location.origin);
          
          // 기존 검색어와 정렬 파라미터 유지
          const currentQuery = url.searchParams.get('q');
          const currentSort = url.searchParams.get('sort');
          const currentAvailableOnly = url.searchParams.get('available_only');
          
          if (currentQuery) linkUrl.searchParams.set('q', currentQuery);
          if (currentSort) linkUrl.searchParams.set('sort', currentSort);
          if (currentAvailableOnly) linkUrl.searchParams.set('available_only', currentAvailableOnly);
          
          // 짧은 지연 후 페이지 이동 (드롭다운 닫힘 애니메이션 완료 대기)
          setTimeout(() => {
            window.location.href = linkUrl.toString();
          }, 100);
        });
      });

      // 초기 로드 시: wantto가 있어도 드롭다운을 열지 않음 (서브 카테고리 선택 후이므로)
      // 페이지 로드 시에는 드롭다운을 닫힌 상태로 유지
      closeAllDropdowns();
    });
    </script>

    <!-- 덕팜 전용: 모바일 최적화 스타일 -->
    <style>
    @media (max-width: 640px) {
      .flex.flex-wrap.gap-2 {
        gap: 0.5rem;
      }
      
      .px-4.py-2 {
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
      }
      
      /* 드롭다운 모바일 최적화 */
      #sell-subcategory, #rental-subcategory {
        position: fixed;
        top: auto;
        left: 1rem;
        right: 1rem;
        margin-top: 0.5rem;
        z-index: 50;
      }
      
      /* 터치 영역 확대 */
      #sell-subcategory a, #rental-subcategory a {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
      }
    }

    /* 태블릿 최적화 */
    @media (min-width: 641px) and (max-width: 1024px) {
      #filter-modal .max-w-md {
        max-width: 28rem;
      }
    }

    /* 드롭다운 애니메이션 */
    #sell-subcategory, #rental-subcategory {
      transition: opacity 0.2s ease-out, transform 0.2s ease-out;
    }

    #sell-subcategory.hidden, #rental-subcategory.hidden {
      opacity: 0;
      transform: translateY(-10px);
      pointer-events: none;
    }

    #sell-subcategory:not(.hidden), #rental-subcategory:not(.hidden) {
      opacity: 1;
      transform: translateY(0);
    }

    /* 화살표 애니메이션 */
    #sell-arrow, #rental-arrow {
      transition: transform 0.2s ease-out;
    }
    </style>

  {% else %}
    <!-- 덕담: 간단한 카테고리 필터 (드롭다운 없음) -->
    <div class="flex flex-wrap gap-2 mb-6 text-sm font-medium">
      {% for label, value, url in category_urls %}
        <a href="{{ url }}"
            class="px-3 py-1 rounded-full border
                    {% if category == value or not category and value == '' %}
                    bg-black text-white
                    {% else %}
                    bg-white text-gray-700 hover:bg-gray-100
                    {% endif %}">
            {{ label }}
        </a>
      {% endfor %}
    </div>
  {% endif %}
</div>