{# components/post_detail/_comments.html #}
{% load humanize %}
<div class="space-y-1 mb-4">
  {% for comment in comments %}
    <div class="text-sm py-2 border-t">
      <!-- 댓글 작성자 & 시간 -->
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-2">
          <a href="{% url 'accounts:profile' comment.user.username %}">
            <img src="{{ comment.user.profile_image.url }}" alt="{{ comment.user.username }}" class="w-8 h-8 rounded-full object-cover" />
          </a>
          <a href="{% url 'accounts:profile' comment.user.username %}" class="font-semibold">
            {{ comment.user.username }}
          </a>
          <span class="text-gray-400">· {{ comment.created_at|naturaltime }}</span>
        </div>
        {% if comment.user == request.user %}
          <a href="{% url comment_delete_url category=category post_id=post.id comment_id=comment.id %}"
             class="text-red-500 text-sm hover:underline">삭제</a>
        {% endif %}
      </div>

      <!-- 댓글 본문 -->
      <p class="text-gray-700 mt-1">{{ comment.content }}</p>

      {% if not comment.parent %}
        <!-- 대댓글 작성 폼 열기 -->
        <div class="text-sm text-gray-500 mt-1">
          <a href="javascript:void(0);" class="hover:underline" onclick="showReplyForm({{ comment.id }})">댓글</a>
        </div>

        <!-- 대댓글 작성 폼 -->
        <form method="POST"
              action="{% url comment_create_url category=category post_id=post.id %}"
              class="hidden mt-2 ml-10" id="reply-form-{{ comment.id }}">
          {% csrf_token %}
          <input type="hidden" name="parent" value="{{ comment.id }}">
          <div class="flex items-center space-x-2">
            <input type="text" name="content" required placeholder="댓글을 작성해주세요..."
                   class="flex-grow border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none">
            <button type="submit" class="bg-black text-white px-4 py-2 rounded text-sm hover:bg-gray-800">등록</button>
          </div>
        </form>
      {% endif %}

      <!-- 대댓글 반복 -->
      {% for reply in comment.replies.all %}
        <div class="mt-2 ml-6 py-2 border-t">
          <div class="flex justify-between items-center">
            <div class="flex items-center space-x-2">
              <a href="{% url 'accounts:profile' reply.user.username %}">
                <img src="{{ reply.user.profile_image.url }}" alt="{{ reply.user.username }}" class="w-8 h-8 rounded-full object-cover" />
              </a>
              <a href="{% url 'accounts:profile' reply.user.username %}" class="font-semibold">{{ reply.user.username }}</a>
              <span class="text-gray-400">· {{ reply.created_at|naturaltime }}</span>
            </div>
            {% if reply.user == request.user %}
              <a href="{% url comment_delete_url category=category post_id=post.id comment_id=reply.id %}"
                 class="text-red-500 text-sm hover:underline">삭제</a>
            {% endif %}
          </div>
          <p class="text-gray-700 mt-1">{{ reply.content }}</p>
        </div>
      {% endfor %}
    </div>
  {% empty %}
    <p class="text-sm text-gray-400 mt-4">등록된 댓글이 없습니다.</p>
  {% endfor %}
</div>
