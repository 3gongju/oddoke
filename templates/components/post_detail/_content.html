{# components/post_detail/_content.html #}
{% load humanize %}
{% load ddokfarm_filters %}
<div class="flex flex-col justify-start h-full">

  <!-- 덕팜: 거래 완료 토글 버튼 -->
  {% if is_ddokfarm %}
    {% if request.user == post.user %}
      <div class="flex gap-2 self-end mb-2">
        {% if category == 'split' %}
          <a href="{% url 'ddokfarm:manage_split_applications' category=category post_id=post.id %}"
            class="px-3 py-1 text-sm rounded bg-blue-500 hover:bg-blue-600 text-white">
            참여자 관리
          </a>
        {% endif %}
        
        <!-- 수정된 거래완료 버튼 -->
        {% if post.is_sold %}
          <button class="px-3 py-1 text-sm rounded transition bg-gray-300 text-gray-500 cursor-not-allowed" disabled>
            거래 완료됨
          </button>
        {% else %}
          <button onclick="showMarkAsSoldModal()" 
                  class="px-3 py-1 text-sm rounded transition bg-black hover:bg-gray-800 active:bg-gray-700 text-white">
            거래 완료로 변경
          </button>
        {% endif %}
      </div>
    {% endif %}
  {% endif %}

  <!-- 제목 -->
  <h2 class="text-lg font-bold mb-2">{{ post.title }}</h2>

  <!-- 유저명 + 시간 -->
  <div class="flex items-center text-sm mb-2 space-x-2">
    {% include 'components/post_detail/_user_profile.html' with user=post.user %}
    <p class="text-sm text-gray-500 mb-2">{{ post.created_at|smart_date }}</p>
  </div>

  <hr class="border-gray-300">

  <!-- 수정/삭제 버튼 - 본인일 경우 (거래 완료 시 수정 불가) -->
  {% if request.user == post.user %}
    <div class="flex justify-end space-x-2 mt-2">
      {% if post.is_sold %}
        <!-- 거래 완료된 경우: 수정 버튼 비활성화, 삭제만 가능 -->
        <span class="text-sm text-gray-400 cursor-not-allowed">수정 불가</span>
        <button type="button" 
                onclick="confirmDelete('{% url app_name|add:':post_delete' category=category post_id=post.id %}')"
                class="text-sm text-red-600 hover:underline bg-transparent border-none cursor-pointer">
          삭제
        </button>
      {% else %}
        <!-- 거래 진행 중인 경우: 수정/삭제 모두 가능 -->
        <a href="{% url app_name|add:':post_edit' category=category post_id=post.id %}"
           class="text-sm text-blue-600 hover:underline">수정</a>
        
        <button type="button" 
                onclick="confirmDelete('{% url app_name|add:':post_delete' category=category post_id=post.id %}')"
                class="text-sm text-red-600 hover:underline bg-transparent border-none cursor-pointer">
          삭제
        </button>
      {% endif %}
    </div>
  {% endif %}

  <!-- 내용 -->
  <div class="text-sm text-gray-800 whitespace-pre-line mb-4">
    {{ post.content }}
  </div>

  <!-- 정보 테이블 + 버튼 묶음 -->
  <div class="mt-auto space-y-4">    
    {% if extra_partial %}
      {% include extra_partial %}
    {% endif %}

    {% if buttons_partial %}
      {% include buttons_partial with is_owner=is_owner %}
    {% endif %}
  </div>
</div>

<!-- 거래완료 확인 모달 (덕팜이고 게시글 작성자이고 아직 거래완료되지 않았을 때만 포함) -->
{% if is_ddokfarm and request.user == post.user and not post.is_sold %}
<div id="markAsSoldModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl shadow-lg p-6 max-w-sm w-full mx-4">
    <div class="text-center">
      <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4">
        <svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.75 0a9 9 0 1 1 18 0 9 9 0 0 1-18 0Zm9 3.75h.008v.008H12v-.008Z" />
        </svg>
      </div>
      <h3 class="text-lg font-semibold text-gray-900 mb-2">거래완료 확인</h3>
      <p class="text-sm text-gray-600 mb-6">
        거래를 완료하시겠습니까?<br>
        <span class="text-red-500 font-medium">(거래완료는 되돌릴 수 없습니다.)</span>
      </p>
      
      <div class="flex gap-3">
        <button onclick="closeMarkAsSoldModal()" 
                class="flex-1 px-4 py-2 text-gray-500 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
          취소
        </button>
        <button onclick="confirmMarkAsSold()" 
                class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
          확인
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- 삭제 확인 JavaScript 함수 추가 -->
<script>
async function confirmDelete(deleteUrl) {
  try {
    // 1단계: 삭제 가능 여부 확인
    const checkResponse = await fetch(deleteUrl, {
      method: 'GET',
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });
    
    const checkData = await checkResponse.json();
    
    if (!checkData.can_delete) {
      showDeleteBlockedModal(checkData);
      return;
    }
    
    // 2단계: 삭제 확인 모달
    showDeleteConfirmModal(deleteUrl);
    
  } catch (error) {
    console.error('삭제 처리 중 오류:', error);
    alert('삭제 처리 중 문제가 발생했습니다.');
  }
}

function showDeleteBlockedModal(data) {
  const modal = document.createElement('div');
  modal.id = 'deleteBlockedModal';
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-xl p-6 max-w-md mx-4 shadow-xl">
      <div class="text-center mb-4">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
          <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.728-.833-2.498 0L4.316 16.5c-.77.833.192 2.5 1.732 2.5z" />
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">삭제할 수 없습니다</h3>
      </div>
      
      <p class="text-gray-600 mb-4">${data.message}</p>
      <p class="text-sm text-gray-500 mb-6">거래를 완료하거나 취소한 후 삭제해주세요.</p>
      
      <button onclick="closeModal('deleteBlockedModal')" 
              class="w-full px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
        확인
      </button>
    </div>
  `;
  
  document.body.appendChild(modal);
}

function showDeleteConfirmModal(deleteUrl) {
  const modal = document.createElement('div');
  modal.id = 'deleteConfirmModal';
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-xl p-6 max-w-sm mx-4 shadow-xl">
      <div class="text-center">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
          <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">게시글 삭제</h3>
        <p class="text-gray-600 mb-6">
          정말 삭제하시겠습니까?<br>
          <span class="text-red-500 font-medium">삭제된 게시글은 복구할 수 없습니다.</span>
        </p>
        
        <div class="flex gap-3">
          <button onclick="closeModal('deleteConfirmModal')" 
                  class="flex-1 px-4 py-2 text-gray-500 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
            취소
          </button>
          <button onclick="executeDelete('${deleteUrl}')" 
                  class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
            삭제
          </button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

async function executeDelete(deleteUrl) {
  try {
    const response = await fetch(deleteUrl, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCsrfToken(),
        'X-Requested-With': 'XMLHttpRequest',
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      window.location.href = data.redirect_url;
    } else {
      closeModal('deleteConfirmModal');
      alert(data.message || '삭제에 실패했습니다.');
    }
  } catch (error) {
    closeModal('deleteConfirmModal');
    alert('삭제 처리 중 문제가 발생했습니다.');
  }
}

function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.remove();
    document.body.style.overflow = 'auto';
  }
}

function getCsrfToken() {
  return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
         document.querySelector('meta[name=csrf-token]')?.content ||
         window.csrfToken;
}
</script>