{# components/post_detail/_content.html #}
{% load humanize %}
{% load ddokfarm_filters %}
<div class="flex flex-col justify-start h-full">
  <!-- ë•íŒœ: ê±°ë˜ ì™„ë£Œ ë²„íŠ¼ (ìˆ˜ì •ëœ ë¶€ë¶„) -->
  {% if is_ddokfarm %}
    {% if request.user == post.user %}
      <div class="flex gap-2 self-end mb-2">
        {% if category == 'split' %}
          <a href="{% url 'ddokfarm:manage_split_applications' category=category post_id=post.id %}"
            class="px-3 py-1 text-sm rounded bg-blue-500 hover:bg-blue-600 text-white">
            ì°¸ì—¬ì ê´€ë¦¬
          </a>
        {% endif %}
        
        <!-- ğŸ”¥ ìˆ˜ì •ëœ ê±°ë˜ì™„ë£Œ ë²„íŠ¼ (í† ê¸€ â†’ ì™„ë£Œë§Œ) -->
        {% if post.is_sold %}
          <span class="px-3 py-1 text-sm rounded bg-green-100 text-green-800 font-medium border border-green-200 flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            </svg>
            ê±°ë˜ ì™„ë£Œë¨
          </span>
        {% else %}
          <button onclick="showMarkAsSoldModal()" 
                  class="px-3 py-1 text-sm rounded transition bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-medium">
            ê±°ë˜ ì™„ë£Œ ì²˜ë¦¬
          </button>
        {% endif %}
      </div>
    {% endif %}
  {% endif %}

  <!-- ì œëª© -->
  <h2 class="text-lg font-bold mb-2">{{ post.title }}</h2>

  <!-- ìœ ì €ëª… + ì‹œê°„ -->
  <div class="flex items-center text-sm mb-2 space-x-2">
    {% include 'components/post_detail/_user_profile.html' with user=post.user %}
    <p class="text-sm text-gray-500 mb-2">{{ post.created_at|smart_date }}</p>
  </div>

  <hr class="border-gray-300">

  <!-- ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ - ë³¸ì¸ì¼ ê²½ìš° (ê±°ë˜ ì™„ë£Œ ì‹œ ìˆ˜ì • ë¶ˆê°€) -->
  {% if request.user == post.user %}
    <div class="flex justify-end space-x-2 mt-2">
      {% if post.is_sold %}
        <!-- ê±°ë˜ ì™„ë£Œëœ ê²½ìš°: ìˆ˜ì • ë²„íŠ¼ ë¹„í™œì„±í™”, ì‚­ì œë§Œ ê°€ëŠ¥ -->
        <span class="text-sm text-gray-400 cursor-not-allowed">ìˆ˜ì • ë¶ˆê°€</span>
        <button type="button" 
                onclick="confirmDelete('{% url app_name|add:':post_delete' category=category post_id=post.id %}')"
                class="text-sm text-red-600 hover:underline bg-transparent border-none cursor-pointer">
          ì‚­ì œ
        </button>
      {% else %}
        <!-- ê±°ë˜ ì§„í–‰ ì¤‘ì¸ ê²½ìš°: ìˆ˜ì •/ì‚­ì œ ëª¨ë‘ ê°€ëŠ¥ -->
        <a href="{% url app_name|add:':post_edit' category=category post_id=post.id %}"
           class="text-sm text-blue-600 hover:underline">ìˆ˜ì •</a>
        
        <button type="button" 
                onclick="confirmDelete('{% url app_name|add:':post_delete' category=category post_id=post.id %}')"
                class="text-sm text-red-600 hover:underline bg-transparent border-none cursor-pointer">
          ì‚­ì œ
        </button>
      {% endif %}
    </div>
  {% endif %}

  <!-- ë‚´ìš© -->
  <div class="text-sm text-gray-800 whitespace-pre-line mb-4">
    {{ post.content }}
  </div>

  <!-- ì •ë³´ í…Œì´ë¸” + ë²„íŠ¼ ë¬¶ìŒ -->
  <div class="mt-auto space-y-4">    
    {% if extra_partial %}
      {% include extra_partial %}
    {% endif %}

    {% if buttons_partial %}
      {% include buttons_partial with is_owner=is_owner %}
    {% endif %}
  </div>
</div>

<!-- ğŸ”¥ ìˆ˜ì •ëœ ê±°ë˜ì™„ë£Œ í™•ì¸ ëª¨ë‹¬ -->
{% if is_ddokfarm and request.user == post.user and not post.is_sold %}
<div id="markAsSoldModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl shadow-lg p-6 max-w-sm w-full mx-4">
    <div class="text-center">
      <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
        <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
        </svg>
      </div>
      <h3 class="text-lg font-semibold text-gray-900 mb-2">ê±°ë˜ì™„ë£Œ ì²˜ë¦¬</h3>
      <div class="text-sm text-gray-600 mb-6">
        <p class="mb-2">ê±°ë˜ë¥¼ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-left">
          <div class="flex items-start space-x-2">
            <svg class="w-4 h-4 text-yellow-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
            </svg>
            <div class="text-xs text-yellow-800">
              <p class="font-medium mb-1 flex items-center gap-1">
                ì£¼ì˜ì‚¬í•­
              </p>
              <ul class="space-y-1">
                <li>â€¢ ê±°ë˜ì™„ë£Œ í›„ì—ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</li>
                <li>â€¢ ëª¨ë“  ì±„íŒ…ë°©ì´ ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½ë©ë‹ˆë‹¤</li>
                <li>â€¢ ê²Œì‹œê¸€ ìˆ˜ì •ì´ ë¶ˆê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      
      <div class="flex gap-3">
        <button onclick="closeMarkAsSoldModal()" 
                class="flex-1 px-4 py-2 text-gray-500 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
          ì·¨ì†Œ
        </button>
        <button onclick="confirmMarkAsSold()" 
                class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors font-medium">
          ê±°ë˜ì™„ë£Œ ì²˜ë¦¬
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<script>
// CSRF í† í° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
function getCsrfToken() {
  const csrfCookie = document.cookie
    .split('; ')
    .find(row => row.startsWith('csrftoken='));
  
  if (csrfCookie) {
    return csrfCookie.split('=')[1];
  }
  
  const csrfMeta = document.querySelector('meta[name="csrf-token"]');
  if (csrfMeta) {
    return csrfMeta.getAttribute('content');
  }
  
  const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
  if (csrfInput) {
    return csrfInput.value;
  }
  
  return null;
}

// ì‚­ì œ í™•ì¸ í•¨ìˆ˜
async function confirmDelete(deleteUrl) {
  if (!deleteUrl) {
    alert('ì‚­ì œ URLì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  try {
    // 1. ë¨¼ì € ì‚­ì œ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
    const checkResponse = await fetch(deleteUrl, {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      }
    });

    const checkResult = await checkResponse.json();

    if (!checkResult.can_delete) {
      alert(checkResult.message || 'ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    // 2. ì‚­ì œ í™•ì¸
    if (confirm('ì •ë§ë¡œ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œ í›„ì—ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
      await continueDelete(deleteUrl);
    }
  } catch (error) {
    console.error('ì‚­ì œ í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
    // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ê¸°ë³¸ í™•ì¸ì°½ í‘œì‹œ
    if (confirm('ì •ë§ë¡œ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œ í›„ì—ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
      await continueDelete(deleteUrl);
    }
  }
}

// ì‹¤ì œ ì‚­ì œ í•¨ìˆ˜
async function continueDelete(deleteUrl) {
  try {
    const csrfToken = getCsrfToken();
    if (!csrfToken) {
      alert('CSRF í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
      return;
    }

    const response = await fetch(deleteUrl, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/json',
      }
    });

    const result = await response.json();

    if (result.success) {
      alert(result.message || 'ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      if (result.redirect_url) {
        window.location.href = result.redirect_url;
      } else {
        window.location.href = '/ddokfarm/';
      }
    } else {
      alert(result.message || 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  } catch (error) {
    console.error('ì‚­ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
    alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// ğŸ”¥ ê±°ë˜ì™„ë£Œ ëª¨ë‹¬ ê´€ë ¨ JavaScript í•¨ìˆ˜ë“¤
function showMarkAsSoldModal() {
  const modal = document.getElementById('markAsSoldModal');
  if (modal) {
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden'; // ìŠ¤í¬ë¡¤ ë°©ì§€
  }
}

function closeMarkAsSoldModal() {
  const modal = document.getElementById('markAsSoldModal');
  if (modal) {
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto'; // ìŠ¤í¬ë¡¤ ë³µì›
  }
}

async function confirmMarkAsSold() {
  const button = event.target;
  const originalText = button.textContent;
  
  try {
    // ë²„íŠ¼ ë¹„í™œì„±í™”
    button.disabled = true;
    button.textContent = 'ì²˜ë¦¬ ì¤‘...';
    
    // í˜„ì¬ URLì—ì„œ mark-as-sold URL ìƒì„±
    const currentUrl = window.location.pathname;
    const markAsSoldUrl = currentUrl.replace(/\/$/, '') + '/mark-as-sold/';
    
    // ì„œë²„ì— ìš”ì²­
    const response = await fetch(markAsSoldUrl, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCsrfToken(),
        'Content-Type': 'application/x-www-form-urlencoded',
      }
    });
    
    if (response.ok) {
      // ì„±ê³µ ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
      window.location.reload();
    } else {
      throw new Error('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  } catch (error) {
    console.error('ê±°ë˜ì™„ë£Œ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
    alert('ê±°ë˜ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    
    // ë²„íŠ¼ ë³µì›
    button.disabled = false;
    button.textContent = originalText;
  }
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.addEventListener('click', function(e) {
  const modal = document.getElementById('markAsSoldModal');
  if (modal && e.target === modal) {
    closeMarkAsSoldModal();
  }
});

// ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeMarkAsSoldModal();
  }
});
</script>