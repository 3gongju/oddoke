{# components/post_detail/_content.html #}
{% load humanize %}
{% load ddokfarm_filters %}
<div class="flex flex-col justify-start h-full">

  <!-- 덕팜: 거래 완료 토글 버튼 -->
  {% if is_ddokfarm %}
    {% if request.user == post.user %}
      <div class="flex gap-2 self-end mb-2">
        {% if category == 'split' %}
          <a href="{% url 'ddokfarm:manage_split_applications' category=category post_id=post.id %}"
            class="px-3 py-1 text-sm rounded bg-blue-500 hover:bg-blue-600 text-white">
            참여자 관리
          </a>
        {% endif %}
        
        <!-- 수정된 거래완료 버튼 -->
        {% if post.is_sold %}
          <button class="px-3 py-1 text-sm rounded transition bg-gray-300 text-gray-500 cursor-not-allowed" disabled>
            거래 완료됨
          </button>
        {% else %}
          <button onclick="showMarkAsSoldModal()" 
                  class="px-3 py-1 text-sm rounded transition bg-black hover:bg-gray-800 active:bg-gray-700 text-white">
            거래 완료로 변경
          </button>
        {% endif %}
      </div>
    {% endif %}
  {% endif %}

  <!-- 제목 -->
  <h2 class="text-lg font-bold mb-2">{{ post.title }}</h2>

  <!-- 유저명 + 시간 -->
  <div class="flex items-center text-sm mb-2 space-x-2">
    {% include 'components/post_detail/_user_profile.html' with user=post.user %}
    <p class="text-sm text-gray-500 mb-2">{{ post.created_at|smart_date }}</p>
  </div>

  <hr class="border-gray-300">

  <!-- ✅ 수정된 수정/삭제 버튼 - 본인일 경우 -->
  {% if request.user == post.user %}
    <div class="flex justify-end space-x-2 mt-2">
      <a href="{% url app_name|add:':post_edit' category=category post_id=post.id %}"
         class="text-sm text-blue-600 hover:underline">수정</a>
      
      <!-- ✅ 삭제 버튼을 JavaScript 함수로 변경 -->
      <button type="button" 
              onclick="confirmDelete('{% url app_name|add:':post_delete' category=category post_id=post.id %}')"
              class="text-sm text-red-600 hover:underline bg-transparent border-none cursor-pointer">
        삭제
      </button>
    </div>
  {% endif %}

  <!-- 내용 -->
  <div class="text-sm text-gray-800 whitespace-pre-line mb-4">
    {{ post.content }}
  </div>

  <!-- 정보 테이블 + 버튼 묶음 -->
  <div class="mt-auto space-y-4">    
    {% if extra_partial %}
      {% include extra_partial %}
    {% endif %}

    {% if buttons_partial %}
      {% include buttons_partial with is_owner=is_owner %}
    {% endif %}
  </div>
</div>

<!-- 거래완료 확인 모달 (덕팜이고 게시글 작성자이고 아직 거래완료되지 않았을 때만 포함) -->
{% if is_ddokfarm and request.user == post.user and not post.is_sold %}
<div id="markAsSoldModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl shadow-lg p-6 max-w-sm w-full mx-4">
    <div class="text-center">
      <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4">
        <svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.75 0a9 9 0 1 1 18 0 9 9 0 0 1-18 0Zm9 3.75h.008v.008H12v-.008Z" />
        </svg>
      </div>
      <h3 class="text-lg font-semibold text-gray-900 mb-2">거래완료 확인</h3>
      <p class="text-sm text-gray-600 mb-6">
        거래를 완료하시겠습니까?<br>
        <span class="text-red-500 font-medium">(거래완료는 되돌릴 수 없습니다.)</span>
      </p>
      
      <div class="flex gap-3">
        <button onclick="closeMarkAsSoldModal()" 
                class="flex-1 px-4 py-2 text-gray-500 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
          취소
        </button>
        <button onclick="confirmMarkAsSold()" 
                class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
          확인
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- ✅ 삭제 확인 JavaScript 함수 추가 -->
<script>
function confirmDelete(deleteUrl) {
  if (confirm('정말 삭제하시겠습니까?')) {
    // POST 요청을 위한 폼 생성
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = deleteUrl;
    
    // CSRF 토큰 추가
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                      document.querySelector('meta[name=csrf-token]')?.content ||
                      window.csrfToken;
    
    if (csrfToken) {
      const csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'csrfmiddlewaretoken';
      csrfInput.value = csrfToken;
      form.appendChild(csrfInput);
    }
    
    // 폼을 body에 추가하고 전송
    document.body.appendChild(form);
    form.submit();
  }
}
</script>