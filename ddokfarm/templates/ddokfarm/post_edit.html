{% extends 'base.html' %}

{% block body %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
  {% include 'components/_farm_header.html' %}

  <form method="post" enctype="multipart/form-data" class="w-full max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-lg space-y-6" id="edit-form">
    {% csrf_token %}
    <input type="hidden" name="category" id="selected-category" value="{{ category }}">

    <!-- 아티스트 선택 -->
    <div>
      <label for="artist" class="block text-sm font-medium text-gray-700 mb-1">아티스트 선택</label>
      <select name="artist" id="artist" class="w-full px-3 py-2 border rounded">
        {% if not post.artist %}
          <option value="" selected hidden>아티스트를 선택하세요</option>
        {% endif %}
        {% for artist in sorted_artists %}
          <option value="{{ artist.id }}"
            {% if post.artist.id == artist.id %}selected{% endif %}>
            {{ artist.display_name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- 멤버 선택 -->
    <div id="member-wrapper" class="mt-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">멤버 선택</label>
      <div id="member-checkboxes">
        {% for member in selected_members %}
          <label class="block mb-2">
            <input type="checkbox" name="members" value="{{ member.id }}"
                  class="mr-2"
                  {% if member.id in selected_member_ids %}checked{% endif %}>
            {{ member.member_name }}
          </label>
        {% endfor %}
      </div>
    </div>
    
    <!-- 제목 -->
    <div>
      <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">제목</label>
      {{ form.title }}
      {% if form.title.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.title.errors.0 }}</p>
      {% endif %}
    </div>

    <!-- 내용 -->
    <div>
      <label for="{{ form.content.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">내용</label>
      {{ form.content }}
      {% if form.content.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.content.errors.0 }}</p>
      {% endif %}
    </div>

    <!-- 이미지 -->
    <div>
      <label for="{{ form.image.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">이미지 업로드</label>
      {{ form.image }}
      {% if form.image.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.image.errors.0 }}</p>
      {% endif %}

      {% if post.image %}
        <div id="original-image" class="mt-4">
            <p class="text-sm text-gray-500 mb-2">현재 이미지:</p>
            <img src="{{ post.image.url }}" alt="기존 이미지" class="max-h-64 rounded border" />
        </div>
      {% endif %}

      <div id="image-preview-container" class="mt-4">
        <img id="image-preview" src="#" alt="미리보기" class="hidden max-h-64 rounded border" />
      </div>
    </div>

    <!-- 카테고리별 필드 -->
    {% if category == 'sell' or category == 'rental' %}
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">가격</label>
        {{ form.price }}
        {% if form.price.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.price.errors.0 }}</p>
        {% endif %}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">거래 방식</label>
        {{ form.want_to }}
        {% if form.want_to.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.want_to.errors.0 }}</p>
        {% endif %}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">상품 상태</label>
        {{ form.condition }}
        {% if form.condition.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.condition.errors.0 }}</p>
        {% endif %}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">배송 방법</label>
        {{ form.shipping }}
        {% if form.shipping.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.shipping.errors.0 }}</p>
        {% endif %}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">직거래 희망 장소</label>
        {{ form.location }}
        {% if form.location.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.location.errors.0 }}</p>
        {% endif %}
      </div>
      {% if category == 'rental' %}
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">대여 시작일</label>
          {{ form.start_date }}
          {% if form.start_date.errors %}
            <p class="text-red-500 text-sm mt-1">{{ form.start_date.errors.0 }}</p>
          {% endif %}
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">대여 종료일</label>
          {{ form.end_date }}
          {% if form.end_date.errors %}
            <p class="text-red-500 text-sm mt-1">{{ form.end_date.errors.0 }}</p>
          {% endif %}
        </div>
      {% endif %}
    {% elif category == 'split' %}
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">앨범 포함 여부</label>
        {{ form.album }}
        {% if form.album.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.album.errors.0 }}</p>
        {% endif %}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">개봉 여부</label>
        {{ form.opened }}
        {% if form.opened.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.opened.errors.0 }}</p>
        {% endif %}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">재배송비</label>
        {{ form.shipping_fee }}
        {% if form.shipping_fee.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.shipping_fee.errors.0 }}</p>
        {% endif %}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">구매처</label>
        {{ form.where }}
        {% if form.where.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.where.errors.0 }}</p>
        {% endif %}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">구매예정일</label>
        {{ form.when }}
        {% if form.when.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.when.errors.0 }}</p>
        {% endif %}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">무산 여부</label>
        {{ form.failure }}
        {% if form.failure.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.failure.errors.0 }}</p>
        {% endif %}
      </div>
    {% endif %}

    <!-- 버튼 영역 -->
    <div class="flex justify-end space-x-2 pt-4 border-t">
      <a href="{% url 'ddokfarm:post_detail' category=category post_id=post.id %}"
         class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">
        취소
      </a>
      <button type="submit"
              class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
        수정 완료
      </button>
    </div>
  </form>
</div>

<script>
  // ✅ 기존에 선택된 멤버 ID들을 템플릿에서 전달 (장고 템플릿 상단에 삽입 필요)
  const selectedMemberIds = {{ selected_member_ids|safe }};

  document.addEventListener("DOMContentLoaded", function () {
    // ✅ 이미지 미리보기
    const fileInput = document.querySelector('input[type="file"][name="image"]');
    const preview = document.getElementById('image-preview');
    const original = document.getElementById('original-image');

    if (fileInput) {
      fileInput.addEventListener('change', function () {
        const file = this.files[0];
        if (file && file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function (e) {
            preview.src = e.target.result;
            preview.classList.remove('hidden');
            if (original) original.classList.add('hidden');
          };
          reader.readAsDataURL(file);
        } else {
          preview.src = '#';
          preview.classList.add('hidden');
          if (original) original.classList.remove('hidden');
        }
      });
    }

    // ✅ 아티스트 선택 시 멤버 목록 동적 로딩
    const artistSelect = document.getElementById('artist');
    const memberWrapper = document.getElementById('member-wrapper');
    const memberContainer = document.getElementById('member-checkboxes');

    function loadMembers(artistId) {
      memberContainer.innerHTML = '';
      memberWrapper.classList.add('hidden');
      if (!artistId) return;

      fetch(`/ddokfarm/ajax/members/${artistId}/`)
        .then(response => response.json())
        .then(data => {
          const members = data.members;
          if (members.length > 0) {
            memberWrapper.classList.remove('hidden');

            // ✅ 전체 선택 추가
            const selectAllId = 'select-all-members';
            const selectAllCheckbox = document.createElement('input');
            selectAllCheckbox.type = 'checkbox';
            selectAllCheckbox.id = selectAllId;
            selectAllCheckbox.classList.add('mr-2');

            const selectAllLabel = document.createElement('label');
            selectAllLabel.classList.add('block', 'mb-2', 'font-semibold');
            selectAllLabel.appendChild(selectAllCheckbox);
            selectAllLabel.appendChild(document.createTextNode('전체 선택'));
            memberContainer.appendChild(selectAllLabel);

            // ✅ 멤버 체크박스 렌더링
            members.forEach(member => {
              const id = `member_${member.id}`;
              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.name = 'members';
              checkbox.id = id;
              checkbox.value = member.id;
              checkbox.classList.add('mr-2', 'member-checkbox');

              // 🔥 선택된 멤버는 체크 처리
              if (selectedMemberIds.map(Number).includes(member.id)) {
                checkbox.checked = true;
              }

              const label = document.createElement('label');
              label.htmlFor = id;
              label.classList.add('block', 'mb-2');
              label.appendChild(checkbox);
              label.appendChild(document.createTextNode(member.name));
              memberContainer.appendChild(label);
            });

            // ✅ 전체 선택 제어 로직
            const memberCheckboxes = document.querySelectorAll('.member-checkbox');
            selectAllCheckbox.addEventListener('change', function () {
              memberCheckboxes.forEach(cb => cb.checked = this.checked);
            });
            memberCheckboxes.forEach(cb => {
              cb.addEventListener('change', function () {
                if (!this.checked) {
                  selectAllCheckbox.checked = false;
                } else {
                  const allChecked = Array.from(memberCheckboxes).every(cb => cb.checked);
                  selectAllCheckbox.checked = allChecked;
                }
              });
            });

            // ✅ 초기 상태에서 전체 체크인지 확인
            const allCheckedInit = Array.from(memberCheckboxes).every(cb => cb.checked);
            selectAllCheckbox.checked = allCheckedInit;
          }
        });
    }

    if (artistSelect) {
      artistSelect.addEventListener('change', function () {
        loadMembers(this.value);
      });

      if (artistSelect.value !== "") {
        loadMembers(artistSelect.value);
      }
    }
  });
</script>

{% endblock %}