{% extends 'base.html' %}

{% block body %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
  {% include 'components/_dam_header.html' %}

  <form method="post" enctype="multipart/form-data" class="w-full max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-lg space-y-6" id="edit-form">
    {% csrf_token %}

    <input type="hidden" name="category" id="selected-category" value="{{ category }}">

    <!-- 제목 -->
    <div>
      <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">제목</label>
      {{ form.title }}
      {% if form.title.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.title.errors.0 }}</p>
      {% endif %}
    </div>

    <!-- 내용 -->
    <div>
      <label for="{{ form.content.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">내용</label>
      {{ form.content }}
      {% if form.content.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.content.errors.0 }}</p>
      {% endif %}
    </div>

    <!-- 이미지 -->
    <div>
      <label for="{{ form.image.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">이미지 업로드</label>
      {{ form.image }}
      {% if form.image.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.image.errors.0 }}</p>
      {% endif %}

      {% if post.image %}
        <div id="original-image" class="mt-4">
            <p class="text-sm text-gray-500 mb-2">현재 이미지:</p>
            <img src="{{ post.image.url }}" alt="기존 이미지" class="max-h-64 rounded border" />
        </div>
      {% endif %}

      <div id="image-preview-container" class="mt-4">
        <img id="image-preview" src="#" alt="미리보기" class="hidden max-h-64 rounded border" />
      </div>
    </div>

    <!-- 카테고리별 필드 -->
    {% if category in 'sell,rental' %}
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">가격</label>
        {{ form.price }}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">거래 방식</label>
        {{ form.want_to }}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">상품 상태</label>
        {{ form.condition }}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">배송 방법</label>
        {{ form.shipping }}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">직거래 희망 장소</label>
        {{ form.location }}
      </div>
      {% if category == 'rental' %}
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">대여 시작일</label>
          {{ form.start_date }}
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">대여 종료일</label>
          {{ form.end_date }}
        </div>
      {% endif %}
    {% elif category == 'split' %}
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">앨범 포함 여부</label>
        {{ form.album }}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">개봉 여부</label>
        {{ form.opened }}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">재배송비</label>
        {{ form.shipping_fee }}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">구매처</label>
        {{ form.where }}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">구매예정일</label>
        {{ form.when }}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">무산 여부</label>
        {{ form.failure }}
      </div>
    {% endif %}

    <!-- 버튼 영역 -->
    <div class="flex justify-end space-x-2 pt-4 border-t">
      <a href="{% url 'ddokfarm:post_detail' category=category post_id=post.id %}"
         class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">
        취소
      </a>
      <button type="submit"
              class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
        수정 완료
      </button>
    </div>
  </form>
</div>

<!-- 이미지 미리보기 JS -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const fileInput = document.querySelector('input[type="file"][name="image"]');
    const preview = document.getElementById('image-preview');
    const original = document.getElementById('original-image');

    if (fileInput) {
      fileInput.addEventListener('change', function () {
        const file = this.files[0];
        if (file && file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function (e) {
            preview.src = e.target.result;
            preview.classList.remove('hidden');

            // 기존 이미지 숨기기
            if (original) {
              original.classList.add('hidden');
            }
          };
          reader.readAsDataURL(file);
        } else {
          preview.src = '#';
          preview.classList.add('hidden');
          if (original) {
            original.classList.remove('hidden');
          }
        }
      });
    }
  });
</script>
{% endblock %}
