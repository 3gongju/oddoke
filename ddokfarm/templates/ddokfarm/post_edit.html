{% extends 'base.html' %}

{% block body %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
  {% include 'components/_farm_header.html' %}

  <form method="post" enctype="multipart/form-data" class="w-full max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-lg space-y-6" id="edit-form">
    {% csrf_token %}
    <input type="hidden" name="category" id="selected-category" value="{{ category }}">

    <!-- ì•„í‹°ìŠ¤íŠ¸ ì„ íƒ -->
    <div>
      <label for="artist" class="block text-sm font-medium text-gray-700 mb-1">ì•„í‹°ìŠ¤íŠ¸ ì„ íƒ</label>
      <select name="artist" id="artist" class="w-full px-3 py-2 border rounded">
        {% if not post.artist %}
          <option value="" selected hidden>ì•„í‹°ìŠ¤íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
        {% endif %}
        {% for artist in sorted_artists %}
          <option value="{{ artist.id }}"
            {% if post.artist.id == artist.id %}selected{% endif %}>
            {{ artist.display_name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- ë©¤ë²„ ì„ íƒ -->
    <div id="member-wrapper" class="mt-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">ë©¤ë²„ ì„ íƒ</label>
      <div id="member-checkboxes">
        {% for member in selected_members %}
          <label class="block mb-2">
            <input type="checkbox" name="members" value="{{ member.id }}"
                  class="mr-2"
                  {% if member.id in selected_member_ids %}checked{% endif %}>
            {{ member.member_name }}
          </label>
        {% endfor %}
      </div>
    </div>
    
    <!-- ì œëª© -->
    <div>
      <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">ì œëª©</label>
      {{ form.title }}
      {% if form.title.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.title.errors.0 }}</p>
      {% endif %}
    </div>

    <!-- ë‚´ìš© -->
    <div>
      <label for="{{ form.content.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">ë‚´ìš©</label>
      {{ form.content }}
      {% if form.content.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.content.errors.0 }}</p>
      {% endif %}
    </div>

    <!-- ì´ë¯¸ì§€ -->
    <div>
      <label for="{{ form.image.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">ì´ë¯¸ì§€ ì—…ë¡œë“œ</label>
      {{ form.image }}
      {% if form.image.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.image.errors.0 }}</p>
      {% endif %}

      {% if post.image %}
        <div id="original-image" class="mt-4">
            <p class="text-sm text-gray-500 mb-2">í˜„ì¬ ì´ë¯¸ì§€:</p>
            <img src="{{ post.image.url }}" alt="ê¸°ì¡´ ì´ë¯¸ì§€" class="max-h-64 rounded border" />
        </div>
      {% endif %}

      <div id="image-preview-container" class="mt-4">
        <img id="image-preview" src="#" alt="ë¯¸ë¦¬ë³´ê¸°" class="hidden max-h-64 rounded border" />
      </div>
    </div>

    <!-- ì¹´í…Œê³ ë¦¬ë³„ í•„ë“œ -->
    {% if category == 'sell' or category == 'rental' %}
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">ê°€ê²©</label>
        {{ form.price }}
        {% if form.price.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.price.errors.0 }}</p>
        {% endif %}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">ê±°ë˜ ë°©ì‹</label>
        {{ form.want_to }}
        {% if form.want_to.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.want_to.errors.0 }}</p>
        {% endif %}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">ìƒí’ˆ ìƒíƒœ</label>
        {{ form.condition }}
        {% if form.condition.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.condition.errors.0 }}</p>
        {% endif %}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">ë°°ì†¡ ë°©ë²•</label>
        {{ form.shipping }}
        {% if form.shipping.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.shipping.errors.0 }}</p>
        {% endif %}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">ì§ê±°ë˜ í¬ë§ ì¥ì†Œ</label>
        {{ form.location }}
        {% if form.location.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.location.errors.0 }}</p>
        {% endif %}
      </div>
      {% if category == 'rental' %}
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ëŒ€ì—¬ ì‹œì‘ì¼</label>
          {{ form.start_date }}
          {% if form.start_date.errors %}
            <p class="text-red-500 text-sm mt-1">{{ form.start_date.errors.0 }}</p>
          {% endif %}
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ëŒ€ì—¬ ì¢…ë£Œì¼</label>
          {{ form.end_date }}
          {% if form.end_date.errors %}
            <p class="text-red-500 text-sm mt-1">{{ form.end_date.errors.0 }}</p>
          {% endif %}
        </div>
      {% endif %}
    {% elif category == 'split' %}
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">ì•¨ë²” í¬í•¨ ì—¬ë¶€</label>
        {{ form.album }}
        {% if form.album.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.album.errors.0 }}</p>
        {% endif %}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">ê°œë´‰ ì—¬ë¶€</label>
        {{ form.opened }}
        {% if form.opened.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.opened.errors.0 }}</p>
        {% endif %}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">ì¬ë°°ì†¡ë¹„</label>
        {{ form.shipping_fee }}
        {% if form.shipping_fee.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.shipping_fee.errors.0 }}</p>
        {% endif %}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">êµ¬ë§¤ì²˜</label>
        {{ form.where }}
        {% if form.where.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.where.errors.0 }}</p>
        {% endif %}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">êµ¬ë§¤ì˜ˆì •ì¼</label>
        {{ form.when }}
        {% if form.when.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.when.errors.0 }}</p>
        {% endif %}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">ë¬´ì‚° ì—¬ë¶€</label>
        {{ form.failure }}
        {% if form.failure.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.failure.errors.0 }}</p>
        {% endif %}
      </div>
    {% endif %}

    <!-- ë²„íŠ¼ ì˜ì—­ -->
    <div class="flex justify-end space-x-2 pt-4 border-t">
      <a href="{% url 'ddokfarm:post_detail' category=category post_id=post.id %}"
         class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">
        ì·¨ì†Œ
      </a>
      <button type="submit"
              class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
        ìˆ˜ì • ì™„ë£Œ
      </button>
    </div>
  </form>
</div>

<script>
  // âœ… ê¸°ì¡´ì— ì„ íƒëœ ë©¤ë²„ IDë“¤ì„ í…œí”Œë¦¿ì—ì„œ ì „ë‹¬ (ì¥ê³  í…œí”Œë¦¿ ìƒë‹¨ì— ì‚½ì… í•„ìš”)
  const selectedMemberIds = {{ selected_member_ids|safe }};

  document.addEventListener("DOMContentLoaded", function () {
    // âœ… ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
    const fileInput = document.querySelector('input[type="file"][name="image"]');
    const preview = document.getElementById('image-preview');
    const original = document.getElementById('original-image');

    if (fileInput) {
      fileInput.addEventListener('change', function () {
        const file = this.files[0];
        if (file && file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function (e) {
            preview.src = e.target.result;
            preview.classList.remove('hidden');
            if (original) original.classList.add('hidden');
          };
          reader.readAsDataURL(file);
        } else {
          preview.src = '#';
          preview.classList.add('hidden');
          if (original) original.classList.remove('hidden');
        }
      });
    }

    // âœ… ì•„í‹°ìŠ¤íŠ¸ ì„ íƒ ì‹œ ë©¤ë²„ ëª©ë¡ ë™ì  ë¡œë”©
    const artistSelect = document.getElementById('artist');
    const memberWrapper = document.getElementById('member-wrapper');
    const memberContainer = document.getElementById('member-checkboxes');

    function loadMembers(artistId) {
      memberContainer.innerHTML = '';
      memberWrapper.classList.add('hidden');
      if (!artistId) return;

      fetch(`/ddokfarm/ajax/members/${artistId}/`)
        .then(response => response.json())
        .then(data => {
          const members = data.members;
          if (members.length > 0) {
            memberWrapper.classList.remove('hidden');

            // âœ… ì „ì²´ ì„ íƒ ì¶”ê°€
            const selectAllId = 'select-all-members';
            const selectAllCheckbox = document.createElement('input');
            selectAllCheckbox.type = 'checkbox';
            selectAllCheckbox.id = selectAllId;
            selectAllCheckbox.classList.add('mr-2');

            const selectAllLabel = document.createElement('label');
            selectAllLabel.classList.add('block', 'mb-2', 'font-semibold');
            selectAllLabel.appendChild(selectAllCheckbox);
            selectAllLabel.appendChild(document.createTextNode('ì „ì²´ ì„ íƒ'));
            memberContainer.appendChild(selectAllLabel);

            // âœ… ë©¤ë²„ ì²´í¬ë°•ìŠ¤ ë Œë”ë§
            members.forEach(member => {
              const id = `member_${member.id}`;
              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.name = 'members';
              checkbox.id = id;
              checkbox.value = member.id;
              checkbox.classList.add('mr-2', 'member-checkbox');

              // ğŸ”¥ ì„ íƒëœ ë©¤ë²„ëŠ” ì²´í¬ ì²˜ë¦¬
              if (selectedMemberIds.map(Number).includes(member.id)) {
                checkbox.checked = true;
              }

              const label = document.createElement('label');
              label.htmlFor = id;
              label.classList.add('block', 'mb-2');
              label.appendChild(checkbox);
              label.appendChild(document.createTextNode(member.name));
              memberContainer.appendChild(label);
            });

            // âœ… ì „ì²´ ì„ íƒ ì œì–´ ë¡œì§
            const memberCheckboxes = document.querySelectorAll('.member-checkbox');
            selectAllCheckbox.addEventListener('change', function () {
              memberCheckboxes.forEach(cb => cb.checked = this.checked);
            });
            memberCheckboxes.forEach(cb => {
              cb.addEventListener('change', function () {
                if (!this.checked) {
                  selectAllCheckbox.checked = false;
                } else {
                  const allChecked = Array.from(memberCheckboxes).every(cb => cb.checked);
                  selectAllCheckbox.checked = allChecked;
                }
              });
            });

            // âœ… ì´ˆê¸° ìƒíƒœì—ì„œ ì „ì²´ ì²´í¬ì¸ì§€ í™•ì¸
            const allCheckedInit = Array.from(memberCheckboxes).every(cb => cb.checked);
            selectAllCheckbox.checked = allCheckedInit;
          }
        });
    }

    if (artistSelect) {
      artistSelect.addEventListener('change', function () {
        loadMembers(this.value);
      });

      if (artistSelect.value !== "") {
        loadMembers(artistSelect.value);
      }
    }
  });
</script>

{% endblock %}