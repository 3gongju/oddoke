{% extends 'base.html' %}
{% load static %}

{% block body %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
  {% include 'ddokfarm/components/_header.html' %}
  <div class="bg-white p-6 rounded-lg shadow-md max-w-5xl mx-auto">

    {% include 'components/post_detail/_artist_tags.html' %}

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- ì´ë¯¸ì§€ (2/3) -->
      <div class="md:col-span-2">
        {% include 'components/post_detail/_image.html' with is_sold=post.is_sold %}
      </div>

      <!-- ì½˜í…ì¸  (1/3) -->
      <div class="h-full">
        {% include 'components/post_detail/_content.html' with is_ddokfarm=True is_owner=is_owner extra_partial='ddokfarm/components/post_detail/_extra_info.html' buttons_partial='ddokfarm/components/post_detail/_buttons.html' %}
      </div>
    </div>

    {% include 'components/post_detail/_like_comment_info.html' %}

    <div class="comment-section mt-8">
      <div class="comment-list space-y-4">
        {% for comment in comments %}
          {% include "components/post_detail/_comment_list.html" with comment=comment is_reply=False %}
        {% endfor %}
      </div>
      {% include "components/post_detail/_comment_form.html" with action_url=comment_create_url parent_id=None %}
    </div>

  </div>
</div>

<script>
  // âœ… CSRF í† í°ì„ ì „ì—­ ë³€ìˆ˜ë¡œ ì„¤ì •
  window.csrfToken = "{{ csrf_token }}";
  
  document.addEventListener('DOMContentLoaded', function () {
    // ì¢‹ì•„ìš” ê¸°ëŠ¥
    const likeButtons = [
      document.getElementById('like-button'),
      document.getElementById('like-button-top')
    ];
    const likeCountEl = document.getElementById('like-count');
    const csrfToken = "{{ csrf_token }}";

    likeButtons.forEach(button => {
      if (!button) return;

      button.addEventListener('click', function () {
        fetch("{% url 'ddokfarm:like_post' category=category post_id=post.id %}", {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(res => {
          if (!res.ok) throw new Error('ìš”ì²­ ì‹¤íŒ¨');
          return res.json();
        })
        .then(data => {
          likeButtons.forEach(btn => {
            btn.dataset.liked = data.liked ? "true" : "false";
            
            // SVG ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
            const svgIcon = btn.querySelector('svg');
            if (svgIcon) {
              if (data.liked) {
                // ì±„ìš´ í•˜íŠ¸ SVGë¡œ ë³€ê²½
                svgIcon.setAttribute('fill', 'currentColor');
                svgIcon.removeAttribute('stroke');
                svgIcon.removeAttribute('stroke-width');
                svgIcon.innerHTML = '<path d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z" />';
              } else {
                // ë¹ˆ í•˜íŠ¸ SVGë¡œ ë³€ê²½
                svgIcon.setAttribute('fill', 'none');
                svgIcon.setAttribute('stroke', 'currentColor');
                svgIcon.setAttribute('stroke-width', '1.5');
                svgIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" />';
              }
            } else {
              // SVGê°€ ì—†ëŠ” ê²½ìš° (í•˜ë‹¨ ë²„íŠ¼ìš©) - ì´ëª¨í‹°ì½˜ ë°©ì‹ ìœ ì§€
              btn.innerHTML = data.liked ? "â¤ï¸" : "ğŸ¤";
            }
            
            // í…ìŠ¤íŠ¸ê°€ ìˆëŠ” ë²„íŠ¼ì˜ ê²½ìš° (ìƒë‹¨ ë²„íŠ¼)
            if (btn.id === 'like-button-top') {
              const textSpan = btn.querySelector('span:last-child') || btn.lastChild;
              if (textSpan && textSpan.nodeType === Node.TEXT_NODE) {
                // í…ìŠ¤íŠ¸ ë…¸ë“œê°€ ì§ì ‘ ìˆëŠ” ê²½ìš°
                btn.childNodes.forEach(node => {
                  if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
                    node.textContent = ' ì°œí•˜ê¸°';
                  }
                });
              } else if (btn.textContent.includes('ì°œí•˜ê¸°')) {
                // í…ìŠ¤íŠ¸ ì „ì²´ë¥¼ ë‹¤ì‹œ ì„¤ì •í•˜ì§€ ì•Šê³  SVGë§Œ ì—…ë°ì´íŠ¸
                // (ìœ„ì—ì„œ ì´ë¯¸ SVG ì—…ë°ì´íŠ¸ ì™„ë£Œ)
              }
            }
          });

          // í•˜ë‹¨ ë²„íŠ¼ ë³„ë„ ì²˜ë¦¬ (SVG ì—†ëŠ” ê²½ìš°)
          const bottomBtn = document.getElementById('like-button');
          if (bottomBtn && !bottomBtn.querySelector('svg')) {
            bottomBtn.innerHTML = data.liked ? "â¤ï¸" : "ğŸ¤";
          }

          if (likeCountEl) {
            likeCountEl.textContent = data.like_count;
          }
        })
        .catch(err => {
          console.error("ì°œ ì‹¤íŒ¨:", err);
          alert("ì°œ ì²˜ë¦¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
      });
    });

    // ì´ë¯¸ì§€ ìºëŸ¬ì…€ ì´ˆê¸°í™” (Swiper)
    if (typeof Swiper !== 'undefined') {
      new Swiper('.swiper-container', {
        loop: true,
        pagination: {
          el: '.swiper-pagination',
          clickable: true,
        },
        navigation: {
          nextEl: '.swiper-button-next',
          prevEl: '.swiper-button-prev',
        },
      });
    }
  });
</script>

<!-- âœ… ëŒ“ê¸€ ë¹„ë™ê¸° ì²˜ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ -->
<script src="{% static 'js/comment.js' %}"></script>
{% endblock %}