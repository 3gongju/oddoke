{# ë¶„ì²  ë©¤ë²„ë³„ ê°€ê²© #}
{% load humanize %}
<div class="border-t p-2 text-sm">
  <h2 class="font-bold mb-3 text-gray-800">ğŸ“Š ë¶„ì²  í˜„í™©</h2>

  <!-- ì”ì—¬ ë©¤ë²„ -->
  {% if participating_members %}
    <div class="mb-3">
      <div class="flex items-center mb-2">
        <span class="inline-flex items-center text-sm font-semibold text-green-700">
          <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
          ì”ì—¬
        </span>
      </div>
      <div class="flex flex-wrap gap-2">
        {% for member in participating_members %}
          <span class="inline-block bg-green-50 border border-green-200 text-green-800 rounded-full px-3 py-1 text-xs font-medium">
            {{ member.member_name }}
          </span>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <!-- ë§ˆê° ë©¤ë²„ -->
  <div class="mb-3">
    <div class="flex items-center mb-2">
      <span class="inline-flex items-center text-sm font-semibold text-gray-600">
        <span class="w-2 h-2 bg-gray-400 rounded-full mr-2"></span>
        ë§ˆê°
      </span>
    </div>
    <div class="flex flex-wrap gap-2">
      {% if checked_out_members %}
        {% for member in checked_out_members %}
          <span class="inline-block bg-gray-50 border border-gray-200 text-gray-700 rounded-full px-3 py-1 text-xs font-medium">
            {{ member.member_name }}
          </span>
        {% endfor %}
      {% else %}
        <span class="text-gray-500 text-xs">ì—†ìŒ</span>
      {% endif %}
    </div>
  </div>

  <!-- ì°¸ì—¬ ì‹ ì²­í•˜ê¸° ë²„íŠ¼ ë˜ëŠ” ë§ˆê° ë©”ì‹œì§€ -->
  <div class="mt-3 pt-2 border-t border-gray-200">
    {% if participating_members %}
      <button id="splitPriceBtn" 
              class="w-full bg-blue-50 hover:bg-blue-100 text-blue-700 font-medium py-2 px-3 rounded-lg transition-colors duration-200 text-sm">
        ğŸ’° ì°¸ì—¬ ì‹ ì²­í•˜ê¸°
      </button>
    {% else %}
      <div class="w-full bg-gray-100 text-gray-500 font-medium py-2 px-3 rounded-lg text-center text-sm">
        ğŸ”’ ëª¨ë“  ë©¤ë²„ê°€ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤
      </div>
    {% endif %}
  </div>
</div>

<!-- ì°¸ì—¬ ì‹ ì²­ ëª¨ë‹¬ (ì”ì—¬ ë©¤ë²„ê°€ ìˆì„ ë•Œë§Œ) -->
{% if participating_members %}
  <div id="splitPriceModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-lg max-w-md w-full mx-4 max-h-[90vh] flex flex-col">
      <!-- ëª¨ë‹¬ í—¤ë” -->
      <div class="bg-blue-600 text-white px-6 py-4 rounded-t-xl flex justify-between items-center flex-shrink-0">
        <h3 class="text-lg font-semibold">ğŸ’° ë¶„ì²  ì°¸ì—¬ ì‹ ì²­</h3>
        <button id="closePriceModal" class="text-white hover:text-gray-300 text-xl">Ã—</button>
      </div>

      <!-- ëª¨ë‹¬ ë‚´ìš© (ìŠ¤í¬ë¡¤ ê°€ëŠ¥) -->
      <div class="flex-1 overflow-y-auto">
        <div class="p-6">
          {% if member_prices %}
            <div class="mb-4">
              <p class="text-sm text-gray-600 mb-3">ì›í•˜ëŠ” ë©¤ë²„ë¥¼ í´ë¦­í•´ì£¼ì„¸ìš” (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)</p>
            </div>
            
            <form id="splitApplicationForm">
              {% csrf_token %}
              <div class="overflow-hidden rounded-lg border border-gray-200">
                <table class="w-full">
                  <thead class="bg-gray-50 sticky top-0">
                    <tr>
                      <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">ë©¤ë²„</th>
                      <th class="px-4 py-3 text-right text-sm font-medium text-gray-700">ê°€ê²©</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-200">
                    {% for sp in member_prices %}
                      <tr class="member-row cursor-pointer transition-colors duration-200 hover:bg-blue-50" 
                          data-member-id="{{ sp.member.id }}" 
                          data-member-name="{{ sp.member.member_name }}"
                          data-price="{{ sp.price }}">
                        <td class="px-4 py-3 text-sm text-gray-800 font-medium">{{ sp.member.member_name }}</td>
                        <td class="px-4 py-3 text-sm text-gray-800 text-right font-medium">{{ sp.price|intcomma }}ì›</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </form>
          {% else %}
            <div class="text-center py-8">
              <p class="text-gray-500">ì°¸ì—¬ ê°€ëŠ¥í•œ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- ëª¨ë‹¬ í‘¸í„° -->
      <div class="bg-gray-50 px-6 py-4 rounded-b-xl flex-shrink-0">
        {% if member_prices %}
          <button id="submitApplicationBtn" 
                  class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                  disabled>
            ì‹ ì²­í•˜ê¸°
          </button>
        {% else %}
          <button id="closePriceModalBtn" 
                  class="w-full bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg transition-colors">
            ë‹«ê¸°
          </button>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- JavaScript (ì”ì—¬ ë©¤ë²„ê°€ ìˆì„ ë•Œë§Œ) -->
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const splitPriceBtn = document.getElementById('splitPriceBtn');
    const splitPriceModal = document.getElementById('splitPriceModal');
    const closePriceModal = document.getElementById('closePriceModal');
    const submitApplicationBtn = document.getElementById('submitApplicationBtn');
    
    let selectedMembers = new Set(); // ì„ íƒëœ ë©¤ë²„ IDë“¤

    // ëª¨ë‹¬ ì—´ê¸°
    splitPriceBtn?.addEventListener('click', function() {
      splitPriceModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    });

    // ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
    function closeModal() {
      splitPriceModal.classList.add('hidden');
      document.body.style.overflow = 'auto';
      // ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
      selectedMembers.clear();
      document.querySelectorAll('.member-row').forEach(row => {
        row.classList.remove('bg-blue-100', 'border-blue-300');
        row.classList.add('hover:bg-blue-50');
      });
      updateSubmitButton();
    }

    // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸
    closePriceModal?.addEventListener('click', closeModal);

    // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
    splitPriceModal?.addEventListener('click', function(e) {
      if (e.target === splitPriceModal) {
        closeModal();
      }
    });

    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && !splitPriceModal.classList.contains('hidden')) {
        closeModal();
      }
    });

    // í–‰ í´ë¦­ ì´ë²¤íŠ¸
    document.querySelectorAll('.member-row').forEach(row => {
      row.addEventListener('click', function() {
        const memberId = this.dataset.memberId;
        
        if (selectedMembers.has(memberId)) {
          // ì„ íƒ í•´ì œ
          selectedMembers.delete(memberId);
          this.classList.remove('bg-blue-100', 'border-blue-300');
          this.classList.add('hover:bg-blue-50');
        } else {
          // ì„ íƒ
          selectedMembers.add(memberId);
          this.classList.add('bg-blue-100', 'border-blue-300');
          this.classList.remove('hover:bg-blue-50');
        }
        
        updateSubmitButton();
      });
    });

    // ì‹ ì²­í•˜ê¸° ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
    function updateSubmitButton() {
      if (submitApplicationBtn) {
        submitApplicationBtn.disabled = selectedMembers.size === 0;
      }
    }

    // ì‹ ì²­í•˜ê¸° ë²„íŠ¼ í´ë¦­
    submitApplicationBtn?.addEventListener('click', function() {
      if (selectedMembers.size === 0) {
        alert('ë©¤ë²„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      // ì„œë²„ë¡œ ì‹ ì²­ ë°ì´í„° ì „ì†¡
      const formData = new FormData();
      formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
      selectedMembers.forEach(id => formData.append('selected_members', id));

      fetch(`{% url 'ddokfarm:split_application' category=category post_id=post.id %}`, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
          closeModal();
          // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ì—…ë°ì´íŠ¸ëœ ìƒíƒœ ë°˜ì˜
          location.reload();
        } else {
          alert(data.message || 'ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      });
    });

    // ì´ˆê¸° ë²„íŠ¼ ìƒíƒœ ì„¤ì •
    updateSubmitButton();
  });
  </script>
{% endif %}