{% extends 'base.html' %}

{% block body %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
  {% include 'components/_farm_header.html' %}

  <!-- 카테고리 선택 버튼 -->
  <div class="flex justify-center gap-4 mb-8">
    <button type="button" class="category-btn px-4 py-2 rounded-lg transition
      {% if category == 'sell' %}bg-green-400 text-white shadow{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}"
      data-category="sell">구매/판매</button>

    <button type="button" class="category-btn px-4 py-2 rounded-lg transition
      {% if category == 'rental' %}bg-green-400 text-white shadow{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}"
      data-category="rental">대여</button>

    <button type="button" class="category-btn px-4 py-2 rounded-lg transition
      {% if category == 'split' %}bg-green-400 text-white shadow{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}"
      data-category="split">분철</button>
  </div>

  <!-- 작성 폼 -->
  <div class="flex justify-center">
    <form method="post" enctype="multipart/form-data" id="create-form"
          class="w-full max-w-2xl bg-white p-6 rounded-xl shadow-lg">
      {% csrf_token %}
      <input type="hidden" name="category" id="selected-category" value="{{ category|default:'sell' }}">

      <!-- 제목 -->
      <div class="mb-6">
        <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">제목</label>
        {{ form.title }}
        {% if form.title.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.title.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- 내용 -->
      <div class="mb-6">
        <label for="{{ form.content.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">내용</label>
        {{ form.content }}
        {% if form.content.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.content.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- 이미지 -->
      <div class="mb-6">
        <label for="{{ form.image.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">이미지 업로드</label>
        {{ form.image }}
        {% if form.image.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.image.errors.0 }}</p>
        {% endif %}

        <div id="image-preview-container" class="mt-4">
          <img id="image-preview" src="#" alt="이미지 미리보기" class="hidden max-h-64 rounded border" />
        </div>
      </div>

      <!-- 카테고리별 필드 -->
      {% if category in 'sell,rental' %}
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-1">가격</label>
          {{ form.price }}
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-1">거래 방식</label>
          {{ form.want_to }}
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-1">상품 상태</label>
          {{ form.condition }}
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-1">배송 방법</label>
          {{ form.shipping }}
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-1">직거래 희망 장소</label>
          {{ form.location }}
        </div>
        {% if category == 'rental' %}
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-1">대여 시작일</label>
            {{ form.start_date }}
          </div>
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-1">대여 종료일</label>
            {{ form.end_date }}
          </div>
        {% endif %}
      {% elif category == 'split' %}
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-1">앨범 포함 여부</label>
          {{ form.album }}
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-1">개봉 여부</label>
          {{ form.opened }}
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-1">재배송비</label>
          {{ form.shipping_fee }}
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-1">구매처</label>
          {{ form.where }}
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-1">구매예정일</label>
          {{ form.when }}
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-1">무산 여부</label>
          {{ form.failure }}
        </div>
      {% endif %}

      <!-- 버튼 -->
      <div class="mt-8 flex justify-end gap-2">
        <a href="{% url 'ddokfarm:index' %}" class="px-4 py-2 rounded border text-gray-700 hover:bg-gray-100">취소</a>
        <button type="submit" class="px-5 py-2 rounded bg-green-500 hover:bg-green-600 text-white font-semibold shadow">
          작성 완료
        </button>
      </div>
    </form>
  </div>
</div>

<!-- 스크립트 -->
<script>
  const buttons = document.querySelectorAll('.category-btn');
  const form = document.getElementById('create-form');
  const categoryInput = document.getElementById('selected-category');

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      const category = btn.dataset.category;
      categoryInput.value = category;
      form.submit();
    });
  });

  document.addEventListener("DOMContentLoaded", function () {
    const fileInput = document.querySelector('input[type="file"][name="image"]');
    const preview = document.getElementById('image-preview');

    fileInput.addEventListener('change', function () {
      const file = this.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function (e) {
          preview.src = e.target.result;
          preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      } else {
        preview.src = '#';
        preview.classList.add('hidden');
      }
    });
  });
</script>
{% endblock %}
