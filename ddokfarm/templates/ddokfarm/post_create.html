{% extends 'base.html' %}

{% block body %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
  {% include 'components/_farm_header.html' %}

  <!-- 카테고리 선택 버튼 -->
  <div class="flex justify-center gap-4 mb-8">
    <button type="button" class="category-btn px-4 py-2 rounded-lg transition
      {% if category == 'sell' %}bg-green-400 text-white shadow{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}"
      data-category="sell">구매/판매</button>

    <button type="button" class="category-btn px-4 py-2 rounded-lg transition
      {% if category == 'rental' %}bg-green-400 text-white shadow{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}"
      data-category="rental">대여</button>

    <button type="button" class="category-btn px-4 py-2 rounded-lg transition
      {% if category == 'split' %}bg-green-400 text-white shadow{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}"
      data-category="split">분철</button>
  </div>

  <!-- 작성 폼 -->
  <div class="flex justify-center">
    <form method="post" enctype="multipart/form-data" id="create-form"
          class="w-full max-w-2xl bg-white p-6 rounded-xl shadow-lg">
      {% csrf_token %}
      <input type="hidden" name="category" id="selected-category" value="{{ category|default:'sell' }}">

      <!-- 아티스트 선택 -->
      <div class="mb-6 relative">
        <label for="artist" class="block mb-1 text-sm font-medium">아티스트 선택</label>
        <select name="artist" id="artist" class="w-full px-3 py-2 border rounded">
          <option value="" {% if not default_artist_id %}selected{% endif %} hidden>아티스트를 선택하세요</option>
          {% for artist in sorted_artists %}
            <option value="{{ artist.id }}"
              {% if artist.id == default_artist_id %}selected{% endif %}>
              {{ artist.display_name }} ❤️
            </option>
          {% endfor %}
        </select>

        <!-- 검색용 input -->
        <input type="text" id="artist-search" placeholder="검색으로 아티스트 추가"
              class="mt-2 w-full px-3 py-2 border rounded" autocomplete="off" />
        <div id="artist-search-results" class="absolute w-full bg-white border mt-1 rounded shadow hidden z-10"></div>
      </div>

      <!-- 멤버 선택 (항상 렌더링, 처음엔 숨김) -->
      <div id="member-wrapper" class="mb-6 hidden">
        <label class="block text-sm font-medium text-gray-700 mb-2">멤버 선택</label>
        <div id="member-checkboxes"></div>
        {% if form.members.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.members.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- 제목 -->
      <div class="mb-6">
        <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">제목</label>
        {{ form.title }}
        {% if form.title.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.title.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- 내용 -->
      <div class="mb-6">
        <label for="{{ form.content.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">내용</label>
        {{ form.content }}
        {% if form.content.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.content.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- 이미지 -->
      <div class="mb-6">
        <label for="{{ form.image.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">이미지 업로드</label>
        {{ form.image }}
        {% if form.image.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.image.errors.0 }}</p>
        {% endif %}

        <!-- 미리보기 -->
        <div id="image-preview-container" class="mt-4">
          <img id="image-preview" src="#" alt="이미지 미리보기" class="hidden max-h-64 rounded border" />
        </div>
      </div>

      <!-- 카테고리별 필드 -->
      {% if category == 'sell' or category == 'rental' %}
        <div class="mb-6">
          <label for="{{ form.price.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">가격</label>
          {{ form.price }}
          {% if form.price.errors %}
            <p class="text-red-500 text-sm mt-1">{{ form.price.errors.0 }}</p>
          {% endif %}
        </div>
        <div class="mb-6">
          <label for="{{ form.want_to.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">거래 방식</label>
          {{ form.want_to }}
          {% if form.want_to.errors %}
            <p class="text-red-500 text-sm mt-1">{{ form.want_to.errors.0 }}</p>
          {% endif %}
        </div>
        <div class="mb-6">
          <label for="{{ form.condition.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">상품 상태</label>
          {{ form.condition }}
          {% if form.condition.errors %}
            <p class="text-red-500 text-sm mt-1">{{ form.condition.errors.0 }}</p>
          {% endif %}
        </div>
        <div class="mb-6">
          <label for="{{ form.shipping.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">배송 방법</label>
          {{ form.shipping }}
          {% if form.shipping.errors %}
            <p class="text-red-500 text-sm mt-1">{{ form.shipping.errors.0 }}</p>
          {% endif %}
        </div>
        <div class="mb-6">
          <label for="{{ form.location.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">직거래 희망 장소</label>
          {{ form.location }}
          {% if form.location.errors %}
            <p class="text-red-500 text-sm mt-1">{{ form.location.errors.0 }}</p>
          {% endif %}
        </div>

        {% if category == 'rental' %}
          <div class="mb-6">
            <label for="{{ form.start_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">대여 시작일</label>
            {{ form.start_date }}
            {% if form.start_date.errors %}
              <p class="text-red-500 text-sm mt-1">{{ form.start_date.errors.0 }}</p>
            {% endif %}
          </div>

          <div class="mb-6">
            <label for="{{ form.end_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">대여 종료일</label>
            {{ form.end_date }}
            {% if form.end_date.errors %}
              <p class="text-red-500 text-sm mt-1">{{ form.end_date.errors.0 }}</p>
            {% endif %}
          </div>
        {% endif %}

      {% elif category == 'split' %}
        <div class="mb-6">
          <label for="{{ form.album.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">앨범 포함 여부</label>
          {{ form.album }}
          {% if form.album.errors %}
            <p class="text-red-500 text-sm mt-1">{{ form.album.errors.0 }}</p>
          {% endif %}
        </div>
        <div class="mb-6">
          <label for="{{ form.opened.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">개봉 여부</label>
          {{ form.opened }}
          {% if form.opened.errors %}
            <p class="text-red-500 text-sm mt-1">{{ form.opened.errors.0 }}</p>
          {% endif %}
        </div>
        <div class="mb-6">
          <label for="{{ form.shipping_fee.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">재배송비</label>
          {{ form.shipping_fee }}
          {% if form.shipping_fee.errors %}
            <p class="text-red-500 text-sm mt-1">{{ form.shipping_fee.errors.0 }}</p>
          {% endif %}
        </div>
        <div class="mb-6">
          <label for="{{ form.where.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">구매처</label>
          {{ form.where }}
          {% if form.where.errors %}
            <p class="text-red-500 text-sm mt-1">{{ form.where.errors.0 }}</p>
          {% endif %}
        </div>
        <div class="mb-6">
          <label for="{{ form.when.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">구매예정일</label>
          {{ form.when }}
          {% if form.when.errors %}
            <p class="text-red-500 text-sm mt-1">{{ form.when.errors.0 }}</p>
          {% endif %}
        </div>
        <div class="mb-6">
          <label for="{{ form.failure.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">무산 여부</label>
          {{ form.failure }}
          {% if form.failure.errors %}
            <p class="text-red-500 text-sm mt-1">{{ form.failure.errors.0 }}</p>
          {% endif %}
        </div>
      {% endif %}

      <!-- 버튼 -->
      <div class="mt-8 flex justify-end gap-2">
        <a href="{% url 'ddokfarm:index' %}" class="px-4 py-2 rounded border text-gray-700 hover:bg-gray-100">취소</a>
        <button type="submit" class="px-5 py-2 rounded bg-green-500 hover:bg-green-600 text-white font-semibold shadow">
          작성 완료
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  const selectedMemberIds = {{ selected_member_ids|default:"[]"|safe }};

  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("artist-search");
    const resultBox = document.getElementById("artist-search-results");
    const selectBox = document.getElementById("artist");
    let currentFocus = -1;

    function highlightItem(index) {
      const items = resultBox.querySelectorAll("div");
      items.forEach((el, i) => {
        el.classList.toggle("bg-gray-200", i === index);
      });
    }

    function selectArtist(id, name) {
      if (![...selectBox.options].some(o => o.value == id)) {
        const newOption = new Option(name, id, true, true);
        selectBox.add(newOption);
      } else {
        selectBox.value = id;
      }
      resultBox.classList.add("hidden");
      searchInput.value = "";
      selectBox.dispatchEvent(new Event('change'));
    }

    searchInput.addEventListener("input", function () {
      const query = this.value.trim();
      if (!query) {
        resultBox.classList.add("hidden");
        resultBox.innerHTML = "";
        return;
      }

      fetch(`/ddokfarm/ajax/search_artists/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
          resultBox.innerHTML = "";
          data.results.forEach(artist => {
            const option = document.createElement("div");
            option.className = "px-3 py-2 hover:bg-gray-100 cursor-pointer";
            option.textContent = artist.name;
            option.dataset.artistId = artist.id;
            option.addEventListener("click", () => {
              selectArtist(artist.id, artist.name);
            });
            resultBox.appendChild(option);
          });
          currentFocus = -1;
          resultBox.classList.remove("hidden");
        });
    });

    searchInput.addEventListener("keydown", function (e) {
      const items = resultBox.querySelectorAll("div");
      if (!items.length) return;

      if (e.key === "ArrowDown") {
        e.preventDefault();
        currentFocus = (currentFocus + 1) % items.length;
        highlightItem(currentFocus);
      } else if (e.key === "ArrowUp") {
        e.preventDefault();
        currentFocus = (currentFocus - 1 + items.length) % items.length;
        highlightItem(currentFocus);
      } else if (e.key === "Enter") {
        e.preventDefault();
        if (currentFocus > -1 && items[currentFocus]) {
          const selected = items[currentFocus];
          selectArtist(selected.dataset.artistId, selected.textContent);
        }
      }
    });

    document.addEventListener("click", function (e) {
      if (!resultBox.contains(e.target) && e.target !== searchInput) {
        resultBox.classList.add("hidden");
      }
    });

    // ✅ 카테고리 버튼 자동 제출
    const buttons = document.querySelectorAll('.category-btn');
    const form = document.getElementById('create-form');
    const categoryInput = document.getElementById('selected-category');

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        categoryInput.value = btn.dataset.category;
        form.submit();
      });
    });

    // ✅ 이미지 미리보기
    const fileInput = document.querySelector('input[type="file"][name="image"]');
    const preview = document.getElementById('image-preview');

    if (fileInput) {
      fileInput.addEventListener('change', function () {
        const file = this.files[0];
        if (file && file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = e => {
            preview.src = e.target.result;
            preview.classList.remove('hidden');
          };
          reader.readAsDataURL(file);
        } else {
          preview.src = '#';
          preview.classList.add('hidden');
        }
      });
    }

    // ✅ 아티스트 변경 시 멤버 불러오기
    const artistSelect = document.getElementById('artist');
    const memberWrapper = document.getElementById('member-wrapper');
    const memberContainer = document.getElementById('member-checkboxes');

    function loadMembers(artistId) {
      memberContainer.innerHTML = '';
      memberWrapper.classList.add('hidden');
      if (!artistId) return;

      fetch(`/ddokfarm/ajax/members/${artistId}/`)
        .then(resp => resp.json())
        .then(data => {
          const members = data.members;
          if (!members.length) return;

          memberWrapper.classList.remove('hidden');

          const selectAllCheckbox = document.createElement('input');
          selectAllCheckbox.type = 'checkbox';
          selectAllCheckbox.classList.add('mr-2');

          const selectAllLabel = document.createElement('label');
          selectAllLabel.classList.add('block', 'mb-2', 'font-semibold');
          selectAllLabel.appendChild(selectAllCheckbox);
          selectAllLabel.appendChild(document.createTextNode('전체 선택'));
          memberContainer.appendChild(selectAllLabel);

          members.forEach(member => {
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = 'members';
            checkbox.id = `member_${member.id}`;
            checkbox.value = member.id;
            checkbox.classList.add('mr-2', 'member-checkbox');
            if (selectedMemberIds.map(Number).includes(member.id)) {
              checkbox.checked = true;
            }

            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.classList.add('block', 'mb-2');
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(member.name));
            memberContainer.appendChild(label);
          });

          const memberCheckboxes = memberContainer.querySelectorAll('.member-checkbox');
          selectAllCheckbox.addEventListener('change', function () {
            memberCheckboxes.forEach(cb => (cb.checked = this.checked));
          });
          memberCheckboxes.forEach(cb => {
            cb.addEventListener('change', () => {
              selectAllCheckbox.checked = Array.from(memberCheckboxes).every(cb => cb.checked);
            });
          });

          // ✅ 전체 선택 초기 체크 반영
          const allCheckedInit = Array.from(memberCheckboxes).every(cb => cb.checked);
          selectAllCheckbox.checked = allCheckedInit;
        })
        .catch(err => {
          console.error('멤버 불러오기 실패:', err);
          alert('멤버 목록을 불러오지 못했습니다. 잠시 후 다시 시도해주세요.');
        });
    }

    if (artistSelect) {
      artistSelect.addEventListener('change', () => loadMembers(artistSelect.value));
      if (artistSelect.value) loadMembers(artistSelect.value);
    }
  });
</script>
{% endblock %}