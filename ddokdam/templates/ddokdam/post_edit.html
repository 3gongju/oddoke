{% extends 'base.html' %}

{% block body %}
<div class="max-w-3xl mx-auto py-10 px-4">
  {% include 'components/_dam_header.html' %}

  <form method="post" enctype="multipart/form-data" class="bg-white p-6 rounded-xl shadow-lg space-y-6">
    {% csrf_token %}

    <!-- 제목 -->
    <div>
      <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">제목</label>
      {{ form.title }}
      {% if form.title.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.title.errors.0 }}</p>
      {% endif %}
    </div>

    <!-- 내용 -->
    <div>
      <label for="{{ form.content.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">내용</label>
      {{ form.content }}
      {% if form.content.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.content.errors.0 }}</p>
      {% endif %}
    </div>

    <!-- 이미지 -->
    <div>
      <label for="{{ form.image.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">이미지 업로드</label>
      {{ form.image }}
      {% if form.image.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.image.errors.0 }}</p>
      {% endif %}

      {% if post.image %}
        <div id="original-image" class="mt-4">
            <p class="text-sm text-gray-500 mb-2">현재 이미지:</p>
            <img src="{{ post.image.url }}" alt="기존 이미지" class="max-h-64 rounded border" />
        </div>
      {% endif %}

      <div id="image-preview-container" class="mt-4">
        <img id="image-preview" src="#" alt="미리보기" class="hidden max-h-64 rounded border" />
      </div>
    </div>

    <!-- 카테고리별 추가 필드 -->
    {% if category == 'manner' %}
      <div>
        <label for="{{ form.location.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">위치</label>
        {{ form.location }}
        {% if form.location.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.location.errors.0 }}</p>
        {% endif %}
      </div>

      <div>
        <label for="{{ form.item.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">예절템</label>
        {{ form.item }}
        {% if form.item.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.item.errors.0 }}</p>
        {% endif %}
      </div>
    {% elif category == 'bdaycafe' %}
      <div>
        <label for="{{ form.cafe_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">카페명</label>
        {{ form.cafe_name }}
        {% if form.cafe_name.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.cafe_name.errors.0 }}</p>
        {% endif %}
      </div>
    {% endif %}

    <!-- 버튼 영역 -->
    <div class="flex justify-end space-x-2 pt-4 border-t">
      <a href="{% url 'ddokdam:post_detail' category=category post_id=post.id %}"
         class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">
        취소
      </a>
      <button type="submit"
              class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">
        수정 완료
      </button>
    </div>
  </form>
</div>

<!-- 이미지 미리보기 JS -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const fileInput = document.querySelector('input[type="file"][name="image"]');
    const preview = document.getElementById('image-preview');
    const original = document.getElementById('original-image');

    if (fileInput) {
      fileInput.addEventListener('change', function () {
        const file = this.files[0];
        if (file && file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function (e) {
            preview.src = e.target.result;
            preview.classList.remove('hidden');

            // 기존 이미지 숨기기
            if (original) {
              original.classList.add('hidden');
            }
          };
          reader.readAsDataURL(file);
        } else {
          preview.src = '#';
          preview.classList.add('hidden');

          // 기존 이미지 다시 보여주기 (선택 취소 등)
          if (original) {
            original.classList.remove('hidden');
          }
        }
      });
    }
  });
</script>

{% endblock %}
