{% extends 'base.html' %}

{% block body %}
<div class="max-w-3xl mx-auto py-10 px-4">
  {% include 'components/_dam_header.html' %}

  <form method="post" enctype="multipart/form-data" class="bg-white p-6 rounded-xl shadow-lg space-y-6">
    {% csrf_token %}

    <!-- 아티스트 선택 -->
    <div>
      <label for="artist" class="block text-sm font-medium text-gray-700 mb-1">아티스트 선택</label>
      <select name="artist" id="artist" class="w-full px-3 py-2 border rounded">
        {% if not post.artist %}
          <option value="" selected hidden>아티스트를 선택하세요</option>
        {% endif %}
        {% for artist in sorted_artists %}
          <option value="{{ artist.id }}"
            {% if post.artist.id == artist.id %}selected{% endif %}>
            {{ artist.display_name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- 멤버 선택 -->
    <div id="member-wrapper" class="mt-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">멤버 선택</label>
      <div id="member-checkboxes">
        {% for member in selected_members %}
          <label class="block mb-2">
            <input type="checkbox" name="members" value="{{ member.id }}"
                  class="mr-2"
                  {% if member.id in selected_member_ids %}checked{% endif %}>
            {{ member.member_name }}
          </label>
        {% endfor %}
      </div>
    </div>

    <!-- 제목 -->
    <div>
      <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">제목</label>
      {{ form.title }}
      {% if form.title.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.title.errors.0 }}</p>
      {% endif %}
    </div>

    <!-- 내용 -->
    <div>
      <label for="{{ form.content.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">내용</label>
      {{ form.content }}
      {% if form.content.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.content.errors.0 }}</p>
      {% endif %}
    </div>

    <!-- 이미지 -->
    <div>
      <label for="{{ form.image.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">이미지 업로드</label>
      {{ form.image }}
      {% if form.image.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.image.errors.0 }}</p>
      {% endif %}

      {% if post.image %}
        <div id="original-image" class="mt-4">
            <p class="text-sm text-gray-500 mb-2">현재 이미지:</p>
            <img src="{{ post.image.url }}" alt="기존 이미지" class="max-h-64 rounded border" />
        </div>
      {% endif %}

      <div id="image-preview-container" class="mt-4">
        <img id="image-preview" src="#" alt="미리보기" class="hidden max-h-64 rounded border" />
      </div>
    </div>

    <!-- 카테고리별 추가 필드 -->
    {% if category == 'manner' %}
      <div>
        <label for="{{ form.location.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">위치</label>
        {{ form.location }}
        {% if form.location.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.location.errors.0 }}</p>
        {% endif %}
      </div>

      <div>
        <label for="{{ form.item.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">예절템</label>
        {{ form.item }}
        {% if form.item.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.item.errors.0 }}</p>
        {% endif %}
      </div>
    {% elif category == 'bdaycafe' %}
      <div>
        <label for="{{ form.cafe_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">카페명</label>
        {{ form.cafe_name }}
        {% if form.cafe_name.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.cafe_name.errors.0 }}</p>
        {% endif %}
      </div>
    {% endif %}

    <!-- 버튼 영역 -->
    <div class="flex justify-end space-x-2 pt-4 border-t">
      <a href="{% url 'ddokdam:post_detail' category=category post_id=post.id %}"
         class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">
        취소
      </a>
      <button type="submit"
              class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">
        수정 완료
      </button>
    </div>
  </form>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const fileInput = document.querySelector('input[type="file"][name="image"]');
    const preview = document.getElementById('image-preview');
    const original = document.getElementById('original-image');

    if (fileInput) {
      fileInput.addEventListener('change', function () {
        const file = this.files[0];
        if (file && file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function (e) {
            preview.src = e.target.result;
            preview.classList.remove('hidden');

            // 기존 이미지 숨기기
            if (original) {
              original.classList.add('hidden');
            }
          };
          reader.readAsDataURL(file);
        } else {
          preview.src = '#';
          preview.classList.add('hidden');

          // 기존 이미지 다시 보여주기 (선택 취소 등)
          if (original) {
            original.classList.remove('hidden');
          }
        }
      });
    }
  });
    document.addEventListener("DOMContentLoaded", function () {
    const artistSelect = document.getElementById('artist');
    const memberWrapper = document.getElementById('member-wrapper');
    const memberContainer = document.getElementById('member-checkboxes');

    function loadMembers(artistId) {
      memberContainer.innerHTML = '';
      memberWrapper.classList.add('hidden');

      if (!artistId) return;

      fetch(`/ddokdam/ajax/members/${artistId}/`)
        .then(response => response.json())
        .then(data => {
          const members = data.members;
          if (members.length > 0) {
            memberWrapper.classList.remove('hidden');

            // 전체 선택 추가
            const selectAllId = 'select-all-members';
            const selectAllCheckbox = document.createElement('input');
            selectAllCheckbox.type = 'checkbox';
            selectAllCheckbox.id = selectAllId;
            selectAllCheckbox.classList.add('mr-2');

            const selectAllLabel = document.createElement('label');
            selectAllLabel.classList.add('block', 'mb-2', 'font-semibold');
            selectAllLabel.appendChild(selectAllCheckbox);
            selectAllLabel.appendChild(document.createTextNode('전체 선택'));

            memberContainer.appendChild(selectAllLabel);

            // 멤버들 추가
            members.forEach(member => {
              const id = `member_${member.id}`;
              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.name = 'members';
              checkbox.id = id;
              checkbox.value = member.id;
              checkbox.classList.add('mr-2', 'member-checkbox');

              const label = document.createElement('label');
              label.htmlFor = id;
              label.classList.add('block', 'mb-2');
              label.appendChild(checkbox);
              label.appendChild(document.createTextNode(member.name));

              memberContainer.appendChild(label);
            });

            // 전체 선택 로직
            const memberCheckboxes = document.querySelectorAll('.member-checkbox');

            selectAllCheckbox.addEventListener('change', function () {
              memberCheckboxes.forEach(cb => cb.checked = this.checked);
            });

            memberCheckboxes.forEach(cb => {
              cb.addEventListener('change', function () {
                if (!this.checked) {
                  selectAllCheckbox.checked = false;
                } else {
                  const allChecked = Array.from(memberCheckboxes).every(cb => cb.checked);
                  selectAllCheckbox.checked = allChecked;
                }
              });
            });
          }
        });
    }

    if (artistSelect) {
      artistSelect.addEventListener('change', function () {
        loadMembers(this.value);
      });

      if (artistSelect.value !== "") {
        loadMembers(artistSelect.value);
      }
    }
  });
</script>

{% endblock %}
