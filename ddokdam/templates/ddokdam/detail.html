{% extends 'base.html' %}
{% load static humanize %}

{% block extra_css %}
<!-- manner ì¹´í…Œê³ ë¦¬ì¼ ë•Œë§Œ ìœ„ì¹˜ ì§€ë„ ìŠ¤íƒ€ì¼ ì¶”ê°€ -->
{% if category == 'manner' %}
<link rel="stylesheet" href="{% static 'css/ddokdam_location.css' %}">
{% endif %}
{% endblock %}

{% block body %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
  {% include 'ddokdam/components/_header.html' %}
  <div class="bg-white p-6 rounded-lg shadow-md max-w-5xl mx-auto">

    {% include 'components/post_detail/_artist_tags.html' %}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- ì´ë¯¸ì§€ (2/3) -->
      <div class="md:col-span-2">
        {% include 'components/post_detail/_image.html' %}
      </div>

      <!-- ì½˜í…ì¸  (1/3) -->
      <div>
        {% include 'components/post_detail/_content.html' with is_ddokdam=False extra_partial='ddokdam/components/post_detail/_extra_info.html' %}
      </div>
    </div>
    {% include 'components/post_detail/_like_comment_info.html' %}

    <!-- ì‹ ê³  ë²„íŠ¼ ì¶”ê°€ (ì‘ì„±ìê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ í‘œì‹œ) -->
    {% if user.is_authenticated and user != post.user %}
    <div class="flex justify-end mt-4">
      <div class="relative">
        <!-- ì‹ ê³  ë²„íŠ¼ -->
        <button id="report-btn" type="button" class="flex items-center space-x-2 px-3 py-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors duration-200">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
          </svg>
          <span class="text-sm">ì‹ ê³ </span>
        </button>
        <!-- ë“œë¡­ë‹¤ìš´ ë©”ë‰´ -->
        <div id="report-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-lg z-10">
          <button type="button" id="report-inappropriate-btn" class="w-full px-4 py-3 text-left text-red-600 hover:bg-red-50 rounded-lg transition-colors duration-200">
            <div class="flex items-center space-x-2">
              <!-- <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 3v1.5M3 21v-6m0 0 2.77-.693a9 9 0 0 1 6.208.682l.108.054a9 9 0 0 0 6.086.71L21 15.5v-4M3 15v-6" />
              </svg> -->
              <span class="text-sm font-medium">ë¶€ì ì ˆí•œ ê²Œì‹œë¬¼ ì‹ ê³ í•˜ê¸°</span>
            </div>
          </button>
        </div>
      </div>
    </div>
    {% endif %}
    
    <div class="comment-section mt-8">
      <div class="comment-list space-y-4">
        {% for comment in comments %}
          {% include "components/post_detail/_comment_list.html" with comment=comment is_reply=False %}
        {% endfor %}
      </div>
      {% include "components/post_detail/_comment_form.html" with action_url=comment_create_url parent_id=None %}
    </div>

  </div>
</div>

<!-- ì‹ ê³  ëª¨ë‹¬ -->
<div id="report-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
  <div class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md transform transition-all duration-300 scale-95 opacity-0" id="report-modal-content">
      <!-- ëª¨ë‹¬ í—¤ë” -->
      <div class="flex items-center justify-between p-6 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">ê²Œì‹œë¬¼ ì‹ ê³ </h3>
        <button type="button" id="close-report-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <!-- ëª¨ë‹¬ ë°”ë”” -->
      <div class="p-6">
        <div class="mb-4">
          <p class="text-sm text-gray-600 mb-4">ë¶€ì ì ˆí•œ ë‚´ìš©ì˜ ê²Œì‹œë¬¼ì„ ì‹ ê³ í•´ì£¼ì„¸ìš”. ì‹ ê³  ë‚´ìš©ì€ ê´€ë¦¬ìê°€ ê²€í†  í›„ ì¡°ì¹˜ë¥¼ ì·¨í•©ë‹ˆë‹¤.</p>
        </div>
        
        <form id="report-form" method="post" action="">
          {% csrf_token %}
          
          <!-- ì‹ ê³  ì‚¬ìœ  ì„ íƒ -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-3">ì‹ ê³  ì‚¬ìœ </label>
            <div class="space-y-3">
              <label class="flex items-start space-x-3 cursor-pointer">
                <input type="radio" name="reason" value="profanity" class="mt-1 h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300">
                <div>
                  <div class="text-sm font-medium text-gray-900">ìš•ì„¤, ë¶ˆì¾Œí•œ í‘œí˜„ ì‚¬ìš© / ê²Œì‹œê¸€ê³¼ ë¬´ê´€í•œ ë‚´ìš© ì‘ì„±</div>
                  <div class="text-xs text-gray-500">ëª¨ìš•ì ì´ê±°ë‚˜ ë¶ˆì¾Œê°ì„ ì£¼ëŠ” ì–¸ì–´ ì‚¬ìš©</div>
                </div>
              </label>
              
              <label class="flex items-start space-x-3 cursor-pointer">
                <input type="radio" name="reason" value="hate_spam" class="mt-1 h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300">
                <div>
                  <div class="text-sm font-medium text-gray-900">í˜ì˜¤ ë°œì–¸, ë°˜ë³µì  ê´‘ê³ , ì„ ì •ì  ë‚´ìš©</div>
                  <div class="text-xs text-gray-500">ì°¨ë³„ì  ë°œì–¸, ìŠ¤íŒ¸, ë¶€ì ì ˆí•œ ì„±ì  ë‚´ìš©</div>
                </div>
              </label>
              
              <label class="flex items-start space-x-3 cursor-pointer">
                <input type="radio" name="reason" value="illegal" class="mt-1 h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300">
                <div>
                  <div class="text-sm font-medium text-gray-900">ë¶ˆë²• ì½˜í…ì¸ , ë²”ì£„, ê°œì¸ì •ë³´ ë…¸ì¶œ</div>
                  <div class="text-xs text-gray-500">ë²•ì  ë¬¸ì œê°€ ìˆëŠ” ë‚´ìš©ì´ë‚˜ ê°œì¸ì •ë³´ ì¹¨í•´</div>
                </div>
              </label>

              <!-- ğŸ”¥ ìƒˆë¡œìš´ ì‹ ê³  ì‚¬ìœ  ì¶”ê°€ -->
              <label class="flex items-start space-x-3 cursor-pointer">
                <input type="radio" name="reason" value="irrelevant" class="mt-1 h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300">
                <div>
                  <div class="text-sm font-medium text-gray-900">ê´€ë ¨ì„±ì´ ë‚®ì€ ê²Œì‹œê¸€</div>
                  <div class="text-xs text-gray-500">ì¹´í…Œê³ ë¦¬ì™€ ë§ì§€ ì•Šê±°ë‚˜ ê´€ë ¨ì„±ì´ ë‚®ì€ ë‚´ìš©</div>
                </div>
              </label>
            </div>
          </div>
          
          <!-- ì¶”ê°€ ì„¤ëª… -->
          <div class="mb-6">
            <label for="additional_info" class="block text-sm font-medium text-gray-700 mb-2">ì¶”ê°€ ì„¤ëª… (ì„ íƒì‚¬í•­)</label>
            <textarea id="additional_info" name="additional_info" rows="3"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                      placeholder="ì¶”ê°€ë¡œ ì„¤ëª…í•  ë‚´ìš©ì´ ìˆë‹¤ë©´ ì‘ì„±í•´ì£¼ì„¸ìš”"></textarea>
          </div>
          
          <!-- ë²„íŠ¼ ê·¸ë£¹ -->
          <div class="flex space-x-3">
            <button type="button" id="cancel-report-btn"
                    class="flex-1 px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium transition-colors">
              ì·¨ì†Œ
            </button>
            <button type="submit" id="submit-report-btn"
                    class="flex-1 px-4 py-2 text-white bg-red-600 hover:bg-red-700 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
              ì‹ ê³ í•˜ê¸°
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ì‹ ê³  ì™„ë£Œ ëª¨ë‹¬ -->
<div id="report-success-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
  <div class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm transform transition-all duration-300">
      <div class="p-6 text-center">
        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤</h3>
        <p class="text-sm text-gray-600 mb-4">ê´€ë¦¬ìê°€ ê²€í†  í›„ ì ì ˆí•œ ì¡°ì¹˜ë¥¼ ì·¨í•˜ê² ìŠµë‹ˆë‹¤.</p>
        <button type="button" id="close-success-modal"
                class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
          í™•ì¸
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // CSRF í† í°ì„ ì „ì—­ ë³€ìˆ˜ë¡œ ì„¤ì •
  window.csrfToken = "{{ csrf_token }}";
  
  document.addEventListener('DOMContentLoaded', function () {
    const likeButton = document.getElementById('like-button');
    const likeCount = document.getElementById('like-count');
    const csrfToken = "{{ csrf_token }}";

    if (likeButton) {
      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ìƒíƒœ ì„¤ì •
      const isLiked = {{ is_liked|yesno:'true,false' }};
      updateButtonState(likeButton, isLiked);

      likeButton.addEventListener('click', function () {
        fetch("{% url 'ddokdam:like_post' category=category post_id=post.id %}", {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(res => res.json())
        .then(data => {
          updateButtonState(likeButton, data.liked);
          if (likeCount) {
            likeCount.textContent = data.like_count;
          }
        });
      });
    }

    // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateButtonState(button, isLiked) {
      button.dataset.liked = isLiked ? "true" : "false";
      
      const svgIcon = button.querySelector('svg');
      if (svgIcon) {
        if (isLiked) {
          // ì±„ìš´ í•˜íŠ¸ SVGë¡œ ë³€ê²½
          svgIcon.setAttribute('fill', 'currentColor');
          svgIcon.setAttribute('viewBox', '0 0 20 20');
          svgIcon.removeAttribute('stroke');
          svgIcon.removeAttribute('stroke-width');
          svgIcon.innerHTML = '<path d="m9.653 16.915-.005-.003-.019-.01a20.759 20.759 0 0 1-1.162-.682 22.045 22.045 0 0 1-2.582-1.9C4.045 12.733 2 10.352 2 7.5a4.5 4.5 0 0 1 8-2.828A4.5 4.5 0 0 1 18 7.5c0 2.852-2.044 5.233-3.885 6.82a22.049 22.049 0 0 1-3.744 2.582l-.019.01-.005.003h-.002a.739.739 0 0 1-.69.001l-.002-.001Z" />';
        } else {
          // ë¹ˆ í•˜íŠ¸ SVGë¡œ ë³€ê²½
          svgIcon.setAttribute('fill', 'none');
          svgIcon.setAttribute('viewBox', '0 0 24 24');
          svgIcon.setAttribute('stroke', 'currentColor');
          svgIcon.setAttribute('stroke-width', '1.5');
          svgIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" />';
        }
      }
    }

    // ì´ë¯¸ì§€ ìºëŸ¬ì…€ ì´ˆê¸°í™” (Swiper)
    if (typeof Swiper !== 'undefined') {
      new Swiper('.swiper-container', {
        loop: true,
        pagination: {
          el: '.swiper-pagination',
          clickable: true,
        },
        navigation: {
          nextEl: '.swiper-button-next',
          prevEl: '.swiper-button-prev',
        },
      });
    }

    // ì‹ ê³  ê¸°ëŠ¥ ê´€ë ¨ ìš”ì†Œë“¤
    const reportBtn = document.getElementById('report-btn');
    const reportDropdown = document.getElementById('report-dropdown');
    const reportInappropriateBtn = document.getElementById('report-inappropriate-btn');
    const reportModal = document.getElementById('report-modal');
    const reportModalContent = document.getElementById('report-modal-content');
    const closeReportModal = document.getElementById('close-report-modal');
    const cancelReportBtn = document.getElementById('cancel-report-btn');
    const reportForm = document.getElementById('report-form');
    const submitReportBtn = document.getElementById('submit-report-btn');
    const reportSuccessModal = document.getElementById('report-success-modal');
    const closeSuccessModal = document.getElementById('close-success-modal');

    // ì‹ ê³  ë²„íŠ¼ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ í† ê¸€
    if (reportBtn && reportDropdown) {
      reportBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        reportDropdown.classList.toggle('hidden');
      });

      // ë¬¸ì„œ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
      document.addEventListener('click', function(e) {
        if (!reportBtn.contains(e.target) && !reportDropdown.contains(e.target)) {
          reportDropdown.classList.add('hidden');
        }
      });
    }

    // "ë¶€ì ì ˆí•œ ê²Œì‹œë¬¼ ì‹ ê³ í•˜ê¸°" í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
    if (reportInappropriateBtn) {
      reportInappropriateBtn.addEventListener('click', function() {
        reportDropdown.classList.add('hidden');
        openReportModal();
      });
    }

    // ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜
    function openReportModal() {
      if (reportModal && reportModalContent) {
        reportModal.classList.remove('hidden');
        setTimeout(() => {
          reportModalContent.classList.remove('scale-95', 'opacity-0');
          reportModalContent.classList.add('scale-100', 'opacity-100');
        }, 10);
        
        // í¼ ì•¡ì…˜ URL ì„¤ì •
        if (reportForm) {
          reportForm.action = `{% url 'accounts:report_post' app_name='ddokdam' category=category post_id=post.id %}`;
        }
      }
    }

    // ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
    function closeReportModalFunction() {
      if (reportModal && reportModalContent) {
        reportModalContent.classList.remove('scale-100', 'opacity-100');
        reportModalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
          reportModal.classList.add('hidden');
          // í¼ ë¦¬ì…‹
          if (reportForm) {
            reportForm.reset();
          }
          // ì œì¶œ ë²„íŠ¼ í™œì„±í™”
          if (submitReportBtn) {
            submitReportBtn.disabled = false;
            submitReportBtn.textContent = 'ì‹ ê³ í•˜ê¸°';
          }
        }, 300);
      }
    }

    // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸ë“¤
    if (closeReportModal) {
      closeReportModal.addEventListener('click', closeReportModalFunction);
    }
    
    if (cancelReportBtn) {
      cancelReportBtn.addEventListener('click', closeReportModalFunction);
    }

    // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
    if (reportModal) {
      reportModal.addEventListener('click', function(e) {
        if (e.target === reportModal) {
          closeReportModalFunction();
        }
      });
    }

    // ì‹ ê³  í¼ ì œì¶œ
    if (reportForm) {
      reportForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(reportForm);
        const reason = formData.get('reason');
        
        if (!reason) {
          alert('ì‹ ê³  ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }

        // ì œì¶œ ë²„íŠ¼ ë¹„í™œì„±í™”
        submitReportBtn.disabled = true;
        submitReportBtn.textContent = 'ì‹ ê³  ì¤‘...';

        // AJAXë¡œ ì‹ ê³  ì œì¶œ
        fetch(reportForm.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': window.csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            closeReportModalFunction();
            showSuccessModal();
          } else {
            alert(data.message || 'ì‹ ê³  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            submitReportBtn.disabled = false;
            submitReportBtn.textContent = 'ì‹ ê³ í•˜ê¸°';
          }
        })
        .catch(error => {
          console.error('ì‹ ê³  ì˜¤ë¥˜:', error);
          alert('ì‹ ê³  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          submitReportBtn.disabled = false;
          submitReportBtn.textContent = 'ì‹ ê³ í•˜ê¸°';
        });
      });
    }

    // ì„±ê³µ ëª¨ë‹¬ í‘œì‹œ
    function showSuccessModal() {
      if (reportSuccessModal) {
        reportSuccessModal.classList.remove('hidden');
      }
    }

    // ì„±ê³µ ëª¨ë‹¬ ë‹«ê¸°
    if (closeSuccessModal) {
      closeSuccessModal.addEventListener('click', function() {
        reportSuccessModal.classList.add('hidden');
      });
    }

    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        if (!reportModal.classList.contains('hidden')) {
          closeReportModalFunction();
        }
        if (!reportSuccessModal.classList.contains('hidden')) {
          reportSuccessModal.classList.add('hidden');
        }
      }
    });
  });
</script>

<!-- manner ì¹´í…Œê³ ë¦¬ì¼ ë•Œë§Œ ì¹´ì¹´ì˜¤ë§µ API ë° ìœ„ì¹˜ ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ -->
{% if category == 'manner' and post.location %}
  
  <!-- ì¹´ì¹´ì˜¤ë§µ API í‚¤ ì„¤ì • -->
  <script>
    window.KAKAO_API_KEY = "{{ kakao_api_key|default:'YOUR_KAKAO_API_KEY'|escapejs }}";
    console.log('ë•ë‹´ ìƒì„¸ í˜ì´ì§€ ì¹´ì¹´ì˜¤ë§µ API í‚¤:', window.KAKAO_API_KEY ? 'ì„¤ì •ë¨' : 'ì—†ìŒ');
  </script>

  <!-- ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ (ì¡°ê±´ë¶€) -->
  {% if kakao_api_key %}
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_api_key }}&libraries=services" 
          onload="console.log('ë•ë‹´ ìƒì„¸ í˜ì´ì§€ ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ ì™„ë£Œ')" 
          onerror="console.error('ë•ë‹´ ìƒì„¸ í˜ì´ì§€ ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ ì‹¤íŒ¨')">
  </script>
  
  <!-- ìƒì„¸ í˜ì´ì§€ ìœ„ì¹˜ ì§€ë„ ëª¨ë“ˆ -->
  <script src="{% static 'js/post_form/detail_map.js' %}"></script>
  
  {% else %}
  <script>
  console.warn('ë•ë‹´ ìƒì„¸ í˜ì´ì§€: ì¹´ì¹´ì˜¤ API í‚¤ê°€ ì—†ì–´ ìœ„ì¹˜ ì§€ë„ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.');
  </script>
  {% endif %}

{% endif %}

<!-- ëŒ“ê¸€ ë¹„ë™ê¸° ì²˜ë¦¬ ìŠ¤í¬ë¦½íŠ¸ -->
<script src="{% static 'js/comment.js' %}"></script>
{% endblock %}