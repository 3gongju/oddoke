{% extends 'base.html' %}

{% block body %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
  {% include 'components/_dam_header.html' %}

  <!-- 카테고리 선택 버튼 -->
  <div class="flex justify-center gap-4 mb-8">
    <button type="button" class="category-btn px-4 py-2 rounded-lg transition
      {% if category == 'community' %}bg-yellow-400 text-white shadow{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}"
      data-category="community">덕담 한마디</button>

    <button type="button" class="category-btn px-4 py-2 rounded-lg transition
      {% if category == 'manner' %}bg-yellow-400 text-white shadow{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}"
      data-category="manner">예절 차리기</button>

    <button type="button" class="category-btn px-4 py-2 rounded-lg transition
      {% if category == 'bdaycafe' %}bg-yellow-400 text-white shadow{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}"
      data-category="bdaycafe">생카 후기</button>
  </div>

  <!-- 작성 폼 -->
  <div class="flex justify-center">
    <form method="post" enctype="multipart/form-data" id="create-form"
          class="w-full max-w-2xl bg-white p-6 rounded-xl shadow-lg">    
      {% csrf_token %}
      <input type="hidden" name="category" id="selected-category" value="{{ category|default:'community' }}">

      <!-- 아티스트 선택 -->
      <div class="mb-6">
        <label for="artist" class="block mb-1 text-sm font-medium">아티스트 선택</label>
          <select name="artist" id="artist" class="w-full px-3 py-2 border rounded">
            {% if not default_artist_id %}
              <!-- 선택되지 않은 초기 상태 -->
              <option value="" {% if not default_artist_id %}selected{% endif %} hidden>아티스트를 선택하세요</option>
            {% endif %}
            {% for artist in sorted_artists %}
              <option value="{{ artist.id }}"
                {% if artist.id == default_artist_id %}selected{% endif %}>
                {{ artist.display_name }}
              </option>
            {% endfor %}
          </select>
      </div>

      <!-- 멤버 선택 (항상 렌더링, 처음엔 숨김) -->
      <div id="member-wrapper" class="mb-6 hidden">
        <label class="block text-sm font-medium text-gray-700 mb-2">멤버 선택</label>
        <div id="member-checkboxes"></div>
        {% if form.members.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.members.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- 제목 -->
      <div class="mb-6">
        <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">제목</label>
        {{ form.title }} 
        {% if form.title.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.title.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- 내용 -->
      <div class="mb-6">
        <label for="{{ form.content.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">내용</label>
        {{ form.content }}
        {% if form.content.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.content.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- 이미지 -->
      <div class="mb-6">
        <label for="{{ form.image.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">이미지 업로드</label>
        {{ form.image }}
        {% if form.image.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.image.errors.0 }}</p>
        {% endif %}

        <!-- 미리보기 -->
        <div id="image-preview-container" class="mt-4">
          <img id="image-preview" src="#" alt="이미지 미리보기" class="hidden max-h-64 rounded border" />
        </div>
      </div>

      <!-- 카테고리별 필드 -->
      {% if category == 'manner' %}
        <div class="mb-6">
          <label for="{{ form.item.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">예절템</label>
          {{ form.item }}
          {% if form.item.errors %}
            <p class="text-red-500 text-sm mt-1">{{ form.item.errors.0 }}</p>
          {% endif %}
        </div>
        <div class="mb-6">
          <label for="{{ form.location.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">위치</label>
          {{ form.location }}
          {% if form.location.errors %}
            <p class="text-red-500 text-sm mt-1">{{ form.location.errors.0 }}</p>
          {% endif %}
        </div>

      {% elif category == 'bdaycafe' %}
        <div class="mb-6">
          <label for="{{ form.cafe_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">카페 이름</label>
          {{ form.cafe_name }}
          {% if form.cafe_name.errors %}
            <p class="text-red-500 text-sm mt-1">{{ form.cafe_name.errors.0 }}</p>
          {% endif %}
        </div>
      {% endif %}

      <!-- 버튼 -->
      <div class="mt-8 flex justify-end gap-2">
        <a href="{% url 'ddokdam:index' %}" class="px-4 py-2 rounded border text-gray-700 hover:bg-gray-100">취소</a>
        <button type="submit" class="px-5 py-2 rounded bg-yellow-500 hover:bg-yellow-600 text-white font-semibold shadow">
          작성 완료
        </button>
      </div>
    </form>

  </div>
</div>

<script>
  const selectedMemberIds = {{ selected_member_ids|default:"[]"|safe }};

document.addEventListener("DOMContentLoaded", function () {
  const buttons       = document.querySelectorAll('.category-btn');
  const form          = document.getElementById('create-form');
  const categoryInput = document.getElementById('selected-category');

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      categoryInput.value = btn.dataset.category;
      form.submit();
    });
  });

  const fileInput = document.querySelector('input[type="file"][name="image"]');
  const preview   = document.getElementById('image-preview');

  if (fileInput) {
    fileInput.addEventListener('change', function () {
      const file = this.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = e => {
          preview.src = e.target.result;
          preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      } else {
        preview.src = '#';
        preview.classList.add('hidden');
      }
    });
  }

  const artistSelect     = document.getElementById('artist');
  const memberWrapper    = document.getElementById('member-wrapper');
  const memberContainer  = document.getElementById('member-checkboxes');

  function loadMembers(artistId) {
    memberContainer.innerHTML = '';
    memberWrapper.classList.add('hidden');
    if (!artistId) return;

    fetch(`/ddokdam/ajax/members/${artistId}/`)
      .then(resp => resp.json())
      .then(data => {
        const members = data.members;
        if (!members.length) return;

        memberWrapper.classList.remove('hidden');

        const selectAllCheckbox = document.createElement('input');
        selectAllCheckbox.type = 'checkbox';
        selectAllCheckbox.classList.add('mr-2');

        const selectAllLabel = document.createElement('label');
        selectAllLabel.classList.add('block', 'mb-2', 'font-semibold');
        selectAllLabel.appendChild(selectAllCheckbox);
        selectAllLabel.appendChild(document.createTextNode('전체 선택'));
        memberContainer.appendChild(selectAllLabel);

        members.forEach(member => {
          const checkbox = document.createElement('input');
          checkbox.type  = 'checkbox';
          checkbox.name  = 'members';
          checkbox.id    = `member_${member.id}`;
          checkbox.value = member.id;
          checkbox.classList.add('mr-2', 'member-checkbox');

          // ✅ 체크 유지
          if (selectedMemberIds.map(Number).includes(member.id)) {
            checkbox.checked = true;
          }

          const label = document.createElement('label');
          label.htmlFor = checkbox.id;
          label.classList.add('block', 'mb-2');
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(member.name));

          memberContainer.appendChild(label);
        });

        const memberCheckboxes = memberContainer.querySelectorAll('.member-checkbox');
        selectAllCheckbox.addEventListener('change', function () {
          memberCheckboxes.forEach(cb => (cb.checked = this.checked));
        });
        memberCheckboxes.forEach(cb => {
          cb.addEventListener('change', () => {
            selectAllCheckbox.checked = Array.from(memberCheckboxes).every(cb => cb.checked);
          });
        });

        // ✅ 전체 선택 초기 체크 반영
        const allCheckedInit = Array.from(memberCheckboxes).every(cb => cb.checked);
        selectAllCheckbox.checked = allCheckedInit;
      })
      .catch(err => {
        console.error('멤버 불러오기 실패:', err);
        alert('멤버 목록을 불러오지 못했습니다. 잠시 후 다시 시도해주세요.');
      });
  }

  if (artistSelect) {
    artistSelect.addEventListener('change', () => loadMembers(artistSelect.value));
    if (artistSelect.value) loadMembers(artistSelect.value);
  }
});
</script>
{% endblock %}