{% extends "base.html" %}
{% load static %}
{% load filters %}

{% block title %}ë‚´ ë“±ë¡ ì¹´í˜ - ë•ìƒ{% endblock %}

{% block body %}
{% csrf_token %}
<section class="max-w-7xl mx-auto px-4 py-10">
  <h2 class="text-2xl font-bold mb-6"> ë‚´ê°€ ë“±ë¡í•œ ìƒì¼ì¹´í˜</h2>

  <script src="{% static 'js/autocomplete.js' %}"></script>

  <!--  ê²€ìƒ‰ í—¤ë” ì»´í¬ë„ŒíŠ¸ -->
  {% include 'ddoksang/components/_search_header.html' %}

  <!--  ê²€ìƒ‰ ë²”ìœ„ ì„ íƒ -->
  {% if query %}
  <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
    <div class="flex items-center justify-between">
      <div class="text-sm text-blue-800">
        '<span class="font-semibold">{{ query }}</span>' ê²€ìƒ‰ ê²°ê³¼ 
        <span class="bg-blue-100 px-2 py-1 rounded-full ml-2">{{ cafes.paginator.count }}ê°œ</span>
      </div>
      <div class="flex items-center space-x-3 text-sm">
        <span class="text-blue-700">ê²€ìƒ‰ ë²”ìœ„:</span>
        <a href="?q={{ query }}&scope=my{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.runtime %}&runtime={{ request.GET.runtime }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}" 
           class="px-3 py-1 rounded-full transition {% if search_scope == 'my' %}bg-blue-600 text-white{% else %}bg-white text-blue-600 hover:bg-blue-100{% endif %}">
          ë‚´ ì¹´í˜ë§Œ
        </a>
        <a href="{% url 'ddoksang:search' %}?q={{ query }}" 
           class="px-3 py-1 rounded-full bg-green-600 text-white hover:bg-green-700 transition">
          ì „ì²´ ì¹´í˜ ê²€ìƒ‰
        </a>
      </div>
    </div>
  </div>
  {% endif %}

  <!--  í†µê³„ ë° í•„í„° ì˜ì—­ -->
  <div class="py-6">
    <div class="mb-6">
      <p class="text-gray-600">ë“±ë¡í•œ ìƒì¼ì¹´í˜ë¥¼ ê´€ë¦¬í•˜ê³  í˜„í™©ì„ í™•ì¸í•˜ì„¸ìš”</p>
      <p class="text-sm text-gray-500 mt-1">ğŸ’¡ ìœ„ ê²€ìƒ‰ì°½ì—ì„œ ê²€ìƒ‰í•˜ë©´ ì „ì²´ ìƒì¹´ì—ì„œ ê²€ìƒ‰ë©ë‹ˆë‹¤</p>
    </div>

    <!-- í†µê³„ ì¹´ë“œ -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-gray-700">{{ stats.total }}</div>
        <div class="text-sm text-black">ì´ ë“±ë¡</div>
      </div>
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-yellow-600">{{ stats.pending }}</div>
        <div class="text-sm text-yellow-600">ìŠ¹ì¸ ëŒ€ê¸°</div>
      </div>
      <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-green-600">{{ stats.approved }}</div>
        <div class="text-sm text-green-600">ìŠ¹ì¸ë¨</div>
      </div>
      <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-red-600">{{ stats.rejected }}</div>
        <div class="text-sm text-red-600">ê±°ì ˆë¨</div>
      </div>
    </div>

    <!-- ìŠ¹ì¸ ìƒíƒœ í•„í„° -->
    {% if status_filters %}
      <div class="mb-6 border-b border-gray-200">
        <nav class="flex space-x-8">
          {% for filter in status_filters %}
            <a href="{{ filter.url }}"
               class="py-2 px-1 border-b-2 font-medium text-sm transition-colors {{ filter.active|yesno:'border-blue-500 text-blue-600,border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300' }}">
              {{ filter.text }}
            </a>
          {% endfor %}
        </nav>
      </div>
    {% endif %}

    <!-- ì¼ì • ìƒíƒœ í•„í„° -->
    {% if runtime_filters %}
      <div class="mb-6 border-b border-gray-100">
        <nav class="flex space-x-4">
          {% for filter in runtime_filters %}
            <a href="{{ filter.url }}"
               class="py-1.5 px-3 rounded-full text-sm border transition
               {% if filter.active %}
                 bg-black text-white border-black
               {% else %}
                 bg-white text-gray-600 border-gray-300 hover:bg-gray-100
               {% endif %}">
              {{ filter.text }}
            </a>
          {% endfor %}
        </nav>
      </div>
    {% endif %}
  </div>

  <!--  ì¹´í˜ ëª©ë¡ -->
  <div class="pb-10">
    {% if cafes %}
      <!-- ì •ë ¬ ì˜µì…˜ -->
      <div class="flex justify-between items-center mb-6">
        <div class="text-sm text-gray-600">
          {% if query %}
            "{{ query }}" ê²€ìƒ‰ ê²°ê³¼ {{ cafes.paginator.count }}ê°œ
          {% else %}
            ì´ {{ cafes.paginator.count }}ê°œì˜ ìƒì¼ì¹´í˜
          {% endif %}
        </div>
        <div class="flex items-center space-x-2">
          <span class="text-sm text-gray-600">ì •ë ¬:</span>
          <select class="text-sm border rounded px-2 py-1" onchange="location.href=this.value">
            <option value="?{% if query %}q={{ query }}&{% endif %}{% if request.GET.status %}status={{ request.GET.status }}&{% endif %}{% if request.GET.runtime %}runtime={{ request.GET.runtime }}&{% endif %}sort=latest" {% if request.GET.sort == 'latest' or not request.GET.sort %}selected{% endif %}>ìµœì‹ ìˆœ</option>
            <option value="?{% if query %}q={{ query }}&{% endif %}{% if request.GET.status %}status={{ request.GET.status }}&{% endif %}{% if request.GET.runtime %}runtime={{ request.GET.runtime }}&{% endif %}sort=oldest" {% if request.GET.sort == 'oldest' %}selected{% endif %}>ì˜¤ë˜ëœìˆœ</option>
            <option value="?{% if query %}q={{ query }}&{% endif %}{% if request.GET.status %}status={{ request.GET.status }}&{% endif %}{% if request.GET.runtime %}runtime={{ request.GET.runtime }}&{% endif %}sort=start_date" {% if request.GET.sort == 'start_date' %}selected{% endif %}>ì‹œì‘ì¼ìˆœ</option>
          </select>
        </div>
      </div>

      <!--  ì¹´í˜ ê·¸ë¦¬ë“œ ì»´í¬ë„ŒíŠ¸ -->
      {% include 'ddoksang/components/_cafe_grid.html' with cafes=cafes empty_message="ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤." show_admin_status=True show_status_badge=True show_preview=True show_favorite_btn=True user_favorites=user_favorites %}
      
      <!--  í˜ì´ì§€ë„¤ì´ì…˜ ì»´í¬ë„ŒíŠ¸ -->
      {% include 'ddoksang/components/_pagination.html' with paginated_object=cafes query=query extra_params=extra_params %}

    {% else %}
      <!-- ë¹ˆ ìƒíƒœ -->
      <div class="text-center py-12">
    
        <h3 class="text-lg font-medium text-gray-900 mb-2">
          {% if query %}ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤{% else %}ì•„ì§ ë“±ë¡í•œ ìƒì¼ì¹´í˜ê°€ ì—†ì–´ìš”{% endif %}
        </h3>
        <p class="text-gray-600 mb-6">
          {% if query %}
            ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¡œ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.
          {% else %}
            ì²« ìƒì¼ì¹´í˜ë¥¼ ë“±ë¡í•´ë³´ì„¸ìš”!
          {% endif %}
        </p>
        <a href="{% url 'ddoksang:create' %}" class="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
          + ìƒì¼ì¹´í˜ ë“±ë¡í•˜ê¸°
        </a>
      </div>
    {% endif %}
  </div>
</section>

<!-- ì°œí•˜ê¸° ê¸°ëŠ¥ ìŠ¤í¬ë¦½íŠ¸ -->
<script src="{% static 'js/favorite.js' %}"></script>

<script>
//  ê²€ìƒ‰ ì‹œ ê¸°ë³¸ì ìœ¼ë¡œ scope=my ì„¤ì •
document.addEventListener('DOMContentLoaded', function() {
  const searchForm = document.querySelector('#my-cafes-search').closest('form');
  
  searchForm.addEventListener('submit', function(e) {
    const queryInput = document.querySelector('#my-cafes-search');
    const query = queryInput.value.trim();
    
    if (query) {
      // scope íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ 'my' ì„¤ì •
      if (!document.querySelector('input[name="scope"]')) {
        const scopeInput = document.createElement('input');
        scopeInput.type = 'hidden';
        scopeInput.name = 'scope';
        scopeInput.value = 'my';
        searchForm.appendChild(scopeInput);
      }
    }
  });
});
</script>
{% endblock %}