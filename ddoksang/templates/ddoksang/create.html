{% extends "ddoksang/base/ddoksang_base.html" %}
{% load static %}

{% block body %}
<section class="max-w-4xl mx-auto px-4 py-10">
  <h1 class="text-2xl font-bold mb-6">ğŸ ìƒì¼ì¹´í˜ ë“±ë¡í•˜ê¸°</h1>
  <p class="text-sm text-gray-600 mb-8">ì¢‹ì•„í•˜ëŠ” ì•„í‹°ìŠ¤íŠ¸ì˜ ìƒì¼ì¹´í˜ ì •ë³´ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”!</p>

  <!-- Progress Bar -->
  <div class="w-full bg-gray-200 rounded-full h-2 mb-8 overflow-hidden">
    <div id="progressBar" class="bg-blue-600 h-2 w-0 transition-width duration-300"></div>
  </div>

  <form method="POST" enctype="multipart/form-data" id="multiStepForm" action="{% url 'ddoksang:create_submit' %}">
    {% csrf_token %}

    <!-- STEP 1: ì•„í‹°ìŠ¤íŠ¸/ë©¤ë²„ ê²€ìƒ‰ -->
    <div id="step-1" class="step">
      <label class="block text-sm font-medium mb-2">ì•„í‹°ìŠ¤íŠ¸/ë©¤ë²„ëª… ê²€ìƒ‰</label>
      <input type="text" id="artist-member-search" class="w-full border rounded px-4 py-2" placeholder="ë©¤ë²„ëª… ì…ë ¥" autocomplete="off" required>
      <ul id="artist-member-results" class="border mt-2 rounded overflow-hidden hidden max-h-48 overflow-y-auto"></ul>
      <input type="hidden" name="artist_id" id="artist_id" required>
      <input type="hidden" name="member_id" id="member_id" required>
    </div>

    <!-- STEP 2: ì¹´í˜ ì •ë³´ -->
    <div id="step-2" class="step hidden">
      <label class="block text-sm font-medium mb-2">ì¹´í˜ëª…</label>
      <input type="text" name="cafe_name" class="w-full border rounded px-4 py-2 mb-4" placeholder="ì¹´í˜ëª… ì…ë ¥" required>

      <label class="block text-sm font-medium mb-2">ì´ë²¤íŠ¸ ìœ í˜•</label>
      <select name="cafe_type" class="w-full border rounded px-4 py-2 mb-4" required>
        <option value="birthday">ğŸ‚ ìƒì¼</option>
        <option value="debut">ë°ë·”</option>
        <option value="comeback">ì»´ë°±</option>
        <option value="concert">ì½˜ì„œíŠ¸</option>
        <option value="other">ê¸°íƒ€</option>
      </select>

      <label class="block text-sm font-medium mb-2">ì£¼ì†Œ ê²€ìƒ‰</label>
      <div class="flex gap-2 mb-2">
        <input type="text" id="place-search" class="flex-grow border rounded px-4 py-2" placeholder="ì£¼ì†Œëª…ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off" required>
        <button type="button" id="searchBtn" class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700">ê²€ìƒ‰</button>
      </div>

      <div id="map" class="w-full h-64 bg-gray-100 rounded"></div>

      <ul id="place-results" class="mt-2 max-h-40 overflow-y-auto border rounded hidden"></ul>

      <div id="selected-place" class="mt-2 p-2 border rounded bg-green-50 hidden"></div>

      <input type="hidden" name="address" id="address" required>
      <input type="hidden" name="road_address" id="road_address" required>
      <input type="hidden" name="latitude" id="latitude" required>
      <input type="hidden" name="longitude" id="longitude" required>
      <input type="hidden" name="kakao_place_id" id="kakao_place_id" required>
    </div>

    <!-- STEP 3: ì¼ì • -->
    <div id="step-3" class="step hidden">
      <label class="block text-sm font-medium mb-1">ì‹œì‘ì¼</label>
      <input type="date" name="start_date" class="w-full border rounded p-2 mb-4" required>
      <label class="block text-sm font-medium mb-1">ì¢…ë£Œì¼</label>
      <input type="date" name="end_date" class="w-full border rounded p-2" required>
    </div>

    <!-- STEP 4: íŠ¹ì „ ë° ì´ë²¤íŠ¸ ì •ë³´ -->
    <div id="step-4" class="step hidden">
      <label class="block text-sm font-medium mb-2">íŠ¹ì „ ì •ë³´ (ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥)</label>
      <div class="grid grid-cols-3 gap-2 mb-4">
        <label class="inline-flex items-center space-x-2">
          <input type="checkbox" name="perks" value="í¬í† ì¹´ë“œ" class="rounded">
          <span>í¬í† ì¹´ë“œ</span>
        </label>
        <label class="inline-flex items-center space-x-2">
          <input type="checkbox" name="perks" value="ìŠ¤í‹°ì»¤" class="rounded">
          <span>ìŠ¤í‹°ì»¤</span>
        </label>
        <label class="inline-flex items-center space-x-2">
          <input type="checkbox" name="perks" value="ì²©ë³´ëŒ€" class="rounded">
          <span>ì²©ë³´ëŒ€</span>
        </label>
        <!-- ì¶”ê°€ í•­ëª© ë” ë„£ìœ¼ì„¸ìš” -->
      </div>

      <label class="block text-sm font-medium mb-2">ì´ë²¤íŠ¸ ì„¤ëª…</label>
      <textarea name="event_description" class="w-full border rounded p-2" rows="4" required></textarea>

      <input type="text" name="hashtags" class="w-full border rounded p-2 mt-2" placeholder="#íƒœê·¸1 #íƒœê·¸2">
    </div>

    <!-- STEP 5: ì¶œì²˜ ì •ë³´ -->
    <div id="step-5" class="step hidden">
      <label class="block text-sm font-medium mb-2">íŠ¸ìœ„í„° ë§í¬</label>
      <input type="url" name="twitter_source" class="w-full border rounded p-2" placeholder="https://twitter.com/">

      <label class="block text-sm font-medium mb-2 mt-4">ì¸ìŠ¤íƒ€ê·¸ë¨ ë§í¬</label>
      <input type="url" name="instagram_source" class="w-full border rounded p-2" placeholder="https://instagram.com/">
    </div>

    <!-- STEP 6: ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ìµœì¢… í™•ì¸ -->
    <div id="step-6" class="step hidden">
      <label class="block text-sm font-medium mb-2">ì´ë¯¸ì§€ ì—…ë¡œë“œ</label>
      <input type="file" name="images" id="images" multiple accept="image/*" class="w-full border rounded p-2 mb-4">

      <div id="image-preview" class="mt-2 flex flex-wrap gap-2"></div>

      <h3 class="font-semibold mt-6 mb-4">ì…ë ¥ ë‚´ìš©ì„ í™•ì¸í•˜ê³  ì œì¶œí•´ì£¼ì„¸ìš”.</h3>
      <ul class="text-sm text-gray-700 space-y-2">
        <li><strong>ì•„í‹°ìŠ¤íŠ¸/ë©¤ë²„:</strong> <span id="summary-name"></span></li>
        <li><strong>ì¹´í˜ ì£¼ì†Œ:</strong> <span id="summary-address"></span></li>
        <li><strong>ì¼ì •:</strong> <span id="summary-dates"></span></li>
        <li><strong>íŠ¹ì „ ì •ë³´:</strong> <span id="summary-perks"></span></li>
        <li><strong>ì„¤ëª…:</strong> <span id="summary-desc"></span></li>
        <li><strong>íŠ¸ìœ„í„°:</strong> <span id="summary-twitter"></span></li>
        <li><strong>ì¸ìŠ¤íƒ€ê·¸ë¨:</strong> <span id="summary-instagram"></span></li>
      </ul>
    </div>

    <div class="mt-6 flex justify-between">
      <button type="button" id="prevBtn" class="bg-gray-300 px-4 py-2 rounded">ì´ì „</button>
      <button type="button" id="nextBtn" class="bg-blue-500 text-white px-4 py-2 rounded">ë‹¤ìŒ</button>
    </div>
  </form>
</section>

<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_api_key }}&libraries=services"></script>

<script>
const steps = 6;
let currentStep = 1;

const nextBtn = document.getElementById("nextBtn");
const prevBtn = document.getElementById("prevBtn");
const progressBar = document.getElementById("progressBar");

function updateStepVisibility() {
  for (let i = 1; i <= steps; i++) {
    const stepDiv = document.getElementById(`step-${i}`);
    const inputs = stepDiv.querySelectorAll("input, textarea, select");
    if (i === currentStep) {
      stepDiv.classList.remove("hidden");
      inputs.forEach(el => el.disabled = false);
    } else {
      stepDiv.classList.add("hidden");
      inputs.forEach(el => el.disabled = true);
    }
  }
  // í”„ë¡œê·¸ë ˆìŠ¤ë°” ë„ˆë¹„ ì¡°ì •
  progressBar.style.width = `${(currentStep / steps) * 100}%`;

  // ë²„íŠ¼ ìƒíƒœ ì¡°ì •
  prevBtn.disabled = currentStep === 1;
  if (currentStep === steps) {
    nextBtn.textContent = "ì œì¶œ";
    nextBtn.type = "submit";
  } else {
    nextBtn.textContent = "ë‹¤ìŒ";
    nextBtn.type = "button";
  }
}

function validateStep() {
  const currentStepDiv = document.getElementById(`step-${currentStep}`);
  const requiredFields = currentStepDiv.querySelectorAll("[required]");
  for (const field of requiredFields) {
    if (!field.value.trim()) {
      field.focus();
      alert("í•„ìˆ˜ ì…ë ¥ë€ì„ ëª¨ë‘ ì±„ì›Œì£¼ì„¸ìš”.");
      return false;
    }
  }
  return true;
}

function updateSummary() {
  document.getElementById("summary-name").textContent = document.getElementById("artist-member-search").value;
  document.getElementById("summary-address").textContent = document.getElementById("address").value;
  const start = document.querySelector('[name="start_date"]').value;
  const end = document.querySelector('[name="end_date"]').value;
  document.getElementById("summary-dates").textContent = `${start} ~ ${end}`;

  const perks = [...document.querySelectorAll('input[name="perks"]:checked')].map(el => el.value);
  document.getElementById("summary-perks").textContent = perks.length > 0 ? perks.join(", ") : "(ì—†ìŒ)";

  document.getElementById("summary-desc").textContent = document.querySelector('[name="event_description"]').value || "(ì„¤ëª… ì—†ìŒ)";
  document.getElementById("summary-twitter").textContent = document.querySelector('[name="twitter_source"]').value || "(ì—†ìŒ)";
  document.getElementById("summary-instagram").textContent = document.querySelector('[name="instagram_source"]').value || "(ì—†ìŒ)";
}

nextBtn.addEventListener("click", () => {
  if (!validateStep()) return;

  if (currentStep < steps) {
    currentStep++;
    updateStepVisibility();

    if (currentStep === steps) {
      updateSummary();
    }
  }
});

prevBtn.addEventListener("click", () => {
  if (currentStep > 1) {
    currentStep--;
    updateStepVisibility();
  }
});

// ì´ˆê¸° ìƒíƒœ ì„¸íŒ…
updateStepVisibility();
</script>

<script>
// ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥
document.getElementById("images").addEventListener("change", function () {
  const previewContainer = document.getElementById("image-preview");
  previewContainer.innerHTML = "";
  Array.from(this.files).forEach(file => {
    const reader = new FileReader();
    reader.onload = function (e) {
      const img = document.createElement("img");
      img.src = e.target.result;
      img.className = "w-24 h-24 object-cover rounded border";
      previewContainer.appendChild(img);
    };
    reader.readAsDataURL(file);
  });
});
</script>

<script>
// ì•„í‹°ìŠ¤íŠ¸/ë©¤ë²„ ìë™ì™„ì„± ê¸°ëŠ¥
document.getElementById("artist-member-search").addEventListener("input", function () {
  const keyword = this.value.trim();
  const resultsBox = document.getElementById("artist-member-results");
  resultsBox.innerHTML = "";
  if (!keyword) {
    resultsBox.classList.add("hidden");
    return;
  }
  fetch(`/ddoksang/autocomplete/members/?q=` + encodeURIComponent(keyword))
    .then(res => res.json())
    .then(data => {
      const results = data.results;
      if (results.length === 0) {
        resultsBox.classList.add("hidden");
        return;
      }
      results.forEach(item => {
        const li = document.createElement("li");
        li.className = "hover:bg-gray-100 px-4 py-2 cursor-pointer text-sm border-b";
        li.innerHTML = `
          <div class="flex justify-between">
            <span>${item.member_name} <span class="text-gray-500 text-xs">(${item.artist_display})</span></span>
            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded">${item.bday}</span>
          </div>
        `;
        li.onclick = () => {
          document.getElementById("artist-member-search").value = `${item.member_name} (${item.artist_display})`;
          document.getElementById("artist_id").value = item.artist_id;
          document.getElementById("member_id").value = item.member_id;
          resultsBox.classList.add("hidden");
        };
        resultsBox.appendChild(li);
      });
      resultsBox.classList.remove("hidden");
    });
});
</script>

<script>
// ì¹´ì¹´ì˜¤ë§µ ì£¼ì†Œ ê²€ìƒ‰ ë° ê²°ê³¼ ì„ íƒ ê¸°ëŠ¥
let map = new kakao.maps.Map(document.getElementById('map'), {
  center: new kakao.maps.LatLng(37.5665, 126.9780),
  level: 3
});
let ps = new kakao.maps.services.Places();
let marker = new kakao.maps.Marker({ map: map });

const placeInput = document.getElementById("place-search");
const searchBtn = document.getElementById("searchBtn") || null;
const placeResults = document.getElementById('place-results');
const selectedPlaceDiv = document.getElementById('selected-place');

if (searchBtn) {
  searchBtn.addEventListener('click', () => {
    searchPlace();
  });
}

placeInput.addEventListener("keydown", function (e) {
  if (e.key === "Enter") {
    e.preventDefault();
    searchPlace();
  }
});

function searchPlace() {
  let keyword = placeInput.value;
  if (!keyword.trim()) return;
  ps.keywordSearch(keyword, function (data, status) {
    if (status === kakao.maps.services.Status.OK) {
      placeResults.innerHTML = '';
      placeResults.classList.remove('hidden');
      data.forEach(place => {
        const li = document.createElement('li');
        li.textContent = `${place.place_name} (${place.road_address_name || place.address_name})`;
        li.className = 'px-4 py-2 cursor-pointer hover:bg-gray-200 border-b last:border-none';
        li.addEventListener('click', () => {
          const latlng = new kakao.maps.LatLng(place.y, place.x);
          map.setCenter(latlng);
          marker.setPosition(latlng);

          selectedPlaceDiv.textContent = `ì„ íƒëœ ì£¼ì†Œ: ${place.place_name} - ${place.road_address_name || place.address_name}`;
          selectedPlaceDiv.classList.remove('hidden');

          document.getElementById("address").value = place.address_name;
          document.getElementById("road_address").value = place.road_address_name || '';
          document.getElementById("latitude").value = place.y;
          document.getElementById("longitude").value = place.x;
          document.getElementById("kakao_place_id").value = place.id;

          placeResults.classList.add('hidden');
        });
        placeResults.appendChild(li);
      });
    } else {
      placeResults.innerHTML = '<li class="px-4 py-2 text-red-500">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
      placeResults.classList.remove('hidden');
    }
  });
}
</script>

{% endblock %}
