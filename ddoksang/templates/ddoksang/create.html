{% extends "ddoksang/base/ddoksang_base.html" %}
{% load static %}
{% load utils %}

{% block body %}
<section class="max-w-4xl mx-auto px-4 py-10">
  <h1 class="text-2xl font-bold mb-6">🎁 생카 등록하기</h1>
  <p class="text-sm text-gray-600 mb-8">좋아하는 아티스트의 생카페 정보를 등록해주세요!</p>

  <!-- Progress Bar -->
  <div class="w-full bg-gray-200 rounded-full h-2 mb-8 overflow-hidden">
    <div id="progressBar" class="bg-blue-600 h-2 w-0 transition-width duration-300"></div>
  </div>

  <form method="POST" enctype="multipart/form-data" id="multiStepForm" action="{% url 'ddoksang:create' %}">
    {% csrf_token %}

    <!-- STEP 1: 아티스트/멤버 검색 -->
    <div id="step-1" class="step">
      <label class="block text-sm font-medium mb-2">아티스트/멤버명 검색</label>
      <input type="text" id="artist-member-search" class="w-full border rounded px-4 py-2" placeholder="멤버명 입력" autocomplete="off" required>
      <ul id="artist-member-results" class="border mt-2 rounded overflow-hidden hidden max-h-48 overflow-y-auto"></ul>
      
      <input type="hidden" name="artist_id" id="artist_id">
      <input type="hidden" name="member_id" id="member_id">
      
      <!-- 선택된 아티스트 표시 -->
      <div id="selected-artist" class="mt-2 p-2 border rounded bg-blue-50 hidden">
        <div class="flex items-center justify-between">
          <div>
            <p class="font-medium text-blue-800" id="selected-artist-text"></p>
          </div>
          <button type="button" onclick="clearSelection()" class="text-blue-600 hover:text-blue-800 text-sm">변경</button>
        </div>
      </div>
    </div>

    <!-- STEP 2: 카페 정보 -->
    <div id="step-2" class="step hidden">
      <label class="block text-sm font-medium mb-2">생카명</label>
      <input type="text" name="cafe_name" class="w-full border rounded px-4 py-2 mb-4" placeholder="생카명 입력" required>

      <label class="block text-sm font-medium mb-2">이벤트 유형</label>
      <select name="cafe_type" class="w-full border rounded px-4 py-2 mb-4" required>
        <option value="bday">생일</option>
        <option value="debut">데뷔</option>
        <option value="comeback">컴백</option>
        <option value="concert">콘서트</option>
        <option value="other">기타</option>
      </select>

      <label class="block text-sm font-medium mb-2">주소 검색</label>
      <div class="flex gap-2 mb-2">
        <input type="text" id="place-search" class="flex-grow border rounded px-4 py-2" placeholder="주소명을 입력하세요" autocomplete="off" required>
        <button type="button" id="searchBtn" class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700">검색</button>
      </div>

      <!-- 지도 컨테이너 -->
      <div class="relative w-full h-64 bg-gray-100 rounded border overflow-hidden">
        <div id="map" class="w-full h-full"></div>
        <div id="mapPlaceholder" class="absolute inset-0 flex items-center justify-center bg-gray-100">
          <div class="text-center text-gray-500">
            <svg class="w-16 h-16 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <p class="text-sm">주소를 검색하면 지도가 표시됩니다</p>
          </div>
        </div>
      </div>

      <ul id="place-results" class="mt-2 max-h-40 overflow-y-auto border rounded hidden"></ul>
      <div id="selected-place" class="mt-2 p-2 border rounded bg-green-50 hidden"></div>

      <input type="hidden" name="place_name" id="place_name"> 
      <input type="hidden" name="address" id="address" required>
      <input type="hidden" name="road_address" id="road_address">
      <input type="hidden" name="latitude" id="latitude" required>
      <input type="hidden" name="longitude" id="longitude" required>
      <input type="hidden" name="kakao_place_id" id="kakao_place_id">
    </div>

    <!-- STEP 3: 일정 -->
    <div id="step-3" class="step hidden">
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-2">시작일</label>
          <input type="text" id="start_date" name="start_date" class="w-full border rounded px-4 py-3" required>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">종료일</label>
          <input type="text" id="end_date" name="end_date" class="w-full border rounded px-4 py-3" required>
        </div>
      </div>
    </div>

    <!-- STEP 4: 특전 및 이벤트 정보 -->
    <div id="step-4" class="step hidden">
      <label class="block text-sm font-medium mb-4">🎁 특전 정보</label>

      <!-- 일반 특전 -->
      <div class="mb-6">
        <h4 class="text-sm font-semibold mb-3">🎨 특전</h4>
        <div class="grid grid-cols-4 gap-2">
          {% for item in "종이컵,포토카드,스티커,엽서,증명사진,달력,포토매틱,엘홀더,포스터,포카홀더,메모지,프리쿠라,부채,마스킹테이프,ID카드,띠부띠부씰,키링,슬로건,그립톡,액자,컵,거울,편지지,틴케이스,토이카메라,짐색,카드지갑,티셔츠,트레카,티켓,수건,기타"|split:"," %}
            <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
              <input type="checkbox" name="perks" value="{{ item }}" class="sr-only">
              <span class="perk-btn">{{ item }}</span>
            </label>
          {% endfor %}
        </div>
      </div>

      <!-- 선착 특전 -->
      <div class="mb-6">
        <h4 class="text-sm font-semibold mb-3">🏃 선착 특전</h4>
        <div class="grid grid-cols-4 gap-2">
          {% for item in "종이컵,포토카드,스티커,엽서,증명사진,달력,포토매틱,엘홀더,포스터,포카홀더,메모지,프리쿠라,부채,마스킹테이프,ID카드,띠부띠부씰,키링,슬로건,그립톡,액자,컵,거울,편지지,틴케이스,토이카메라,짐색,카드지갑,티셔츠,트레카,티켓,수건,기타"|split:"," %}
            <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
              <input type="checkbox" name="perks_priority" value="{{ item }}" class="sr-only">
              <span class="perk-btn">{{ item }}</span>
            </label>
          {% endfor %}
        </div>
      </div>

      <!-- 그 외 특전 -->
      <div class="mb-6">
        <h4 class="text-sm font-semibold mb-3">✨ 그 외 특전</h4>
        <div class="grid grid-cols-4 gap-2">
          {% for item in "메뉴 특전,선착 특전,당일 특전,랜덤 특전,럭키 넘버,럭키 드로우,가챠 뽑기,포토부스,전시회,해시태그 이벤트,기타"|split:"," %}
            <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
              <input type="checkbox" name="perks_extra" value="{{ item }}" class="sr-only">
              <span class="perk-btn">{{ item }}</span>
            </label>
          {% endfor %}
        </div>
      </div>

      <label class="block text-sm font-medium mb-2">이벤트 설명</label>
      <textarea name="event_description" class="w-full border rounded p-3" rows="4" placeholder="생일카페 이벤트에 대한 자세한 설명을 입력해주세요." required></textarea>
    </div>

    <!-- STEP 5: 출처 정보 -->
    <div id="step-5" class="step hidden">
      <label class="block text-sm font-medium mb-2">X 계정</label>
      <div class="flex items-center mb-4">
        <span class="inline-flex items-center px-3 py-2 border border-r-0 border-gray-300 bg-gray-50 text-gray-500 text-sm rounded-l">@</span>
        <input type="text" name="twitter_username" class="flex-1 border border-gray-300 rounded-r px-3 py-2" placeholder="twitter_username">
      </div>
      <p class="text-xs text-gray-500 mb-4">예: @bts_official → https://twitter.com/bts_official 링크로 연결됩니다</p>
    </div>

    <!-- STEP 6: 이미지 업로드 -->
    <div id="step-6" class="step hidden">
      <label class="block text-sm font-medium mb-4">생일카페 이미지 업로드</label>
      
      <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors">
        <input type="file" name="images" id="images" multiple accept="image/*" class="hidden">
        <label for="images" class="cursor-pointer">
          <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div class="mt-4">
            <p class="text-sm text-gray-600">
              <span class="font-medium text-blue-600 hover:text-blue-500">클릭하여 이미지 선택</span> 또는 드래그하여 업로드
            </p>
            <p class="text-xs text-gray-500">PNG, JPG, JPEG 파일만 업로드 가능 (최대 5개, 각 5MB 이하)</p>
          </div>
        </label>
      </div>

      <div id="image-preview" class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-4"></div>
    </div>

    <!-- 네비게이션 버튼 - 폼 안으로 이동 -->
    <div class="mt-8 flex justify-between">
      <button type="button" id="prevBtn" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">이전</button>
      <button type="button" id="nextBtn" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">다음</button>
    </div>
  </form>
</section>

<!-- Styles -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
  .perk-btn {
    display: block;
    width: 100%;
    text-align: center;
    font-size: 12px;
    transition: all 0.2s;
  }
  input[type="checkbox"]:checked + .perk-btn {
    background-color: #3b82f6;
    color: white;
    border-radius: 4px;
    transform: scale(0.95);
  }
  label:hover .perk-btn {
    background-color: #f3f4f6;
  }
  input[type="checkbox"]:checked + .perk-btn:hover {
    background-color: #2563eb !important;
    color: white !important;
  }
  input[type="date"]::-webkit-calendar-picker-indicator {
    opacity: 0;
    cursor: pointer;
  }
</style>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_api_key }}&libraries=services"></script>
<script>
flatpickr("#start_date", { dateFormat: "Y-m-d", defaultDate: new Date() });
flatpickr("#end_date", { dateFormat: "Y-m-d", defaultDate: new Date() });

// 🔧 디버깅 및 수정된 스크립트
const steps = 6;
let currentStep = 1;
let map = null;

const nextBtn = document.getElementById("nextBtn");
const prevBtn = document.getElementById("prevBtn");
const progressBar = document.getElementById("progressBar");

function updateStepVisibility() {
  for (let i = 1; i <= steps; i++) {
    const stepDiv = document.getElementById(`step-${i}`);
    const inputs = stepDiv.querySelectorAll("input:not([type='hidden']), textarea, select");
    if (i === currentStep) {
      stepDiv.classList.remove("hidden");
      inputs.forEach(el => el.disabled = false);
    } else {
      stepDiv.classList.add("hidden");
      inputs.forEach(el => el.disabled = true);
    }
  }
  
  // 프로그레스바 업데이트
  progressBar.style.width = `${(currentStep / steps) * 100}%`;

  // 버튼 상태 조정
  prevBtn.disabled = currentStep === 1;
  
  // 정확히 마지막 단계(6단계)일 때만 제출 버튼으로 변경
  if (currentStep === steps) {
    nextBtn.textContent = "최종 제출";
    nextBtn.type = "submit";
    nextBtn.className = "px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600";
  } else {
    nextBtn.textContent = "다음";
    nextBtn.type = "button";
    nextBtn.className = "px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600";
  }
  
  // Step 2에서 지도 초기화
  if (currentStep === 2 && !map) {
    initializeMap();
  }
}

function validateStep() {
  const currentStepDiv = document.getElementById(`step-${currentStep}`);
  
  // Step 1: 아티스트 선택 검증
  if (currentStep === 1) {
    const artistId = document.getElementById("artist_id").value;
    const searchInput = document.getElementById("artist-member-search").value.trim();
    
    if (!artistId || !searchInput) {
      alert("아티스트/멤버를 검색하고 선택해주세요.");
      document.getElementById("artist-member-search").focus();
      return false;
    }
    return true;
  }
  
  // 다른 단계들의 기본 검증
  const requiredFields = currentStepDiv.querySelectorAll("[required]");
  
  for (const field of requiredFields) {
    if (!field.value.trim()) {
      field.focus();
      alert("필수 입력란을 모두 채워주세요.");
      return false;
    }
  }
  
  // Step 2: 주소 선택 검증
  if (currentStep === 2) {
    const address = document.getElementById("address").value;
    if (!address) {
      alert("주소를 검색하고 선택해주세요.");
      document.getElementById("place-search").focus();
      return false;
    }
  }
  
  return true;
}

// 수정된 nextBtn 이벤트 리스너
nextBtn.addEventListener("click", (e) => {
  // 마지막 단계가 아닌 경우에만 단계 이동 처리
  if (currentStep < steps) {
    e.preventDefault(); // 폼 제출 방지
    
    if (!validateStep()) return;
    
    currentStep++;
    updateStepVisibility();
  }
  // currentStep === steps인 경우 (6단계)에는 자연스럽게 폼 제출됨
});

prevBtn.addEventListener("click", () => {
  if (currentStep > 1) {
    currentStep--;
    updateStepVisibility();
  }
});

// 초기 상태 설정
updateStepVisibility();

// 지도 초기화
function initializeMap() {
  const mapContainer = document.getElementById('map');
  const mapOption = {
    center: new kakao.maps.LatLng(37.5665, 126.9780),
    level: 3
  };
  
  map = new kakao.maps.Map(mapContainer, mapOption);
  document.getElementById('mapPlaceholder').style.display = 'none';
}

// 이미지 미리보기
document.getElementById("images").addEventListener("change", function () {
  const previewContainer = document.getElementById("image-preview");
  previewContainer.innerHTML = "";
  
  if (this.files.length > 5) {
    alert("최대 5개의 이미지만 업로드할 수 있습니다.");
    this.value = "";
    return;
  }
  
  Array.from(this.files).forEach((file, index) => {
    if (file.size > 5 * 1024 * 1024) {
      alert(`${file.name}: 파일 크기가 5MB를 초과합니다.`);
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function (e) {
      const div = document.createElement("div");
      div.className = "relative";
      div.innerHTML = `
        <img src="${e.target.result}" alt="Preview ${index + 1}" class="w-full h-32 object-cover rounded border">
        <div class="absolute top-2 left-2 bg-blue-500 text-white text-xs px-2 py-1 rounded">
          ${index === 0 ? '대표' : index + 1}
        </div>
        <button type="button" onclick="removeImage(${index})" class="absolute top-2 right-2 bg-red-500 text-white text-xs w-6 h-6 rounded-full hover:bg-red-600">
          ×
        </button>
      `;
      previewContainer.appendChild(div);
    };
    reader.readAsDataURL(file);
  });
});

function removeImage(index) {
  const input = document.getElementById("images");
  const dt = new DataTransfer();
  
  Array.from(input.files).forEach((file, i) => {
    if (i !== index) dt.items.add(file);
  });
  
  input.files = dt.files;
  input.dispatchEvent(new Event('change'));
}

// 🔧 중복 제거 기능이 추가된 아티스트/멤버 자동완성
document.getElementById("artist-member-search").addEventListener("input", function () {
  const keyword = this.value.trim();
  const resultsBox = document.getElementById("artist-member-results");
  resultsBox.innerHTML = "";
  
  if (!keyword) {
    resultsBox.classList.add("hidden");
    clearSelection();
    return;
  }
  
  fetch(`/ddoksang/autocomplete/members/?q=${encodeURIComponent(keyword)}`)
      .then(res => res.json())
      .then(data => {
        let results = data.results;
        
        // 🔧 중복 제거: member_id와 artist_id 조합으로 중복 제거
        const seen = new Set();
        results = results.filter(item => {
          // member_name과 artist_display 조합으로 중복 체크
          const key = `${item.member_name}-${item.artist_display}`;
          if (seen.has(key)) {
            return false;
          }
          seen.add(key);
          return true;
        });
        
        // 🔧 여기에 정렬 코드 추가!
        results.sort((a, b) => a.member_name.toLowerCase() === keyword.toLowerCase() ? -1 : 1);
        
        if (results.length === 0) {
          resultsBox.innerHTML = '<li class="px-4 py-2 text-gray-500 text-sm">검색 결과가 없습니다.</li>';
          resultsBox.classList.remove("hidden");
          return;
        }
        
      results.forEach(item => {
        const li = document.createElement("li");
        li.className = "hover:bg-gray-100 px-4 py-2 cursor-pointer text-sm border-b";

        li.innerHTML = `
          <div class="flex justify-between items-center">
             <div class="flex flex-col">
                <span class="font-medium">${item.member_name}</span>
                <span class="text-xs text-gray-500">${item.artist_display}</span>
              </div>
             <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded">${item.bday}</span>
          </div>
        `;

        li.onclick = () => selectArtist(item);
        resultsBox.appendChild(li);
      });
      resultsBox.classList.remove("hidden");
    })
    .catch(err => {
      console.error('자동완성 오류:', err);
      resultsBox.innerHTML = '<li class="px-4 py-2 text-red-500 text-sm">검색 중 오류가 발생했습니다.</li>';
      resultsBox.classList.remove("hidden");
    });
});

function selectArtist(item) {
  // 검색 결과 숨기기
  document.getElementById("artist-member-results").classList.add("hidden");
  
  // 선택된 아티스트 정보 설정
  document.getElementById("artist-member-search").value = `${item.member_name} (${item.artist_display})`;
  document.getElementById("artist_id").value = item.artist_id;
  document.getElementById("member_id").value = item.member_id;
  
  // 선택된 아티스트 표시
  document.getElementById("selected-artist-text").textContent = `✓ ${item.member_name} (${item.artist_display}) 선택됨`;
  document.getElementById("selected-artist").classList.remove("hidden");
}

function clearSelection() {
  document.getElementById("artist_id").value = "";
  document.getElementById("member_id").value = "";
  document.getElementById("artist-member-search").value = "";
  document.getElementById("selected-artist").classList.add("hidden");
  document.getElementById("artist-member-results").classList.add("hidden");
}

// 카카오맵 주소 검색
let ps = null;
let marker = null;

function initPlaceSearch() {
  if (!ps) {
    ps = new kakao.maps.services.Places();
    marker = new kakao.maps.Marker({ map: map });
  }
}

const placeInput = document.getElementById("place-search");
const searchBtn = document.getElementById("searchBtn");
const placeResults = document.getElementById('place-results');
const selectedPlaceDiv = document.getElementById('selected-place');

searchBtn?.addEventListener('click', searchPlace);

placeInput.addEventListener("keydown", function (e) {
  if (e.key === "Enter") {
    e.preventDefault();
    searchPlace();
  }
});

function searchPlace() {
  if (!map) initializeMap();
  if (!ps) initPlaceSearch();
  
  let keyword = placeInput.value.trim();
  if (!keyword) return;
  
  ps.keywordSearch(keyword, function (data, status) {
    if (status === kakao.maps.services.Status.OK) {
      placeResults.innerHTML = '';
      placeResults.classList.remove('hidden');
      
      data.forEach(place => {
        const li = document.createElement('li');
        li.textContent = `${place.place_name} (${place.road_address_name || place.address_name})`;
        li.className = 'px-4 py-2 cursor-pointer hover:bg-gray-200 border-b last:border-none text-sm';
        li.addEventListener('click', () => selectPlace(place));
        placeResults.appendChild(li);
      });
    } else {
      placeResults.innerHTML = '<li class="px-4 py-2 text-red-500 text-sm">검색 결과가 없습니다.</li>';
      placeResults.classList.remove('hidden');
    }
  });
}

function selectPlace(place) {
  const latlng = new kakao.maps.LatLng(place.y, place.x);
  map.setCenter(latlng);
  marker.setPosition(latlng);

  console.log("✅ 선택된 place 객체:", place);
  console.log("✅ place_name:", place.place_name);

  document.getElementById("place_name").value = place.place_name;
  console.log("✅ input에 들어간 값:", document.getElementById("place_name").value);

  selectedPlaceDiv.innerHTML = `
    <div class="flex items-center justify-between">
      <div>
        <p class="font-medium text-green-800">${place.place_name}</p>
        <p class="text-sm text-green-600">${place.road_address_name || place.address_name}</p>
      </div>
      <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
      </svg>
    </div>
  `;
  selectedPlaceDiv.classList.remove('hidden');

  // 폼 데이터 설정 (기존)
  document.getElementById("place_name").value = place.place_name;
  document.getElementById("address").value = place.address_name;
  document.getElementById("road_address").value = place.road_address_name || '';
  document.getElementById("latitude").value = place.y;
  document.getElementById("longitude").value = place.x;
  document.getElementById("kakao_place_id").value = place.id;

  // 🔧 카카오맵 데이터를 JSON으로 저장 (새로 추가)
  const kakaoData = {
    place_name: place.place_name,      // 실제 가게명 - 이게 중요!
    address_name: place.address_name,
    road_address_name: place.road_address_name || '',
    phone: place.phone || '',
    place_url: place.place_url || '',
    category_name: place.category_name || '',
    id: place.id,
    x: place.x,
    y: place.y
  };
  
  // hidden input에 JSON 저장 (새로 추가)
  let kakaoInput = document.getElementById('kakao_place_data');
  if (!kakaoInput) {
    // hidden input이 없으면 동적으로 생성
    kakaoInput = document.createElement('input');
    kakaoInput.type = 'hidden';
    kakaoInput.id = 'kakao_place_data';
    kakaoInput.name = 'kakao_place_data';
    document.querySelector('form').appendChild(kakaoInput);
  }
  kakaoInput.value = JSON.stringify(kakaoData);

  placeResults.classList.add('hidden');
}

// 드래그 앤 드롭 이미지 업로드
const imageUploadArea = document.querySelector('label[for="images"]').parentElement;

imageUploadArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  imageUploadArea.classList.add('border-blue-400', 'bg-blue-50');
});

imageUploadArea.addEventListener('dragleave', (e) => {
  e.preventDefault();
  imageUploadArea.classList.remove('border-blue-400', 'bg-blue-50');
});

imageUploadArea.addEventListener('drop', (e) => {
  e.preventDefault();
  imageUploadArea.classList.remove('border-blue-400', 'bg-blue-50');
  
  const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
  if (files.length > 0) {
    const input = document.getElementById('images');
    const dt = new DataTransfer();
    files.forEach(file => dt.items.add(file));
    input.files = dt.files;
    input.dispatchEvent(new Event('change'));
  }
});

// 날짜 유효성 검증
document.querySelector('[name="start_date"]').addEventListener('change', function() {
  const endDate = document.querySelector('[name="end_date"]');
  endDate.min = this.value;
  
  if (endDate.value && endDate.value < this.value) {
    endDate.value = this.value;
  }
});

document.querySelector('[name="end_date"]').addEventListener('change', function() {
  const startDate = document.querySelector('[name="start_date"]');
  startDate.max = this.value;
  
  if (startDate.value && startDate.value > this.value) {
    startDate.value = this.value;
  }
});

// 폼 제출 시 데이터 변환
document.getElementById('multiStepForm').addEventListener('submit', function(e) {
  // 모든 input, textarea, select 활성화
  const allInputs = this.querySelectorAll('input, textarea, select');
  allInputs.forEach(input => {
    input.disabled = false;
  });
  
  // Twitter username을 URL로 변환
  const twitterUsername = document.querySelector('[name="twitter_username"]').value.trim();
  
  if (twitterUsername) {
    const twitterInput = document.createElement('input');
    twitterInput.type = 'hidden';
    twitterInput.name = 'twitter_source';
    twitterInput.value = `https://twitter.com/${twitterUsername.replace('@', '')}`;
    this.appendChild(twitterInput);
  }
});
</script>
{% endblock %}