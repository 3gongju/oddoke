{% extends "ddoksang/base/ddoksang_base.html" %}
{% load static %}
{% load utils %}

{% block body %}
<section class="max-w-4xl mx-auto px-4 py-10">
  <h1 class="text-2xl font-bold mb-6">ğŸ ìƒì¹´ ë“±ë¡í•˜ê¸°</h1>
  <p class="text-sm text-gray-600 mb-8">ì¢‹ì•„í•˜ëŠ” ì•„í‹°ìŠ¤íŠ¸ì˜ ìƒì¹´í˜ ì •ë³´ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”!</p>

  <!-- Progress Bar -->
  <div class="w-full bg-gray-200 rounded-full h-2 mb-8 overflow-hidden">
    <div id="progressBar" class="bg-blue-600 h-2 w-0 transition-width duration-300"></div>
  </div>

  <form method="POST" enctype="multipart/form-data" id="multiStepForm" action="{% url 'ddoksang:create' %}">
    {% csrf_token %}

    <!-- STEP 1: ì•„í‹°ìŠ¤íŠ¸/ë©¤ë²„ ê²€ìƒ‰ -->
    <div id="step-1" class="step">
      <label class="block text-sm font-medium mb-2">ì•„í‹°ìŠ¤íŠ¸/ë©¤ë²„ëª… ê²€ìƒ‰</label>
      <input type="text" id="artist-member-search" class="w-full border rounded px-4 py-2" placeholder="ë©¤ë²„ëª… ì…ë ¥" autocomplete="off" required>
      <ul id="artist-member-results" class="border mt-2 rounded overflow-hidden hidden max-h-48 overflow-y-auto"></ul>
      
      <input type="hidden" name="artist_id" id="artist_id">
      <input type="hidden" name="member_id" id="member_id">
      
      <!-- ì„ íƒëœ ì•„í‹°ìŠ¤íŠ¸ í‘œì‹œ -->
      <div id="selected-artist" class="mt-2 p-2 border rounded bg-blue-50 hidden">
        <div class="flex items-center justify-between">
          <div>
            <p class="font-medium text-blue-800" id="selected-artist-text"></p>
          </div>
          <button type="button" onclick="clearSelection()" class="text-blue-600 hover:text-blue-800 text-sm">ë³€ê²½</button>
        </div>
      </div>
    </div>

    <!-- STEP 2: ì¹´í˜ ì •ë³´ -->
    <div id="step-2" class="step hidden">
      <label class="block text-sm font-medium mb-2">ìƒì¹´ëª…</label>
      <input type="text" name="cafe_name" class="w-full border rounded px-4 py-2 mb-4" placeholder="ìƒì¹´ëª… ì…ë ¥" required>

      <label class="block text-sm font-medium mb-2">ì´ë²¤íŠ¸ ìœ í˜•</label>
      <select name="cafe_type" class="w-full border rounded px-4 py-2 mb-4" required>
        <option value="bday">ìƒì¼</option>
        <option value="debut">ë°ë·”</option>
        <option value="comeback">ì»´ë°±</option>
        <option value="concert">ì½˜ì„œíŠ¸</option>
        <option value="other">ê¸°íƒ€</option>
      </select>

      <label class="block text-sm font-medium mb-2">ì£¼ì†Œ ê²€ìƒ‰</label>
      <div class="flex gap-2 mb-2">
        <input type="text" id="place-search" class="flex-grow border rounded px-4 py-2" placeholder="ì£¼ì†Œëª…ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off" required>
        <button type="button" id="searchBtn" class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700">ê²€ìƒ‰</button>
      </div>

      <!-- ì§€ë„ ì»¨í…Œì´ë„ˆ -->
      <div class="relative w-full h-64 bg-gray-100 rounded border overflow-hidden">
        <div id="map" class="w-full h-full"></div>
        <div id="mapPlaceholder" class="absolute inset-0 flex items-center justify-center bg-gray-100">
          <div class="text-center text-gray-500">
            <svg class="w-16 h-16 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <p class="text-sm">ì£¼ì†Œë¥¼ ê²€ìƒ‰í•˜ë©´ ì§€ë„ê°€ í‘œì‹œë©ë‹ˆë‹¤</p>
          </div>
        </div>
      </div>

      <ul id="place-results" class="mt-2 max-h-40 overflow-y-auto border rounded hidden"></ul>
      <div id="selected-place" class="mt-2 p-2 border rounded bg-green-50 hidden"></div>

      <input type="hidden" name="place_name" id="place_name"> 
      <input type="hidden" name="address" id="address" required>
      <input type="hidden" name="road_address" id="road_address">
      <input type="hidden" name="latitude" id="latitude" required>
      <input type="hidden" name="longitude" id="longitude" required>
      <input type="hidden" name="kakao_place_id" id="kakao_place_id">
    </div>

    <!-- STEP 3: ì¼ì • -->
    <div id="step-3" class="step hidden">
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-2">ì‹œì‘ì¼</label>
          <input type="text" id="start_date" name="start_date" class="w-full border rounded px-4 py-3" required>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">ì¢…ë£Œì¼</label>
          <input type="text" id="end_date" name="end_date" class="w-full border rounded px-4 py-3" required>
        </div>
      </div>
    </div>

    <!-- STEP 4: íŠ¹ì „ ë° ì´ë²¤íŠ¸ ì •ë³´ -->
    <div id="step-4" class="step hidden">
      <label class="block text-sm font-medium mb-4">ğŸ íŠ¹ì „ ì •ë³´</label>

      <!-- ì¼ë°˜ íŠ¹ì „ -->
      <div class="mb-6">
        <h4 class="text-sm font-semibold mb-3">ğŸ¨ íŠ¹ì „</h4>
        <div class="grid grid-cols-4 gap-2">
          {% for item in "ì¢…ì´ì»µ,í¬í† ì¹´ë“œ,ìŠ¤í‹°ì»¤,ì—½ì„œ,ì¦ëª…ì‚¬ì§„,ë‹¬ë ¥,í¬í† ë§¤í‹±,ì—˜í™€ë”,í¬ìŠ¤í„°,í¬ì¹´í™€ë”,ë©”ëª¨ì§€,í”„ë¦¬ì¿ ë¼,ë¶€ì±„,ë§ˆìŠ¤í‚¹í…Œì´í”„,IDì¹´ë“œ,ë ë¶€ë ë¶€ì”°,í‚¤ë§,ìŠ¬ë¡œê±´,ê·¸ë¦½í†¡,ì•¡ì,ì»µ,ê±°ìš¸,í¸ì§€ì§€,í‹´ì¼€ì´ìŠ¤,í† ì´ì¹´ë©”ë¼,ì§ìƒ‰,ì¹´ë“œì§€ê°‘,í‹°ì…”ì¸ ,íŠ¸ë ˆì¹´,í‹°ì¼“,ìˆ˜ê±´,ê¸°íƒ€"|split:"," %}
            <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
              <input type="checkbox" name="perks" value="{{ item }}" class="sr-only">
              <span class="perk-btn">{{ item }}</span>
            </label>
          {% endfor %}
        </div>
      </div>

      <!-- ì„ ì°© íŠ¹ì „ -->
      <div class="mb-6">
        <h4 class="text-sm font-semibold mb-3">ğŸƒ ì„ ì°© íŠ¹ì „</h4>
        <div class="grid grid-cols-4 gap-2">
          {% for item in "ì¢…ì´ì»µ,í¬í† ì¹´ë“œ,ìŠ¤í‹°ì»¤,ì—½ì„œ,ì¦ëª…ì‚¬ì§„,ë‹¬ë ¥,í¬í† ë§¤í‹±,ì—˜í™€ë”,í¬ìŠ¤í„°,í¬ì¹´í™€ë”,ë©”ëª¨ì§€,í”„ë¦¬ì¿ ë¼,ë¶€ì±„,ë§ˆìŠ¤í‚¹í…Œì´í”„,IDì¹´ë“œ,ë ë¶€ë ë¶€ì”°,í‚¤ë§,ìŠ¬ë¡œê±´,ê·¸ë¦½í†¡,ì•¡ì,ì»µ,ê±°ìš¸,í¸ì§€ì§€,í‹´ì¼€ì´ìŠ¤,í† ì´ì¹´ë©”ë¼,ì§ìƒ‰,ì¹´ë“œì§€ê°‘,í‹°ì…”ì¸ ,íŠ¸ë ˆì¹´,í‹°ì¼“,ìˆ˜ê±´,ê¸°íƒ€"|split:"," %}
            <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
              <input type="checkbox" name="perks_priority" value="{{ item }}" class="sr-only">
              <span class="perk-btn">{{ item }}</span>
            </label>
          {% endfor %}
        </div>
      </div>

      <!-- ê·¸ ì™¸ íŠ¹ì „ -->
      <div class="mb-6">
        <h4 class="text-sm font-semibold mb-3">âœ¨ ê·¸ ì™¸ íŠ¹ì „</h4>
        <div class="grid grid-cols-4 gap-2">
          {% for item in "ë©”ë‰´ íŠ¹ì „,ì„ ì°© íŠ¹ì „,ë‹¹ì¼ íŠ¹ì „,ëœë¤ íŠ¹ì „,ëŸ­í‚¤ ë„˜ë²„,ëŸ­í‚¤ ë“œë¡œìš°,ê°€ì±  ë½‘ê¸°,í¬í† ë¶€ìŠ¤,ì „ì‹œíšŒ,í•´ì‹œíƒœê·¸ ì´ë²¤íŠ¸,ê¸°íƒ€"|split:"," %}
            <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
              <input type="checkbox" name="perks_extra" value="{{ item }}" class="sr-only">
              <span class="perk-btn">{{ item }}</span>
            </label>
          {% endfor %}
        </div>
      </div>

      <label class="block text-sm font-medium mb-2">ì´ë²¤íŠ¸ ì„¤ëª…</label>
      <textarea name="event_description" class="w-full border rounded p-3" rows="4" placeholder="ìƒì¼ì¹´í˜ ì´ë²¤íŠ¸ì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." required></textarea>
    </div>

    <!-- STEP 5: ì¶œì²˜ ì •ë³´ -->
    <div id="step-5" class="step hidden">
      <label class="block text-sm font-medium mb-2">X ê³„ì •</label>
      <div class="flex items-center mb-4">
        <span class="inline-flex items-center px-3 py-2 border border-r-0 border-gray-300 bg-gray-50 text-gray-500 text-sm rounded-l">@</span>
        <input type="text" name="twitter_username" class="flex-1 border border-gray-300 rounded-r px-3 py-2" placeholder="twitter_username">
      </div>
      <p class="text-xs text-gray-500 mb-4">ì˜ˆ: @bts_official â†’ https://twitter.com/bts_official ë§í¬ë¡œ ì—°ê²°ë©ë‹ˆë‹¤</p>
    </div>

    <!-- STEP 6: ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
    <div id="step-6" class="step hidden">
      <label class="block text-sm font-medium mb-4">ìƒì¼ì¹´í˜ ì´ë¯¸ì§€ ì—…ë¡œë“œ</label>
      
      <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors">
        <input type="file" name="images" id="images" multiple accept="image/*" class="hidden">
        <label for="images" class="cursor-pointer">
          <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div class="mt-4">
            <p class="text-sm text-gray-600">
              <span class="font-medium text-blue-600 hover:text-blue-500">í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì„ íƒ</span> ë˜ëŠ” ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ
            </p>
            <p class="text-xs text-gray-500">PNG, JPG, JPEG íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥ (ìµœëŒ€ 5ê°œ, ê° 5MB ì´í•˜)</p>
          </div>
        </label>
      </div>

      <div id="image-preview" class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-4"></div>
    </div>

    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ - í¼ ì•ˆìœ¼ë¡œ ì´ë™ -->
    <div class="mt-8 flex justify-between">
      <button type="button" id="prevBtn" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">ì´ì „</button>
      <button type="button" id="nextBtn" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">ë‹¤ìŒ</button>
    </div>
  </form>
</section>

<!-- Styles -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
  .perk-btn {
    display: block;
    width: 100%;
    text-align: center;
    font-size: 12px;
    transition: all 0.2s;
  }
  input[type="checkbox"]:checked + .perk-btn {
    background-color: #3b82f6;
    color: white;
    border-radius: 4px;
    transform: scale(0.95);
  }
  label:hover .perk-btn {
    background-color: #f3f4f6;
  }
  input[type="checkbox"]:checked + .perk-btn:hover {
    background-color: #2563eb !important;
    color: white !important;
  }
  input[type="date"]::-webkit-calendar-picker-indicator {
    opacity: 0;
    cursor: pointer;
  }
</style>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_api_key }}&libraries=services"></script>
<script>
flatpickr("#start_date", { dateFormat: "Y-m-d", defaultDate: new Date() });
flatpickr("#end_date", { dateFormat: "Y-m-d", defaultDate: new Date() });

// ğŸ”§ ë””ë²„ê¹… ë° ìˆ˜ì •ëœ ìŠ¤í¬ë¦½íŠ¸
const steps = 6;
let currentStep = 1;
let map = null;

const nextBtn = document.getElementById("nextBtn");
const prevBtn = document.getElementById("prevBtn");
const progressBar = document.getElementById("progressBar");

function updateStepVisibility() {
  for (let i = 1; i <= steps; i++) {
    const stepDiv = document.getElementById(`step-${i}`);
    const inputs = stepDiv.querySelectorAll("input:not([type='hidden']), textarea, select");
    if (i === currentStep) {
      stepDiv.classList.remove("hidden");
      inputs.forEach(el => el.disabled = false);
    } else {
      stepDiv.classList.add("hidden");
      inputs.forEach(el => el.disabled = true);
    }
  }
  
  // í”„ë¡œê·¸ë ˆìŠ¤ë°” ì—…ë°ì´íŠ¸
  progressBar.style.width = `${(currentStep / steps) * 100}%`;

  // ë²„íŠ¼ ìƒíƒœ ì¡°ì •
  prevBtn.disabled = currentStep === 1;
  
  // ì •í™•íˆ ë§ˆì§€ë§‰ ë‹¨ê³„(6ë‹¨ê³„)ì¼ ë•Œë§Œ ì œì¶œ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
  if (currentStep === steps) {
    nextBtn.textContent = "ìµœì¢… ì œì¶œ";
    nextBtn.type = "submit";
    nextBtn.className = "px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600";
  } else {
    nextBtn.textContent = "ë‹¤ìŒ";
    nextBtn.type = "button";
    nextBtn.className = "px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600";
  }
  
  // Step 2ì—ì„œ ì§€ë„ ì´ˆê¸°í™”
  if (currentStep === 2 && !map) {
    initializeMap();
  }
}

function validateStep() {
  const currentStepDiv = document.getElementById(`step-${currentStep}`);
  
  // Step 1: ì•„í‹°ìŠ¤íŠ¸ ì„ íƒ ê²€ì¦
  if (currentStep === 1) {
    const artistId = document.getElementById("artist_id").value;
    const searchInput = document.getElementById("artist-member-search").value.trim();
    
    if (!artistId || !searchInput) {
      alert("ì•„í‹°ìŠ¤íŠ¸/ë©¤ë²„ë¥¼ ê²€ìƒ‰í•˜ê³  ì„ íƒí•´ì£¼ì„¸ìš”.");
      document.getElementById("artist-member-search").focus();
      return false;
    }
    return true;
  }
  
  // ë‹¤ë¥¸ ë‹¨ê³„ë“¤ì˜ ê¸°ë³¸ ê²€ì¦
  const requiredFields = currentStepDiv.querySelectorAll("[required]");
  
  for (const field of requiredFields) {
    if (!field.value.trim()) {
      field.focus();
      alert("í•„ìˆ˜ ì…ë ¥ë€ì„ ëª¨ë‘ ì±„ì›Œì£¼ì„¸ìš”.");
      return false;
    }
  }
  
  // Step 2: ì£¼ì†Œ ì„ íƒ ê²€ì¦
  if (currentStep === 2) {
    const address = document.getElementById("address").value;
    if (!address) {
      alert("ì£¼ì†Œë¥¼ ê²€ìƒ‰í•˜ê³  ì„ íƒí•´ì£¼ì„¸ìš”.");
      document.getElementById("place-search").focus();
      return false;
    }
  }
  
  return true;
}

// ìˆ˜ì •ëœ nextBtn ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
nextBtn.addEventListener("click", (e) => {
  // ë§ˆì§€ë§‰ ë‹¨ê³„ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ë‹¨ê³„ ì´ë™ ì²˜ë¦¬
  if (currentStep < steps) {
    e.preventDefault(); // í¼ ì œì¶œ ë°©ì§€
    
    if (!validateStep()) return;
    
    currentStep++;
    updateStepVisibility();
  }
  // currentStep === stepsì¸ ê²½ìš° (6ë‹¨ê³„)ì—ëŠ” ìì—°ìŠ¤ëŸ½ê²Œ í¼ ì œì¶œë¨
});

prevBtn.addEventListener("click", () => {
  if (currentStep > 1) {
    currentStep--;
    updateStepVisibility();
  }
});

// ì´ˆê¸° ìƒíƒœ ì„¤ì •
updateStepVisibility();

// ì§€ë„ ì´ˆê¸°í™”
function initializeMap() {
  const mapContainer = document.getElementById('map');
  const mapOption = {
    center: new kakao.maps.LatLng(37.5665, 126.9780),
    level: 3
  };
  
  map = new kakao.maps.Map(mapContainer, mapOption);
  document.getElementById('mapPlaceholder').style.display = 'none';
}

// ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
document.getElementById("images").addEventListener("change", function () {
  const previewContainer = document.getElementById("image-preview");
  previewContainer.innerHTML = "";
  
  if (this.files.length > 5) {
    alert("ìµœëŒ€ 5ê°œì˜ ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    this.value = "";
    return;
  }
  
  Array.from(this.files).forEach((file, index) => {
    if (file.size > 5 * 1024 * 1024) {
      alert(`${file.name}: íŒŒì¼ í¬ê¸°ê°€ 5MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function (e) {
      const div = document.createElement("div");
      div.className = "relative";
      div.innerHTML = `
        <img src="${e.target.result}" alt="Preview ${index + 1}" class="w-full h-32 object-cover rounded border">
        <div class="absolute top-2 left-2 bg-blue-500 text-white text-xs px-2 py-1 rounded">
          ${index === 0 ? 'ëŒ€í‘œ' : index + 1}
        </div>
        <button type="button" onclick="removeImage(${index})" class="absolute top-2 right-2 bg-red-500 text-white text-xs w-6 h-6 rounded-full hover:bg-red-600">
          Ã—
        </button>
      `;
      previewContainer.appendChild(div);
    };
    reader.readAsDataURL(file);
  });
});

function removeImage(index) {
  const input = document.getElementById("images");
  const dt = new DataTransfer();
  
  Array.from(input.files).forEach((file, i) => {
    if (i !== index) dt.items.add(file);
  });
  
  input.files = dt.files;
  input.dispatchEvent(new Event('change'));
}

// ğŸ”§ ì¤‘ë³µ ì œê±° ê¸°ëŠ¥ì´ ì¶”ê°€ëœ ì•„í‹°ìŠ¤íŠ¸/ë©¤ë²„ ìë™ì™„ì„±
document.getElementById("artist-member-search").addEventListener("input", function () {
  const keyword = this.value.trim();
  const resultsBox = document.getElementById("artist-member-results");
  resultsBox.innerHTML = "";
  
  if (!keyword) {
    resultsBox.classList.add("hidden");
    clearSelection();
    return;
  }
  
  fetch(`/ddoksang/autocomplete/members/?q=${encodeURIComponent(keyword)}`)
      .then(res => res.json())
      .then(data => {
        let results = data.results;
        
        // ğŸ”§ ì¤‘ë³µ ì œê±°: member_idì™€ artist_id ì¡°í•©ìœ¼ë¡œ ì¤‘ë³µ ì œê±°
        const seen = new Set();
        results = results.filter(item => {
          // member_nameê³¼ artist_display ì¡°í•©ìœ¼ë¡œ ì¤‘ë³µ ì²´í¬
          const key = `${item.member_name}-${item.artist_display}`;
          if (seen.has(key)) {
            return false;
          }
          seen.add(key);
          return true;
        });
        
        // ğŸ”§ ì—¬ê¸°ì— ì •ë ¬ ì½”ë“œ ì¶”ê°€!
        results.sort((a, b) => a.member_name.toLowerCase() === keyword.toLowerCase() ? -1 : 1);
        
        if (results.length === 0) {
          resultsBox.innerHTML = '<li class="px-4 py-2 text-gray-500 text-sm">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
          resultsBox.classList.remove("hidden");
          return;
        }
        
      results.forEach(item => {
        const li = document.createElement("li");
        li.className = "hover:bg-gray-100 px-4 py-2 cursor-pointer text-sm border-b";

        li.innerHTML = `
          <div class="flex justify-between items-center">
             <div class="flex flex-col">
                <span class="font-medium">${item.member_name}</span>
                <span class="text-xs text-gray-500">${item.artist_display}</span>
              </div>
             <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded">${item.bday}</span>
          </div>
        `;

        li.onclick = () => selectArtist(item);
        resultsBox.appendChild(li);
      });
      resultsBox.classList.remove("hidden");
    })
    .catch(err => {
      console.error('ìë™ì™„ì„± ì˜¤ë¥˜:', err);
      resultsBox.innerHTML = '<li class="px-4 py-2 text-red-500 text-sm">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</li>';
      resultsBox.classList.remove("hidden");
    });
});

function selectArtist(item) {
  // ê²€ìƒ‰ ê²°ê³¼ ìˆ¨ê¸°ê¸°
  document.getElementById("artist-member-results").classList.add("hidden");
  
  // ì„ íƒëœ ì•„í‹°ìŠ¤íŠ¸ ì •ë³´ ì„¤ì •
  document.getElementById("artist-member-search").value = `${item.member_name} (${item.artist_display})`;
  document.getElementById("artist_id").value = item.artist_id;
  document.getElementById("member_id").value = item.member_id;
  
  // ì„ íƒëœ ì•„í‹°ìŠ¤íŠ¸ í‘œì‹œ
  document.getElementById("selected-artist-text").textContent = `âœ“ ${item.member_name} (${item.artist_display}) ì„ íƒë¨`;
  document.getElementById("selected-artist").classList.remove("hidden");
}

function clearSelection() {
  document.getElementById("artist_id").value = "";
  document.getElementById("member_id").value = "";
  document.getElementById("artist-member-search").value = "";
  document.getElementById("selected-artist").classList.add("hidden");
  document.getElementById("artist-member-results").classList.add("hidden");
}

// ì¹´ì¹´ì˜¤ë§µ ì£¼ì†Œ ê²€ìƒ‰
let ps = null;
let marker = null;

function initPlaceSearch() {
  if (!ps) {
    ps = new kakao.maps.services.Places();
    marker = new kakao.maps.Marker({ map: map });
  }
}

const placeInput = document.getElementById("place-search");
const searchBtn = document.getElementById("searchBtn");
const placeResults = document.getElementById('place-results');
const selectedPlaceDiv = document.getElementById('selected-place');

searchBtn?.addEventListener('click', searchPlace);

placeInput.addEventListener("keydown", function (e) {
  if (e.key === "Enter") {
    e.preventDefault();
    searchPlace();
  }
});

function searchPlace() {
  if (!map) initializeMap();
  if (!ps) initPlaceSearch();
  
  let keyword = placeInput.value.trim();
  if (!keyword) return;
  
  ps.keywordSearch(keyword, function (data, status) {
    if (status === kakao.maps.services.Status.OK) {
      placeResults.innerHTML = '';
      placeResults.classList.remove('hidden');
      
      data.forEach(place => {
        const li = document.createElement('li');
        li.textContent = `${place.place_name} (${place.road_address_name || place.address_name})`;
        li.className = 'px-4 py-2 cursor-pointer hover:bg-gray-200 border-b last:border-none text-sm';
        li.addEventListener('click', () => selectPlace(place));
        placeResults.appendChild(li);
      });
    } else {
      placeResults.innerHTML = '<li class="px-4 py-2 text-red-500 text-sm">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
      placeResults.classList.remove('hidden');
    }
  });
}

function selectPlace(place) {
  const latlng = new kakao.maps.LatLng(place.y, place.x);
  map.setCenter(latlng);
  marker.setPosition(latlng);

  console.log("âœ… ì„ íƒëœ place ê°ì²´:", place);
  console.log("âœ… place_name:", place.place_name);

  document.getElementById("place_name").value = place.place_name;
  console.log("âœ… inputì— ë“¤ì–´ê°„ ê°’:", document.getElementById("place_name").value);

  selectedPlaceDiv.innerHTML = `
    <div class="flex items-center justify-between">
      <div>
        <p class="font-medium text-green-800">${place.place_name}</p>
        <p class="text-sm text-green-600">${place.road_address_name || place.address_name}</p>
      </div>
      <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
      </svg>
    </div>
  `;
  selectedPlaceDiv.classList.remove('hidden');

  // í¼ ë°ì´í„° ì„¤ì • (ê¸°ì¡´)
  document.getElementById("place_name").value = place.place_name;
  document.getElementById("address").value = place.address_name;
  document.getElementById("road_address").value = place.road_address_name || '';
  document.getElementById("latitude").value = place.y;
  document.getElementById("longitude").value = place.x;
  document.getElementById("kakao_place_id").value = place.id;

  // ğŸ”§ ì¹´ì¹´ì˜¤ë§µ ë°ì´í„°ë¥¼ JSONìœ¼ë¡œ ì €ì¥ (ìƒˆë¡œ ì¶”ê°€)
  const kakaoData = {
    place_name: place.place_name,      // ì‹¤ì œ ê°€ê²Œëª… - ì´ê²Œ ì¤‘ìš”!
    address_name: place.address_name,
    road_address_name: place.road_address_name || '',
    phone: place.phone || '',
    place_url: place.place_url || '',
    category_name: place.category_name || '',
    id: place.id,
    x: place.x,
    y: place.y
  };
  
  // hidden inputì— JSON ì €ì¥ (ìƒˆë¡œ ì¶”ê°€)
  let kakaoInput = document.getElementById('kakao_place_data');
  if (!kakaoInput) {
    // hidden inputì´ ì—†ìœ¼ë©´ ë™ì ìœ¼ë¡œ ìƒì„±
    kakaoInput = document.createElement('input');
    kakaoInput.type = 'hidden';
    kakaoInput.id = 'kakao_place_data';
    kakaoInput.name = 'kakao_place_data';
    document.querySelector('form').appendChild(kakaoInput);
  }
  kakaoInput.value = JSON.stringify(kakaoData);

  placeResults.classList.add('hidden');
}

// ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë¯¸ì§€ ì—…ë¡œë“œ
const imageUploadArea = document.querySelector('label[for="images"]').parentElement;

imageUploadArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  imageUploadArea.classList.add('border-blue-400', 'bg-blue-50');
});

imageUploadArea.addEventListener('dragleave', (e) => {
  e.preventDefault();
  imageUploadArea.classList.remove('border-blue-400', 'bg-blue-50');
});

imageUploadArea.addEventListener('drop', (e) => {
  e.preventDefault();
  imageUploadArea.classList.remove('border-blue-400', 'bg-blue-50');
  
  const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
  if (files.length > 0) {
    const input = document.getElementById('images');
    const dt = new DataTransfer();
    files.forEach(file => dt.items.add(file));
    input.files = dt.files;
    input.dispatchEvent(new Event('change'));
  }
});

// ë‚ ì§œ ìœ íš¨ì„± ê²€ì¦
document.querySelector('[name="start_date"]').addEventListener('change', function() {
  const endDate = document.querySelector('[name="end_date"]');
  endDate.min = this.value;
  
  if (endDate.value && endDate.value < this.value) {
    endDate.value = this.value;
  }
});

document.querySelector('[name="end_date"]').addEventListener('change', function() {
  const startDate = document.querySelector('[name="start_date"]');
  startDate.max = this.value;
  
  if (startDate.value && startDate.value > this.value) {
    startDate.value = this.value;
  }
});

// í¼ ì œì¶œ ì‹œ ë°ì´í„° ë³€í™˜
document.getElementById('multiStepForm').addEventListener('submit', function(e) {
  // ëª¨ë“  input, textarea, select í™œì„±í™”
  const allInputs = this.querySelectorAll('input, textarea, select');
  allInputs.forEach(input => {
    input.disabled = false;
  });
  
  // Twitter usernameì„ URLë¡œ ë³€í™˜
  const twitterUsername = document.querySelector('[name="twitter_username"]').value.trim();
  
  if (twitterUsername) {
    const twitterInput = document.createElement('input');
    twitterInput.type = 'hidden';
    twitterInput.name = 'twitter_source';
    twitterInput.value = `https://twitter.com/${twitterUsername.replace('@', '')}`;
    this.appendChild(twitterInput);
  }
});
</script>
{% endblock %}