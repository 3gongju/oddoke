{% extends "ddoksang/base/ddoksang_base.html" %}
{% load static %}

{% block body %}
<section class="max-w-4xl mx-auto px-4 py-10">
  <h1 class="text-2xl font-bold mb-6">ğŸ ìƒì¼ì¹´í˜ ë“±ë¡í•˜ê¸°</h1>
  <p class="text-sm text-gray-600 mb-8">ì¢‹ì•„í•˜ëŠ” ì•„í‹°ìŠ¤íŠ¸ì˜ ìƒì¼ì¹´í˜ ì •ë³´ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”!</p>

  <!-- Progress Bar -->
  <div class="w-full bg-gray-200 rounded-full h-2 mb-8 overflow-hidden">
    <div id="progressBar" class="bg-blue-600 h-2 w-0 transition-width duration-300"></div>
  </div>

  <form method="POST" enctype="multipart/form-data" id="multiStepForm" action="{% url 'ddoksang:create' %}">
    {% csrf_token %}

    <!-- STEP 1: ì•„í‹°ìŠ¤íŠ¸/ë©¤ë²„ ê²€ìƒ‰ -->
    <div id="step-1" class="step">
      <label class="block text-sm font-medium mb-2">ì•„í‹°ìŠ¤íŠ¸/ë©¤ë²„ëª… ê²€ìƒ‰</label>
      <input type="text" id="artist-member-search" class="w-full border rounded px-4 py-2" placeholder="ë©¤ë²„ëª… ì…ë ¥" autocomplete="off" required>
      <ul id="artist-member-results" class="border mt-2 rounded overflow-hidden hidden max-h-48 overflow-y-auto"></ul>
      
      <input type="hidden" name="artist_id" id="artist_id">
      <input type="hidden" name="member_id" id="member_id">
      
      <!-- ì„ íƒëœ ì•„í‹°ìŠ¤íŠ¸ í‘œì‹œ -->
      <div id="selected-artist" class="mt-2 p-2 border rounded bg-blue-50 hidden">
        <div class="flex items-center justify-between">
          <div>
            <p class="font-medium text-blue-800" id="selected-artist-text"></p>
          </div>
          <button type="button" onclick="clearSelection()" class="text-blue-600 hover:text-blue-800 text-sm">ë³€ê²½</button>
        </div>
      </div>
    </div>

    <!-- STEP 2: ì¹´í˜ ì •ë³´ -->
    <div id="step-2" class="step hidden">
      <label class="block text-sm font-medium mb-2">ì¹´í˜ëª…</label>
      <input type="text" name="cafe_name" class="w-full border rounded px-4 py-2 mb-4" placeholder="ì¹´í˜ëª… ì…ë ¥" required>

      <label class="block text-sm font-medium mb-2">ì´ë²¤íŠ¸ ìœ í˜•</label>
      <select name="cafe_type" class="w-full border rounded px-4 py-2 mb-4" required>
        <option value="bday">ğŸ‚ ìƒì¼</option>
        <option value="debut">ë°ë·”</option>
        <option value="comeback">ì»´ë°±</option>
        <option value="concert">ì½˜ì„œíŠ¸</option>
        <option value="other">ê¸°íƒ€</option>
      </select>

      <label class="block text-sm font-medium mb-2">ì£¼ì†Œ ê²€ìƒ‰</label>
      <div class="flex gap-2 mb-2">
        <input type="text" id="place-search" class="flex-grow border rounded px-4 py-2" placeholder="ì£¼ì†Œëª…ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off" required>
        <button type="button" id="searchBtn" class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700">ê²€ìƒ‰</button>
      </div>

      <!-- ì§€ë„ ì»¨í…Œì´ë„ˆ -->
      <div class="relative w-full h-64 bg-gray-100 rounded border overflow-hidden">
        <div id="map" class="w-full h-full"></div>
        <div id="mapPlaceholder" class="absolute inset-0 flex items-center justify-center bg-gray-100">
          <div class="text-center text-gray-500">
            <svg class="w-16 h-16 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <p class="text-sm">ì£¼ì†Œë¥¼ ê²€ìƒ‰í•˜ë©´ ì§€ë„ê°€ í‘œì‹œë©ë‹ˆë‹¤</p>
          </div>
        </div>
      </div>

      <ul id="place-results" class="mt-2 max-h-40 overflow-y-auto border rounded hidden"></ul>
      <div id="selected-place" class="mt-2 p-2 border rounded bg-green-50 hidden"></div>

      <input type="hidden" name="address" id="address" required>
      <input type="hidden" name="road_address" id="road_address">
      <input type="hidden" name="latitude" id="latitude" required>
      <input type="hidden" name="longitude" id="longitude" required>
      <input type="hidden" name="kakao_place_id" id="kakao_place_id">
    </div>

    <!-- STEP 3: ì¼ì • -->
    <div id="step-3" class="step hidden">
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-2">ì‹œì‘ì¼</label>
          <div class="relative">
            <input type="date" name="start_date" class="w-full border rounded px-4 py-3 pr-10" required>
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
              <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
            </div>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">ì¢…ë£Œì¼</label>
          <div class="relative">
            <input type="date" name="end_date" class="w-full border rounded px-4 py-3 pr-10" required>
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
              <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- STEP 4: íŠ¹ì „ ë° ì´ë²¤íŠ¸ ì •ë³´ -->
    <div id="step-4" class="step hidden">
      <label class="block text-sm font-medium mb-4">íŠ¹ì „ ì •ë³´ (ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥)</label>
      
      <!-- ìŒì‹ -->
      <div class="mb-6">
        <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
          ğŸ° ìŒì‹
        </h4>
        <div class="grid grid-cols-4 gap-2">
          <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="perks" value="í™€ì¼€ì´í¬" class="sr-only">
            <span class="perk-btn">ğŸ‚ í™€ì¼€ì´í¬</span>
          </label>
          <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="perks" value="í¬í† ì¹´ë“œ" class="sr-only">
            <span class="perk-btn">ğŸ° ì¼€ì´í¬</span>
          </label>
          <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="perks" value="ìŒë£Œìˆ˜" class="sr-only">
            <span class="perk-btn">ğŸ¥¤ ìŒë£Œìˆ˜</span>
          </label>
          <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="perks" value="ì¿ í‚¤" class="sr-only">
            <span class="perk-btn">ğŸª ì¿ í‚¤</span>
          </label>
          <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="perks" value="ì»µì¼€ì´í¬" class="sr-only">
            <span class="perk-btn">ğŸ§ ì»µì¼€ì´í¬</span>
          </label>
          <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="perks" value="ë„ë„›" class="sr-only">
            <span class="perk-btn">ğŸ© ë„ë„›</span>
          </label>
          <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="perks" value="ì´ˆì½œë¦¿" class="sr-only">
            <span class="perk-btn">ğŸ« ì´ˆì½œë¦¿</span>
          </label>
          <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="perks" value="ì»¤í”¼" class="sr-only">
            <span class="perk-btn">â˜• ì»¤í”¼</span>
          </label>
        </div>
      </div>

      <!-- êµ¿ì¦ˆ -->
      <div class="mb-6">
        <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
          ğŸ êµ¿ì¦ˆ
        </h4>
        <div class="grid grid-cols-4 gap-2">
          <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="perks" value="í¬í† ì¹´ë“œ" class="sr-only">
            <span class="perk-btn">ğŸ“· í¬í† ì¹´ë“œ</span>
          </label>
          <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="perks" value="ìŠ¤í‹°ì»¤" class="sr-only">
            <span class="perk-btn">â­ ìŠ¤í‹°ì»¤</span>
          </label>
          <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="perks" value="í‚¤ë§" class="sr-only">
            <span class="perk-btn">ğŸ”‘ í‚¤ë§</span>
          </label>
          <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="perks" value="ì¹´ë“œì§€ê°‘" class="sr-only">
            <span class="perk-btn">ğŸ’³ ì¹´ë“œì§€ê°‘</span>
          </label>
          <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="perks" value="í‹°ì…”ì¸ " class="sr-only">
            <span class="perk-btn">ğŸ‘• í‹°ì…”ì¸ </span>
          </label>
          <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="perks" value="ë“œë§í¬í™€ë”" class="sr-only">
            <span class="perk-btn">ğŸ¥¤ ë“œë§í¬í™€ë”</span>
          </label>
          <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="perks" value="ì—½ì„œ" class="sr-only">
            <span class="perk-btn">ğŸ’Œ ì—½ì„œ</span>
          </label>
          <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="perks" value="íƒ€íˆ¬ìŠ¤í‹°ì»¤" class="sr-only">
            <span class="perk-btn">ğŸŒŸ íƒ€íˆ¬ìŠ¤í‹°ì»¤</span>
          </label>
        </div>
      </div>

      <!-- ê¸°íƒ€ -->
      <div class="mb-6">
        <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
          âœ¨ ê¸°íƒ€
        </h4>
        <div class="grid grid-cols-4 gap-2">
          <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="perks" value="ë©”ë‰´ íŠ¹ê°€" class="sr-only">
            <span class="perk-btn">ğŸ’° ë©”ë‰´ íŠ¹ê°€</span>
          </label>
          <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="perks" value="ì„ ì°©ìˆœ íŠ¹ì „" class="sr-only">
            <span class="perk-btn">ğŸƒ ì„ ì°©ìˆœ íŠ¹ì „</span>
          </label>
          <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="perks" value="ëœë¤ íŠ¹ì „" class="sr-only">
            <span class="perk-btn">ğŸ² ëœë¤ íŠ¹ì „</span>
          </label>
          <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="perks" value="ì´ë²¤íŠ¸ í• ì¸" class="sr-only">
            <span class="perk-btn">ğŸŠ ì´ë²¤íŠ¸ í• ì¸</span>
          </label>
          <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="perks" value="ê½ƒë‹¤ë°œ" class="sr-only">
            <span class="perk-btn">ğŸ’ ê½ƒë‹¤ë°œ</span>
          </label>
          <label class="inline-flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="perks" value="ê¸°ë…í’ˆ" class="sr-only">
            <span class="perk-btn">ğŸ ê¸°ë…í’ˆ</span>
          </label>
        </div>
      </div>

      <label class="block text-sm font-medium mb-2">ì´ë²¤íŠ¸ ì„¤ëª…</label>
      <textarea name="event_description" class="w-full border rounded p-3" rows="4" placeholder="ìƒì¼ì¹´í˜ ì´ë²¤íŠ¸ì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." required></textarea>

      <label class="block text-sm font-medium mb-2 mt-4">í•´ì‹œíƒœê·¸</label>
      <input type="text" name="hashtags" class="w-full border rounded p-3" placeholder="#íƒœê·¸1 #íƒœê·¸2">
    </div>

    <!-- STEP 5: ì¶œì²˜ ì •ë³´ -->
    <div id="step-5" class="step hidden">
      <label class="block text-sm font-medium mb-2">X (íŠ¸ìœ„í„°) ê³„ì •</label>
      <div class="flex items-center mb-4">
        <span class="inline-flex items-center px-3 py-2 border border-r-0 border-gray-300 bg-gray-50 text-gray-500 text-sm rounded-l">@</span>
        <input type="text" name="twitter_username" class="flex-1 border border-gray-300 rounded-r px-3 py-2" placeholder="twitter_username">
      </div>
      <p class="text-xs text-gray-500 mb-4">ì˜ˆ: @bts_official â†’ https://twitter.com/bts_official ë§í¬ë¡œ ì—°ê²°ë©ë‹ˆë‹¤</p>
    </div>

    <!-- STEP 6: ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
    <div id="step-6" class="step hidden">
      <label class="block text-sm font-medium mb-4">ìƒì¼ì¹´í˜ ì´ë¯¸ì§€ ì—…ë¡œë“œ</label>
      
      <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors">
        <input type="file" name="images" id="images" multiple accept="image/*" class="hidden">
        <label for="images" class="cursor-pointer">
          <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div class="mt-4">
            <p class="text-sm text-gray-600">
              <span class="font-medium text-blue-600 hover:text-blue-500">í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì„ íƒ</span> ë˜ëŠ” ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ
            </p>
            <p class="text-xs text-gray-500">PNG, JPG, JPEG íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥ (ìµœëŒ€ 5ê°œ, ê° 5MB ì´í•˜)</p>
          </div>
        </label>
      </div>

      <div id="image-preview" class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-4"></div>
    </div>

    <!-- STEP 7: ìµœì¢… í™•ì¸ -->
    <div id="step-7" class="step hidden">
      <h3 class="text-lg font-semibold mb-6">ğŸ“‹ ì…ë ¥ ë‚´ìš© ìµœì¢… í™•ì¸</h3>
      
      <div class="bg-gray-50 rounded-lg p-6 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <h4 class="font-medium text-gray-900 mb-2">ì•„í‹°ìŠ¤íŠ¸/ë©¤ë²„</h4>
            <p id="summary-name" class="text-gray-700"></p>
          </div>
          <div>
            <h4 class="font-medium text-gray-900 mb-2">ì¹´í˜ëª…</h4>
            <p id="summary-cafe-name" class="text-gray-700"></p>
          </div>
          <div>
            <h4 class="font-medium text-gray-900 mb-2">ì£¼ì†Œ</h4>
            <p id="summary-address" class="text-gray-700"></p>
          </div>
          <div>
            <h4 class="font-medium text-gray-900 mb-2">ì¼ì •</h4>
            <p id="summary-dates" class="text-gray-700"></p>
          </div>
          <div>
            <h4 class="font-medium text-gray-900 mb-2">íŠ¹ì „ ì •ë³´</h4>
            <p id="summary-perks" class="text-gray-700"></p>
          </div>
          <div>
            <h4 class="font-medium text-gray-900 mb-2">SNS ê³„ì •</h4>
            <p id="summary-social" class="text-gray-700"></p>
          </div>
        </div>
        
        <div>
          <h4 class="font-medium text-gray-900 mb-2">ì´ë²¤íŠ¸ ì„¤ëª…</h4>
          <p id="summary-desc" class="text-gray-700"></p>
        </div>
        
        <div>
          <h4 class="font-medium text-gray-900 mb-2">ì—…ë¡œë“œëœ ì´ë¯¸ì§€</h4>
          <div id="summary-images" class="flex flex-wrap gap-2"></div>
        </div>
      </div>

      <div class="mt-6 p-4 bg-blue-50 rounded-lg">
        <div class="flex">
          <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
          </svg>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-blue-800">ì œì¶œ ì „ í™•ì¸ì‚¬í•­</h3>
            <div class="mt-2 text-sm text-blue-700">
              <p>â€¢ ì…ë ¥í•œ ì •ë³´ê°€ ì •í™•í•œì§€ ë‹¤ì‹œ í•œ ë²ˆ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
              <p>â€¢ ì œì¶œ í›„ì—ëŠ” ê´€ë¦¬ì ìŠ¹ì¸ì„ ê±°ì³ ê³µê°œë©ë‹ˆë‹¤.</p>
              <p>â€¢ í—ˆìœ„ ì •ë³´ ì…ë ¥ ì‹œ ìŠ¹ì¸ì´ ê±°ì ˆë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
    <div class="mt-8 flex justify-between">
      <button type="button" id="prevBtn" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">ì´ì „</button>
      <button type="button" id="nextBtn" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">ë‹¤ìŒ</button>
    </div>
  </form>
</section>

<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_api_key }}&libraries=services"></script>

<style>
.perk-btn {
  display: block;
  width: 100%;
  text-align: center;
  font-size: 12px;
  transition: all 0.2s;
}

input[type="checkbox"]:checked + .perk-btn {
  background-color: #3b82f6;
  color: white;
  border-radius: 4px;
}

input[type="checkbox"]:checked + .perk-btn {
  transform: scale(0.95);
}

label:hover .perk-btn {
  background-color: #f3f4f6;
}

input[type="checkbox"]:checked + .perk-btn:hover {
  background-color: #2563eb !important;
  color: white !important;
}
</style>

<script>
const steps = 7;
let currentStep = 1;
let map = null;

const nextBtn = document.getElementById("nextBtn");
const prevBtn = document.getElementById("prevBtn");
const progressBar = document.getElementById("progressBar");

function updateStepVisibility() {
  for (let i = 1; i <= steps; i++) {
    const stepDiv = document.getElementById(`step-${i}`);
    const inputs = stepDiv.querySelectorAll("input:not([type='hidden']), textarea, select");
    if (i === currentStep) {
      stepDiv.classList.remove("hidden");
      inputs.forEach(el => el.disabled = false);
    } else {
      stepDiv.classList.add("hidden");
      inputs.forEach(el => el.disabled = true);
    }
  }
  
  // í”„ë¡œê·¸ë ˆìŠ¤ë°” ì—…ë°ì´íŠ¸
  progressBar.style.width = `${(currentStep / steps) * 100}%`;

  // ë²„íŠ¼ ìƒíƒœ ì¡°ì •
  prevBtn.disabled = currentStep === 1;
  
  if (currentStep === steps) {
    nextBtn.textContent = "ìµœì¢… ì œì¶œ";
    nextBtn.type = "submit";
    nextBtn.className = "px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600";
  } else {
    nextBtn.textContent = "ë‹¤ìŒ";
    nextBtn.type = "button";
    nextBtn.className = "px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600";
  }
  
  // Step 2ì—ì„œ ì§€ë„ ì´ˆê¸°í™”
  if (currentStep === 2 && !map) {
    initializeMap();
  }
}

function validateStep() {
  const currentStepDiv = document.getElementById(`step-${currentStep}`);
  
  // Step 1: ì•„í‹°ìŠ¤íŠ¸ ì„ íƒ ê²€ì¦
  if (currentStep === 1) {
    const artistId = document.getElementById("artist_id").value;
    const searchInput = document.getElementById("artist-member-search").value.trim();
    
    if (!artistId || !searchInput) {
      alert("ì•„í‹°ìŠ¤íŠ¸/ë©¤ë²„ë¥¼ ê²€ìƒ‰í•˜ê³  ì„ íƒí•´ì£¼ì„¸ìš”.");
      document.getElementById("artist-member-search").focus();
      return false;
    }
    return true;
  }
  
  // ë‹¤ë¥¸ ë‹¨ê³„ë“¤ì˜ ê¸°ë³¸ ê²€ì¦
  const requiredFields = currentStepDiv.querySelectorAll("[required]");
  
  for (const field of requiredFields) {
    if (!field.value.trim()) {
      field.focus();
      alert("í•„ìˆ˜ ì…ë ¥ë€ì„ ëª¨ë‘ ì±„ì›Œì£¼ì„¸ìš”.");
      return false;
    }
  }
  
  // Step 2: ì£¼ì†Œ ì„ íƒ ê²€ì¦
  if (currentStep === 2) {
    const address = document.getElementById("address").value;
    if (!address) {
      alert("ì£¼ì†Œë¥¼ ê²€ìƒ‰í•˜ê³  ì„ íƒí•´ì£¼ì„¸ìš”.");
      document.getElementById("place-search").focus();
      return false;
    }
  }
  
  return true;
}

function updateSummary() {
  // ì•„í‹°ìŠ¤íŠ¸/ë©¤ë²„
  document.getElementById("summary-name").textContent = document.getElementById("artist-member-search").value;
  
  // ì¹´í˜ëª…
  document.getElementById("summary-cafe-name").textContent = document.querySelector('[name="cafe_name"]').value;
  
  // ì£¼ì†Œ
  document.getElementById("summary-address").textContent = document.getElementById("address").value;
  
  // ë‚ ì§œ
  const start = document.querySelector('[name="start_date"]').value;
  const end = document.querySelector('[name="end_date"]').value;
  document.getElementById("summary-dates").textContent = `${start} ~ ${end}`;

  // íŠ¹ì „
  const perks = [...document.querySelectorAll('input[name="perks"]:checked')].map(el => el.value);
  document.getElementById("summary-perks").textContent = perks.length > 0 ? perks.join(", ") : "(ì„ íƒ ì•ˆí•¨)";

  // SNS
  const twitter = document.querySelector('[name="twitter_username"]').value;
  let socialText = "";
  if (twitter) socialText += `X: @${twitter}`;
  document.getElementById("summary-social").textContent = socialText || "(ì—†ìŒ)";

  // ì„¤ëª…
  document.getElementById("summary-desc").textContent = document.querySelector('[name="event_description"]').value || "(ì„¤ëª… ì—†ìŒ)";
  
  // ì´ë¯¸ì§€
  const imageContainer = document.getElementById("summary-images");
  const images = document.getElementById("images").files;
  imageContainer.innerHTML = "";
  for (let i = 0; i < images.length; i++) {
    const img = document.createElement("img");
    img.src = URL.createObjectURL(images[i]);
    img.className = "w-16 h-16 object-cover rounded border";
    imageContainer.appendChild(img);
  }
  if (images.length === 0) {
    imageContainer.innerHTML = '<span class="text-gray-500 text-sm">(ì´ë¯¸ì§€ ì—†ìŒ)</span>';
  }
}

nextBtn.addEventListener("click", () => {
  if (!validateStep()) return;

  if (currentStep < steps) {
    currentStep++;
    updateStepVisibility();

    if (currentStep === steps) {
      updateSummary();
    }
  }
});

prevBtn.addEventListener("click", () => {
  if (currentStep > 1) {
    currentStep--;
    updateStepVisibility();
  }
});

// ì´ˆê¸° ìƒíƒœ ì„¤ì •
updateStepVisibility();

// ì§€ë„ ì´ˆê¸°í™”
function initializeMap() {
  const mapContainer = document.getElementById('map');
  const mapOption = {
    center: new kakao.maps.LatLng(37.5665, 126.9780),
    level: 3
  };
  
  map = new kakao.maps.Map(mapContainer, mapOption);
  document.getElementById('mapPlaceholder').style.display = 'none';
}

// ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
document.getElementById("images").addEventListener("change", function () {
  const previewContainer = document.getElementById("image-preview");
  previewContainer.innerHTML = "";
  
  if (this.files.length > 5) {
    alert("ìµœëŒ€ 5ê°œì˜ ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    this.value = "";
    return;
  }
  
  Array.from(this.files).forEach((file, index) => {
    if (file.size > 5 * 1024 * 1024) {
      alert(`${file.name}: íŒŒì¼ í¬ê¸°ê°€ 5MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function (e) {
      const div = document.createElement("div");
      div.className = "relative";
      div.innerHTML = `
        <img src="${e.target.result}" alt="Preview ${index + 1}" class="w-full h-32 object-cover rounded border">
        <div class="absolute top-2 left-2 bg-blue-500 text-white text-xs px-2 py-1 rounded">
          ${index === 0 ? 'ëŒ€í‘œ' : index + 1}
        </div>
        <button type="button" onclick="removeImage(${index})" class="absolute top-2 right-2 bg-red-500 text-white text-xs w-6 h-6 rounded-full hover:bg-red-600">
          Ã—
        </button>
      `;
      previewContainer.appendChild(div);
    };
    reader.readAsDataURL(file);
  });
});

function removeImage(index) {
  const input = document.getElementById("images");
  const dt = new DataTransfer();
  
  Array.from(input.files).forEach((file, i) => {
    if (i !== index) dt.items.add(file);
  });
  
  input.files = dt.files;
  input.dispatchEvent(new Event('change'));
}

// ì•„í‹°ìŠ¤íŠ¸/ë©¤ë²„ ìë™ì™„ì„±
document.getElementById("artist-member-search").addEventListener("input", function () {
  const keyword = this.value.trim();
  const resultsBox = document.getElementById("artist-member-results");
  resultsBox.innerHTML = "";
  
  if (!keyword) {
    resultsBox.classList.add("hidden");
    clearSelection();
    return;
  }
  
  fetch(`/ddoksang/autocomplete/members/?q=${encodeURIComponent(keyword)}`)
    .then(res => res.json())
    .then(data => {
      const results = data.results;
      if (results.length === 0) {
        resultsBox.innerHTML = '<li class="px-4 py-2 text-gray-500 text-sm">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
        resultsBox.classList.remove("hidden");
        return;
      }
      
      results.forEach(item => {
        const li = document.createElement("li");
        li.className = "hover:bg-gray-100 px-4 py-2 cursor-pointer text-sm border-b";
        li.innerHTML = `
          <div class="flex justify-between">
            <span>${item.member_name} <span class="text-gray-500 text-xs">(${item.artist_display})</span></span>
            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded">${item.bday}</span>
          </div>
        `;
        li.onclick = () => selectArtist(item);
        resultsBox.appendChild(li);
      });
      resultsBox.classList.remove("hidden");
    })
    .catch(err => {
      console.error('ìë™ì™„ì„± ì˜¤ë¥˜:', err);
      resultsBox.innerHTML = '<li class="px-4 py-2 text-red-500 text-sm">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</li>';
      resultsBox.classList.remove("hidden");
    });
});

function selectArtist(item) {
  // ê²€ìƒ‰ ê²°ê³¼ ìˆ¨ê¸°ê¸°
  document.getElementById("artist-member-results").classList.add("hidden");
  
  // ì„ íƒëœ ì•„í‹°ìŠ¤íŠ¸ ì •ë³´ ì„¤ì •
  document.getElementById("artist-member-search").value = `${item.member_name} (${item.artist_display})`;
  document.getElementById("artist_id").value = item.artist_id;
  document.getElementById("member_id").value = item.member_id;
  
  // ì„ íƒëœ ì•„í‹°ìŠ¤íŠ¸ í‘œì‹œ
  document.getElementById("selected-artist-text").textContent = `âœ“ ${item.member_name} (${item.artist_display}) ì„ íƒë¨`;
  document.getElementById("selected-artist").classList.remove("hidden");
  
  console.log('ì•„í‹°ìŠ¤íŠ¸ ì„ íƒë¨:', {
    artist_id: item.artist_id,
    member_id: item.member_id,
    member_name: item.member_name,
    artist_display: item.artist_display
  });
}

function clearSelection() {
  document.getElementById("artist_id").value = "";
  document.getElementById("member_id").value = "";
  document.getElementById("artist-member-search").value = "";
  document.getElementById("selected-artist").classList.add("hidden");
  document.getElementById("artist-member-results").classList.add("hidden");
}

// ì¹´ì¹´ì˜¤ë§µ ì£¼ì†Œ ê²€ìƒ‰
let ps = null;
let marker = null;

function initPlaceSearch() {
  if (!ps) {
    ps = new kakao.maps.services.Places();
    marker = new kakao.maps.Marker({ map: map });
  }
}

const placeInput = document.getElementById("place-search");
const searchBtn = document.getElementById("searchBtn");
const placeResults = document.getElementById('place-results');
const selectedPlaceDiv = document.getElementById('selected-place');

searchBtn?.addEventListener('click', searchPlace);

placeInput.addEventListener("keydown", function (e) {
  if (e.key === "Enter") {
    e.preventDefault();
    searchPlace();
  }
});

function searchPlace() {
  if (!map) initializeMap();
  if (!ps) initPlaceSearch();
  
  let keyword = placeInput.value.trim();
  if (!keyword) return;
  
  ps.keywordSearch(keyword, function (data, status) {
    if (status === kakao.maps.services.Status.OK) {
      placeResults.innerHTML = '';
      placeResults.classList.remove('hidden');
      
      data.forEach(place => {
        const li = document.createElement('li');
        li.textContent = `${place.place_name} (${place.road_address_name || place.address_name})`;
        li.className = 'px-4 py-2 cursor-pointer hover:bg-gray-200 border-b last:border-none text-sm';
        li.addEventListener('click', () => selectPlace(place));
        placeResults.appendChild(li);
      });
    } else {
      placeResults.innerHTML = '<li class="px-4 py-2 text-red-500 text-sm">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
      placeResults.classList.remove('hidden');
    }
  });
}

function selectPlace(place) {
  const latlng = new kakao.maps.LatLng(place.y, place.x);
  map.setCenter(latlng);
  marker.setPosition(latlng);

  selectedPlaceDiv.innerHTML = `
    <div class="flex items-center justify-between">
      <div>
        <p class="font-medium text-green-800">${place.place_name}</p>
        <p class="text-sm text-green-600">${place.road_address_name || place.address_name}</p>
      </div>
      <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
      </svg>
    </div>
  `;
  selectedPlaceDiv.classList.remove('hidden');

  // í¼ ë°ì´í„° ì„¤ì •
  document.getElementById("address").value = place.address_name;
  document.getElementById("road_address").value = place.road_address_name || '';
  document.getElementById("latitude").value = place.y;
  document.getElementById("longitude").value = place.x;
  document.getElementById("kakao_place_id").value = place.id;

  placeResults.classList.add('hidden');
}

// ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë¯¸ì§€ ì—…ë¡œë“œ
const imageUploadArea = document.querySelector('label[for="images"]').parentElement;

imageUploadArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  imageUploadArea.classList.add('border-blue-400', 'bg-blue-50');
});

imageUploadArea.addEventListener('dragleave', (e) => {
  e.preventDefault();
  imageUploadArea.classList.remove('border-blue-400', 'bg-blue-50');
});

imageUploadArea.addEventListener('drop', (e) => {
  e.preventDefault();
  imageUploadArea.classList.remove('border-blue-400', 'bg-blue-50');
  
  const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
  if (files.length > 0) {
    const input = document.getElementById('images');
    const dt = new DataTransfer();
    files.forEach(file => dt.items.add(file));
    input.files = dt.files;
    input.dispatchEvent(new Event('change'));
  }
});

// ë‚ ì§œ ìœ íš¨ì„± ê²€ì¦
document.querySelector('[name="start_date"]').addEventListener('change', function() {
  const endDate = document.querySelector('[name="end_date"]');
  endDate.min = this.value;
  
  if (endDate.value && endDate.value < this.value) {
    endDate.value = this.value;
  }
});

document.querySelector('[name="end_date"]').addEventListener('change', function() {
  const startDate = document.querySelector('[name="start_date"]');
  startDate.max = this.value;
  
  if (startDate.value && startDate.value > this.value) {
    startDate.value = this.value;
  }
});

// í¼ ì œì¶œ ì‹œ ë°ì´í„° ë³€í™˜
document.getElementById('multiStepForm').addEventListener('submit', function(e) {
  console.log("=== í¼ ì œì¶œ ì§ì „ ë””ë²„ê¹… ===");
  
  // ğŸ”§ ëª¨ë“  input, textarea, select í™œì„±í™” (ì•„ì£¼ ì¤‘ìš”!)
  const allInputs = this.querySelectorAll('input, textarea, select');
  allInputs.forEach(input => {
    input.disabled = false;
  });
  
  console.log('artist_id:', document.getElementById('artist_id').value);
  console.log('member_id:', document.getElementById('member_id').value);
  console.log('cafe_name:', document.querySelector('[name="cafe_name"]').value);
  console.log('address:', document.getElementById('address').value);
  console.log('start_date:', document.querySelector('[name="start_date"]').value);
  console.log('end_date:', document.querySelector('[name="end_date"]').value);
  console.log('event_description:', document.querySelector('[name="event_description"]').value);
  
  // Twitter usernameì„ URLë¡œ ë³€í™˜
  const twitterUsername = document.querySelector('[name="twitter_username"]').value.trim();
  
  if (twitterUsername) {
    const twitterInput = document.createElement('input');
    twitterInput.type = 'hidden';
    twitterInput.name = 'twitter_source';
    twitterInput.value = `https://twitter.com/${twitterUsername.replace('@', '')}`;
    this.appendChild(twitterInput);
  }
  
  console.log("==========================");
});
</script>
{% endblock %}