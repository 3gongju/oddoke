{% extends "ddoksang/base/ddoksang_base.html" %}
{% load static %}

{% block body %}
<section class="max-w-4xl mx-auto px-4 py-10">
  <h1 class="text-2xl font-bold mb-6">ğŸ ìƒì¼ì¹´í˜ ë“±ë¡í•˜ê¸°</h1>
  <p class="text-sm text-gray-600 mb-8">ì¢‹ì•„í•˜ëŠ” ì•„í‹°ìŠ¤íŠ¸ì˜ ìƒì¼ì¹´í˜ ì •ë³´ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”!</p>

  <form method="POST" id="multiStepForm">
    {% csrf_token %}

    <!-- STEP 1: ì•„í‹°ìŠ¤íŠ¸/ë©¤ë²„ ê²€ìƒ‰ -->
    <div id="step-1" class="step">
      <label class="block text-sm font-medium mb-2">ì•„í‹°ìŠ¤íŠ¸/ë©¤ë²„ëª… ê²€ìƒ‰</label>
      <input type="text" id="artist-member-search" class="w-full border rounded px-4 py-2" placeholder="ë©¤ë²„ëª… ì…ë ¥">
      <ul id="artist-member-results" class="border mt-2 rounded overflow-hidden hidden"></ul>
      <input type="hidden" name="artist_id" id="artist_id">
      <input type="hidden" name="member_id" id="member_id">
    </div>

    <!-- STEP 2: ì¥ì†Œ -->
    <div id="step-2" class="step hidden">
      <label class="block text-sm font-medium mb-2">ì¹´í˜ ìœ„ì¹˜ ê²€ìƒ‰</label>
      <input type="text" id="place-search" class="w-full border rounded px-4 py-2" placeholder="ì¥ì†Œëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
      <div id="map" class="w-full h-64 bg-gray-100 my-4 rounded"></div>
      <input type="hidden" name="address" id="address">
      <input type="hidden" name="road_address" id="road_address">
      <input type="hidden" name="latitude" id="latitude">
      <input type="hidden" name="longitude" id="longitude">
      <input type="hidden" name="kakao_place_id" id="kakao_place_id">
    </div>

    <!-- STEP 3: ì¼ì • -->
    <div id="step-3" class="step hidden">
      <label class="block text-sm font-medium mb-1">ì‹œì‘ì¼</label>
      <input type="date" name="start_date" class="w-full border rounded p-2">
      <label class="block text-sm font-medium mb-1 mt-4">ì¢…ë£Œì¼</label>
      <input type="date" name="end_date" class="w-full border rounded p-2">
    </div>

    <!-- STEP 4: ì„¤ëª… -->
    <div id="step-4" class="step hidden">
      <label class="block text-sm font-medium mb-2">ì´ë²¤íŠ¸ ì„¤ëª…</label>
      <textarea name="event_description" class="w-full border rounded p-2" rows="4"></textarea>
      <input type="text" name="hashtags" class="w-full border rounded p-2 mt-2" placeholder="#íƒœê·¸1 #íƒœê·¸2">
      <input type="url" name="twitter_source" class="w-full border rounded p-2 mt-2" placeholder="Twitter ë§í¬">
      <input type="url" name="instagram_source" class="w-full border rounded p-2 mt-2" placeholder="Instagram ë§í¬">
    </div>

    <!-- STEP 5: í™•ì¸ ë° ì œì¶œ -->
    <div id="step-5" class="step hidden">
      <h3 class="font-semibold mb-4">ì…ë ¥í•˜ì‹  ë‚´ìš©ì„ í™•ì¸í•˜ê³  ì œì¶œí•´ì£¼ì„¸ìš”.</h3>
      <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">ğŸ‰ ë“±ë¡ ì™„ë£Œí•˜ê¸°</button>
    </div>

    <div class="mt-6 flex justify-between">
      <button type="button" id="prevBtn" class="bg-gray-300 px-4 py-2 rounded">ì´ì „</button>
      <button type="button" id="nextBtn" class="bg-blue-500 text-white px-4 py-2 rounded">ë‹¤ìŒ</button>
    </div>
  </form>
</section>

<!-- âœ… ë©¤ë²„ ìë™ì™„ì„± ìŠ¤í¬ë¦½íŠ¸ -->
<script>
document.getElementById("artist-member-search").addEventListener("input", function () {
  const keyword = this.value.trim();
  const resultsBox = document.getElementById("artist-member-results");
  resultsBox.innerHTML = "";

  if (!keyword) {
    resultsBox.classList.add("hidden");
    return;
  }

  fetch(`/ddoksang/autocomplete/members/?q=` + encodeURIComponent(keyword))
    .then(res => res.json())
    .then(data => {
      const results = data.results;
      if (results.length === 0) {
        resultsBox.classList.add("hidden");
        return;
      }

      results.forEach(item => {
        const li = document.createElement("li");
        li.className = "hover:bg-gray-100 px-4 py-2 cursor-pointer text-sm border-b";
        li.innerHTML = `
          <div class="flex justify-between">
            <span>${item.member_name} <span class="text-gray-500 text-xs">(${item.artist_display})</span></span>
            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded">${item.bday}</span>
          </div>
        `;
        li.onclick = () => {
          document.getElementById("artist-member-search").value = `${item.member_name} (${item.artist_display})`;
          document.getElementById("artist_id").value = item.artist_id;
          document.getElementById("member_id").value = item.member_id;
          resultsBox.classList.add("hidden");
        };
        resultsBox.appendChild(li);
      });
      resultsBox.classList.remove("hidden");
    });
});
</script>

<!-- âœ… ì¹´ì¹´ì˜¤ë§µ ì—°ë™ ìŠ¤í¬ë¦½íŠ¸ -->
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_api_key }}&libraries=services"></script>
<script>
let map = new kakao.maps.Map(document.getElementById('map'), {
  center: new kakao.maps.LatLng(37.5665, 126.9780),
  level: 3
});
let ps = new kakao.maps.services.Places();
let marker = new kakao.maps.Marker({ map: map });

const placeInput = document.getElementById("place-search");
placeInput.addEventListener("keydown", function (e) {
  if (e.key === "Enter") {
    e.preventDefault();
    searchPlace();
  }
});

function searchPlace() {
  let keyword = placeInput.value;
  if (!keyword.trim()) return;
  ps.keywordSearch(keyword, function (data, status) {
    if (status === kakao.maps.services.Status.OK) {
      const place = data[0];
      const latlng = new kakao.maps.LatLng(place.y, place.x);
      map.setCenter(latlng);
      marker.setPosition(latlng);

      document.getElementById("address").value = place.address_name;
      document.getElementById("road_address").value = place.road_address_name;
      document.getElementById("latitude").value = place.y;
      document.getElementById("longitude").value = place.x;
      document.getElementById("kakao_place_id").value = place.id;
    }
  });
}
</script>
<script>
document.getElementById("artist-member-search").addEventListener("input", function () {
  const keyword = this.value.trim();
  const resultsBox = document.getElementById("artist-member-results");
  resultsBox.innerHTML = "";

  if (!keyword) {
    resultsBox.classList.add("hidden");
    return;
  }

  fetch(`/ddoksang/autocomplete/members/?q=` + encodeURIComponent(keyword))
    .then(res => res.json())
    .then(data => {
      const results = data.results;
      if (results.length === 0) {
        resultsBox.classList.add("hidden");
        return;
      }

      results.forEach(item => {
        const li = document.createElement("li");
        li.className = "hover:bg-gray-100 px-4 py-2 cursor-pointer text-sm border-b";
        li.innerHTML = `
          <div class="flex justify-between">
            <span>${item.member_name} <span class="text-gray-500 text-xs">(${item.artist_display})</span></span>
            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded">${item.bday}</span>
          </div>
        `;
        li.onclick = () => {
          document.getElementById("artist-member-search").value = `${item.member_name} (${item.artist_display})`;
          document.getElementById("artist_id").value = item.artist_id;
          document.getElementById("member_id").value = item.member_id;
          resultsBox.classList.add("hidden");
        };
        resultsBox.appendChild(li);
      });
      resultsBox.classList.remove("hidden");
    });
});
</script>


{% endblock %}
