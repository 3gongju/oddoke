{% extends "ddoksang/base/ddoksang_base.html" %}
{% load static %}
{% load filters %}
{% load member_images %}

{% block title %}ğŸ‚ ë•ìƒ - ìƒì¼ì¹´í˜ íˆ¬ì–´ë§µ{% endblock %}

{% block ddoksang_content %}

<!-- JSON ë°ì´í„° ì „ë‹¬ -->
{% csrf_token %}
{{ cafes_json|json_script:"cafes-data" }}

<!-- ìœ„ì¹˜ ë™ì˜ ëª¨ë‹¬ -->
<div id="locationModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-2xl p-6 sm:p-8 max-w-md w-full mx-4 shadow-2xl">
        <div class="text-center">
            <div class="w-12 h-12 sm:w-16 sm:h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-6 h-6 sm:w-8 sm:h-8 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
            </div>
            <h2 class="text-lg sm:text-xl font-bold text-gray-900 mb-2">ìœ„ì¹˜ ì •ë³´ ì‚¬ìš© ë™ì˜</h2>
            <p class="text-sm sm:text-base text-gray-600 mb-6 leading-relaxed">
                ë‚´ ì£¼ë³€ì˜ ìƒì¼ì¹´í˜ë¥¼ ì°¾ì•„ë“œë¦¬ê¸° ìœ„í•´<br>
                ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•˜ê² ìŠµë‹ˆë‹¤.
            </p>
            <div class="space-y-3">
                <button id="allowLocationBtn" class="w-full bg-gray-900 text-white py-2.5 sm:py-3 px-4 sm:px-6 rounded-lg font-semibold hover:bg-gray-800 transition-all duration-200 text-sm sm:text-base">
                    ìœ„ì¹˜ ì •ë³´ í—ˆìš©í•˜ê¸°
                </button>
                <button id="denyLocationBtn" class="w-full bg-gray-100 text-gray-700 py-2.5 sm:py-3 px-4 sm:px-6 rounded-lg font-medium hover:bg-gray-200 transition-colors text-sm sm:text-base">
                    ê±°ë¶€í•˜ê³  ê¸°ë³¸ ì§€ë„ ë³´ê¸°
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-4">
                ìœ„ì¹˜ ì •ë³´ëŠ” ì¹´í˜ ê²€ìƒ‰ì—ë§Œ ì‚¬ìš©ë˜ë©° ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </p>
        </div>
    </div>
</div>

<!-- ì¹´í˜ ì •ë³´ ëª¨ë‹¬ -->
<div id="cafeInfoModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4" onclick="closeCafeInfoModal(event)">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[80vh] overflow-y-auto transform transition-all duration-300 scale-95" onclick="event.stopPropagation()" id="cafeInfoContent">
        <!-- ëª¨ë‹¬ í—¤ë” -->
        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 rounded-t-xl z-10">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-bold text-gray-900" id="modalCafeTitle">ì¹´í˜ ì •ë³´</h3>
                <button onclick="closeCafeInfoModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- ëª¨ë‹¬ ì½˜í…ì¸  -->
        <div class="p-6" id="modalCafeContent">
            <!-- ì¹´í˜ ì •ë³´ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤ -->
        </div>
    </div>
</div>

<!-- ìƒë‹¨ ê²€ìƒ‰ í—¤ë” -->
{% include 'ddoksang/components/_search_header.html' with search_input_id='ddok-search' autocomplete_list_id='ddok-autocomplete-list' show_create_button=True %}

<!-- ğŸ—ºï¸ ë©”ì¸ ì§€ë„ ì„¹ì…˜ with ì‚¬ì´ë“œë°” -->
<section class="py-4 sm:py-8 px-4">
  <div class="max-w-7xl mx-auto">
    <div class="bg-white rounded-xl sm:rounded-2xl shadow-xl overflow-hidden">
      
      <!-- í—¤ë” -->
      <div class="p-4 sm:p-6 bg-gray-50 border-b">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-3 sm:space-y-0">
          <div>
            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 flex items-center">
              <span class="text-2xl sm:text-3xl mr-2 sm:mr-3">ğŸ—ºï¸</span>
              <span>ìƒì¹´ ì§€ë„</span>
            </h2>
            <div class="flex items-center mt-2">
              <span class="text-xs sm:text-sm bg-gray-200 text-gray-800 px-2 sm:px-3 py-1 rounded-full" id="cafeCountDisplay">{{ total_cafes }}ê°œ ìš´ì˜ì¤‘</span>
            </div>
            <p class="text-gray-600 mt-1 sm:mt-2 text-sm sm:text-base">íˆ¬ì–´ë§µì„ í†µí•´ ë” ìì„¸í•œ ì¹´í˜ ìœ„ì¹˜ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”!</p>
          </div>
          
          <!-- ì§€ë„ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤ -->
          <div class="flex flex-wrap items-center gap-2 sm:gap-3">
            <!-- íˆ¬ì–´ë§µ ë²„íŠ¼ -->
            <a href="{% url 'ddoksang:tour_map' %}" 
                class="flex-1 sm:flex-none px-3 py-2 text-xs sm:px-4 sm:py-2.5 sm:text-sm bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center justify-center gap-1 sm:gap-2 transition-colors min-w-[80px] sm:min-w-[120px]">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m0 0L9 7"></path>
              </svg>
              <span class="hidden sm:inline">íˆ¬ì–´ë§µ</span>
              <span class="sm:hidden">íˆ¬ì–´</span>
            </a>
            <!-- ë‚´ ìœ„ì¹˜ ë²„íŠ¼ -->
            <button id="myLocationBtn"
                    class="flex-1 sm:flex-none px-3 py-2 text-xs sm:px-4 sm:py-2.5 sm:text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-1 sm:gap-2 transition-colors min-w-[80px] sm:min-w-[100px]">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                </svg>
                <span class="hidden sm:inline">ë‚´ ìœ„ì¹˜</span>
            </button>

            <!-- í´ëŸ¬ìŠ¤í„°ë§ í† ê¸€ ë²„íŠ¼ -->
            <button id="clusterToggle" 
                class="flex-1 sm:flex-none px-3 py-2 text-xs sm:px-4 sm:py-2.5 sm:text-sm bg-gray-600 text-white rounded-lg hover:bg-gray-700 flex items-center justify-center transition-colors gap-1 sm:gap-2 min-w-[80px] sm:min-w-[120px]">
              <span class="hidden sm:inline">í´ëŸ¬ìŠ¤í„°ë§ ON</span>
              <span class="sm:hidden">í´ëŸ¬ìŠ¤í„°</span>
            </button>
          </div>
        </div>
      </div>
 
      <!-- ì§€ë„ + ì‚¬ì´ë“œë°” ì»¨í…Œì´ë„ˆ -->
      <div class="flex flex-col lg:flex-row relative">
        
        {% include 'ddoksang/components/_floating_card_list.html' %}

        <!-- ì§€ë„ ì»¨í…Œì´ë„ˆ (ì˜¤ë¥¸ìª½) -->
        <div class="flex-1 relative">
          <div id="mapContainer" class="w-full h-[500px] lg:h-[600px] bg-gray-100"></div>
          
          <!-- ì§€ë„ ë¡œë”© ìƒíƒœ -->
          <div id="mapLoading" class="absolute inset-0 bg-white bg-opacity-90 flex items-center justify-center">
              <div class="text-center">
                  <div class="animate-spin rounded-full h-8 w-8 sm:h-12 sm:w-12 border-b-2 border-gray-800 mx-auto mb-2 sm:mb-4"></div>
                  <p class="text-gray-600 text-sm sm:text-base">ìƒì¼ì¹´í˜ ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
              </div>
          </div>

          <!-- ì£¼ë³€ ì¹´í˜ íŒ¨ë„ -->
          <div id="nearbyPanel" class="absolute top-4 left-4 bg-white rounded-lg shadow-lg p-4 w-[280px] max-h-[500px] overflow-y-auto z-50 hidden">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-semibold text-gray-800">ğŸ“ ë‚´ ì£¼ë³€ ìƒì¹´</h3>
                <button id="closeNearbyPanel" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="nearbyList" class="space-y-3">
                <div class="text-center text-gray-500 py-4">
                    <p class="text-sm">ë‚´ ìœ„ì¹˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</p>
                </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ì´ë²ˆ ì£¼ ìƒì¼ ì•„í‹°ìŠ¤íŠ¸ ì„¹ì…˜ -->
<div class="mt-16 text-center mb-6 sm:mb-8">
  <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">ğŸ‚ ì´ë²ˆ ì£¼ ìƒì¼ë•</h2>
  <p class="text-gray-600 text-sm sm:text-base">ì´ë²ˆì£¼ ìƒì¼ ì•„í‹°ìŠ¤íŠ¸ë¥¼ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤.</p>
</div>

<section class="px-4 mb-16"> 
  <div class="max-w-7xl mx-auto">
    {% include 'ddoksang/_weekly_bday_member.html' %}
  </div>
</section>

<!-- ì°œí•œ ì¹´í˜ ì„¹ì…˜ -->
<section class="py-4 sm:py-8 px-4">
  <div class="max-w-7xl mx-auto">
    {% include 'ddoksang/components/_favorites_section.html' %}
  </div>
</section>

<!-- ë•ìƒ my-cafesë¡œ ê°€ëŠ” ë§í¬ ë²„íŠ¼ -->
{% if user.is_authenticated %}
  <section class="py-4 px-4">
    <div class="max-w-7xl mx-auto">
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
        <div class="inline-flex items-center justify-center w-14 h-14 bg-gray-900 rounded-full mb-3">
          <span class="text-xl">ğŸ—‚</span>
        </div>
        <h3 class="text-lg font-bold text-gray-900 mb-2">ë‚´ ë•ìƒ ê´€ë¦¬</h3>
        <p class="text-gray-600 mb-4 text-sm">ë“±ë¡í•œ ìƒì¼ì¹´í˜ì™€ ì°œí•œ ì¹´í˜ë¥¼ í™•ì¸í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</p>
        <a href="{% url 'ddoksang:my_cafes' %}" 
           class="inline-block bg-gray-900 text-white px-6 py-2.5 rounded-lg font-medium hover:bg-gray-800 transition-colors">
          ê´€ë¦¬í•˜ëŸ¬ ê°€ê¸°
        </a>
      </div>
    </div>
  </section>
{% endif %}

<!-- ìµœì‹  ë“±ë¡ëœ ìƒì¼ì¹´í˜ ì„¹ì…˜ -->
<section class="mt-16 sm:mt-20 py-8 sm:py-12 px-4">  
  <div class="max-w-7xl mx-auto">
    {% include 'ddoksang/components/_latest_cafe_section.html' %}
  </div>
</section>

<!-- í”Œë¡œíŒ… ì•¡ì…˜ ë²„íŠ¼ -->
<!-- ğŸ“± í”Œë¡œíŒ… ì•¡ì…˜ ë²„íŠ¼ -->
<div class="fixed bottom-4 right-4 sm:bottom-6 sm:right-6 z-50">
  <a href="{% url 'ddoksang:create' %}" 
     class="w-14 h-14 sm:w-16 sm:h-16 bg-gray-900 text-white rounded-full shadow-2xl hover:shadow-3xl flex items-center justify-center transition-all duration-200">
    <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
    </svg>
  </a>
</div>



<!-- í˜ì´ì§€ ì‹ë³„ì (ì°œí•˜ê¸° ê¸°ëŠ¥ìš©) -->
<div id="page-identifier" data-page="home" style="display: none;"></div>

{% endblock %}

{% block extra_js %}
<!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_api_key }}&libraries=services,clusterer"></script>
<script src="{% static 'js/autocomplete.js' %}"></script>

<!-- ê¸°ì¡´ ë•ìƒ ëª¨ë“ˆë“¤ -->
<script src="{% static 'js/ddoksang_maps.js' %}"></script>
<script src="{% static 'js/ddoksang_ui_components.js' %}"></script>

<!-- ìƒˆë¡œ ë¶„ë¦¬ëœ í™ˆí˜ì´ì§€ ì „ìš© ëª¨ë“ˆë“¤ -->
<script src="{% static 'js/ddoksang_home_main.js' %}"></script>
<script src="{% static 'js/ddoksang_home_modals.js' %}"></script>
<script src="{% static 'js/ddoksang_home_location.js' %}"></script>

<!-- âœ… ìˆ˜ì •ëœ ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ -->
<script>
document.addEventListener('DOMContentLoaded', function() {

    
    // âœ… ë©”ì¸ ì•± ì´ˆê¸°í™” (ìˆ˜ì •ë¨)
    if (window.ddoksangHome) {
        window.ddoksangHome.init().then(() => {
            
            // âœ… ì´ˆê¸°í™” ì™„ë£Œ í›„ ì¶”ê°€ ì„¤ì •
            console.log('ğŸ¯ ë§ˆì»¤ í´ë¦­ â†’ ëª¨ë‹¬ í‘œì‹œ');
            console.log('ğŸ“Œ ì‚¬ì´ë“œë°” ì¹´ë“œ í´ë¦­ â†’ ì§€ë„ ì´ë™');
            
        }).catch(error => {
            console.error('âŒ í™ˆí˜ì´ì§€ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        });
    } else {
        console.error('âŒ ddoksangHome ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    // âœ… ìœ„ì¹˜ ê´€ë¦¬ ì´ˆê¸°í™” (ê¸°ì¡´ ìœ ì§€)
    if (window.DdoksangLocation) {
        window.DdoksangLocation.init();
    } else {
        console.error('âŒ DdoksangLocation í´ë˜ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    // âœ… ëª¨ë‹¬ ì‹œìŠ¤í…œ ì´ˆê¸°í™” (ê¸°ì¡´ ìœ ì§€)
    if (window.DdoksangModals) {
        window.DdoksangModals.init();
    }
    
    // âœ… ì°œí•˜ê¸° ê¸°ëŠ¥ ì´ˆê¸°í™” (ì¶”ê°€)
    if (window.Ddoksang && window.Ddoksang.favoriteManager) {
        // ì°œí•˜ê¸° ë²„íŠ¼ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì´ˆê¸°í™”
        if (document.querySelector('[data-favorite-btn]')) {
            new window.Ddoksang.FavoriteManager();
            console.log('âœ… ì°œí•˜ê¸° ê¸°ëŠ¥ ì´ˆê¸°í™”');
        }
    }
    
    // âœ… ìƒì¼ ì•„í‹°ìŠ¤íŠ¸ ìŠ¬ë¼ì´ë” ì´ˆê¸°í™” (ê¸°ì¡´ ìœ ì§€)
    if (typeof initBirthdayNavigation === 'function') {
        setTimeout(() => {
            initBirthdayNavigation();
            console.log('âœ… ìƒì¼ ì•„í‹°ìŠ¤íŠ¸ ìŠ¬ë¼ì´ë” ì´ˆê¸°í™”');
        }, 100);
    }
});

// âœ… ì „ì—­ í•¨ìˆ˜ ì„¤ì • (í•˜ìœ„ í˜¸í™˜ì„±)
window.moveToLocationHome = function(lat, lng) {
    console.log('ğŸ—ºï¸ moveToLocationHome í˜¸ì¶œ:', lat, lng);
    if (window.ddoksangHome && window.ddoksangHome.mapManager) {
        window.ddoksangHome.mapManager.moveToLocation(lat, lng, 5);
    } else {
        console.warn('âš ï¸ ddoksangHome.mapManagerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
};

window.showCafeInfoModal = function(cafe) {
    console.log('ğŸ“± showCafeInfoModal í˜¸ì¶œ:', cafe);
    if (window.DdoksangModals && window.DdoksangModals.showCafeInfo) {
        window.DdoksangModals.showCafeInfo(cafe);
    } else {
        console.warn('âš ï¸ DdoksangModalsë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
};

window.closeCafeInfoModal = function(event) {
    if (window.DdoksangModals && window.DdoksangModals.closeCafeInfo) {
        window.DdoksangModals.closeCafeInfo(event);
    }
};


</script>
{% endblock %}