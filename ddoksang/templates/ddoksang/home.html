{% extends "ddoksang/base/ddoksang_base.html" %}
{% load static %}
{% load filters %}
{% load member_images %}

{% block title %}🎂 덕생 - 생일카페 투어맵{% endblock %}

{% block ddoksang_content %}

<!-- JSON 데이터 전달 -->
{% csrf_token %}
{{ cafes_json|json_script:"cafes-data" }}

<!-- 위치 동의 모달 -->
<div id="locationModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-2xl p-6 sm:p-8 max-w-md w-full mx-4 shadow-2xl">
        <div class="text-center">
            <div class="w-12 h-12 sm:w-16 sm:h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-6 h-6 sm:w-8 sm:h-8 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
            </div>
            <h2 class="text-lg sm:text-xl font-bold text-gray-900 mb-2">위치 정보 사용 동의</h2>
            <p class="text-sm sm:text-base text-gray-600 mb-6 leading-relaxed">
                내 주변의 생일카페를 찾아드리기 위해<br>
                위치 정보를 사용하겠습니다.
            </p>
            <div class="space-y-3">
                <button id="allowLocationBtn" class="w-full bg-gray-900 text-white py-2.5 sm:py-3 px-4 sm:px-6 rounded-lg font-semibold hover:bg-gray-800 transition-all duration-200 text-sm sm:text-base">
                    위치 정보 허용하기
                </button>
                <button id="denyLocationBtn" class="w-full bg-gray-100 text-gray-700 py-2.5 sm:py-3 px-4 sm:px-6 rounded-lg font-medium hover:bg-gray-200 transition-colors text-sm sm:text-base">
                    거부하고 기본 지도 보기
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-4">
                위치 정보는 카페 검색에만 사용되며 저장되지 않습니다.
            </p>
        </div>
    </div>
</div>

<!-- 카페 정보 모달 -->
<div id="cafeInfoModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4" onclick="closeCafeInfoModal(event)">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[80vh] overflow-y-auto transform transition-all duration-300 scale-95" onclick="event.stopPropagation()" id="cafeInfoContent">
        <!-- 모달 헤더 -->
        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 rounded-t-xl z-10">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-bold text-gray-900" id="modalCafeTitle">카페 정보</h3>
                <button onclick="closeCafeInfoModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- 모달 콘텐츠 -->
        <div class="p-6" id="modalCafeContent">
            <!-- 카페 정보가 여기에 동적으로 삽입됩니다 -->
        </div>
    </div>
</div>

<!-- 상단 검색 헤더 -->
{% include 'ddoksang/components/_search_header.html' with search_input_id='ddok-search' autocomplete_list_id='ddok-autocomplete-list' show_create_button=True %}

<!-- 🗺️ 메인 지도 섹션 with 사이드바 -->
<section class="py-4 sm:py-8 px-4">
  <div class="max-w-7xl mx-auto">
    <div class="bg-white rounded-xl sm:rounded-2xl shadow-xl overflow-hidden">
      
      <!-- 헤더 -->
      <div class="p-4 sm:p-6 bg-gray-50 border-b">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-3 sm:space-y-0">
          <div>
            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 flex items-center">
              <span class="text-2xl sm:text-3xl mr-2 sm:mr-3">🗺️</span>
              <span>생카 지도</span>
            </h2>
            <div class="flex items-center mt-2">
              <span class="text-xs sm:text-sm bg-gray-200 text-gray-800 px-2 sm:px-3 py-1 rounded-full" id="cafeCountDisplay">{{ total_cafes }}개 운영중</span>
            </div>
            <p class="text-gray-600 mt-1 sm:mt-2 text-sm sm:text-base">투어맵을 통해 더 자세한 카페 위치 정보를 확인하세요!</p>
          </div>
          
          <!-- 지도 컨트롤 버튼들 -->
          <div class="flex flex-wrap items-center gap-2 sm:gap-3">
            <!-- 투어맵 버튼 -->
            <a href="{% url 'ddoksang:tour_map' %}" 
                class="flex-1 sm:flex-none px-3 py-2 text-xs sm:px-4 sm:py-2.5 sm:text-sm bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center justify-center gap-1 sm:gap-2 transition-colors min-w-[80px] sm:min-w-[120px]">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m0 0L9 7"></path>
              </svg>
              <span class="hidden sm:inline">투어맵</span>
              <span class="sm:hidden">투어</span>
            </a>
            <!-- 내 위치 버튼 -->
            <button id="myLocationBtn"
                    class="flex-1 sm:flex-none px-3 py-2 text-xs sm:px-4 sm:py-2.5 sm:text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-1 sm:gap-2 transition-colors min-w-[80px] sm:min-w-[100px]">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                </svg>
                <span class="hidden sm:inline">내 위치</span>
            </button>

            <!-- 클러스터링 토글 버튼 -->
            <button id="clusterToggle" 
                class="flex-1 sm:flex-none px-3 py-2 text-xs sm:px-4 sm:py-2.5 sm:text-sm bg-gray-600 text-white rounded-lg hover:bg-gray-700 flex items-center justify-center transition-colors gap-1 sm:gap-2 min-w-[80px] sm:min-w-[120px]">
              <span class="hidden sm:inline">클러스터링 ON</span>
              <span class="sm:hidden">클러스터</span>
            </button>
          </div>
        </div>
      </div>
 
      <!-- 지도 + 사이드바 컨테이너 -->
      <div class="flex flex-col lg:flex-row relative">
        
        {% include 'ddoksang/components/_floating_card_list.html' %}

        <!-- 지도 컨테이너 (오른쪽) -->
        <div class="flex-1 relative">
          <div id="mapContainer" class="w-full h-[500px] lg:h-[600px] bg-gray-100"></div>
          
          <!-- 지도 로딩 상태 -->
          <div id="mapLoading" class="absolute inset-0 bg-white bg-opacity-90 flex items-center justify-center">
              <div class="text-center">
                  <div class="animate-spin rounded-full h-8 w-8 sm:h-12 sm:w-12 border-b-2 border-gray-800 mx-auto mb-2 sm:mb-4"></div>
                  <p class="text-gray-600 text-sm sm:text-base">생일카페 지도를 불러오는 중...</p>
              </div>
          </div>

          <!-- 주변 카페 패널 -->
          <div id="nearbyPanel" class="absolute top-4 left-4 bg-white rounded-lg shadow-lg p-4 w-[280px] max-h-[500px] overflow-y-auto z-50 hidden">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-semibold text-gray-800">📍 내 주변 생카</h3>
                <button id="closeNearbyPanel" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="nearbyList" class="space-y-3">
                <div class="text-center text-gray-500 py-4">
                    <p class="text-sm">내 위치 버튼을 눌러주세요</p>
                </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- 이번 주 생일 아티스트 섹션 -->
<div class="mt-16 text-center mb-6 sm:mb-8">
  <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">🎂 이번 주 생일덕</h2>
  <p class="text-gray-600 text-sm sm:text-base">이번주 생일 아티스트를 추천해드립니다.</p>
</div>

<section class="px-4 mb-16"> 
  <div class="max-w-7xl mx-auto">
    {% include 'ddoksang/_weekly_bday_member.html' %}
  </div>
</section>

<!-- 찜한 카페 섹션 -->
<section class="py-4 sm:py-8 px-4">
  <div class="max-w-7xl mx-auto">
    {% include 'ddoksang/components/_favorites_section.html' %}
  </div>
</section>

<!-- 덕생 my-cafes로 가는 링크 버튼 -->
{% if user.is_authenticated %}
  <section class="py-4 px-4">
    <div class="max-w-7xl mx-auto">
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
        <div class="inline-flex items-center justify-center w-14 h-14 bg-gray-900 rounded-full mb-3">
          <span class="text-xl">🗂</span>
        </div>
        <h3 class="text-lg font-bold text-gray-900 mb-2">내 덕생 관리</h3>
        <p class="text-gray-600 mb-4 text-sm">등록한 생일카페와 찜한 카페를 확인하고 관리하세요</p>
        <a href="{% url 'ddoksang:my_cafes' %}" 
           class="inline-block bg-gray-900 text-white px-6 py-2.5 rounded-lg font-medium hover:bg-gray-800 transition-colors">
          관리하러 가기
        </a>
      </div>
    </div>
  </section>
{% endif %}

<!-- 최신 등록된 생일카페 섹션 -->
<section class="mt-16 sm:mt-20 py-8 sm:py-12 px-4">  
  <div class="max-w-7xl mx-auto">
    {% include 'ddoksang/components/_latest_cafe_section.html' %}
  </div>
</section>

<!-- 플로팅 액션 버튼 -->
<!-- 📱 플로팅 액션 버튼 -->
<div class="fixed bottom-4 right-4 sm:bottom-6 sm:right-6 z-50">
  <a href="{% url 'ddoksang:create' %}" 
     class="w-14 h-14 sm:w-16 sm:h-16 bg-gray-900 text-white rounded-full shadow-2xl hover:shadow-3xl flex items-center justify-center transition-all duration-200">
    <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
    </svg>
  </a>
</div>



<!-- 페이지 식별자 (찜하기 기능용) -->
<div id="page-identifier" data-page="home" style="display: none;"></div>

{% endblock %}

{% block extra_js %}
<!-- 외부 라이브러리 -->
<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_api_key }}&libraries=services,clusterer"></script>
<script src="{% static 'js/autocomplete.js' %}"></script>

<!-- 기존 덕생 모듈들 -->
<script src="{% static 'js/ddoksang_maps.js' %}"></script>
<script src="{% static 'js/ddoksang_ui_components.js' %}"></script>

<!-- 새로 분리된 홈페이지 전용 모듈들 -->
<script src="{% static 'js/ddoksang_home_main.js' %}"></script>
<script src="{% static 'js/ddoksang_home_modals.js' %}"></script>
<script src="{% static 'js/ddoksang_home_location.js' %}"></script>

<!-- ✅ 수정된 초기화 스크립트 -->
<script>
document.addEventListener('DOMContentLoaded', function() {

    
    // ✅ 메인 앱 초기화 (수정됨)
    if (window.ddoksangHome) {
        window.ddoksangHome.init().then(() => {
            
            // ✅ 초기화 완료 후 추가 설정
            console.log('🎯 마커 클릭 → 모달 표시');
            console.log('📌 사이드바 카드 클릭 → 지도 이동');
            
        }).catch(error => {
            console.error('❌ 홈페이지 초기화 실패:', error);
        });
    } else {
        console.error('❌ ddoksangHome 인스턴스를 찾을 수 없습니다');
    }
    
    // ✅ 위치 관리 초기화 (기존 유지)
    if (window.DdoksangLocation) {
        window.DdoksangLocation.init();
    } else {
        console.error('❌ DdoksangLocation 클래스를 찾을 수 없습니다');
    }
    
    // ✅ 모달 시스템 초기화 (기존 유지)
    if (window.DdoksangModals) {
        window.DdoksangModals.init();
    }
    
    // ✅ 찜하기 기능 초기화 (추가)
    if (window.Ddoksang && window.Ddoksang.favoriteManager) {
        // 찜하기 버튼이 있는 경우에만 초기화
        if (document.querySelector('[data-favorite-btn]')) {
            new window.Ddoksang.FavoriteManager();
            console.log('✅ 찜하기 기능 초기화');
        }
    }
    
    // ✅ 생일 아티스트 슬라이더 초기화 (기존 유지)
    if (typeof initBirthdayNavigation === 'function') {
        setTimeout(() => {
            initBirthdayNavigation();
            console.log('✅ 생일 아티스트 슬라이더 초기화');
        }, 100);
    }
});

// ✅ 전역 함수 설정 (하위 호환성)
window.moveToLocationHome = function(lat, lng) {
    console.log('🗺️ moveToLocationHome 호출:', lat, lng);
    if (window.ddoksangHome && window.ddoksangHome.mapManager) {
        window.ddoksangHome.mapManager.moveToLocation(lat, lng, 5);
    } else {
        console.warn('⚠️ ddoksangHome.mapManager를 찾을 수 없습니다');
    }
};

window.showCafeInfoModal = function(cafe) {
    console.log('📱 showCafeInfoModal 호출:', cafe);
    if (window.DdoksangModals && window.DdoksangModals.showCafeInfo) {
        window.DdoksangModals.showCafeInfo(cafe);
    } else {
        console.warn('⚠️ DdoksangModals를 찾을 수 없습니다');
    }
};

window.closeCafeInfoModal = function(event) {
    if (window.DdoksangModals && window.DdoksangModals.closeCafeInfo) {
        window.DdoksangModals.closeCafeInfo(event);
    }
};


</script>
{% endblock %}