<!-- ddoksang/templates/ddoksang/map.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>덕생 - 생일카페 지도</title>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: 'Malgun Gothic', -apple-system, BlinkMacSystemFont, sans-serif; 
            background-color: #f5f5f5;
        }
        
        #map { 
            width: 100%; 
            height: 100vh; 
        }
        
        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 320px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .info-panel h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 18px;
            font-weight: bold;
        }
        
        .info-panel p {
            margin: 0 0 15px 0;
            color: #666;
            font-size: 14px;
        }
        
        .bday-cafe-info {
            margin-bottom: 12px;
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-size: 13px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .bday-cafe-info:hover {
            background: #e3f2fd;
            border-color: #2196f3;
            transform: translateY(-1px);
        }
        
        .bday-cafe-name { 
            font-weight: bold; 
            color: #333; 
            margin-bottom: 4px;
        }
        
        .artist-name { 
            color: #2196f3; 
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .bday-cafe-address {
            color: #666;
            font-size: 11px;
        }
        
        .custom-overlay {
            position: relative;
            bottom: 85px;
            border-radius: 8px;
            border: 2px solid #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            float: left;
            background: white;
            max-width: 280px;
        }
        
        .custom-overlay .title {
            display: block;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 6px 6px 0 0;
        }
        
        .overlay-content {
            padding: 12px;
            background: white;
        }
        
        .artist-info {
            font-weight: bold; 
            color: #667eea; 
            margin-bottom: 6px;
        }
        
        .address-info {
            font-size: 12px; 
            color: #666; 
            margin: 4px 0;
        }
        
        .status-badges {
            margin-top: 8px;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-right: 4px;
        }
        
        .badge-type {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .badge-active {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .badge-inactive {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .no-cafes {
            text-align: center;
            color: #999;
            padding: 20px;
            font-size: 14px;
        }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        
        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .info-panel {
                top: 10px;
                left: 10px;
                right: 10px;
                max-width: none;
                padding: 15px;
            }
            
            .custom-overlay {
                max-width: 240px;
            }
        }
    </style>
</head>
<body>
    <div class="info-panel">
        <h3>🗺️ 덕생 - 생일카페 지도</h3>
        <p>현재 <strong>{{ total_bday_cafes }}개</strong>의 생카가 진행 중입니다</p>
        
        <div id="bday-cafe-list">
            <div class="loading">
                <div>📍 생카 정보를 불러오는 중...</div>
            </div>
        </div>
    </div>
    
    <div id="map"></div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_api_key }}"></script>
    <script>
        // 생일카페 데이터
        const bdayCafesData = {{ bday_cafes_json|safe }};
        console.log('🎉 로드된 생카 데이터:', bdayCafesData);
        
        // 지도 생성
        const container = document.getElementById('map');
        const options = {
            center: new kakao.maps.LatLng(37.5665, 126.9780), // 서울 중심
            level: 8
        };
        const map = new kakao.maps.Map(container, options);
        
        // 마커 배열
        const markers = [];
        let currentInfoWindow = null;
        
        // 생카 마커 생성 및 표시
        function createBdayCafeMarkers() {
            bdayCafesData.forEach(function(bdayCafe) {
                // 마커 위치
                const position = new kakao.maps.LatLng(bdayCafe.latitude, bdayCafe.longitude);
                
                // 마커 생성
                const marker = new kakao.maps.Marker({
                    position: position,
                    title: bdayCafe.name
                });
                
                // 지도에 마커 표시
                marker.setMap(map);
                markers.push(marker);
                
                // 정보창 내용
                const infoContent = `
                    <div class="custom-overlay">
                        <div class="title">${bdayCafe.name}</div>
                        <div class="overlay-content">
                            <div class="artist-info">${bdayCafe.artist}${bdayCafe.member ? ' - ' + bdayCafe.member : ''}</div>
                            <div class="address-info">${bdayCafe.address}</div>
                            <div class="status-badges">
                                <span class="badge badge-type">${bdayCafe.cafe_type}</span>
                                ${bdayCafe.is_active ? 
                                    `<span class="badge badge-active">${bdayCafe.days_remaining}일 남음</span>` :
                                    `<span class="badge badge-inactive">종료됨</span>`
                                }
                            </div>
                        </div>
                    </div>
                `;
                
                // 정보창 생성
                const infowindow = new kakao.maps.CustomOverlay({
                    content: infoContent,
                    position: position,
                    xAnchor: 0.5,
                    yAnchor: 1.2
                });
                
                // 마커 클릭 이벤트
                kakao.maps.event.addListener(marker, 'click', function() {
                    // 기존 정보창 닫기
                    if (currentInfoWindow) {
                        currentInfoWindow.setMap(null);
                    }
                    
                    // 새 정보창 열기
                    infowindow.setMap(map);
                    currentInfoWindow = infowindow;
                    
                    // 해당 위치를 지도 중심으로 이동
                    map.setCenter(position);
                    map.setLevel(4); // 줌 인
                });
            });
        }
        
        // 지도 클릭 시 정보창 닫기
        kakao.maps.event.addListener(map, 'click', function() {
            if (currentInfoWindow) {
                currentInfoWindow.setMap(null);
                currentInfoWindow = null;
            }
        });
        
        // 사이드 패널에 생카 리스트 표시
        function displayBdayCafeList() {
            const bdayCafeListDiv = document.getElementById('bday-cafe-list');
            
            if (bdayCafesData.length === 0) {
                bdayCafeListDiv.innerHTML = `
                    <div class="no-cafes">
                        <div>🔍</div>
                        <div>현재 진행 중인 생카가 없습니다.</div>
                        <div style="font-size: 12px; margin-top: 8px; color: #999;">
                            관리자 페이지에서 테스트 생카를 등록해보세요!
                        </div>
                    </div>
                `;
                return;
            }
            
            const listHtml = bdayCafesData.map(bdayCafe => `
                <div class="bday-cafe-info" onclick="focusBdayCafe(${bdayCafe.latitude}, ${bdayCafe.longitude})">
                    <div class="bday-cafe-name">${bdayCafe.name}</div>
                    <div class="artist-name">${bdayCafe.artist}${bdayCafe.member ? ' - ' + bdayCafe.member : ''}</div>
                    <div class="bday-cafe-address">${bdayCafe.address}</div>
                    <div style="margin-top: 6px;">
                        <span class="badge badge-type">${bdayCafe.cafe_type}</span>
                        ${bdayCafe.is_active ? 
                            `<span class="badge badge-active">${bdayCafe.days_remaining}일 남음</span>` :
                            `<span class="badge badge-inactive">종료됨</span>`
                        }
                    </div>
                </div>
            `).join('');
            
            bdayCafeListDiv.innerHTML = listHtml;
        }
        
        // 특정 생카로 지도 이동
        function focusBdayCafe(lat, lng) {
            const position = new kakao.maps.LatLng(lat, lng);
            map.setCenter(position);
            map.setLevel(3);
            
            // 해당 마커의 정보창도 열기
            const targetMarker = markers.find(marker => {
                const markerPos = marker.getPosition();
                return Math.abs(markerPos.getLat() - lat) < 0.0001 && 
                       Math.abs(markerPos.getLng() - lng) < 0.0001;
            });
            
            if (targetMarker) {
                // 마커 클릭 이벤트 트리거
                kakao.maps.event.trigger(targetMarker, 'click');
            }
        }
        
        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', function() {
            // 생카 마커 생성
            createBdayCafeMarkers();
            
            // 사이드 패널 리스트 표시
            displayBdayCafeList();
            
            // 모든 마커가 보이도록 지도 범위 조정
            if (markers.length > 0) {
                const bounds = new kakao.maps.LatLngBounds();
                markers.forEach(marker => {
                    bounds.extend(marker.getPosition());
                });
                map.setBounds(bounds);
                
                // 너무 많이 줌인되지 않도록 제한
                setTimeout(() => {
                    if (map.getLevel() < 6) {
                        map.setLevel(6);
                    }
                }, 100);
            }
            
            console.log('🗺️ 지도 초기화 완료!');
            console.log(`📍 총 ${markers.length}개의 생카 마커가 표시되었습니다.`);
        });
        
        // 지도 타입 컨트롤 추가
        const mapTypeControl = new kakao.maps.MapTypeControl();
        map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);
        
        // 줌 컨트롤 추가
        const zoomControl = new kakao.maps.ZoomControl();
        map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);
    </script>
</body>
</html>