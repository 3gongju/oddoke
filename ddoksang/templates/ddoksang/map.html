<!-- ddoksang/templates/ddoksang/map.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë•ìƒ - ìƒì¼ì¹´í˜ ì§€ë„</title>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: 'Malgun Gothic', -apple-system, BlinkMacSystemFont, sans-serif; 
            background-color: #f5f5f5;
        }
        
        #map { 
            width: 100%; 
            height: 100vh; 
        }
        
        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 320px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .info-panel h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 18px;
            font-weight: bold;
        }
        
        .info-panel p {
            margin: 0 0 15px 0;
            color: #666;
            font-size: 14px;
        }
        
        .bday-cafe-info {
            margin-bottom: 12px;
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-size: 13px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .bday-cafe-info:hover {
            background: #e3f2fd;
            border-color: #2196f3;
            transform: translateY(-1px);
        }
        
        .bday-cafe-name { 
            font-weight: bold; 
            color: #333; 
            margin-bottom: 4px;
        }
        
        .artist-name { 
            color: #2196f3; 
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .bday-cafe-address {
            color: #666;
            font-size: 11px;
        }
        
        .custom-overlay {
            position: relative;
            bottom: 85px;
            border-radius: 8px;
            border: 2px solid #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            float: left;
            background: white;
            max-width: 280px;
        }
        
        .custom-overlay .title {
            display: block;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 6px 6px 0 0;
        }
        
        .overlay-content {
            padding: 12px;
            background: white;
        }
        
        .artist-info {
            font-weight: bold; 
            color: #667eea; 
            margin-bottom: 6px;
        }
        
        .address-info {
            font-size: 12px; 
            color: #666; 
            margin: 4px 0;
        }
        
        .status-badges {
            margin-top: 8px;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-right: 4px;
        }
        
        .badge-type {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .badge-active {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .badge-inactive {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .no-cafes {
            text-align: center;
            color: #999;
            padding: 20px;
            font-size: 14px;
        }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        
        .debug-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .info-panel {
                top: 10px;
                left: 10px;
                right: 10px;
                max-width: none;
                padding: 15px;
            }
            
            .custom-overlay {
                max-width: 240px;
            }
        }
    </style>
</head>
<body>
    <div class="info-panel">
        <h3>ğŸ—ºï¸ ë•ìƒ - ìƒì¼ì¹´í˜ ì§€ë„</h3>
        <p>í˜„ì¬ <strong>{{ total_bday_cafes }}ê°œ</strong>ì˜ ìƒì¹´ê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤</p>
        
        <!-- ğŸ”¥ ë””ë²„ê¹… ì •ë³´ ì¶”ê°€ -->
        <div class="debug-info">
            <strong>ë””ë²„ê¹… ì •ë³´:</strong><br>
            ì¹´ì¹´ì˜¤ API í‚¤: {{ kakao_api_key|default:"âŒ ì„¤ì •ë˜ì§€ ì•ŠìŒ" }}<br>
            ë°ì´í„° ê°œìˆ˜: {{ total_bday_cafes }}ê°œ<br>
            í˜„ì¬ ì‹œê°„: {% now "Y-m-d H:i:s" %}
        </div>
        
        <div id="bday-cafe-list">
            <div class="loading">
                <div>ğŸ“ ìƒì¹´ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>
    
    <div id="map"></div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_api_key }}"></script>
    <script>
        // ğŸ”¥ ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
        console.log('=== ì¹´ì¹´ì˜¤ë§µ ë””ë²„ê¹… ì •ë³´ ===');
        console.log('ì¹´ì¹´ì˜¤ API í‚¤:', '{{ kakao_api_key }}');
        console.log('ì´ ìƒì¹´ ê°œìˆ˜:', {{ total_bday_cafes }});
        console.log('JSON ë°ì´í„°:', `{{ bday_cafes_json|safe }}`);
        
        // ìƒì¼ì¹´í˜ ë°ì´í„°
        const bdayCafesData = {{ bday_cafes_json|safe }};
        console.log('ğŸ‰ íŒŒì‹±ëœ ìƒì¹´ ë°ì´í„°:', bdayCafesData);
        console.log('ë°ì´í„° íƒ€ì…:', typeof bdayCafesData);
        console.log('ë°ì´í„° ê¸¸ì´:', Array.isArray(bdayCafesData) ? bdayCafesData.length : 'ë°°ì—´ì´ ì•„ë‹˜');
        
        // ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ í™•ì¸
        if (typeof kakao === 'undefined') {
            console.error('âŒ ì¹´ì¹´ì˜¤ë§µ APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
            document.getElementById('bday-cafe-list').innerHTML = `
                <div class="no-cafes">
                    <div>âŒ</div>
                    <div>ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ ì‹¤íŒ¨</div>
                    <div style="font-size: 12px; margin-top: 8px; color: #999;">
                        API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”!
                    </div>
                </div>
            `;
        } else {
            console.log('âœ… ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ ì„±ê³µ!');
            
            // ì§€ë„ ìƒì„±
            const container = document.getElementById('map');
            const options = {
                center: new kakao.maps.LatLng(37.5665, 126.9780), // ì„œìš¸ ì¤‘ì‹¬
                level: 8
            };
            
            try {
                const map = new kakao.maps.Map(container, options);
                console.log('âœ… ì§€ë„ ìƒì„± ì„±ê³µ!');
                
                // ë§ˆì»¤ ë°°ì—´
                const markers = [];
                let currentInfoWindow = null;
                
                // ìƒì¹´ ë§ˆì»¤ ìƒì„± ë° í‘œì‹œ
                function createBdayCafeMarkers() {
                    console.log('ë§ˆì»¤ ìƒì„± ì‹œì‘...');
                    
                    if (!Array.isArray(bdayCafesData) || bdayCafesData.length === 0) {
                        console.log('âš ï¸ í‘œì‹œí•  ìƒì¹´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    bdayCafesData.forEach(function(bdayCafe, index) {
                        console.log(`ë§ˆì»¤ ${index + 1} ìƒì„± ì¤‘:`, bdayCafe);
                        
                        // ë§ˆì»¤ ìœ„ì¹˜
                        const position = new kakao.maps.LatLng(bdayCafe.latitude, bdayCafe.longitude);
                        
                        // ë§ˆì»¤ ìƒì„±
                        const marker = new kakao.maps.Marker({
                            position: position,
                            title: bdayCafe.name
                        });
                        
                        // ì§€ë„ì— ë§ˆì»¤ í‘œì‹œ
                        marker.setMap(map);
                        markers.push(marker);
                        console.log(`âœ… ë§ˆì»¤ ${index + 1} ìƒì„± ì™„ë£Œ`);
                        
                        // ì •ë³´ì°½ ë‚´ìš©
                        const infoContent = `
                            <div class="custom-overlay">
                                <div class="title">${bdayCafe.name}</div>
                                <div class="overlay-content">
                                    <div class="artist-info">${bdayCafe.artist}${bdayCafe.member ? ' - ' + bdayCafe.member : ''}</div>
                                    <div class="address-info">${bdayCafe.address}</div>
                                    <div class="status-badges">
                                        <span class="badge badge-type">${bdayCafe.cafe_type}</span>
                                        ${bdayCafe.is_active ? 
                                            `<span class="badge badge-active">${bdayCafe.days_remaining}ì¼ ë‚¨ìŒ</span>` :
                                            `<span class="badge badge-inactive">ì¢…ë£Œë¨</span>`
                                        }
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // ì •ë³´ì°½ ìƒì„±
                        const infowindow = new kakao.maps.CustomOverlay({
                            content: infoContent,
                            position: position,
                            xAnchor: 0.5,
                            yAnchor: 1.2
                        });
                        
                        // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
                        kakao.maps.event.addListener(marker, 'click', function() {
                            // ê¸°ì¡´ ì •ë³´ì°½ ë‹«ê¸°
                            if (currentInfoWindow) {
                                currentInfoWindow.setMap(null);
                            }
                            
                            // ìƒˆ ì •ë³´ì°½ ì—´ê¸°
                            infowindow.setMap(map);
                            currentInfoWindow = infowindow;
                            
                            // í•´ë‹¹ ìœ„ì¹˜ë¥¼ ì§€ë„ ì¤‘ì‹¬ìœ¼ë¡œ ì´ë™
                            map.setCenter(position);
                            map.setLevel(4); // ì¤Œ ì¸
                        });
                    });
                    
                    console.log(`ğŸ¯ ì´ ${markers.length}ê°œ ë§ˆì»¤ ìƒì„± ì™„ë£Œ!`);
                }
                
                // ì§€ë„ í´ë¦­ ì‹œ ì •ë³´ì°½ ë‹«ê¸°
                kakao.maps.event.addListener(map, 'click', function() {
                    if (currentInfoWindow) {
                        currentInfoWindow.setMap(null);
                        currentInfoWindow = null;
                    }
                });
                
                // ì‚¬ì´ë“œ íŒ¨ë„ì— ìƒì¹´ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
                function displayBdayCafeList() {
                    const bdayCafeListDiv = document.getElementById('bday-cafe-list');
                    
                    if (!Array.isArray(bdayCafesData) || bdayCafesData.length === 0) {
                        bdayCafeListDiv.innerHTML = `
                            <div class="no-cafes">
                                <div>ğŸ”</div>
                                <div>í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ìƒì¹´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                                <div style="font-size: 12px; margin-top: 8px; color: #999;">
                                    ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ í…ŒìŠ¤íŠ¸ ìƒì¹´ë¥¼ ë“±ë¡í•´ë³´ì„¸ìš”!<br>
                                    <strong>Django Admin â†’ BdayCafe ì¶”ê°€</strong>
                                </div>
                            </div>
                        `;
                        return;
                    }
                    
                    const listHtml = bdayCafesData.map(bdayCafe => `
                        <div class="bday-cafe-info" onclick="focusBdayCafe(${bdayCafe.latitude}, ${bdayCafe.longitude})">
                            <div class="bday-cafe-name">${bdayCafe.name}</div>
                            <div class="artist-name">${bdayCafe.artist}${bdayCafe.member ? ' - ' + bdayCafe.member : ''}</div>
                            <div class="bday-cafe-address">${bdayCafe.address}</div>
                            <div style="margin-top: 6px;">
                                <span class="badge badge-type">${bdayCafe.cafe_type}</span>
                                ${bdayCafe.is_active ? 
                                    `<span class="badge badge-active">${bdayCafe.days_remaining}ì¼ ë‚¨ìŒ</span>` :
                                    `<span class="badge badge-inactive">ì¢…ë£Œë¨</span>`
                                }
                            </div>
                        </div>
                    `).join('');
                    
                    bdayCafeListDiv.innerHTML = listHtml;
                }
                
                // íŠ¹ì • ìƒì¹´ë¡œ ì§€ë„ ì´ë™
                function focusBdayCafe(lat, lng) {
                    const position = new kakao.maps.LatLng(lat, lng);
                    map.setCenter(position);
                    map.setLevel(3);
                    
                    // í•´ë‹¹ ë§ˆì»¤ì˜ ì •ë³´ì°½ë„ ì—´ê¸°
                    const targetMarker = markers.find(marker => {
                        const markerPos = marker.getPosition();
                        return Math.abs(markerPos.getLat() - lat) < 0.0001 && 
                               Math.abs(markerPos.getLng() - lng) < 0.0001;
                    });
                    
                    if (targetMarker) {
                        // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°
                        kakao.maps.event.trigger(targetMarker, 'click');
                    }
                }
                
                // ì „ì—­ìœ¼ë¡œ í•¨ìˆ˜ ë“±ë¡
                window.focusBdayCafe = focusBdayCafe;
                
                // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('DOM ë¡œë“œ ì™„ë£Œ, ì´ˆê¸°í™” ì‹œì‘...');
                    
                    // ìƒì¹´ ë§ˆì»¤ ìƒì„±
                    createBdayCafeMarkers();
                    
                    // ì‚¬ì´ë“œ íŒ¨ë„ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
                    displayBdayCafeList();
                    
                    // ëª¨ë“  ë§ˆì»¤ê°€ ë³´ì´ë„ë¡ ì§€ë„ ë²”ìœ„ ì¡°ì •
                    if (markers.length > 0) {
                        const bounds = new kakao.maps.LatLngBounds();
                        markers.forEach(marker => {
                            bounds.extend(marker.getPosition());
                        });
                        map.setBounds(bounds);
                        
                        // ë„ˆë¬´ ë§ì´ ì¤Œì¸ë˜ì§€ ì•Šë„ë¡ ì œí•œ
                        setTimeout(() => {
                            if (map.getLevel() < 6) {
                                map.setLevel(6);
                            }
                        }, 100);
                    }
                    
                    console.log('ğŸ—ºï¸ ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ!');
                    console.log(`ğŸ“ ì´ ${markers.length}ê°œì˜ ìƒì¹´ ë§ˆì»¤ê°€ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                });
                
                // ì§€ë„ íƒ€ì… ì»¨íŠ¸ë¡¤ ì¶”ê°€
                const mapTypeControl = new kakao.maps.MapTypeControl();
                map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);
                
                // ì¤Œ ì»¨íŠ¸ë¡¤ ì¶”ê°€
                const zoomControl = new kakao.maps.ZoomControl();
                map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);
                
            } catch (error) {
                console.error('âŒ ì§€ë„ ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
                document.getElementById('bday-cafe-list').innerHTML = `
                    <div class="no-cafes">
                        <div>âŒ</div>
                        <div>ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨</div>
                        <div style="font-size: 12px; margin-top: 8px; color: #999;">
                            ${error.message}
                        </div>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>