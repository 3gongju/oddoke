<!-- templates/ddoksang/tour_map.html -->
 <!-- ì¶”í›„ êµ¬í˜„ ìœ„í•´ ë‚¨ê²¨ë†“ìŒ -->
{% extends "ddoksang/base/ddoksang_base.html" %}
{% load static %}

{% block body %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-gray-900">ğŸ—ºï¸ ìƒì¹´ íˆ¬ì–´ë§µ</h1>
                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                        {{ total_bday_cafes }}ê°œ ìš´ì˜ì¤‘
                    </span>
                    <!-- ë””ë²„ê¹… ì •ë³´ -->
                    {% if debug_info %}
                    <div class="text-xs text-gray-500">
                        (ì „ì²´: {{ debug_info.total_queried }}ê°œ)
                    </div>
                    {% endif %}
                </div>
                <div class="flex items-center space-x-4">
                    <button id="myLocationBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        ğŸ“ ë‚´ ìœ„ì¹˜
                    </button>
                    <button id="clusterToggle" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                        ğŸ”— í´ëŸ¬ìŠ¤í„°ë§ ON
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Container -->
    <div class="relative">
        <div id="map" class="w-full h-[calc(100vh-120px)]"></div>

        <!--  ë‚´ ì£¼ë³€ ì¹´í˜ íŒ¨ë„ - ìˆ˜ì •ëœ ë²„ì „ -->
        <div id="nearbyPanel" class="absolute top-4 left-4 bg-white rounded-lg shadow-lg p-4 w-[280px] max-h-[500px] overflow-y-auto z-50">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-semibold text-gray-800"> ë‚´ ì£¼ë³€ ìƒì¹´</h3>
                <button id="closeNearbyPanel" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="nearbyList" class="space-y-3">
                <div class="text-center text-gray-500 py-4">
                    <p class="text-sm">ë‚´ ìœ„ì¹˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</p>
                </div>
            </div>
        </div>

        <!-- Map Controls -->
        <div class="absolute top-4 right-4 bg-white rounded-lg shadow-lg p-4 space-y-2">
            <div class="text-sm font-medium text-gray-700">ë²”ë¡€</div>
            <div class="flex items-center space-x-2">
                <div class="w-4 h-4 bg-red-500 rounded-full"></div>
                <span class="text-sm text-gray-600">ìš´ì˜ì¤‘ ìƒì¼ì¹´í˜</span>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-4 h-4 bg-blue-500 rounded-full border-2 border-white"></div>
                <span class="text-sm text-gray-600">í´ëŸ¬ìŠ¤í„°</span>
            </div>
        </div>

        <!-- Loading -->
        <div id="mapLoading" class="absolute inset-0 bg-black bg-opacity-20 flex items-center justify-center">
            <div class="bg-white rounded-lg p-4 shadow-lg">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                <div class="mt-2 text-sm text-gray-600">ì§€ë„ ë¡œë”©ì¤‘...</div>
            </div>
        </div>
        
        <!-- âœ… ì„ì‹œ ë””ë²„ê¹… íŒ¨ë„ -->
        <div id="debugPanel" class="absolute bottom-4 right-4 bg-white rounded-lg shadow-lg p-4 max-w-sm text-xs opacity-75">
            <h4 class="font-bold mb-2">ë””ë²„ê¹… ì •ë³´</h4>
            <div id="debugContent">
                <p>API í‚¤: {{ kakao_api_key|slice:":10" }}...</p>
                <p>ì´ ì¹´í˜: {{ total_bday_cafes }}ê°œ</p>
                {% if debug_info %}
                <p>ì¡°íšŒëœ ì¹´í˜: {{ debug_info.total_queried }}ê°œ</p>
                <p>ìœ íš¨í•œ ì¹´í˜: {{ debug_info.total_valid }}ê°œ</p>
                <p>ê¸°ì¤€ì¼: {{ debug_info.today }}</p>
                {% endif %}
                <div class="mt-2 text-xs text-gray-500">
                    <button onclick="document.getElementById('debugPanel').style.display='none'" class="text-red-600 hover:text-red-800">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- âœ… ì¹´í˜ ì •ë³´ íŒ¨ë„ - ìˆ˜ì •ëœ ë²„ì „ -->
    <div id="cafeInfoPanel" class="fixed bottom-0 left-0 right-0 bg-white shadow-2xl transform translate-y-full transition-transform duration-300 z-50">
        <div class="p-4 border-b">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold" id="cafeInfoTitle">ì¹´í˜ ì •ë³´</h3>
                <button id="closeCafeInfo" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div id="cafeInfoContent" class="p-4 max-h-80 overflow-y-auto">
            <!-- ì¹´í˜ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
    </div>
</div>

<!-- ì¹´ì¹´ì˜¤ë§µ ìŠ¤í¬ë¦½íŠ¸ -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_api_key }}&libraries=services,clusterer"></script>

<script>
// ì „ì—­ ë³€ìˆ˜
let map;
let clusterer;
let markers = [];
let isClusteringEnabled = true;
let userLocationMarker = null;

// ìƒì¼ì¹´í˜ ë°ì´í„° - ì•ˆì „í•œ íŒŒì‹±
let bdayCafes = [];
try {
    const rawData = `{{ bday_cafes_json|escapejs }}`;
    
    if (rawData && rawData.trim() !== '[]' && rawData.trim() !== '') {
        bdayCafes = JSON.parse(rawData);
        
        // ì²« ë²ˆì§¸ ì¹´í˜ ë°ì´í„° êµ¬ì¡° í™•ì¸
        if (bdayCafes.length > 0) {
        }
    } else {
        console.warn('ìƒì¼ì¹´í˜ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
    }
} catch (error) {
    bdayCafes = [];
}

// ë§ˆì»¤ ìƒì„± í•¨ìˆ˜
function createMarkers() {

    markers = [];
    let successCount = 0;
    let errorCount = 0;
    
    if (!bdayCafes || bdayCafes.length === 0) {
        console.warn('ìƒì¼ì¹´í˜ ë°ì´í„°ê°€ ì—†ì–´ ë§ˆì»¤ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    bdayCafes.forEach((cafe, index) => {
        try {
            // ì¢Œí‘œ ë°ì´í„° ê²€ì¦
            if (!cafe.latitude || !cafe.longitude) {
                console.warn(`ì¹´í˜ ${index}: ì¢Œí‘œ ì •ë³´ ì—†ìŒ`, cafe);
                errorCount++;
                return;
            }
            
            // ì¢Œí‘œ íƒ€ì… ê²€ì¦
            const lat = parseFloat(cafe.latitude);
            const lng = parseFloat(cafe.longitude);
            
            if (isNaN(lat) || isNaN(lng)) {
                console.warn(`ì¹´í˜ ${index}: ì˜ëª»ëœ ì¢Œí‘œ í˜•ì‹`, cafe);
                errorCount++;
                return;
            }
            
            // í•œêµ­ ì¢Œí‘œ ë²”ìœ„ ê²€ì¦
            if (lat < 33 || lat > 43 || lng < 124 || lng > 132) {
                console.warn(`ì¹´í˜ ${index}: ì¢Œí‘œê°€ í•œêµ­ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¨ (${lat}, ${lng})`, cafe);
                errorCount++;
                return;
            }
            
            const position = new kakao.maps.LatLng(lat, lng);
            
            // ì»¤ìŠ¤í…€ ë§ˆì»¤ ì´ë¯¸ì§€ ìƒì„±
            const svgString = `
                <svg xmlns='http://www.w3.org/2000/svg' width='32' height='40' viewBox='0 0 32 40'>
                    <path d='M16 0C7.163 0 0 7.163 0 16s16 24 16 24 16-15.163 16-24S24.837 0 16 0z' fill='#ef4444'/>
                    <circle cx='16' cy='16' r='8' fill='white'/>
                    <text x='16' y='20' text-anchor='middle' font-family='Arial' font-size='12' font-weight='bold' fill='#ef4444'>ğŸ‚</text>
                </svg>`;

            const imageSrc = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString)));
            const imageSize = new kakao.maps.Size(32, 40);
            const imageOption = { offset: new kakao.maps.Point(16, 40) };
            const markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);
            
            const marker = new kakao.maps.Marker({
                position: position,
                image: markerImage,
                title: cafe.name || cafe.cafe_name || 'ìƒì¼ì¹´í˜'  // cafe.nameì„ ìš°ì„  ì‚¬ìš©
            });
            
            // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
            kakao.maps.event.addListener(marker, 'click', function() {
            
                showCafeInfo(cafe);
            });
            
            markers.push(marker);
            successCount++;
            
            
        } catch (error) {
            console.error(`ì¹´í˜ ${index} ë§ˆì»¤ ìƒì„± ì˜¤ë¥˜:`, error, cafe);
            errorCount++;
        }
    });
    
    
    // í´ëŸ¬ìŠ¤í„°ëŸ¬ì— ë§ˆì»¤ ì¶”ê°€
    if (clusterer && markers.length > 0) {
        if (isClusteringEnabled) {
            clusterer.addMarkers(markers);
        } else {
            markers.forEach(marker => marker.setMap(map));
        }
        
        // í´ëŸ¬ìŠ¤í„° í´ë¦­ ì´ë²¤íŠ¸
        kakao.maps.event.addListener(clusterer, 'clusterclick', function(cluster) {
            const level = map.getLevel() - 2;
            map.setLevel(level, { anchor: cluster.getCenter() });
        });
        
        // ë§ˆì»¤ê°€ ìˆëŠ” ê²½ìš° ì§€ë„ ì¤‘ì‹¬ì„ ì²« ë²ˆì§¸ ë§ˆì»¤ë¡œ ì´ë™
        if (markers.length > 0) {
            const firstMarkerPosition = markers[0].getPosition();
            map.setCenter(firstMarkerPosition);
            map.setLevel(8);
        }
    } else {
        console.warn('í´ëŸ¬ìŠ¤í„°ëŸ¬ê°€ ì—†ê±°ë‚˜ ë§ˆì»¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
    }
}

// ì§€ë„ ì´ˆê¸°í™” í•¨ìˆ˜
function initMap() {
    
    const loadingEl = document.getElementById('mapLoading');
    if (loadingEl) {
        loadingEl.classList.remove('hidden');
    }
    
    try {
        // ì§€ë„ ì»¨í…Œì´ë„ˆ í™•ì¸
        const mapContainer = document.getElementById('map');
        if (!mapContainer) {
            throw new Error('ì§€ë„ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        
        // ì§€ë„ ìƒì„±
        const mapOption = {
            center: new kakao.maps.LatLng(37.5665, 126.9780), // ì„œìš¸ ì‹œì²­
            level: 8
        };
        
        map = new kakao.maps.Map(mapContainer, mapOption);
        
        // í´ëŸ¬ìŠ¤í„°ëŸ¬ ìƒì„±
        if (typeof kakao.maps.MarkerClusterer !== 'undefined') {
            clusterer = new kakao.maps.MarkerClusterer({
                map: map,
                averageCenter: true,
                minLevel: 6,
                disableClickZoom: true,
                styles: [
                    {
                        width: '40px',
                        height: '40px',
                        background: 'rgba(59, 130, 246, 0.8)',
                        borderRadius: '50%',
                        color: '#fff',
                        textAlign: 'center',
                        fontWeight: 'bold',
                        fontSize: '14px',
                        lineHeight: '40px'
                    },
                    {
                        width: '50px',
                        height: '50px',
                        background: 'rgba(147, 51, 234, 0.8)',
                        borderRadius: '50%',
                        color: '#fff',
                        textAlign: 'center',
                        fontWeight: 'bold',
                        fontSize: '16px',
                        lineHeight: '50px'
                    },
                    {
                        width: '60px',
                        height: '60px',
                        background: 'rgba(239, 68, 68, 0.8)',
                        borderRadius: '50%',
                        color: '#fff',
                        textAlign: 'center',
                        fontWeight: 'bold',
                        fontSize: '18px',
                        lineHeight: '60px'
                    }
                ]
            });
        } else {
        }
        
        // ë§ˆì»¤ ìƒì„±
        createMarkers();
        
        if (loadingEl) {
            loadingEl.classList.add('hidden');
        }
        
        
    } catch (error) {
        console.error('ì§€ë„ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
        if (loadingEl) {
            loadingEl.innerHTML = `
                <div class="bg-white rounded-lg p-4 shadow-lg text-center">
                    <div class="text-red-600">
                        <p class="font-bold">ì§€ë„ ë¡œë”© ì˜¤ë¥˜</p>
                        <p class="text-sm mt-1">${error.message}</p>
                        <button onclick="location.reload()" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                            ìƒˆë¡œê³ ì¹¨
                        </button>
                    </div>
                </div>
            `;
        }
    }
}

// ì¹´í˜ ì •ë³´ í‘œì‹œ - ìˆ˜ì •ëœ ë²„ì „
function showCafeInfo(cafe) {
    console.log('ì¹´í˜ ì •ë³´ í‘œì‹œ:', cafe); // ë””ë²„ê¹…ìš©
    
    const panel = document.getElementById('cafeInfoPanel');
    const title = document.getElementById('cafeInfoTitle');
    const content = document.getElementById('cafeInfoContent');
    
    // ì¹´í˜ëª… í™•ì¸ - cafe.nameì„ ìš°ì„  ì‚¬ìš©
    const cafeName = cafe.name || cafe.cafe_name || 'ìƒì¼ì¹´í˜';
    const artistName = cafe.artist || 'ì•„í‹°ìŠ¤íŠ¸';
    const memberName = cafe.member || '';
    const address = cafe.address || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ';
    const specialBenefits = cafe.special_benefits || '';
    const mainImage = cafe.main_image || '';
    const startDate = cafe.start_date || '';
    const endDate = cafe.end_date || '';
    const isActive = cafe.is_active || false;
    const daysRemaining = cafe.days_remaining || 0;
    
    title.textContent = cafeName;
    
    content.innerHTML = `
        <div class="space-y-4">
            <div class="flex items-start space-x-4">
                ${mainImage ? `<img src="${mainImage}" alt="${cafeName}" class="w-20 h-20 object-cover rounded-lg">` : 
                '<div class="w-20 h-20 bg-gray-200 rounded-lg flex items-center justify-center"><span class="text-gray-400">ğŸ‚</span></div>'}
                <div class="flex-1">
                    <h4 class="font-semibold text-lg">${cafeName}</h4>
                    <p class="text-sm text-gray-600">${artistName}${memberName ? ` - ${memberName}` : ''}</p>
                    <p class="text-sm text-blue-600">${startDate} ~ ${endDate}</p>
                    ${isActive ? 
                        '<span class="inline-block px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">ìš´ì˜ì¤‘</span>' : 
                        `<span class="inline-block px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded-full">${daysRemaining < 0 ? 'ì¢…ë£Œ' : 'ì˜ˆì •'}</span>`
                    }
                </div>
            </div>
            
            <div class="border-t pt-4">
                <h5 class="font-medium mb-2">ğŸ“ ìœ„ì¹˜</h5>
                <p class="text-sm text-gray-600">${address}</p>
            </div>
            
            ${specialBenefits ? `
            <div class="border-t pt-4">
                <h5 class="font-medium mb-2">íŠ¹ì „</h5>
                <p class="text-sm text-gray-600">${specialBenefits}</p>
            </div>
            ` : ''}
            
            <div class="border-t pt-4 flex space-x-2">
                <a href="/ddoksang/cafe/${cafe.id}/" class="flex-1 bg-blue-600 text-white text-center py-2 rounded-lg hover:bg-blue-700">
                    ìì„¸íˆ ë³´ê¸°
                </a>
                <button onclick="moveToLocation(${cafe.latitude}, ${cafe.longitude})" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                    ìœ„ì¹˜ë¡œ ì´ë™
                </button>
            </div>
        </div>
    `;
    
    panel.classList.remove('translate-y-full');
}

// ë‚´ ìœ„ì¹˜ ì°¾ê¸° ë° ì£¼ë³€ ì¹´í˜ í‘œì‹œ - ìˆ˜ì •ëœ ë²„ì „
function findMyLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const locPosition = new kakao.maps.LatLng(lat, lng);
            
            // ê¸°ì¡´ ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ ì œê±°
            if (userLocationMarker) {
                userLocationMarker.setMap(null);
            }

            // ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ ìƒì„±
            const imageSrc = 'data:image/svg+xml;base64,' + btoa(`
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20">
                    <circle cx="10" cy="10" r="8" fill="#3b82f6" stroke="white" stroke-width="2"/>
                    <circle cx="10" cy="10" r="3" fill="white"/>
                </svg>
            `);
            const imageSize = new kakao.maps.Size(20, 20);
            const markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

            userLocationMarker = new kakao.maps.Marker({
                map: map,
                position: locPosition,
                image: markerImage
            });

            // ì§€ë„ ì¤‘ì‹¬ ì´ë™
            map.setCenter(locPosition);
            map.setLevel(6);

            // ì£¼ë³€ ì¹´í˜ í‘œì‹œ
            showNearbyCafes(lat, lng);
        }, (error) => {
            alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        });
    } else {
        alert('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }
}

// ìœ„ì¹˜ë¡œ ì´ë™
function moveToLocation(lat, lng) {
    const movePosition = new kakao.maps.LatLng(lat, lng);
    map.setCenter(movePosition);
    map.setLevel(5);
}

// í´ëŸ¬ìŠ¤í„°ë§ í† ê¸€
function toggleClustering() {
    const button = document.getElementById('clusterToggle');
    
    if (isClusteringEnabled) {
        // í´ëŸ¬ìŠ¤í„°ë§ ë¹„í™œì„±í™”
        clusterer.clear();
        markers.forEach(marker => marker.setMap(map));
        button.textContent = 'ğŸ”— í´ëŸ¬ìŠ¤í„°ë§ OFF';
        button.classList.remove('bg-gray-600', 'hover:bg-gray-700');
        button.classList.add('bg-red-600', 'hover:bg-red-700');
        isClusteringEnabled = false;
    } else {
        // í´ëŸ¬ìŠ¤í„°ë§ í™œì„±í™”
        markers.forEach(marker => marker.setMap(null));
        clusterer.addMarkers(markers);
        button.textContent = 'ğŸ”— í´ëŸ¬ìŠ¤í„°ë§ ON';
        button.classList.remove('bg-red-600', 'hover:bg-red-700');
        button.classList.add('bg-gray-600', 'hover:bg-gray-700');
        isClusteringEnabled = true;
    }
}

// ì£¼ë³€ ì¹´í˜ í‘œì‹œ - ìˆ˜ì •ëœ ë²„ì „
function showNearbyCafes(userLat, userLng) {
    const panel = document.getElementById('nearbyPanel');
    const list = document.getElementById('nearbyList');
    list.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

    const userPosition = new kakao.maps.LatLng(userLat, userLng);
    
    // ì£¼ë³€ ì¹´í˜ ì°¾ê¸° (2km ì´ë‚´)
    const nearby = bdayCafes.filter(cafe => {
        if (!cafe.latitude || !cafe.longitude) return false;
        
        const cafePosition = new kakao.maps.LatLng(cafe.latitude, cafe.longitude);
        const distance = kakao.maps.services.Util.getDistance(userPosition, cafePosition);
        return distance <= 2000; // 2km ì´ë‚´
    }).map(cafe => {
        const cafePosition = new kakao.maps.LatLng(cafe.latitude, cafe.longitude);
        const distance = kakao.maps.services.Util.getDistance(userPosition, cafePosition);
        return {
            ...cafe,
            distance: Math.round(distance),
            walkTime: Math.round(distance / 80) // ë„ë³´ ì‹œê°„ (í‰ê·  ì†ë„ 80m/ë¶„)
        };
    }).sort((a, b) => a.distance - b.distance); // ê±°ë¦¬ìˆœ

    if (nearby.length === 0) {
        list.innerHTML = '<div class="text-center text-gray-500 py-4"><p class="text-sm">ì£¼ë³€ 2km ì´ë‚´ì— ìš´ì˜ì¤‘ì¸ ìƒì¹´ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
    } else {
        nearby.forEach(cafe => {
            const item = document.createElement('div');
            item.className = 'border border-gray-200 p-3 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors';
            
            // cafe.nameì„ ìš°ì„  ì‚¬ìš©
            const cafeName = cafe.name || cafe.cafe_name || 'ìƒì¼ì¹´í˜';
            const artistName = cafe.artist || '';
            const memberName = cafe.member || '';
            const address = cafe.address || '';
            const mainImage = cafe.main_image || '';
            
            item.innerHTML = `
                <div class="flex items-start space-x-3">
                    ${mainImage ? 
                        `<img src="${mainImage}" alt="${cafeName}" class="w-12 h-12 object-cover rounded-lg flex-shrink-0">` :
                        '<div class="w-12 h-12 bg-gray-200 rounded-lg flex items-center justify-center flex-shrink-0"><span class="text-gray-400 text-sm">ğŸ‚</span></div>'
                    }
                    <div class="flex-1 min-w-0">
                        <h4 class="font-medium text-sm text-gray-900 truncate">${cafeName}</h4>
                        <p class="text-xs text-gray-600 truncate">${artistName}${memberName ? ` - ${memberName}` : ''}</p>
                        <p class="text-xs text-gray-500 truncate mt-1">${address}</p>
                        <div class="flex items-center space-x-2 mt-2">
                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${cafe.distance}m</span>
                            <span class="text-xs text-gray-500">ë„ë³´ ${cafe.walkTime}ë¶„</span>
                        </div>
                    </div>
                </div>
            `;
            
            // í´ë¦­ ì´ë²¤íŠ¸
            item.addEventListener('click', () => {
                showCafeInfo(cafe);
                moveToLocation(cafe.latitude, cafe.longitude);
            });
            
            list.appendChild(item);
        });
    }

    // íŒ¨ë„ í‘œì‹œ
    panel.classList.remove('hidden');
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
document.addEventListener('DOMContentLoaded', function() {
    
    // ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ í™•ì¸
    if (typeof kakao === 'undefined' || !kakao.maps) {
        console.error('ì¹´ì¹´ì˜¤ë§µ APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        const loadingEl = document.getElementById('mapLoading');
        if (loadingEl) {
            loadingEl.innerHTML = `
                <div class="bg-white rounded-lg p-4 shadow-lg">
                    <div class="text-red-600 text-center">
                        <p>ì¹´ì¹´ì˜¤ë§µ ë¡œë“œ ì‹¤íŒ¨</p>
                        <p class="text-sm mt-1">API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”</p>
                        <button onclick="location.reload()" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded text-sm">ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                </div>
            `;
        }
        return;
    }
    
    
    // ì§€ë„ ì´ˆê¸°í™”
    try {
        initMap();
        
        // ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        const myLocationBtn = document.getElementById('myLocationBtn');
        const clusterToggle = document.getElementById('clusterToggle');
        const closeCafeInfo = document.getElementById('closeCafeInfo');
        const closeNearbyPanel = document.getElementById('closeNearbyPanel');
        
        if (myLocationBtn) {
            myLocationBtn.addEventListener('click', findMyLocation);
        }
        
        if (clusterToggle) {
            clusterToggle.addEventListener('click', toggleClustering);
        }
        
        if (closeCafeInfo) {
            closeCafeInfo.addEventListener('click', () => {
                document.getElementById('cafeInfoPanel').classList.add('translate-y-full');
            });
        }
        
        if (closeNearbyPanel) {
            closeNearbyPanel.addEventListener('click', () => {
                document.getElementById('nearbyPanel').classList.add('hidden');
            });
        }

        // ì§€ë„ í´ë¦­ ì‹œ ì¹´í˜ ì •ë³´ íŒ¨ë„ ë‹«ê¸° (ì§€ì—° ì„¤ì •)
        setTimeout(() => {
            if (map) {
                kakao.maps.event.addListener(map, 'click', () => {
                    document.getElementById('cafeInfoPanel').classList.add('translate-y-full');
                });
            }
        }, 1000);
        
        
    } catch (error) {
    }
});

// í™”ë©´ í¬ê¸° ë³€ê²½ ì‹œ ì§€ë„ ì¬ì¡°ì •
window.addEventListener('resize', () => {
    if (map) {
        setTimeout(() => {
            map.relayout();
        }, 100);
    }
});
</script>

window.ddoksangHome = new DdoksangHome('tour'); 
{% endblock %}