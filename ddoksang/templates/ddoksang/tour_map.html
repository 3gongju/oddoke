<!-- templates/ddoksang/tour_map.html -->
{% extends "ddoksang/base/ddoksang_base.html" %}
{% load static %}

{% block body %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-gray-900">ğŸ—ºï¸ ìƒì¹´ íˆ¬ì–´ë§µ</h1>
                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                        {{ total_bday_cafes }}ê°œ ìš´ì˜ì¤‘
                    </span>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="myLocationBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        ğŸ“ ë‚´ ìœ„ì¹˜
                    </button>
                    <button id="clusterToggle" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                        ğŸ”— í´ëŸ¬ìŠ¤í„°ë§ ON
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Container -->
    <div class="relative">
        <div id="map" class="w-full h-[calc(100vh-120px)]"></div>

        <!-- âœ… ë‚´ ì£¼ë³€ ì¹´í˜ íŒ¨ë„ -->
        <div id="nearbyPanel" class="absolute top-4 left-4 bg-white rounded-lg shadow-lg p-4 w-[250px] max-h-[400px] overflow-y-auto z-50 hidden">
            <h3 class="text-sm font-semibold mb-3 text-gray-800">ğŸ“ ë‚´ ì£¼ë³€ ìƒì¹´</h3>
            <div id="nearbyList" class="space-y-3"></div>
        </div>

        <!-- Map Controls -->
        <div class="absolute top-4 right-4 bg-white rounded-lg shadow-lg p-4 space-y-2">
            <div class="text-sm font-medium text-gray-700">ë²”ë¡€</div>
            <div class="flex items-center space-x-2">
                <div class="w-4 h-4 bg-red-500 rounded-full"></div>
                <span class="text-sm text-gray-600">ìš´ì˜ì¤‘ ìƒì¼ì¹´í˜</span>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-4 h-4 bg-blue-500 rounded-full border-2 border-white"></div>
                <span class="text-sm text-gray-600">í´ëŸ¬ìŠ¤í„°</span>
            </div>
        </div>

        <!-- Loading -->
        <div id="mapLoading" class="absolute inset-0 bg-black bg-opacity-20 flex items-center justify-center hidden">
            <div class="bg-white rounded-lg p-4 shadow-lg">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                <div class="mt-2 text-sm text-gray-600">ì§€ë„ ë¡œë”©ì¤‘...</div>
            </div>
        </div>
    </div>

    <!-- Cafe Info Panel -->
    <div id="cafeInfoPanel" class="fixed bottom-0 left-0 right-0 bg-white shadow-2xl transform translate-y-full transition-transform duration-300 z-50">
        <div class="p-4 border-b">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold" id="cafeInfoTitle">ì¹´í˜ ì •ë³´</h3>
                <button id="closeCafeInfo" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div id="cafeInfoContent" class="p-4 max-h-80 overflow-y-auto">
            <!-- ì¹´í˜ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
    </div>
</div>

<!-- ì¹´ì¹´ì˜¤ë§µ ìŠ¤í¬ë¦½íŠ¸ -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_api_key }}&libraries=services,clusterer"></script>

<script>
// ì „ì—­ ë³€ìˆ˜
let map;
let clusterer;
let markers = [];
let isClusteringEnabled = true;
let userLocationMarker = null;

// ìƒì¼ì¹´í˜ ë°ì´í„°
const bdayCafes = {{ bday_cafes_json|safe }};

// ì§€ë„ ì´ˆê¸°í™”
function initMap() {
    document.getElementById('mapLoading').classList.remove('hidden');
    
    // ì„œìš¸ ì¤‘ì‹¬ìœ¼ë¡œ ì§€ë„ ìƒì„±
    const mapContainer = document.getElementById('map');
    const mapOption = {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 8
    };
    
    map = new kakao.maps.Map(mapContainer, mapOption);
    
    // í´ëŸ¬ìŠ¤í„°ëŸ¬ ìƒì„±
    clusterer = new kakao.maps.MarkerClusterer({
        map: map,
        averageCenter: true,
        minLevel: 6,
        disableClickZoom: true,
        styles: [
            {
                width: '40px',
                height: '40px',
                background: 'rgba(59, 130, 246, 0.8)',
                borderRadius: '50%',
                color: '#fff',
                textAlign: 'center',
                fontWeight: 'bold',
                fontSize: '14px',
                lineHeight: '40px'
            },
            {
                width: '50px',
                height: '50px',
                background: 'rgba(147, 51, 234, 0.8)',
                borderRadius: '50%',
                color: '#fff',
                textAlign: 'center',
                fontWeight: 'bold',
                fontSize: '16px',
                lineHeight: '50px'
            },
            {
                width: '60px',
                height: '60px',
                background: 'rgba(239, 68, 68, 0.8)',
                borderRadius: '50%',
                color: '#fff',
                textAlign: 'center',
                fontWeight: 'bold',
                fontSize: '18px',
                lineHeight: '60px'
            }
        ]
    });
    
    // ë§ˆì»¤ ìƒì„± ë° ì¶”ê°€
    createMarkers();
    
    document.getElementById('mapLoading').classList.add('hidden');
    
    console.log(`${bdayCafes.length}ê°œì˜ ìƒì¼ì¹´í˜ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
}

// ë§ˆì»¤ ìƒì„±
function createMarkers() {
    markers = [];
    
    bdayCafes.forEach((cafe, index) => {
        if (!cafe.latitude || !cafe.longitude) {
            console.warn(`ì¹´í˜ ${cafe.name}: ì¢Œí‘œ ì •ë³´ ì—†ìŒ`);
            return;
        }
        
        const position = new kakao.maps.LatLng(cafe.latitude, cafe.longitude);
        
        // ì»¤ìŠ¤í…€ ë§ˆì»¤ ì´ë¯¸ì§€
   
        const svgString = `
        <svg xmlns='http://www.w3.org/2000/svg' width='32' height='40' viewBox='0 0 32 40'>
            <path d='M16 0C7.163 0 0 7.163 0 16s16 24 16 24 16-15.163 16-24S24.837 0 16 0z' fill='#ef4444'/>
            <circle cx='16' cy='16' r='8' fill='white'/>
            <text x='16' y='20' text-anchor='middle' font-family='Arial' font-size='12' font-weight='bold' fill='#ef4444'>ğŸ‚</text>
        </svg>`;

        const imageSrc = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString)));

        
        const imageSize = new kakao.maps.Size(32, 40);
        const imageOption = { offset: new kakao.maps.Point(16, 40) };
        const markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);
        
        const marker = new kakao.maps.Marker({
            position: position,
            image: markerImage,
            title: cafe.name
        });
        
        // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
        kakao.maps.event.addListener(marker, 'click', () => {
            showCafeInfo(cafe);
        });
        
        markers.push(marker);
    });
    
    // í´ëŸ¬ìŠ¤í„°ëŸ¬ì— ë§ˆì»¤ ì¶”ê°€
    if (isClusteringEnabled) {
        clusterer.addMarkers(markers);
    } else {
        markers.forEach(marker => marker.setMap(map));
    }
    
    // í´ëŸ¬ìŠ¤í„° í´ë¦­ ì´ë²¤íŠ¸
    kakao.maps.event.addListener(clusterer, 'clusterclick', (cluster) => {
        const level = map.getLevel() - 2;
        map.setLevel(level, { anchor: cluster.getCenter() });
    });
}

// ì¹´í˜ ì •ë³´ í‘œì‹œ
function showCafeInfo(cafe) {
    const panel = document.getElementById('cafeInfoPanel');
    const title = document.getElementById('cafeInfoTitle');
    const content = document.getElementById('cafeInfoContent');
    
    title.textContent = cafe.name;
    
    content.innerHTML = `
        <div class="space-y-4">
            <div class="flex items-start space-x-4">
                ${cafe.main_image ? `<img src="${cafe.main_image}" alt="${cafe.name}" class="w-20 h-20 object-cover rounded-lg">` : ''}
                <div class="flex-1">
                    <h4 class="font-semibold text-lg">${cafe.name}</h4>
                    <p class="text-sm text-gray-600">${cafe.artist}${cafe.member ? ` - ${cafe.member}` : ''}</p>
                    <p class="text-sm text-blue-600">${cafe.start_date} ~ ${cafe.end_date}</p>
                    ${cafe.is_active ? '<span class="inline-block px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">ìš´ì˜ì¤‘</span>' : 
                      `<span class="inline-block px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded-full">${cafe.days_remaining < 0 ? 'ì¢…ë£Œ' : 'ì˜ˆì •'}</span>`}
                </div>
            </div>
            
            <div class="border-t pt-4">
                <h5 class="font-medium mb-2">ğŸ“ ìœ„ì¹˜</h5>
                <p class="text-sm text-gray-600">${cafe.address}</p>
            </div>
            
            ${cafe.special_benefits ? `
            <div class="border-t pt-4">
                <h5 class="font-medium mb-2">ğŸ íŠ¹ì „</h5>
                <p class="text-sm text-gray-600">${cafe.special_benefits}</p>
            </div>
            ` : ''}
            
            <div class="border-t pt-4 flex space-x-2">
                <a href="/ddoksang/detail/${cafe.id}/" class="flex-1 bg-blue-600 text-white text-center py-2 rounded-lg hover:bg-blue-700">
                    ìì„¸íˆ ë³´ê¸°
                </a>
                <button onclick="moveToLocation(${cafe.latitude}, ${cafe.longitude})" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                    ìœ„ì¹˜ë¡œ ì´ë™
                </button>
            </div>
        </div>
    `;
    
    panel.classList.remove('translate-y-full');
}
function findMyLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const locPosition = new kakao.maps.LatLng(lat, lng);
            
            if (userLocationMarker) {
                userLocationMarker.setMap(null);
            }

            const imageSrc = 'data:image/svg+xml;base64,' + btoa(`
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20">
                    <circle cx="10" cy="10" r="8" fill="#3b82f6" stroke="white" stroke-width="2"/>
                    <circle cx="10" cy="10" r="3" fill="white"/>
                </svg>
            `);
            const imageSize = new kakao.maps.Size(20, 20);
            const markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

            userLocationMarker = new kakao.maps.Marker({
                map: map,
                position: locPosition,
                image: markerImage
            });

            map.setCenter(locPosition);
            map.setLevel(6);

            // âœ… ì£¼ë³€ ì¹´í˜ í‘œì‹œ
            showNearbyCafes(lat, lng);
        }, (error) => {
            alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        });
    } else {
        alert('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }
}



// í´ëŸ¬ìŠ¤í„°ë§ í† ê¸€
function toggleClustering() {
    const button = document.getElementById('clusterToggle');
    
    if (isClusteringEnabled) {
        // í´ëŸ¬ìŠ¤í„°ë§ ë¹„í™œì„±í™”
        clusterer.clear();
        markers.forEach(marker => marker.setMap(map));
        button.textContent = 'ğŸ”— í´ëŸ¬ìŠ¤í„°ë§ OFF';
        button.classList.remove('bg-gray-600', 'hover:bg-gray-700');
        button.classList.add('bg-red-600', 'hover:bg-red-700');
        isClusteringEnabled = false;
    } else {
        // í´ëŸ¬ìŠ¤í„°ë§ í™œì„±í™”
        markers.forEach(marker => marker.setMap(null));
        clusterer.addMarkers(markers);
        button.textContent = 'ğŸ”— í´ëŸ¬ìŠ¤í„°ë§ ON';
        button.classList.remove('bg-red-600', 'hover:bg-red-700');
        button.classList.add('bg-gray-600', 'hover:bg-gray-700');
        isClusteringEnabled = true;
    }
}

function showNearbyCafes(userLat, userLng) {
    const panel = document.getElementById('nearbyPanel');
    const list = document.getElementById('nearbyList');
    list.innerHTML = ''; // ê¸°ì¡´ ì¹´ë“œ ì´ˆê¸°í™”

    const userPosition = new kakao.maps.LatLng(userLat, userLng);
    const nearby = bdayCafes.filter(cafe => {
        if (!cafe.latitude || !cafe.longitude) return false;
        const cafePosition = new kakao.maps.LatLng(cafe.latitude, cafe.longitude);
        const distance = kakao.maps.services.Util.getDistance(userPosition, cafePosition);
        return distance <= 2000; // 2km ì´ë‚´
    });

    if (nearby.length === 0) {
        list.innerHTML = '<p class="text-gray-500 text-sm">ì£¼ë³€ 2km ì´ë‚´ì— ìš´ì˜ì¤‘ì¸ ìƒì¹´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    } else {
        nearby.forEach(cafe => {
            const item = document.createElement('div');
            item.className = 'border p-2 rounded hover:bg-gray-50 cursor-pointer';
            item.innerHTML = `
                <div class="font-medium text-sm">${cafe.name}</div>
                <div class="text-xs text-gray-500">${cafe.address}</div>
            `;
            item.addEventListener('click', () => {
                showCafeInfo(cafe);
                moveToLocation(cafe.latitude, cafe.longitude);
            });
            list.appendChild(item);
        });
    }

    panel.classList.remove('hidden');
}
</script>


<script>
// ìœ„ ëª¨ë“  í•¨ìˆ˜ë“¤ì€ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ë©´ì„œ,
// ì•„ë˜ ë¶€ë¶„ë§Œ ìˆ˜ì •í•´ì„œ <script> ë‚´ë¶€ì—ì„œ ì˜ ë‹«íˆë„ë¡ í•˜ê³ ,
// map ì´ˆê¸°í™” ì´í›„ ì´ë²¤íŠ¸ë¥¼ ë³´ì¥í•©ë‹ˆë‹¤.

document.addEventListener('DOMContentLoaded', () => {
    initMap();

    // ì´í›„ 100ms ë”œë ˆì´ í›„ map ì ‘ê·¼ ë³´ì¥ (ë˜ëŠ” setTimeout ì‚¬ìš© ê°€ëŠ¥)
    setTimeout(() => {
        if (map) {
            kakao.maps.event.addListener(map, 'click', () => {
                document.getElementById('cafeInfoPanel').classList.add('translate-y-full');
            });
        }
    }, 300);

    document.getElementById('myLocationBtn').addEventListener('click', findMyLocation);
    document.getElementById('clusterToggle').addEventListener('click', toggleClustering);
    document.getElementById('closeCafeInfo').addEventListener('click', () => {
        document.getElementById('cafeInfoPanel').classList.add('translate-y-full');
    });
});

window.addEventListener('resize', () => {
    if (map) {
        map.relayout();
    }
});
</script>


{% endblock %}