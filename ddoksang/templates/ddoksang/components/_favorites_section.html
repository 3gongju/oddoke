{% load static %}
{% load filters %}

<section class="mb-12" id="favoritesSection">
  <div class="flex items-center justify-between mb-4 px-4">
    <h2 class="text-xl font-semibold text-gray-800">ğŸ’– ë‚´ê°€ ì°œí•œ ìƒì¼ì¹´í˜</h2>
    <a href="{% url 'ddoksang:favorites' %}" class="text-sm text-pink-600 hover:underline">ì „ì²´ ë³´ê¸° &rarr;</a>
  </div>

  {% if my_favorite_cafes %}
    <!-- âœ… Swiper ì»¨í…Œì´ë„ˆ -->
    <div class="relative px-4">
      <div class="swiper favorites-swiper">
        <div class="swiper-wrapper" id="favoriteCarousel">
          {% for cafe in my_favorite_cafes %}
            <!-- âœ… ê° ì¹´í˜ë¥¼ swiper-slideë¡œ ê°ìŒˆ -->
            <div class="swiper-slide" data-cafe-id="{{ cafe.id }}">
              {% include 'ddoksang/components/_cafe_card.html' with cafe=cafe show_favorite_btn=True user_favorites=user_favorites show_status_badge=True %}
            </div>
          {% endfor %}
        </div>

        <!-- âœ… ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ë“¤ -->
        <div class="swiper-button-next favorites-button-next"></div>
        <div class="swiper-button-prev favorites-button-prev"></div>
        
        <!-- âœ… í˜ì´ì§€ë„¤ì´ì…˜ (ì„ íƒì‚¬í•­) -->
        <div class="swiper-pagination favorites-pagination"></div>
      </div>
    </div>
  {% else %}
    <div class="text-center py-16">
      <div class="text-6xl mb-4">ğŸ’”</div>
      <h3 class="text-lg font-medium text-gray-900 mb-2">ì•„ì§ ì°œí•œ ìƒì¼ì¹´í˜ê°€ ì—†ì–´ìš”</h3>
      <p class="text-gray-600 mb-6">ë§ˆìŒì— ë“œëŠ” ìƒì¹´ë¥¼ ì°œí•´ë³´ì„¸ìš”!</p>
      <a href="{% url 'ddoksang:home' %}" class="inline-block bg-pink-600 text-white px-6 py-3 rounded-lg hover:bg-pink-700 transition-colors">
        ìƒì¼ì¹´í˜ ë‘˜ëŸ¬ë³´ê¸°
      </a>
    </div>
  {% endif %}
</section>

<!-- âœ… Swiper CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

<!-- âœ… Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<!-- âœ… Swiper ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // âœ… Swiper ì´ˆê¸°í™” (ì°œí•œ ì¹´í˜ ì„¹ì…˜)
    initFavoritesSwiper();
});

function initFavoritesSwiper() {
    const swiperContainer = document.querySelector('.favorites-swiper');
    if (!swiperContainer) return;

    const swiper = new Swiper('.favorites-swiper', {
        // âœ… ë°˜ì‘í˜• ìŠ¬ë¼ì´ë“œ ì„¤ì •
        slidesPerView: 1,
        spaceBetween: 16,
        
        // âœ… ë°˜ì‘í˜• ë¸Œë ˆì´í¬í¬ì¸íŠ¸
        breakpoints: {
            // 640px ì´ìƒ
            640: {
                slidesPerView: 2,
                spaceBetween: 20,
            },
            // 1024px ì´ìƒ
            1024: {
                slidesPerView: 3,
                spaceBetween: 24,
            },
            // 1280px ì´ìƒ
            1280: {
                slidesPerView: 4,
                spaceBetween: 24,
            },
        },
        
        // âœ… ë„¤ë¹„ê²Œì´ì…˜
        navigation: {
            nextEl: '.favorites-button-next',
            prevEl: '.favorites-button-prev',
        },
        
        // âœ… í˜ì´ì§€ë„¤ì´ì…˜
        pagination: {
            el: '.favorites-pagination',
            clickable: true,
            dynamicBullets: true,
        },
        
        // âœ… ìŠ¤í¬ë¡¤ë°” (ì„ íƒì‚¬í•­)
        // scrollbar: {
        //     el: '.swiper-scrollbar',
        //     draggable: true,
        // },
        
        // âœ… ìë™ì¬ìƒ (ì„ íƒì‚¬í•­ - ì‚¬ìš©ìê°€ ì¡°ì‘í•˜ë©´ ë©ˆì¶¤)
        // autoplay: {
        //     delay: 5000,
        //     disableOnInteraction: true,
        // },
        
        // âœ… ë£¨í”„ (ì¹´ë“œê°€ ë§ì„ ë•Œë§Œ)
        loop: false,
        
        // âœ… ë§ˆìš°ìŠ¤ íœ ë¡œ ìŠ¬ë¼ì´ë“œ ë³€ê²½
        mousewheel: {
            forceToAxis: true,
        },
        
        // âœ… í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
        keyboard: {
            enabled: true,
        },
        
        // âœ… í„°ì¹˜ ì œìŠ¤ì²˜
        touchRatio: 1,
        touchAngle: 45,
        grabCursor: true,
        
        // âœ… ì§€ì—° ë¡œë”© (ì´ë¯¸ì§€ ìµœì í™”)
        lazy: {
            loadPrevNext: true,
        },
        
        // âœ… ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        on: {
            init: function() {
                console.log('ì°œí•œ ì¹´í˜ Swiper ì´ˆê¸°í™” ì™„ë£Œ');
            },
            slideChange: function() {
                // ìŠ¬ë¼ì´ë“œ ë³€ê²½ ì‹œ ì‹¤í–‰í•  ì½”ë“œ
            }
        }
    });

    // âœ… ì „ì—­ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì €ì¥
    window.favoritesSwiper = swiper;
}

// âœ… Swiper ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (AJAXë¡œ ì¹´ë“œ ì¶”ê°€/ì œê±° ì‹œ ì‚¬ìš©)
function updateFavoritesSwiper() {
    if (window.favoritesSwiper) {
        window.favoritesSwiper.update();
        window.favoritesSwiper.updateSlides();
    }
}

// âœ… ìƒˆë¡œìš´ ìŠ¬ë¼ì´ë“œ ì¶”ê°€ í•¨ìˆ˜
function addSlideToFavoritesSwiper(slideHTML, prepend = true) {
    if (!window.favoritesSwiper) return;
    
    if (prepend) {
        window.favoritesSwiper.prependSlide(`<div class="swiper-slide" data-cafe-id="">${slideHTML}</div>`);
    } else {
        window.favoritesSwiper.appendSlide(`<div class="swiper-slide" data-cafe-id="">${slideHTML}</div>`);
    }
}

// âœ… ìŠ¬ë¼ì´ë“œ ì œê±° í•¨ìˆ˜
function removeSlideFromFavoritesSwiper(cafeId) {
    if (!window.favoritesSwiper) return;
    
    const slides = document.querySelectorAll('.favorites-swiper .swiper-slide[data-cafe-id="' + cafeId + '"]');
    slides.forEach((slide, index) => {
        const slideIndex = Array.from(slide.parentNode.children).indexOf(slide);
        window.favoritesSwiper.removeSlide(slideIndex);
    });
}
</script>

<!-- âœ… Swiper ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ -->
<style>
/* ì°œí•œ ì¹´í˜ Swiper ì „ìš© ìŠ¤íƒ€ì¼ */
.favorites-swiper {
    padding: 0 40px 50px 40px; /* ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ê³¼ í˜ì´ì§€ë„¤ì´ì…˜ì„ ìœ„í•œ ì—¬ë°± */
}

/* ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ì»¤ìŠ¤í„°ë§ˆì´ì§• */
.favorites-button-next,
.favorites-button-prev {
    width: 32px;
    height: 32px;
    margin-top: -16px;
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease;
}

.favorites-button-next:hover,
.favorites-button-prev:hover {
    background: #f3f4f6;
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.favorites-button-next::after,
.favorites-button-prev::after {
    font-size: 14px;
    font-weight: bold;
    color: #6b7280;
}

.favorites-button-next:hover::after,
.favorites-button-prev:hover::after {
    color: #374151;
}

/* ë¹„í™œì„±í™”ëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.favorites-button-next.swiper-button-disabled,
.favorites-button-prev.swiper-button-disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

/* í˜ì´ì§€ë„¤ì´ì…˜ ì»¤ìŠ¤í„°ë§ˆì´ì§• */
.favorites-pagination {
    position: static !important;
    margin-top: 20px;
}

.favorites-pagination .swiper-pagination-bullet {
    width: 8px;
    height: 8px;
    background: #d1d5db;
    opacity: 1;
    transition: all 0.2s ease;
}

.favorites-pagination .swiper-pagination-bullet-active {
    background: #ec4899;
    transform: scale(1.2);
}

/* ëª¨ë°”ì¼ì—ì„œ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìˆ¨ê¸°ê¸° (ì„ íƒì‚¬í•­) */
@media (max-width: 640px) {
    .favorites-button-next,
    .favorites-button-prev {
        display: none;
    }
    
    .favorites-swiper {
        padding: 0 0 50px 0;
    }
}

/* ì¹´ë“œ í˜¸ë²„ íš¨ê³¼ ê°•í™” */
.favorites-swiper .swiper-slide {
    transition: transform 0.2s ease;
}

.favorites-swiper .swiper-slide:hover {
    transform: translateY(-4px);
}

/* ìŠ¤ì™€ì´í”„ ì¸ë””ì¼€ì´í„° (ëª¨ë°”ì¼ìš©) */
@media (max-width: 640px) {
    .favorites-swiper::before {
        content: 'â† ì¢Œìš°ë¡œ ìŠ¤ì™€ì´í”„í•˜ì„¸ìš” â†’';
        position: absolute;
        top: -30px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 12px;
        color: #9ca3af;
        z-index: 10;
    }
}
</style>