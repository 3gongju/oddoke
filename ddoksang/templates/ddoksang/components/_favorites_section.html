{% load static %}
{% load filters %}

<section class="mb-12" id="favoritesSection">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-semibold text-gray-800">ğŸ’– ë‚´ê°€ ì°œí•œ ìƒì¼ì¹´í˜</h2>
    <a href="{% url 'ddoksang:favorites' %}" class="text-sm text-pink-600 hover:underline">ì „ì²´ ë³´ê¸° &rarr;</a>
  </div>

  {% if my_favorite_cafes %}
    <!-- ê³ ì • ì»¨í…Œì´ë„ˆ ì•ˆì—ì„œ ìŠ¤ì™€ì´í•‘ -->
    <div class="relative">
      <!-- Swiper ì»¨í…Œì´ë„ˆ -->
      <div class="swiper-container favorites-swiper overflow-hidden">
        <div class="swiper-wrapper">
          {% for cafe in my_favorite_cafes %}
            <!-- ê° ì¹´í˜ë¥¼ swiper-slideë¡œ ê°ìŒˆ -->
            <div class="swiper-slide">
              <div class="h-full px-2" data-cafe-id="{{ cafe.id }}">
                {% include 'ddoksang/components/_cafe_card.html' with cafe=cafe show_favorite_btn=True user_favorites=user_favorites %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
      
      <!-- í˜ì´ì§€ë„¤ì´ì…˜ë§Œ ìœ ì§€ -->
      <div class="swiper-pagination favorites-pagination mt-4"></div>
    </div>
  {% else %}
    <div class="text-center py-16">
      <div class="text-6xl mb-4">ğŸ’”</div>
      <h3 class="text-lg font-medium text-gray-900 mb-2">ì•„ì§ ì°œí•œ ìƒì¼ì¹´í˜ê°€ ì—†ì–´ìš”</h3>
      <p class="text-gray-600 mb-6">ë§ˆìŒì— ë“œëŠ” ìƒì¹´ë¥¼ ì°œí•´ë³´ì„¸ìš”!</p>
      <a href="{% url 'ddoksang:home' %}" class="inline-block bg-pink-600 text-white px-6 py-3 rounded-lg hover:bg-pink-700 transition-colors">
        ìƒì¼ì¹´í˜ ë‘˜ëŸ¬ë³´ê¸°
      </a>
    </div>
  {% endif %}
</section>

<!-- Swiper CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@9.0.0/swiper-bundle.min.css">

<!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@9.0.0/swiper-bundle.min.js"></script>

<!-- ì»¤ìŠ¤í…€ CSS -->
<style>
/* ì»¨í…Œì´ë„ˆ ê³ ì • ë° ì˜¤ë²„í”Œë¡œìš° ìˆ¨ê¹€ */
.favorites-swiper {
  margin: 0 auto;
  position: relative;
  overflow: hidden;
}

/* í˜ì´ì§€ë„¤ì´ì…˜ */
.favorites-pagination {
  position: static !important;
  text-align: center;
}

.favorites-swiper .swiper-pagination-bullet {
  background: #d1d5db;
  opacity: 1;
  transition: all 0.3s ease;
  margin: 0 4px;
}

.favorites-swiper .swiper-pagination-bullet-active {
  background: #ec4899;
  transform: scale(1.2);
}

/* ìŠ¬ë¼ì´ë“œ ê°„ê²© ì¡°ì • */
.favorites-swiper .swiper-slide {
  height: auto;
  display: flex;
  box-sizing: border-box;
}

.favorites-swiper .swiper-slide > div {
  width: 100%;
}

/* ìƒì¼ ì•„í‹°ìŠ¤íŠ¸ ì„¹ì…˜ê³¼ ì¼ì¹˜í•˜ëŠ” ìŠ¤íƒ€ì¼ */
.favorites-swiper .swiper-wrapper {
  align-items: stretch;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let favoritesSwiper = null;
    
    // Swiper ì´ˆê¸°í™” í•¨ìˆ˜
    function initFavoritesSwiper() {
        // ê¸°ì¡´ Swiperê°€ ìˆë‹¤ë©´ ì™„ì „íˆ íŒŒê´´
        if (favoritesSwiper) {
            try {
                favoritesSwiper.destroy(true, true);
            } catch (e) {
                console.warn('Swiper destroy error:', e);
            }
            favoritesSwiper = null;
        }
        
        // Swiper ì»¨í…Œì´ë„ˆê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
        const swiperContainer = document.querySelector('.favorites-swiper');
        if (!swiperContainer) {
            console.log('Swiper container not found');
            return;
        }
        
        // ìƒˆ Swiper ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
        favoritesSwiper = new Swiper('.favorites-swiper', {
            slidesPerView: 1,
            spaceBetween: 16,
            loop: false,
            centeredSlides: false,
            
            // ë°˜ì‘í˜• ì„¤ì • (ìƒì¼ ì•„í‹°ìŠ¤íŠ¸ì™€ ë™ì¼)
            breakpoints: {
                640: {
                    slidesPerView: 2,
                    spaceBetween: 16,
                },
                768: {
                    slidesPerView: 3,
                    spaceBetween: 20,
                },
                1024: {
                    slidesPerView: 4,
                    spaceBetween: 20,
                },
                1280: {
                    slidesPerView: 5,
                    spaceBetween: 24,
                }
            },
            
            // í˜ì´ì§€ë„¤ì´ì…˜ë§Œ ìœ ì§€
            pagination: {
                el: '.favorites-pagination',
                clickable: true,
                dynamicBullets: true,
            },
            
            // ì¶”ê°€ ì„¤ì •
            autoHeight: false,
            touchRatio: 1,
            touchAngle: 45,
            grabCursor: true,
            
            // ìŠ¬ë¼ì´ë“œ ì „í™˜ íš¨ê³¼
            effect: 'slide',
            speed: 300,
            
            // ì ‘ê·¼ì„±
            a11y: {
                enabled: true,
            },
            
            // ì˜µì €ë²„ ì„¤ì • (DOM ë³€ê²½ ê°ì§€)
            observer: true,
            observeParents: true,
        });
        
        console.log('Favorites Swiper initialized');
        return favoritesSwiper;
    }
    
    // ì´ˆê¸° Swiper ìƒì„±
    initFavoritesSwiper();
    
    // ì°œí•˜ê¸° ìƒíƒœ ë³€ê²½ ì‹œ ì²˜ë¦¬ - ë‹¨ìˆœí™”ëœ ë²„ì „
    if (window.favoriteManager) {
        window.favoriteManager.onFavoriteChange((cafeId, isFavorited) => {
            console.log(`ì°œí•˜ê¸° ìƒíƒœ ë³€ê²½: ì¹´í˜ ${cafeId}, ì°œë¨: ${isFavorited}`);
            
            if (!isFavorited) {
                // ì°œ í•´ì œ ì‹œ í•´ë‹¹ ìŠ¬ë¼ì´ë“œ ì°¾ê¸°
                const slideToRemove = document.querySelector(`.favorites-swiper .swiper-slide [data-cafe-id="${cafeId}"]`)?.closest('.swiper-slide');
                
                if (slideToRemove && favoritesSwiper) {
                    // ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ì œê±°
                    slideToRemove.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    slideToRemove.style.opacity = '0';
                    slideToRemove.style.transform = 'scale(0.8)';
                    
                    setTimeout(() => {
                        // DOMì—ì„œ ì œê±°
                        slideToRemove.remove();
                        
                        // Swiper ì—…ë°ì´íŠ¸
                        if (favoritesSwiper && favoritesSwiper.el) {
                            try {
                                favoritesSwiper.update();
                                favoritesSwiper.updateSlidesClasses();
                            } catch (e) {
                                console.warn('Swiper update error:', e);
                            }
                        }
                        
                        // ëª¨ë“  ìŠ¬ë¼ì´ë“œê°€ ì œê±°ë˜ì—ˆëŠ”ì§€ í™•ì¸
                        const remainingSlides = document.querySelectorAll('.favorites-swiper .swiper-slide');
                        if (remainingSlides.length === 0) {
                            console.log('ëª¨ë“  ì°œì´ í•´ì œë¨, ë¹ˆ ìƒíƒœë¡œ ë³€ê²½');
                            // ì „ì²´ ì„¹ì…˜ì„ ë¹ˆ ìƒíƒœë¡œ êµì²´
                            const favoritesSection = document.getElementById('favoritesSection');
                            if (favoritesSection) {
                                favoritesSection.innerHTML = `
                                    <div class="flex items-center justify-between mb-4">
                                        <h2 class="text-xl font-semibold text-gray-800">ğŸ’– ë‚´ê°€ ì°œí•œ ìƒì¼ì¹´í˜</h2>
                                        <a href="/ddoksang/favorites/" class="text-sm text-pink-600 hover:underline">ì „ì²´ ë³´ê¸° &rarr;</a>
                                    </div>
                                    <div class="text-center py-16">
                                        <div class="text-6xl mb-4">ğŸ’”</div>
                                        <h3 class="text-lg font-medium text-gray-900 mb-2">ì•„ì§ ì°œí•œ ìƒì¼ì¹´í˜ê°€ ì—†ì–´ìš”</h3>
                                        <p class="text-gray-600 mb-6">ë§ˆìŒì— ë“œëŠ” ìƒì¹´ë¥¼ ì°œí•´ë³´ì„¸ìš”!</p>
                                        <a href="/ddoksang/home/" class="inline-block bg-pink-600 text-white px-6 py-3 rounded-lg hover:bg-pink-700 transition-colors">
                                            ìƒì¼ì¹´í˜ ë‘˜ëŸ¬ë³´ê¸°
                                        </a>
                                    </div>
                                `;
                            }
                        }
                    }, 300);
                }
            }
            // ì°œ ì¶”ê°€ì˜ 
            // ê²½ìš° í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ì²˜ë¦¬ (ë‹¨ìˆœí™”)
        });
    }
    
    // ì „ì—­ì—ì„œ ì¬ì´ˆê¸°í™” ê°€ëŠ¥í•˜ë„ë¡ í•¨ìˆ˜ ë…¸ì¶œ
    window.reinitFavoritesSwiper = initFavoritesSwiper;
});
</script>