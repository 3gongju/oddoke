<!-- ddoksang/templates/ddoksang/components/detail/_nearby_cafes.html -->
<!-- 주변 생일카페 리스트 -->

<div id="nearbyCafeContainer" class="bg-white rounded-2xl shadow-sm border p-6">
  <h3 class="font-bold text-gray-900 mb-4 flex items-center">
    <span class="mr-2">📍</span> 운영중/예정 생일카페
    {% if nearby_cafes %}
      <span class="ml-auto text-xs text-gray-500 font-normal">{{ nearby_cafes|length }}개</span>
    {% endif %}
  </h3>
  <div id="nearbyCafeList" class="space-y-3">
    {% if nearby_cafes %}
      {% for nearby_cafe in nearby_cafes %}
        <div class="nearby-cafe-card flex items-center space-x-3 p-3 rounded-lg cursor-pointer hover:shadow-lg hover:border-blue-300 transition-all duration-200 border border-gray-200" 
             onclick="location.href='{% url 'ddoksang:detail' nearby_cafe.id %}'">
          
          <!-- 🔧 이미지 처리 개선 -->
          {% if nearby_cafe.main_image %}
            <img src="{{ nearby_cafe.main_image }}" alt="{{ nearby_cafe.cafe_name }}" 
                 class="w-14 h-14 rounded-lg object-cover flex-shrink-0 shadow-sm">
          {% else %}
            <div class="w-14 h-14 bg-gradient-to-br from-gray-100 to-gray-200 rounded-lg flex items-center justify-center flex-shrink-0 shadow-sm">
              <span class="text-gray-400 text-lg">🎂</span>
            </div>
          {% endif %}
          
          <div class="flex-1 min-w-0">
            <div class="flex items-center space-x-2 mb-1.5">
              <h4 class="text-sm font-semibold text-gray-900 truncate">{{ nearby_cafe.cafe_name }}</h4>
              <!-- 🔧 관련 카페 표시 (같은 멤버/아티스트) -->
              {% if nearby_cafe.artist == cafe.artist %}
                <span class="related-badge flex-shrink-0">관련</span>
              {% endif %}
            </div>
            
            <p class="text-xs text-gray-600 truncate mb-2">
              {{ nearby_cafe.artist }}{% if nearby_cafe.member %} - {{ nearby_cafe.member }}{% endif %}
            </p>
            
            <div class="flex items-center space-x-2">
              <!-- 🔧 거리 표시 -->
              <span class="distance-badge">{{ nearby_cafe.distance|floatformat:1 }}km</span>
              
              <!-- 🔧 도보 시간 계산 -->
              {% if nearby_cafe.walk_time %}
                <span class="text-xs text-gray-500">🚶‍♂️ {{ nearby_cafe.walk_time }}분</span>
              {% endif %}
              
              <!-- 🔧 상태 표시 개선 -->
              {% if nearby_cafe.is_active %}
                <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-medium">운영중</span>
              {% elif nearby_cafe.days_until_start > 0 %}
                <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-medium">{{ nearby_cafe.days_until_start }}일 후</span>
              {% else %}
                <span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">종료</span>
              {% endif %}
            </div>
          </div>
          
          <div class="flex-shrink-0">
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </div>
        </div>
      {% endfor %}
      
      <!-- 🔧 관련 카페 설명 -->
      {% if nearby_cafes|length > 0 %}
        <div class="mt-4 pt-3 border-t border-gray-100">
          <p class="text-xs text-gray-500 flex items-center">
            <span class="related-badge mr-2">관련</span>
            같은 아티스트/멤버의 생일카페
          </p>
        </div>
      {% endif %}
    {% else %}
      <div class="text-center py-6">
        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
          <span class="text-gray-400 text-2xl">🔍</span>
        </div>
        <p class="text-sm text-gray-500">운영중/예정 카페가 없습니다</p>
        <p class="text-xs text-gray-400 mt-1">50km 반경 내 검색 결과 (종료된 카페 제외)</p>
      </div>
    {% endif %}
  </div>
</div>

<!-- 🔧 디버깅 정보 (개발 중에만 표시) -->
{% if settings.DEBUG %}
<div class="mt-2 text-xs text-gray-400">
  <!-- 디버깅: nearby_cafes 변수 확인 -->
  디버그: nearby_cafes 타입 = {{ nearby_cafes|length }}개 
  {% if cafe.member %}
    | 현재 카페 멤버: {{ cafe.member.member_name }}
  {% endif %}
</div>
{% endif %}