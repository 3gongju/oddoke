{% load static %}
{% load filters %}

<a href="{% url 'ddoksang:detail' cafe.id %}" class="block group transform transition-all duration-300 hover:-translate-y-1 card-favorite">
  {% with cafe|cafe_status as cafe_state %}
  <div class="relative overflow-hidden rounded-2xl border border-gray-200 transition-all duration-300">

    <!-- ✅ 회색 오버레이 + 블러 (종료된 경우) -->
    {% if cafe_state == 'ended' %}
      <div class="absolute inset-0 bg-gray-900/40 backdrop-blur-[1px] z-30 rounded-2xl pointer-events-none"></div>
    {% endif %}

    <!-- 이미지 + 오버레이 -->
    <div class="relative h-48">
      {% if cafe.get_main_image %}
        <img src="{{ cafe.get_main_image }}" alt="{{ cafe.cafe_name }}" class="w-full h-full object-cover" loading="lazy">
      {% else %}
        <div class="w-full h-full bg-gradient-to-br from-pink-100 to-purple-100 flex items-center justify-center">
          <span class="text-pink-400 text-4xl">🎂</span>
        </div>
      {% endif %}

      <!-- 기본 그라디언트 오버레이 -->
      <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent z-0"></div>

      <!-- 상태 뱃지 -->
      <div class="absolute -bottom-3 right-3 z-40">
        {% if cafe_state == 'ongoing' %}
          <span class="bg-green-500 text-white text-xs font-medium px-2 py-1 rounded-full">운영중</span>
        {% elif cafe_state == 'upcoming' %}
          <span class="bg-blue-500 text-white text-xs font-medium px-2 py-1 rounded-full">예정</span>
        {% else %}
          <span class="bg-gray-500 text-white text-xs font-medium px-2 py-1 rounded-full">종료</span>
        {% endif %}
      </div>

      <!-- 찜 하트 버튼 -->
      {% if user.is_authenticated and cafe.status == 'approved' %}
        <div class="absolute top-2.5 right-2.5 z-40">
          <button 
            data-favorite-btn 
            data-cafe-id="{{ cafe.id }}" 
            class="w-9 h-9 bg-white bg-opacity-90 backdrop-blur-sm rounded-full flex items-center justify-center hover:scale-110 transition-all favorite-heart-btn"
            style="color: {% if cafe.id in user_favorites %}#ef4444{% else %}#6b7280{% endif %};"
            title="{% if cafe.id in user_favorites %}찜 해제{% else %}찜하기{% endif %}">
            <span class="text-lg">{% if cafe.id in user_favorites %}♥{% else %}♡{% endif %}</span>
          </button>
        </div>        
      {% endif %}

      <!-- 오버레이 텍스트 -->
      <div class="absolute bottom-0 left-0 right-0 p-4 text-white z-0">
        <p class="text-sm opacity-90 truncate">
          {{ cafe.member.member_name }}{% if cafe.member %} ({{ cafe.artist.display_name }}){% endif %}
        </p>
        <p class="text-xs opacity-75 mt-1 truncate">
          📍 {{ cafe.place_name|default:cafe.address|truncatechars:20 }}
        </p>
      </div>
    </div>

    <!-- 하단 정보 -->
    <div class="bg-white p-4">
      <p class="text-base font-semibold text-gray-900 mb-1 truncate">
        {{ cafe.cafe_name }}
      </p>
      <!-- ✅ 새로운 날짜 로직 적용 -->
      <div class="flex items-center justify-between text-xs sm:text-sm text-gray-600">

        <span>{{ cafe.start_date|date:"m.d" }} - {{ cafe.end_date|date:"m.d" }}</span>
        {% if cafe_state == 'upcoming' and cafe.days_until_start > 0 and cafe.days_until_start <= 7 %}
          <span class="text-blue-600 font-medium">시작 D-{{ cafe.days_until_start }}</span>
        {% elif cafe_state == 'ongoing' and cafe.days_remaining > 0 and cafe.days_remaining <= 7 %}
          <span class="text-red-600 font-medium">종료 D-{{ cafe.days_remaining }}</span>
        {% endif %}
      </div>
    </div>
  </div>
  {% endwith %}
</a>

<style>
.card-favorite .text-shadow {
  text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

.card-favorite:hover > div {
  transform: scale(1.02);
}

.card-favorite .favorite-heart-btn:hover {
  transform: scale(1.15);
}
.card-favorite .favorite-heart-btn:active {
  transform: scale(1.05);
}
</style>