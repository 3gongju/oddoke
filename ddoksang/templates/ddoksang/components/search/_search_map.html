{% load static %}
{% load filters %}

<!-- Kakao Maps API ë¶ˆëŸ¬ì˜¤ê¸° -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_api_key }}&libraries=clusterer"></script>

<!-- ì§€ë„ ì˜ì—­ -->
<div class="mt-10 relative max-w-5xl mx-auto">
  <h2 class="text-lg font-semibold text-gray-800 mb-4 px-2">ğŸ“ ê²€ìƒ‰ëœ ìƒì¼ì¹´í˜ ì§€ë„</h2>
  <div id="searchMap" class="w-full h-[450px] rounded-xl shadow-md border border-gray-200"></div>
  <button id="locateBtn" class="absolute top-4 right-4 px-3 py-1 rounded-lg bg-white border shadow hover:bg-gray-100 text-sm">ë‚´ ìœ„ì¹˜</button>
  {{ cafes_json|json_script:"cafes-data" }}
</div>

<!-- ìƒì„¸ ì¹´ë“œ -->
<div id="searchMapCard" class="fixed z-50 bottom-6 left-1/2 transform -translate-x-1/2 w-[320px] bg-white/80 backdrop-blur-md border rounded-2xl shadow-xl p-4 hidden transition-all duration-300">
  <div class="flex justify-between items-start mb-2">
    <h3 id="cardTitle" class="text-base font-semibold text-gray-800"></h3>
    <button onclick="closeSearchMapCard()" class="text-gray-400 hover:text-gray-600">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
  </div>
  <img id="cardImage" src="" alt="í¬ìŠ¤í„°" class="w-full h-40 object-cover rounded-lg mb-3" />
  <p id="cardPlace" class="text-sm text-gray-700 mb-1 text-center"></p>
  <p id="cardDate" class="text-sm text-gray-600 mb-3 text-center"></p>
  <a id="cardLink" href="#" class="block text-center px-3 py-1 text-sm bg-black text-white rounded-lg hover:bg-gray-900 transition">ìƒì„¸ë³´ê¸°</a>
</div>

<!-- ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
  // âœ… canvas ê¸°ë°˜ ì›í˜• ë§ˆì»¤ ìƒì„± í•¨ìˆ˜
  function createCircularMarkerImage(url, diameter = 44, border = 2, borderColor = 'red') {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.src = url;

      img.onload = () => {
        const canvas = document.createElement('canvas');
        const size = diameter + border * 2;
        canvas.width = canvas.height = size;
        const ctx = canvas.getContext('2d');

        ctx.clearRect(0, 0, size, size);

        // ì›í˜• ë§ˆìŠ¤í¬
        ctx.save();
        ctx.beginPath();
        ctx.arc(size / 2, size / 2, diameter / 2, 0, Math.PI * 2);
        ctx.clip();
        ctx.drawImage(img, border, border, diameter, diameter);
        ctx.restore();

        // í…Œë‘ë¦¬
        if (border > 0) {
          ctx.beginPath();
          ctx.arc(size / 2, size / 2, diameter / 2, 0, Math.PI * 2);
          ctx.lineWidth = border;
          ctx.strokeStyle = borderColor;
          ctx.stroke();
        }

        const dataUrl = canvas.toDataURL();
        const kakaoImage = new kakao.maps.MarkerImage(dataUrl, new kakao.maps.Size(size, size), {
          offset: new kakao.maps.Point(size / 2, size / 2)
        });

        resolve(kakaoImage);
      };

      img.onerror = () => reject('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨');
    });
  }

  // âœ… ìƒì„¸ ì¹´ë“œ ë³´ì—¬ì£¼ê¸°
  function showSearchMapCard(cafe) {
    document.getElementById("cardTitle").textContent = cafe.cafe_name || "ì œëª© ì—†ìŒ";
    document.getElementById("cardPlace").textContent = cafe.road_address || cafe.address || "ì¥ì†Œ ì •ë³´ ì—†ìŒ";
    document.getElementById("cardDate").textContent = (cafe.start_date || '') + " ~ " + (cafe.end_date || '');
    document.getElementById("cardImage").src = cafe.main_image_url || '';
    document.getElementById("cardLink").href = `/ddoksang/cafe/${cafe.id}/`;
    document.getElementById("searchMapCard").classList.remove("hidden");
  }

  function closeSearchMapCard() {
    document.getElementById("searchMapCard").classList.add("hidden");
  }

  // âœ… ì§€ë„ ì´ˆê¸°í™”
  document.addEventListener('DOMContentLoaded', async function () {
    const cafeData = JSON.parse(document.getElementById("cafes-data").textContent);
    const container = document.getElementById('searchMap');
    if (!container || !window.kakao || !window.kakao.maps) return;

    const map = new kakao.maps.Map(container, {
      center: new kakao.maps.LatLng(37.5665, 126.9780),
      level: 6
    });

    const bounds = new kakao.maps.LatLngBounds();

    for (const cafe of cafeData) {
      if (!cafe.latitude || !cafe.longitude) continue;

      const position = new kakao.maps.LatLng(cafe.latitude, cafe.longitude);
      bounds.extend(position);

      try {
        const image = await createCircularMarkerImage(cafe.main_image_url || "", 44, 2, '#ff3366');
        const marker = new kakao.maps.Marker({
          map,
          position,
          title: cafe.cafe_name,
          image
        });

        kakao.maps.event.addListener(marker, 'click', () => showSearchMapCard(cafe));
      } catch (e) {
        console.warn('ë§ˆì»¤ ìƒì„± ì‹¤íŒ¨:', e);
      }
    }

    if (cafeData.length > 0) map.setBounds(bounds);

    // âœ… ë‚´ ìœ„ì¹˜ ë²„íŠ¼ ì²˜ë¦¬
    const locateBtn = document.getElementById('locateBtn');
    locateBtn.addEventListener('click', () => {
      if (!navigator.geolocation) return alert("ìœ„ì¹˜ ì •ë³´ ì‚¬ìš© ë¶ˆê°€");

      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const locPosition = new kakao.maps.LatLng(lat, lng);

        const iconUrl = "{% static 'image/ddok_circle_red.png' %}";
        const markerImage = await createCircularMarkerImage(iconUrl, 44, 2, 'black');

        new kakao.maps.Marker({
          map,
          position: locPosition,
          image: markerImage
        });

        map.panTo(locPosition);
      }, () => {
        alert("ìœ„ì¹˜ ì ‘ê·¼ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
      });
    });
  });
</script>
