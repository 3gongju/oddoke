<!-- ddokchat/templates/ddokchat/components/chat/_messages.html -->

<div id="chat-log" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-100">
  {% for message in messages %}
    {% if message.sender == current_user %}
      {% with is_my_message=True %}
        <div class="flex justify-end mb-3">
          <div class="max-w-xs">
            
            <!-- ë©”ì‹œì§€ íƒ€ì…ë³„ ì²˜ë¦¬ -->
            {% if message.message_type == 'text' %}
              <!-- í…ìŠ¤íŠ¸ ë©”ì‹œì§€ -->
              <div class="bg-gray-900 text-white px-4 py-2 rounded-2xl shadow-sm">
                <p class="text-sm break-words">{{ message.text_content.content }}</p>
              </div>
              
            {% elif message.message_type == 'image' %}
              <!-- ì´ë¯¸ì§€ ë©”ì‹œì§€ -->
              <div class="bg-gray-900 text-white px-3 py-2 rounded-2xl shadow-sm">
                <img src="{{ message.image_content.image.url }}" alt="ì „ì†¡ ì´ë¯¸ì§€" class="w-full max-h-64 rounded-lg object-cover">
                {% if message.image_content.caption %}
                  <p class="text-sm mt-2 text-gray-200">{{ message.image_content.caption }}</p>
                {% endif %}
              </div>
              
            {% elif message.message_type == 'account_info' %}
              <!-- ë‚´ê°€ ë³´ë‚¸ ê³„ì¢Œì •ë³´ ë©”ì‹œì§€ -->
              {% with account_info=message.account_content.get_display_info %}
                <div class="bg-gray-900 text-white px-4 py-3 rounded-2xl shadow-sm">
                  <div class="space-y-3">
                    <div class="flex items-center space-x-2 mb-2">
                      <span class="text-lg">ğŸ’³</span>
                      <span class="font-semibold">ê³„ì¢Œì •ë³´ ì „ì†¡</span>
                    </div>
                    
                    {% if account_info.is_deleted %}
                      <div class="bg-gray-800 rounded-lg p-4 text-center">
                        <p class="text-sm text-gray-300 font-medium">{{ account_info.deleted_message }}</p>
                      </div>
                    {% else %}
                      <div class="bg-gray-800 rounded-lg p-3 space-y-2">
                        <div class="flex justify-between">
                          <span class="text-sm text-gray-300">ì€í–‰</span>
                          <span class="font-medium text-white">{{ account_info.bank_name }}</span>
                        </div>
                        <div class="flex justify-between">
                          <span class="text-sm text-gray-300">ê³„ì¢Œë²ˆí˜¸</span>
                          <span class="font-mono text-white">{{ account_info.account_number }}</span>
                        </div>
                        <div class="flex justify-between">
                          <span class="text-sm text-gray-300">ì˜ˆê¸ˆì£¼</span>
                          <span class="font-medium text-white">{{ account_info.account_holder }}</span>
                        </div>
                      </div>
                    {% endif %}
                  </div>
                </div>
              {% endwith %}
              
            {% elif message.message_type == 'address_info' %}
              <!-- ë‚´ê°€ ë³´ë‚¸ ë°°ì†¡ì •ë³´ ë©”ì‹œì§€ -->
              {% with address_info=message.address_content.get_display_info %}
                <div class="bg-gray-900 text-white px-4 py-3 rounded-2xl shadow-sm">
                  <div class="space-y-3">
                    <div class="flex items-center space-x-2 mb-2">
                      <span class="text-lg">ğŸ“¦</span>
                      <span class="font-semibold">ë°°ì†¡ì •ë³´ ì „ì†¡</span>
                    </div>
                    
                    {% if address_info.is_deleted %}
                      <div class="bg-gray-800 rounded-lg p-4 text-center">
                        <p class="text-sm text-gray-300 font-medium">{{ address_info.deleted_message }}</p>
                      </div>
                    {% else %}
                      <div class="bg-gray-800 rounded-lg p-3 space-y-2">
                        <div class="flex justify-between">
                          <span class="text-sm text-gray-300">ì—°ë½ì²˜</span>
                          <span class="font-mono text-white">{{ address_info.phone_number }}</span>
                        </div>
                        <div class="flex justify-between">
                          <span class="text-sm text-gray-300">ìš°í¸ë²ˆí˜¸</span>
                          <span class="font-medium text-white">{{ address_info.postal_code }}</span>
                        </div>
                        <div>
                          <span class="text-sm text-gray-300">ë°°ì†¡ì£¼ì†Œ</span>
                          <p class="font-medium text-white mt-1">{{ address_info.full_address }}</p>
                        </div>
                      </div>
                    {% endif %}
                  </div>
                </div>
              {% endwith %}
            {% endif %}

            <!-- ì‹œê°„ ë° ì½ìŒ ì—¬ë¶€ -->
            <div class="flex justify-end items-center gap-1 mt-1">
              {% if message.is_read == 0 %}
                <span class="text-xs text-red-500 font-semibold unread-label">ì•ˆì½ìŒ</span>
                <span class="text-xs text-gray-400">â€¢</span>
              {% endif %}
              <span class="text-xs text-gray-400">{{ message.timestamp|time:"H:i" }}</span>
            </div>
          </div>
        </div>
      {% endwith %}
    {% else %}
      {% with is_my_message=False %}
        <div class="flex justify-start mb-3">
          <div class="max-w-xs">
            
            <!-- ë‹‰ë„¤ì„ì„ ìƒë‹¨ì— í‘œì‹œ -->
            <p class="text-sm font-semibold text-gray-800 mb-1">{{ message.sender.username }}</p>
            
            <!-- ë©”ì‹œì§€ íƒ€ì…ë³„ ì²˜ë¦¬ -->
            {% if message.message_type == 'text' %}
              <!-- í…ìŠ¤íŠ¸ ë©”ì‹œì§€ -->
              <div class="bg-white text-gray-800 border border-gray-200 px-4 py-2 rounded-2xl shadow-sm">
                <p class="text-sm break-words">{{ message.text_content.content }}</p>
              </div>
              
            {% elif message.message_type == 'image' %}
              <!-- ì´ë¯¸ì§€ ë©”ì‹œì§€ -->
              <div class="bg-white text-gray-800 border border-gray-200 px-3 py-2 rounded-2xl shadow-sm">
                <img src="{{ message.image_content.image.url }}" alt="ì „ì†¡ ì´ë¯¸ì§€" class="w-full max-h-64 rounded-lg object-cover">
                {% if message.image_content.caption %}
                  <p class="text-sm mt-2 text-gray-600">{{ message.image_content.caption }}</p>
                {% endif %}
              </div>
              
            {% elif message.message_type == 'account_info' %}
              <!-- ê³„ì¢Œì •ë³´ ë©”ì‹œì§€ (ìƒëŒ€ë°©ì´ ë³´ë‚¸ ê²ƒ) -->
              {% with account_info=message.account_content.get_display_info %}
                <div class="bg-white text-gray-800 border border-gray-200 px-4 py-3 rounded-2xl shadow-sm">
                  <div class="space-y-3">
                    <div class="flex items-center space-x-2 mb-2">
                      <span class="text-lg">ğŸ’³</span>
                      <span class="font-semibold">ê³„ì¢Œì •ë³´</span>
                    </div>
                    
                    {% if account_info.is_deleted %}
                      <div class="bg-gray-100 rounded-lg p-4 text-center">
                        <p class="text-sm text-gray-600 font-medium">{{ account_info.deleted_message }}</p>
                      </div>
                    {% else %}
                      <div class="bg-gray-50 rounded-lg p-3 space-y-2">
                        <div class="flex justify-between">
                          <span class="text-sm text-gray-600">ì€í–‰</span>
                          <span class="font-medium">{{ account_info.bank_name }}</span>
                        </div>
                        <div class="flex justify-between">
                          <span class="text-sm text-gray-600">ê³„ì¢Œë²ˆí˜¸</span>
                          <span class="font-mono">{{ account_info.account_number }}</span>
                        </div>
                        <div class="flex justify-between">
                          <span class="text-sm text-gray-600">ì˜ˆê¸ˆì£¼</span>
                          <span class="font-medium">{{ account_info.account_holder }}</span>
                        </div>
                      </div>
                      
                      <!-- ìƒëŒ€ë°© ë©”ì‹œì§€ì—ë§Œ ë²„íŠ¼ í‘œì‹œ -->
                      <div class="flex space-x-2 mt-3">
                        <button onclick="copyAccountNumber('{{ account_info.account_number }}')" 
                                class="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-2 rounded-lg transition-colors">
                          ê³„ì¢Œë²ˆí˜¸ ë³µì‚¬
                        </button>
                        <button onclick="checkFraudHistory('{{ account_info.bank_code }}', '{{ account_info.account_number }}', '{{ account_info.account_holder }}')" 
                                class="flex-1 bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-2 rounded-lg transition-colors">
                          ì‹ ê³ ì´ë ¥ ì¡°íšŒ
                        </button>
                      </div>
                    {% endif %}
                  </div>
                </div>
              {% endwith %}
              
            {% elif message.message_type == 'address_info' %}
              <!-- ë°°ì†¡ì •ë³´ ë©”ì‹œì§€ (ìƒëŒ€ë°©ì´ ë³´ë‚¸ ê²ƒ) -->
              {% with address_info=message.address_content.get_display_info %}
                <div class="bg-white text-gray-800 border border-gray-200 px-4 py-3 rounded-2xl shadow-sm">
                  <div class="space-y-3">
                    <div class="flex items-center space-x-2 mb-2">
                      <span class="text-lg">ğŸ“¦</span>
                      <span class="font-semibold">ë°°ì†¡ì •ë³´</span>
                    </div>
                    
                    {% if address_info.is_deleted %}
                      <div class="bg-gray-100 rounded-lg p-4 text-center">
                        <p class="text-sm text-gray-600 font-medium">{{ address_info.deleted_message }}</p>
                      </div>
                    {% else %}
                      <div class="bg-gray-50 rounded-lg p-3 space-y-2">
                        <div class="flex justify-between">
                          <span class="text-sm text-gray-600">ì—°ë½ì²˜</span>
                          <span class="font-mono">{{ address_info.phone_number }}</span>
                        </div>
                        <div class="flex justify-between">
                          <span class="text-sm text-gray-600">ìš°í¸ë²ˆí˜¸</span>
                          <span class="font-medium">{{ address_info.postal_code }}</span>
                        </div>
                        <div>
                          <span class="text-sm text-gray-600">ë°°ì†¡ì£¼ì†Œ</span>
                          <p class="font-medium mt-1">{{ address_info.full_address }}</p>
                        </div>
                      </div>
                      
                      <!-- ë°°ì†¡ì •ë³´ ë³µì‚¬ ë²„íŠ¼ë“¤ -->
                      <div class="flex space-x-2 mt-3">
                        <button onclick="copyDeliveryInfo('{{ address_info.phone_number }}', '{{ address_info.full_address }}')" 
                                class="flex-1 bg-green-500 hover:bg-green-600 text-white text-xs px-3 py-2 rounded-lg transition-colors">
                          ë°°ì†¡ì •ë³´ ë³µì‚¬
                        </button>
                        <button onclick="copyPhoneNumber('{{ address_info.phone_number }}')" 
                                class="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-2 rounded-lg transition-colors">
                          ì—°ë½ì²˜ ë³µì‚¬
                        </button>
                      </div>
                    {% endif %}
                  </div>
                </div>
              {% endwith %}
            {% endif %}

            <!-- ì‹œê°„ í‘œì‹œ -->
            <div class="flex justify-start items-center gap-1 mt-1">
              <span class="text-xs text-gray-400">{{ message.timestamp|time:"H:i" }}</span>
            </div>
          </div>
        </div>
      {% endwith %}
    {% endif %}
  {% endfor %}
</div>