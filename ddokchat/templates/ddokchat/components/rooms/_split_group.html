<!-- ddokchat/templates/ddokchat/components/rooms/_split_group.html -->

{% load humanize %}

<div class="split-group bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-4">
  <!-- 분철 그룹 헤더 (클릭하면 접기/펼치기) -->
  <div class="split-group-header cursor-pointer" onclick="toggleSplitGroup(this)">
    <div class="p-4 bg-purple-50 border-b border-purple-100 hover:bg-purple-100 transition-colors">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <!-- 분철 아이콘 -->
          <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl flex items-center justify-center shadow-sm">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
            </svg>
          </div>
          
          <!-- 분철 정보 -->
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-1">
              <span class="text-xs bg-purple-500 text-white px-2 py-0.5 rounded-full font-medium">분철</span>
              {% if group.is_completed %}
                <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-medium">거래완료</span>
              {% endif %}
            </div>
            <h3 class="font-semibold text-gray-900 text-sm truncate">{{ group.post.title }}</h3>
            <p class="text-xs text-gray-500 mt-0.5">
              {{ group.room_count }}개 채팅
              {% if group.latest_message_time %}
                • {{ group.latest_message_time|timesince }} 전
              {% endif %}
            </p>
          </div>
        </div>
        
        <div class="flex items-center gap-3">
          <!-- 총 안읽은 메시지 수 -->
          {% if group.total_unread and not group.is_completed %}
            <span class="bg-red-500 text-white text-xs rounded-full px-2 py-1 min-w-[20px] text-center font-semibold">
              {{ group.total_unread }}
            </span>
          {% endif %}
          
          <!-- 접기/펼치기 아이콘 -->
          <div class="toggle-icon transform transition-transform duration-200">
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 분철 채팅방 목록 (접기/펼치기 가능) -->
  <div class="split-group-content">
    <div class="divide-y divide-gray-100">
      {% for room in group.rooms %}
        <div class="hover:bg-gray-50 transition-colors">
          <a href="{% url 'ddokchat:chat_room' room_id=room.id %}" class="block p-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <!-- 참여자 프로필 -->
                <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden">
                  {% if room.partner.profile_image %}
                    <img src="{{ room.partner.profile_image.url }}" alt="{{ room.partner.username }}" class="w-full h-full object-cover">
                  {% else %}
                    <div class="w-full h-full flex items-center justify-center text-white {% if group.is_completed %}bg-gray-600{% else %}bg-gradient-to-r from-purple-400 to-pink-400{% endif %}">
                      {{ room.partner.username|first|upper }}
                    </div>
                  {% endif %}
                </div>
                
                <!-- 참여자 정보 -->
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <h4 class="font-medium {% if group.is_completed %}text-gray-700{% else %}text-gray-900{% endif %}">
                      {{ room.partner.username }}
                    </h4>
                    <span class="text-xs {% if group.is_completed %}bg-gray-100 text-gray-600{% else %}bg-purple-100 text-purple-700{% endif %} px-2 py-0.5 rounded-full font-medium">
                      {% if current_user == room.buyer %}판매자{% else %}참여자{% endif %}
                    </span>
                  </div>
                  
                  <!-- 마지막 메시지 미리보기 -->
                  {% if room.last_message %}
                    <div class="text-xs {% if group.is_completed %}text-gray-500{% else %}text-gray-600{% endif %}">
                      {% if room.last_message.sender == current_user %}
                        <span class="font-medium">나:</span>
                      {% else %}
                        <span class="font-medium">{{ room.last_message.sender.username }}:</span>
                      {% endif %}
                      
                      {% if room.last_message.message_type == 'text' %}
                        {{ room.last_message.text_content.content|truncatechars:30 }}
                      {% elif room.last_message.message_type == 'image' %}
                        <span class="italic">사진을 보냈습니다.</span>
                      {% elif room.last_message.message_type == 'account_info' %}
                        <span class="italic">계좌정보를 보냈습니다.</span>
                      {% elif room.last_message.message_type == 'address_info' %}
                        <span class="italic">배송정보를 보냈습니다.</span>
                      {% endif %}
                    </div>
                  {% else %}
                    <div class="text-xs {% if group.is_completed %}text-gray-400{% else %}text-gray-500{% endif %}">
                      아직 대화가 없습니다
                    </div>
                  {% endif %}
                </div>
              </div>
              
              <div class="flex items-center gap-2">
                <!-- 개별 채팅방 시간 -->
                {% if room.last_message %}
                  <span class="text-xs text-gray-400">
                    {{ room.last_message.timestamp|timesince }} 전
                  </span>
                {% endif %}
                
                <!-- 개별 안읽은 메시지 -->
                {% if room.unread_count and not group.is_completed %}
                  <span class="bg-purple-500 text-white text-xs rounded-full px-2 py-1 min-w-[18px] text-center font-medium">
                    {{ room.unread_count }}
                  </span>
                {% endif %}
              </div>
            </div>
          </a>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
function toggleSplitGroup(headerElement) {
  const groupElement = headerElement.closest('.split-group');
  const contentElement = groupElement.querySelector('.split-group-content');
  const toggleIcon = groupElement.querySelector('.toggle-icon');
  
  if (contentElement.style.display === 'none') {
    // 펼치기
    contentElement.style.display = 'block';
    toggleIcon.style.transform = 'rotate(0deg)';
    groupElement.classList.remove('collapsed');
  } else {
    // 접기
    contentElement.style.display = 'none';
    toggleIcon.style.transform = 'rotate(-90deg)';
    groupElement.classList.add('collapsed');
  }
}

// 페이지 로드 시 기본적으로 모든 그룹 펼쳐놓기
document.addEventListener('DOMContentLoaded', function() {
  const splitGroups = document.querySelectorAll('.split-group');
  splitGroups.forEach(group => {
    const content = group.querySelector('.split-group-content');
    if (content) {
      content.style.display = 'block';
    }
  });
});
</script>

<style>
.split-group {
  transition: all 0.3s ease;
}

.split-group.collapsed {
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.split-group:not(.collapsed) {
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.split-group-content {
  transition: all 0.3s ease;
}

.toggle-icon {
  transition: transform 0.2s ease;
}
</style>