<!-- ddokchat/templates/ddokchat/components/rooms/_split_group_card.html 수정 -->
{% load humanize %}
{% load price_filters %}

<div class="chat-card bg-white rounded-xl shadow-sm hover:shadow-md transition-all duration-200 border border-gray-200 chat-item">
    <!-- 그룹 헤더 (클릭하면 접기/펼치기) -->
    <div class="split-group-header cursor-pointer" onclick="toggleSplitGroup(this)">
        <div class="p-4">
            <div class="space-y-4">
                <!-- 상품 정보 -->
                <div class="flex items-center space-x-3">
                    <div class="w-16 h-16 rounded-lg overflow-hidden bg-gray-100 shadow-sm flex-shrink-0">
                        <img src="{{ group.post.get_main_image }}" alt="{{ group.post.title }}" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-xs bg-gray-500 text-white px-2 py-0.5 rounded-full font-medium">분철</span>
                            <span class="text-xs text-gray-600 font-medium">{{ group.room_count }}개 채팅</span>
                        </div>
                        <p class="text-base text-gray-900 font-semibold truncate">{{ group.post.title }}</p>
                        
                        <!-- ✅ 최적화된 분철 가격 표시 (총대 기준) -->
                        {% get_post_price_info group.post current_user as price_info %}
                        {% if price_info and price_info.category_type == 'split' %}
                            <div class="flex items-center space-x-2">
                                <p class="text-lg text-orange-600 font-bold">
                                    {{ price_info.display_price }}
                                </p>
                                <!-- ✅ 뱃지 제거됨 - 요구사항대로 -->
                            </div>
                            
                            <!-- 멤버 수 정보 -->
                            {% if price_info.item_count > 0 %}
                                <p class="text-xs text-gray-500 mt-1">
                                    총 {{ price_info.item_count }}개 멤버 가격
                                </p>
                            {% endif %}
                        {% else %}
                            <!-- 가격 정보 조회 실패 시 폴백 -->
                            <p class="text-lg text-orange-600 font-bold">
                                {% if group.total_price %}
                                    {{ group.total_price|floatformat:0|add:"0"|intcomma }}원
                                {% else %}
                                    가격 협의
                                {% endif %}
                            </p>
                        {% endif %}
                    </div>
                    <div class="flex items-center space-x-2">
                        {% if group.latest_message_time %}
                            <span class="text-xs text-gray-500">{{ group.latest_message_time|timesince }} 전</span>
                        {% endif %}
                        {% if group.total_unread %}
                            <span class="unread-badge bg-red-500 text-white text-xs rounded-full px-2 py-1 min-w-[20px] text-center font-medium">
                                {{ group.total_unread }}
                            </span>
                        {% endif %}
                        <!-- 접기/펼치기 아이콘 -->
                        <div class="toggle-icon transform transition-transform duration-200 ml-2">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- 마지막 메시지 표시 -->
                <div class="flex items-start space-x-3">
                    <!-- 동적 프로필 표시 - 대화 상대방들 기준 -->
                    <div class="flex-shrink-0">
                        {% if group.has_multiple_partners %}
                            <!-- 2명 이상과 최근에 대화 - 상대방들 프로필 나란히 -->
                            <div class="flex -space-x-2">
                                {% for partner in group.recent_partners|slice:":2" %}
                                    <div class="w-10 h-10 rounded-full bg-gray-900 flex items-center justify-center text-white font-medium text-sm border-2 border-white">
                                        {% if partner.profile_image %}
                                            <img src="{{ partner.profile_image.url }}" alt="{{ partner.username }}" class="w-full h-full object-cover rounded-full">
                                        {% else %}
                                            {{ partner.username|first|upper }}
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <!-- 1명과만 최근에 대화 - 단일 상대방 프로필 -->
                            {% with single_partner=group.primary_partner %}
                                {% if single_partner %}
                                    <div class="w-10 h-10 rounded-full bg-gray-900 flex items-center justify-center text-white font-medium text-sm">
                                        {% if single_partner.profile_image %}
                                            <img src="{{ single_partner.profile_image.url }}" alt="{{ single_partner.username }}" class="w-full h-full object-cover rounded-full">
                                        {% else %}
                                            {{ single_partner.username|first|upper }}
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                    </div>
                    
                    <!-- 닉네임과 메시지 -->
                    <div class="flex-1 min-w-0">
                        {% if group.latest_message %}
                            <!-- 동적 닉네임 표시 - 대화 상대방들 기준 -->
                            <h3 class="font-semibold text-gray-900 mb-2">
                                {% if group.has_multiple_partners %}
                                    <!-- 여러 명과 대화: "testuser 외 N명" -->
                                    {% with first_partner=group.recent_partners.0 others_count=group.recent_partners|length|add:"-1" %}
                                        {{ first_partner.username }} 외 {{ others_count }}명
                                    {% endwith %}
                                {% else %}
                                    <!-- 한 명과만 대화: 그 사람 이름 -->
                                    {% if group.primary_partner %}
                                        {{ group.primary_partner.username }}
                                    {% else %}
                                        {{ group.room_count }}명의 참여자
                                    {% endif %}
                                {% endif %}
                            </h3>
                            
                            <!-- 메시지 미리보기 (발신자 구분 없이) -->
                            {% with latest_message=group.latest_message %}
                                {% if latest_message.sender == current_user %}
                                    {% include 'ddokchat/components/rooms/_message_preview.html' with message=latest_message is_mine=True truncate=50 %}
                                {% else %}
                                    {% include 'ddokchat/components/rooms/_message_preview.html' with message=latest_message is_mine=False truncate=50 %}
                                {% endif %}
                            {% endwith %}
                        {% else %}
                            <h3 class="font-semibold text-gray-900 mb-2">{{ group.room_count }}명의 참여자</h3>
                            <div class="bg-gray-50 px-3 py-2 rounded-xl text-sm text-gray-500">
                                첫 메시지를 보내보세요!
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 개별 채팅방 목록 (접기/펼치기) -->
    <div class="split-group-content" style="display: none;">
        <div class="border-t border-gray-100">
            {% for room in group.rooms %}
                <div class="border-b border-gray-50 last:border-b-0 hover:bg-gray-50 transition-colors">
                    <a href="{% url 'ddokchat:chat_room' room_code=room.room_code %}" class="block p-4 pl-8">
                        <div class="flex items-start space-x-3">
                            <!-- 프로필 영역 -->
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-full bg-gray-900 flex items-center justify-center text-white font-medium text-sm">
                                    {% if room.partner.profile_image %}
                                        <img src="{{ room.partner.profile_image.url }}" alt="{{ room.partner.username }}" class="w-full h-full object-cover rounded-full">
                                    {% else %}
                                        {{ room.partner.username|first|upper }}
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- 사용자명 + 마지막 메시지 -->
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-2">
                                        <h4 class="font-semibold text-gray-900">{{ room.partner.username }}</h4>
                                        <!-- ✅ 수정된 멤버 배지 - 여러 멤버 표시 -->
                                        {% if room.partner == group.post.user %}
                                            <!-- 총대(게시글 작성자)인 경우 -->
                                            <span class="text-xs bg-purple-500 text-white px-2 py-0.5 rounded-full font-medium">덕장</span>
                                        {% else %}
                                            <!-- ✅ 일반 참여자인 경우 - 여러 멤버명 표시 -->
                                            {% if group.partner_member_map %}
                                                {% for user, member_names in group.partner_member_map.items %}
                                                    {% if user == room.partner %}
                                                        <span class="text-xs bg-gray-500 text-white px-2 py-0.5 rounded-full font-medium">{{ member_names }}</span>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        {% if room.last_message %}
                                            <span class="text-xs text-gray-500">{{ room.last_message.timestamp|timesince }} 전</span>
                                        {% endif %}
                                        {% if room.unread_count %}
                                            <span class="bg-red-500 text-white text-xs rounded-full px-2 py-1 min-w-[18px] text-center font-medium">
                                                {{ room.unread_count }}
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                {% if room.last_message %}
                                    {% if room.last_message.sender == current_user %}
                                        {% include 'ddokchat/components/rooms/_message_preview.html' with message=room.last_message is_mine=True truncate=30 %}
                                    {% else %}
                                        {% include 'ddokchat/components/rooms/_message_preview.html' with message=room.last_message is_mine=False truncate=30 %}
                                    {% endif %}
                                {% else %}
                                    {% include 'ddokchat/components/rooms/_message_preview.html' with message=None is_mine=False truncate=30 %}
                                {% endif %}
                            </div>
                        </div>
                    </a>
                </div>
            {% endfor %}
        </div>
    </div>
</div>