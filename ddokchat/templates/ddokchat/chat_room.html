{% extends "base.html" %}
{% load static %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block body %}
<!-- ì „ì²´ í™”ë©´ ë†’ì´ ì‚¬ìš© -->
<div class="h-screen flex flex-col bg-gray-50">
  
  <!-- ì±„íŒ…ë°© í—¤ë” (ê³ ì • ë†’ì´) -->
  {% include 'ddokchat/components/chat/_header.html' %}

  <!-- ë©”ì‹œì§€ ì˜ì—­ (ê°€ë³€ ë†’ì´) -->
  <div class="flex-1 overflow-hidden">
    {% include 'ddokchat/components/chat/_messages.html' %}
  </div>

  <!-- ğŸ”¥ NEW: ë¦¬ë·° ì‘ì„± ë°°ë„ˆ (ë©”ì‹œì§€ì™€ ì…ë ¥ ì˜ì—­ ì‚¬ì´) -->
  {% include 'ddokchat/components/chat/_review_banner.html' %}

  <!-- ë©”ì‹œì§€ ì…ë ¥ ì˜ì—­ (ê³ ì • ë†’ì´) -->
  {% include 'ddokchat/components/chat/_input_area.html' %}
  
</div>

<!-- ëª¨ë‹¬ë“¤ -->
{% include 'ddokchat/components/modals/_fraud_check.html' %}
{% include 'ddokchat/components/modals/_common_modals.html' %}

<!-- ğŸ”¥ ì‹ ê³  ëª¨ë‹¬ ì¶”ê°€ -->
{% include 'components/_report_modal.html' with target_user=other_user report_type="ì‚¬ìš©ì" hide_button=True %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.js"></script>

<!-- CSS íŒŒì¼ë“¤ ë¡œë“œ -->
<link rel="stylesheet" href="{% static 'css/ddokchat/chat_room.css' %}">
<link rel="stylesheet" href="{% static 'css/ddokchat/animations.css' %}">
<link rel="stylesheet" href="{% static 'css/ddokchat/modal.css' %}">
<link rel="stylesheet" href="{% static 'css/ddokchat/message_bubble.css' %}">

<style>
/* ê¸°ì¡´ ìŠ¤íƒ€ì¼ë“¤ */
body {
  overflow: hidden !important;
}

#faqButton, #faqModal {
  display: none !important;
}

html, body {
  height: 100%;
  overflow-x: hidden;
}

/* ëª¨ë“  í•˜ë‹¨ ì—¬ë°± ê°•ì œ ì œê±° */
body > *:last-child {
  display: none !important;
}

.h-32, .h-48 {
  display: none !important;
}

body {
  margin: 0 !important;
  padding: 0 !important;
  overflow: hidden !important;
}

/* ğŸ”¥ ì±„íŒ… ì»¨í…Œì´ë„ˆ ë„ˆë¹„ ì œí•œ ë° ì¤‘ì•™ ì •ë ¬ */
.h-screen {
  height: 100vh !important;
  position: fixed !important;
  top: 0 !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  width: 100vw !important;
  max-width: 800px !important; /* PCì—ì„œ ìµœëŒ€ ë„ˆë¹„ ì œí•œ */
}

/* ğŸ”¥ ë°˜ì‘í˜• ë„¤ë¹„ê²Œì´ì…˜ ë° í—¤ë” ìœ„ì¹˜ ì¡°ì • */
@media (max-width: 767px) {
  /* ëª¨ë°”ì¼: ë„¤ë¹„ë°” ìˆ¨ê¹€ */
  nav {
    display: none !important;
  }
  
  /* ì±„íŒ… í—¤ë” ìœ„ì¹˜ ì¡°ì • */
  .h-screen {
    top: 0 !important;
    width: 100vw !important;
    max-width: none !important; /* ëª¨ë°”ì¼ì—ì„œëŠ” ë„ˆë¹„ ì œí•œ ì—†ìŒ */
  }
  
  /* ğŸ”§ ëª¨ë°”ì¼ ë©”ì‹œì§€ ì˜ì—­ ë†’ì´ ì¡°ì • (ì—¬ë°± ìµœì í™”) */
  #chat-log {
    height: calc(100vh - 170px - 70px) !important; /* ì—¬ë°± 20px ë³µêµ¬ */
    padding-bottom: 1rem !important; /* í•˜ë‹¨ ì—¬ë°± ì¶•ì†Œ */
  }
}

@media (min-width: 768px) {
  /* PC: ë„¤ë¹„ë°” ìœ ì§€ */
  .h-screen {
    top: 64px !important; /* ë„¤ë¹„ë°” ë†’ì´ë§Œí¼ ì•„ë˜ë¡œ */
    height: calc(100vh - 64px) !important; /* ë„¤ë¹„ë°” ë†’ì´ ì œì™¸ */
  }
  
  /* ğŸ”§ PC ë©”ì‹œì§€ ì˜ì—­ ë†’ì´ ì¡°ì • (ì—¬ë°± ìµœì í™”) */
  #chat-log {
    height: calc(100vh - 64px - 166px - 70px) !important; /* ì—¬ë°± 20px ë³µêµ¬ */
    padding-bottom: 1rem !important; /* í•˜ë‹¨ ì—¬ë°± ì¶•ì†Œ */
  }
  
  /* PCì—ì„œ ì¢Œìš° ì—¬ë°± ì¶”ê°€ */
  #messageInputArea {
    padding-left: 1rem !important;
    padding-right: 1rem !important;
  }
}

/* ì…ë ¥ì°½ ìƒë‹¨ ì—¬ë°± ì œê±° */
#messageInputArea {
  padding-bottom: 0.75rem !important; /* pb-3ë§Œ ìœ ì§€ */
}

/* ì±„íŒ…ë°©ì—ì„œ í‘¸í„° ì™„ì „ ìˆ¨ê¹€ */
footer {
  display: none !important;
}

/* base.htmlì˜ footer includeë„ ìˆ¨ê¹€ */
body > footer,
body > div:has(footer),
[class*="footer"] {
  display: none !important;
}
</style>

<script>
  // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
  window.roomCode = "{{ room.room_code }}";
  window.room_code = "{{ room.room_code }}";
  window.currentUser = "{{ current_user.username }}";
  window.currentUserId = "{{ current_user.id }}";
  window.isTradeCompleted = "{{ room.is_fully_completed }}" === "True";
  window.hasAlreadyReviewed = {{ has_already_reviewed|yesno:"true,false" }};
  window.isFullyCompleted = {{ room.is_fully_completed|yesno:"true,false" }};
  window.roomBuyer = "{{ room.buyer.username }}";
  window.roomSeller = "{{ room.seller.username }}";
  window.csrfToken = "{{ csrf_token }}";
  
  // roomCode ìœ íš¨ì„± ê²€ì‚¬
  if (!window.roomCode || window.roomCode === 'undefined' || window.roomCode === '') {
    alert('ì±„íŒ…ë°© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
  }
  
  // WebSocket ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
  function isWebSocketReady() {
    return window.sendWebSocketMessage && typeof window.sendWebSocketMessage === 'function';
  }
  
  // ì‹ ê³  ëª¨ë‹¬ ì—°ê²°
  document.addEventListener('DOMContentLoaded', function() {
    // ì‹ ê³  ëª¨ë‹¬ ì´ˆê¸°í™”
    ReportModal.init({
      reportActionUrl: `{% url 'accounts:report_user' user_id=other_user.id %}`
    });
    
    // í—¤ë”ì˜ ì‹ ê³  ë²„íŠ¼ê³¼ ì—°ê²°
    const reportUserBtn = document.getElementById('reportUserBtn');
    if (reportUserBtn) {
      reportUserBtn.addEventListener('click', function() {
        // ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
        const dropdown = document.getElementById('headerDropdownMenu');
        if (dropdown) dropdown.classList.add('hidden');
        
        // ì‹ ê³  ëª¨ë‹¬ ì—´ê¸°
        const modal = document.getElementById('report-modal');
        const content = document.getElementById('report-modal-content');
        
        if (modal && content) {
          modal.classList.remove('hidden');
          setTimeout(() => {
            content.classList.remove('scale-95', 'opacity-0');
            content.classList.add('scale-100', 'opacity-100');
          }, 10);
        }
      });
    }
  });

  // í˜„ì¬ ì±„íŒ…ë°© ìœ„ì¹˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updateCurrentChatroom(roomCode) {
      fetch('/ddokchat/api/update-current-chatroom/', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: JSON.stringify({
              'room_code': roomCode
          })
      }).then(response => response.json())
      .then(data => {
          // ì„±ê³µ ì‹œ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
      }).catch(error => {
          console.error('ì±„íŒ…ë°© ìœ„ì¹˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
      });
  }

  // í˜„ì¬ ì±„íŒ…ë°© ìœ„ì¹˜ í•´ì œ í•¨ìˆ˜
  function clearCurrentChatroom() {
      fetch('/ddokchat/api/clear-current-chatroom/', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
      }).then(response => response.json())
      .then(data => {
          // ì„±ê³µ ì‹œ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
      }).catch(error => {
          console.error('ì±„íŒ…ë°© ìœ„ì¹˜ í•´ì œ ì‹¤íŒ¨:', error);
      });
  }

  // ì•ˆì½ì€ ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ í•¨ìˆ˜ (íƒ­ í™œì„±í™” ì‹œ)
  function markMessagesAsReadOnFocus() {
      if (isWebSocketReady()) {
          window.sendWebSocketMessage({
              'type': 'read_all'
          });
      }
  }

  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
  document.addEventListener('DOMContentLoaded', function() {
      const roomCode = '{{ room.room_code }}';
      
      // roomCode ê²€ì¦
      if (!roomCode || roomCode === 'undefined' || roomCode === '') {
          return;
      }
      
      // í˜ì´ì§€ ë¡œë“œ ì‹œ í˜„ì¬ ìœ„ì¹˜ ì„¤ì •
      updateCurrentChatroom(roomCode);
      
      // íƒ­/ì°½ í™œì„±í™” ì´ë²¤íŠ¸
      window.addEventListener('focus', function() {
          updateCurrentChatroom(roomCode);
          markMessagesAsReadOnFocus();
      });
      
      // íƒ­/ì°½ ë¹„í™œì„±í™” ì´ë²¤íŠ¸
      window.addEventListener('blur', function() {
          clearCurrentChatroom();
      });
      
      // í˜ì´ì§€ ì´íƒˆ ì‹œ ìœ„ì¹˜ í•´ì œ
      window.addEventListener('beforeunload', function() {
          navigator.sendBeacon('/ddokchat/api/clear-current-chatroom/', 
              new Blob([JSON.stringify({})], {type: 'application/json'})
          );
      });
      
      // í˜ì´ì§€ ìˆ¨ê¹€/í‘œì‹œ ì´ë²¤íŠ¸ (ëª¨ë°”ì¼ ëŒ€ì‘)
      document.addEventListener('visibilitychange', function() {
          if (document.hidden) {
              clearCurrentChatroom();
          } else {
              updateCurrentChatroom(roomCode);
              markMessagesAsReadOnFocus();
          }
      });
  });
</script>

<!-- ğŸ”¥ ì‹ ê³  ëª¨ë‹¬ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ -->
<script src="{% static 'js/report_modal.js' %}"></script>
<script type="module" src="{% static 'js/ddokchat/chat_room.js' %}"></script>
{% endblock %}